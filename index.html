<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SFP - ERP Sistema Integral</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb' },
                        blue: { custom: '#2563eb' },   /* Compatibilidad con l√≥gica antigua */
                        orange: { custom: '#f97316' }, /* Compatibilidad con l√≥gica antigua */
                        yellow: { custom: '#eab308' },
                        sidebar: { bg: '#1e293b', hover: '#334155', active: '#0f172a', text: '#cbd5e1' }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos del Nuevo Men√∫ */
        .sidebar-scroll::-webkit-scrollbar { width: 5px; }
        .sidebar-scroll::-webkit-scrollbar-track { background: #1e293b; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .submenu.open { max-height: 500px; transition: max-height 0.5s ease-in; }
        .arrow-icon { transition: transform 0.3s ease; }
        .arrow-icon.rotate { transform: rotate(180deg); }

        /* Estilos de Impresi√≥n */
        @media print {
            /* 1. Oculta todo lo que tenga la clase 'no-print' */
            .no-print {
                display: none !important;
            }

            /* 2. Resetea el body para la impresi√≥n */
            body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* 3. Ajusta los m√°rgenes de la hoja de papel */
            @page {
                size: letter;
                margin: 1.0cm;
            }

            /* 4. Por defecto, oculta TODAS las secciones y √°reas de impresi√≥n */
            #dashboard, #invoiceSection, #receiptSection, #historySection, 
            #reportsSection, #agendaSection, #morosidadSection, #accountStatementSection,
            #invoicePreview, #receiptPreview, #statement-preview {
                display: none !important;
            }

            /* --- 5. L√ìGICA INTELIGENTE DE IMPRESI√ìN --- */

            /* A. CUANDO SE IMPRIME UNA FACTURA O RECIBO (COMPACTO) */
            body.printing-invoice #invoiceSection,
            body.printing-invoice #invoicePreview,
            body.printing-receipt #receiptSection,
            body.printing-receipt #receiptPreview {
                display: block !important;
                position: static !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                min-height: 0 !important;
                font-size: 10pt;
            }

            /* B. Estilos de compactaci√≥n SOLO para Facturas */
            body.printing-invoice #invoicePreview h1, 
            body.printing-invoice #invoicePreview h2, 
            body.printing-invoice #invoicePreview h3, 
            body.printing-invoice #invoicePreview h4, 
            body.printing-invoice #invoicePreview p {
                margin: 0 0 0.10rem 0; /* Tu estilo compacto */
                padding: 0;
            }
            body.printing-invoice #invoicePreview table th, 
            body.printing-invoice #invoicePreview table td {
                padding: 4px 6px; /* Tu estilo compacto */
                font-size: 9pt;
            }
            body.printing-invoice #invoicePreview .text-right.text-xs {
                line-height: 1.2; /* Tu estilo compacto */
            }
            
            body.printing-invoice #invoicePreview .border-t, 
            body.printing-invoice #invoicePreview .text-center {
                margin-top: 0.10rem; /* Tu estilo compacto */
            }            


            /* C. CUANDO SE IMPRIME UN ESTADO DE CUENTA (ANCHO) */
            body.printing-statement #accountStatementSection,
            body.printing-statement #statement-preview {
                display: block !important;
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 10pt;
            }
            
            /* D. Estilos de compactaci√≥n (para TODOS los documentos) */
            body.printing-invoice table th, 
            body.printing-invoice table td,
            body.printing-receipt table th, 
            body.printing-receipt table td,
            body.printing-statement table th, 
            body.printing-statement table td {
                padding: 4px 6px;
                font-size: 9pt;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gray-50 z-50 relative">
        <div class="flex flex-col md:flex-row w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden">
            <div class="w-full md:w-1/2 p-8 flex flex-col justify-center items-center bg-gradient-to-br from-blue-600 to-blue-800 text-white">
                <div class="text-center">
                    <i class="fas fa-cube text-6xl mb-4"></i>
                    <h1 class="text-3xl font-bold mb-2">Sistema ERP</h1>
                    <p class="text-blue-100">Gesti√≥n integral simple y eficiente.</p>
                </div>
            </div>
            <div class="w-full md:w-1/2 p-8 md:p-12">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Iniciar Sesi√≥n</h2>
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email</label>
                        <input id="loginEmail" type="email" placeholder="usuario@ejemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                        <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-600 outline-none" />
                    </div>
                    <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-lg">
                        Iniciar sesi√≥n
                    </button>
                    <p id="loginError" class="text-red-500 text-sm mt-4 hidden text-center">Credenciales inv√°lidas o error de conexi√≥n.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="appScreen" class="hidden flex h-screen overflow-hidden">
        
        <aside class="w-64 bg-sidebar-bg text-sidebar-text flex flex-col h-full shadow-xl z-20 flex-shrink-0 transition-all duration-300 no-print" id="sidebar">
            <div class="h-16 flex items-center px-6 border-b border-gray-700 bg-sidebar-active">
                <div class="flex items-center gap-3">
                    <div class="bg-white p-1 rounded-lg shadow-lg overflow-hidden flex items-center justify-center w-10 h-10">
                        <!-- Reemplaza "TU_URL_DEL_LOGO.png" por el enlace a tu imagen o un base64 -->
                        <img src="LogoSFP.jpg" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-white tracking-wide">SFP - ERP</h1>
                        <p class="text-[10px] text-gray-400 uppercase tracking-wider">Enterprise v<span id="app-version">1.0.0</span> </p>
                    </div>
                </div>
            </div>

            <!-- Perfil Usuario (Click para editar) -->
            <div class="p-4 border-b border-gray-700 bg-gray-800/30">
                
                <!-- ‚ñº‚ñº‚ñº ESTE ES EL BLOQUE MODIFICADO ‚ñº‚ñº‚ñº -->
                <div class="flex items-center gap-3 cursor-pointer hover:bg-white/10 p-2 rounded-lg transition-colors group" onclick="showMyProfile()" title="Editar mi perfil">
                    
                    <!-- Avatar -->
                    <img id="sidebarUserAvatar" src="" class="w-9 h-9 rounded-full border-2 border-gray-600 bg-gray-700 object-cover group-hover:border-blue-500 transition-colors" alt="User">
                    
                    <div class="flex-1 min-w-0">
                        <!-- Nombre (Texto blanco para el men√∫ oscuro) -->
                        <p id="sidebarUserName" class="text-sm font-semibold text-white truncate group-hover:text-blue-400 transition-colors">Cargando...</p>
                        
                        <!-- Rol y Estado -->
                        <div class="flex items-center gap-1.5">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            <p id="sidebarUserRole" class="text-xs text-gray-400 truncate">Usuario</p>
                        </div>
                    </div>
                    
                    <!-- Icono de edici√≥n sutil -->
                    <i class="fas fa-pen text-[10px] text-gray-500 group-hover:text-white"></i>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ FIN DEL BLOQUE ‚ñ≤‚ñ≤‚ñ≤ -->

            </div>

            <nav class="flex-1 overflow-y-auto sidebar-scroll p-4 space-y-1">
                <a href="#" onclick="showSection('reportsSection'); setActive(this)" data-permission="view_reports" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-sidebar-hover hover:text-white transition-colors group bg-sidebar-hover text-white font-medium">
                    <i class="fas fa-home w-5 text-center group-hover:text-brand-500"></i><span>Inicio (Reportes)</span>
                </a>

                <div class="pt-4 pb-1"><p class="px-3 text-xs font-bold text-gray-500 uppercase tracking-wider">Operaciones</p></div>

                <div class="relative">
                    <button onclick="toggleSubmenu('ventas-submenu', this)" class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg hover:bg-sidebar-hover hover:text-white transition-colors group">
                        <div class="flex items-center gap-3"><i class="fas fa-shopping-cart w-5 text-center group-hover:text-blue-400"></i><span>Ventas</span></div>
                        <i class="fas fa-chevron-down text-xs arrow-icon"></i>
                    </button>
                    <div id="ventas-submenu" class="submenu pl-10 space-y-1">
                        <a href="#" onclick="showSection('invoiceSection')" data-permission="create_invoice" class="block px-3 py-2 rounded-lg text-sm hover:text-white hover:bg-gray-700/50">Nueva Factura</a>
                        <a href="#" onclick="showSection('receiptSection')" data-permission="create_receipt" class="block px-3 py-2 rounded-lg text-sm hover:text-white hover:bg-gray-700/50">Nuevo Recibo</a>
                        <a href="#" onclick="showHistory()" data-permission="view_history" class="block px-3 py-2 rounded-lg text-sm hover:text-white hover:bg-gray-700/50">Historial Documentos</a>
                        <a href="#" onclick="showClientManager()" data-permission="manage_clients" class="block px-3 py-2 rounded-lg text-sm hover:text-white hover:bg-gray-700/50">Clientes</a>
                    </div>
                </div>

                <a href="#" onclick="showProductManager(); setActive(this)" data-permission="manage_products" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-sidebar-hover hover:text-white transition-colors group">
                    <i class="fas fa-boxes w-5 text-center group-hover:text-teal-400"></i><span>Inventario / Productos</span>
                </a>

                <div class="relative">
                    <button onclick="toggleSubmenu('finanzas-submenu', this)" class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg hover:bg-sidebar-hover hover:text-white transition-colors group">
                        <div class="flex items-center gap-3"><i class="fas fa-chart-line w-5 text-center group-hover:text-green-400"></i><span>Finanzas</span></div>
                        <i class="fas fa-chevron-down text-xs arrow-icon"></i>
                    </button>
                    <div id="finanzas-submenu" class="submenu pl-10 space-y-1">
                        <a href="#" onclick="showAccountStatement()" data-permission="view_estadocuenta" class="block px-3 py-2 rounded-lg text-sm hover:text-white hover:bg-gray-700/50">Estado de Cuenta</a>
                        <a href="#" onclick="showMorosidadReport()" data-permission="view_morosidad" class="block px-3 py-2 rounded-lg text-sm hover:text-white hover:bg-gray-700/50">Morosidad</a>
                        <a href="#" onclick="showPaymentReport()" data-permission="view_ingresos" class="block px-3 py-2 rounded-lg text-sm hover:text-white hover:bg-gray-700/50">Reporte de Ingresos (Abonos)</a>
                        <a href="#" onclick="showBankAccountManager()" data-permission="manage_banks" class="block px-3 py-2 rounded-lg text-sm hover:text-white hover:bg-gray-700/50">Ctas. Bancarias</a>
                    </div>
                </div>

                <div class="pt-4 pb-1"><p class="px-3 text-xs font-bold text-gray-500 uppercase tracking-wider">Productividad</p></div>
                <a href="#" onclick="showAgenda(); setActive(this)" data-permission="view_agenda" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-sidebar-hover hover:text-white transition-colors group">
                    <i class="far fa-calendar-alt w-5 text-center group-hover:text-purple-400"></i><span>Agenda</span>
                </a>

                <div class="pt-4 pb-1"><p class="px-3 text-xs font-bold text-gray-500 uppercase tracking-wider">Admin</p></div>
                <a href="#" onclick="showUserManager(); setActive(this)" data-permission="manage_users" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-sidebar-hover hover:text-white transition-colors group">
                    <i class="fas fa-users w-5 text-center group-hover:text-indigo-400"></i><span>Usuarios</span>
                </a>
                <a href="#" onclick="showCompanyManager(); setActive(this)" data-permission="manage_company" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-sidebar-hover hover:text-white transition-colors group">
                    <i class="fas fa-building w-5 text-center group-hover:text-gray-400"></i><span>Empresas</span>
                </a>
                <a href="#" onclick="showAuthManager(); setActive(this)" data-permission="manage_auths" class="flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-sidebar-hover hover:text-white transition-colors group">
                    <i class="fas fa-file-contract w-5 text-center group-hover:text-yellow-400"></i><span>Autorizaciones (SAR)</span>
                </a>
            </nav>

            <div class="p-4 border-t border-gray-700">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition-colors shadow-lg">
                    <i class="fas fa-sign-out-alt"></i><span>Salir</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-gray-100 h-screen overflow-hidden relative w-full">
            
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 shadow-sm z-10 no-print">
                <div class="flex items-center gap-4">
                    <button class="md:hidden text-gray-600" onclick="toggleSidebar()"><i class="fas fa-bars text-xl"></i></button>
                    <h2 class="text-xl font-semibold text-gray-800">Panel de Control</h2>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <button onclick="toggleNotificationPanel()" id="notification-bell-btn" class="relative p-2 text-gray-400 hover:text-gray-600 transition-colors">
                            <i class="far fa-bell text-xl"></i>
                            <span id="notification-count-badge" class="hidden absolute top-1 right-1 w-4 h-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">0</span>
                        </button>
                        <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden z-50 border border-gray-200">
                            <div class="py-2 px-4 border-b border-gray-200 bg-gray-50"><h3 class="font-bold text-gray-800 text-sm">Notificaciones</h3></div>
                            <div id="notification-list" class="divide-y divide-gray-100 max-h-64 overflow-y-auto">
                                <p class="text-center text-gray-500 p-4 text-sm">Sin notificaciones nuevas.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-4 md:p-6" id="app-content">
                
                <!-- SECCION DE FACTURAS -->
                <div id="invoiceSection" class="section">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-blue-custom no-print">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                            <span class="bg-blue-custom text-white p-2 rounded-lg mr-3">üìÑ</span> <span id="invoiceTitle">Nueva Factura</span>
                        </h2>
                        <form id="invoiceForm" class="space-y-4" onsubmit="return false;">
                            <input type="hidden" id="editingInvoiceId">
                            <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Factura</label>
                                <input type="text" id="invoiceNumber" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                <input type="date" id="invoiceDate" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                            </div>
                            </div>
                            <div id="authInfo" class="hidden text-sm text-gray-600 bg-purple-50 p-3 rounded-lg">
                            <p><strong>CAI Activo:</strong> <span id="activeCAI"></span></p>
                            <p><strong>Rango:</strong> <span id="activeRange"></span> | <strong>Fecha L√≠mite:</strong> <span id="activeDate"></span></p>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Datos de la Empresa</h3>
                            <select id="companySelect" onchange="updateCompanyData()" class="w-full border border-gray-300 rounded-lg px-3 py-2"><option value="">Seleccionar empresa...</option></select>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Cliente</h3>
                            
                            <label for="invoiceClientSelect" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Cliente Existente</label>
                            <select id="invoiceClientSelect" onchange="clientSelected('invoice')" class="w-full border rounded px-3 py-2 mb-3"></select>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="invoiceClientName" placeholder="Nombre del cliente" class="border rounded px-3 py-2">
                                <input type="text" id="invoiceClientRTN" placeholder="RTN del cliente" class="border rounded px-3 py-2">
                                <input type="text" id="invoiceClientAddress" placeholder="Direcci√≥n" class="md:col-span-2 border rounded px-3 py-2">
                            </div>

                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Productos/Servicios</h3>
                            <div id="invoiceItems" class="space-y-2">                
                            </div>
                            <button type="button" onclick="addInvoiceItem()" class="mt-2 bg-yellow-custom hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">+ Agregar</button>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Detalles del Pago</h3>              
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">M√©todo de Pago</label>
                                <select id="paymentMethod" class="w-full border rounded px-3 py-2">
                                    <option value="Contado">Contado</option>
                                    <option value="Transferencia Bancaria">Transferencia Bancaria</option>
                                    <option value="Tarjeta de Cr√©dito">Tarjeta de Cr√©dito</option>
                                    <option value="Tarjeta de D√©bito">Tarjeta de D√©bito</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Dep√≥sito Bancario">Dep√≥sito Bancario</option>
                                </select>
                                </div>
                                <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ISV (%)</label>
                                <select id="taxRate" onchange="handleTaxChange()" class="w-full border rounded px-3 py-2">
                                    <option value="15">15% - ISV est√°ndar</option>
                                    <option value="18">18% - ISV especial</option>
                                    <option value="0">0% - Exento</option>
                                    <option value="exonerado">Exonerado</option>
                                </select>
                                </div>
                            </div>

                            <div id="exoneradoFields" class="hidden mt-4 space-y-4 border-t pt-4">
                                <h4 class="text-md font-semibold text-gray-700">Detalles de Exoneraci√≥n</h4>
                                <div>
                                <label class="block text-sm font-medium text-gray-700"># Correlativo de Orden de Compra Exenta</label>
                                <input type="text" id="ordenCompraExenta" class="w-full border rounded px-3 py-2 mt-1">
                                </div>
                                <div>
                                <label class="block text-sm font-medium text-gray-700"># Correlativo de Constancia de Registro Exonerado</label>
                                <input type="text" id="constanciaRegistroExonerado" class="w-full border rounded px-3 py-2 mt-1">
                                </div>
                                <div>
                                <label class="block text-sm font-medium text-gray-700"># Identificativo del Registro de la SAG</label>
                                <input type="text" id="registroSAG" class="w-full border rounded px-3 py-2 mt-1">
                                </div>
                            </div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <div class="space-y-3 text-right">
                                <div class="flex justify-between items-center">
                                    <span>Subtotal:</span> 
                                    <span id="subtotal">L 0.00</span>
                                </div>
                                
                                <div class="flex justify-between items-center gap-4">
                                    <label for="discountAmount" class="text-sm font-medium text-gray-700">Descuento (L):</label>
                                    <input type="number" step="0.01" id="discountAmount" placeholder="0.00" 
                                        class="w-32 border rounded-lg px-3 py-1 text-right" 
                                        oninput="calculateTotals()">
                                </div>
                                <div class="flex justify-between items-center">
                                    <span>ISV:</span> 
                                    <span id="taxAmount">L 0.00</span>
                                </div>
                                <div class="flex justify-between font-bold text-lg border-t pt-2">
                                    <span>TOTAL:</span> 
                                    <span id="total">L 0.00</span>
                                </div>
                                </div>
                            </div>
                            <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
                            <textarea id="observations" rows="3" class="w-full border rounded px-3 py-2"></textarea>
                            </div>
                            <div class="flex gap-4">
                                <button type="button" id="saveInvoiceBtn" onclick="handleInvoiceSubmit()" class="w-full bg-gradient-to-r from-blue-custom to-blue-600 text-white py-3 rounded-lg text-lg font-semibold">üíæ Guardar Factura</button>
                                <button type="button" onclick="resetInvoiceForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg text-lg font-semibold">‚ú® Nueva</button>
                            </div>
                        </form>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4 no-print">
                            <h3 class="text-xl font-bold">Vista Previa</h3>
                            <button onclick="printCurrentDocument()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üñ®Ô∏è Imprimir</button>
                        </div>
                        <div id="invoicePreview" class="border rounded-lg p-4 min-h-96">
                            <p class="text-gray-500 text-center mt-20">La vista previa aparecer√° aqu√≠</p>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- SECCION DE RECIBOS -->
                <div id="receiptSection" class="section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-orange-custom no-print">
                        <h2 class="text-2xl font-bold mb-6 flex items-center"><span class="bg-orange-custom text-white p-2 rounded-lg mr-3">üßæ</span> <span id="receiptTitle">Nuevo Recibo</span></h2>
                        <form id="receiptForm" class="space-y-4" onsubmit="return false;">
                            <input type="hidden" id="editingReceiptId">
                            <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Recibo</label>
                                <input type="text" id="receiptNumber" class="w-full border rounded px-3 py-2 bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                <input type="date" id="receiptDate" class="w-full border rounded px-3 py-2">
                            </div>
                            </div>
                            <div class="bg-orange-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Datos de la Empresa</h3>
                            <select id="receiptCompanySelect" onchange="updateReceiptCompanyData()" class="w-full border rounded px-3 py-2"><option value="">Seleccionar empresa...</option></select>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Cliente</h3>

                            <label for="receiptClientSelect" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Cliente Existente</label>
                            <select id="receiptClientSelect" onchange="clientSelected('receipt')" class="w-full border rounded px-3 py-2 mb-3"></select>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="receiptClientName" placeholder="Nombre del cliente" class="border rounded px-3 py-2">
                                <input type="text" id="receiptClientPhone" placeholder="Tel√©fono" class="border rounded px-3 py-2">
                                <input type="text" id="receiptClientAddress" placeholder="Direcci√≥n" class="md:col-span-2 border rounded px-3 py-2">
                            </div>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3">Detalles del Pago</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">Monto (L) *</label><input type="number" step="0.01" id="receiptAmount" placeholder="0.00" class="w-full border rounded px-3 py-2" required></div>
                                <div><label class="block text-sm font-medium text-gray-700 mb-1">M√©todo de Pago</label><select id="receiptPaymentMethod" class="w-full border rounded px-3 py-2"><option value="Efectivo">Efectivo</option><option value="Transferencia Bancaria">Transferencia Bancaria</option><option value="Tarjeta de Cr√©dito">Tarjeta de Cr√©dito</option><option value="Tarjeta de D√©bito">Tarjeta de D√©bito</option><option value="Cheque">Cheque</option><option value="Dep√≥sito Bancario">Dep√≥sito Bancario</option></select></div>
                            </div>
                            </div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Concepto/Descripci√≥n</label><textarea id="receiptConcept" rows="3" placeholder="Descripci√≥n del pago..." class="w-full border rounded px-3 py-2"></textarea></div>
                            <div><label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label><textarea id="receiptObservations" rows="2" class="w-full border rounded px-3 py-2"></textarea></div>
                            <div class="flex gap-4">
                                <button type="button" id="saveReceiptBtn" onclick="handleReceiptSubmit()" class="w-full bg-gradient-to-r from-orange-custom to-orange-600 text-white py-3 rounded-lg text-lg font-semibold">üíæ Guardar Recibo</button>
                                <button type="button" onclick="resetReceiptForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg text-lg font-semibold">‚ú® Nuevo</button>
                            </div>
                        </form>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4 no-print">
                            <h3 class="text-xl font-bold">Vista Previa</h3>
                            <button onclick="printCurrentDocument()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üñ®Ô∏è Imprimir</button>
                        </div>
                        <div id="receiptPreview" class="border rounded-lg p-4 min-h-96">
                            <p class="text-gray-500 text-center mt-20">La vista previa aparecer√° aqu√≠</p>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- SECCION DE HISTORIAL DE DOCUMENTOS -->
                <div id="historySection" class="section hidden">
                    <div class="bg-white p-6 rounded-lg shadow-lg no-print">
                        <h2 class="text-2xl font-bold mb-4">Historial de Documentos</h2>

                        <div class="flex flex-wrap gap-4 items-center mb-4">
                            <div class="flex-grow">
                                <label for="historyCompanyFilter" class="text-sm font-medium">Filtrar por Empresa:</label>
                                <select id="historyCompanyFilter" onchange="filterHistoryByCompany(this.value)" class="w-full mt-1 border rounded-lg px-3 py-2"></select>
                            </div>

                            <div>
                                <label class="text-sm font-medium">Filtrar por Rango de Fechas:</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="date" id="historyDateStart" onchange="filterHistoryByDate()" class="border rounded-lg px-3 py-2" placeholder="Desde">
                                    <input type="date" id="historyDateEnd" onchange="filterHistoryByDate()" class="border rounded-lg px-3 py-2" placeholder="Hasta">
                                    <button onclick="clearDateFilter()" class="px-3 py-2 text-sm rounded-lg bg-gray-300 hover:bg-gray-400" title="Limpiar filtro de fecha">‚úï</button>
                                </div>
                            </div>

                            <div>
                                <label class="text-sm font-medium">Filtrar por Tipo:</label>
                                <div id="historyTypeFilter" class="flex gap-2 mt-1">
                                    <button onclick="filterHistory('all')" class="px-4 py-2 text-sm rounded-lg bg-blue-custom text-white">Todos</button>
                                    <button onclick="filterHistory('factura')" class="px-4 py-2 text-sm rounded-lg bg-gray-200">Facturas</button>
                                    <button onclick="filterHistory('recibo')" class="px-4 py-2 text-sm rounded-lg bg-gray-200">Recibos</button>
                                </div>
                            </div>

                            <div class="flex gap-3 items-end">
                                <div>
                                    <label class="block text-sm font-medium text-transparent select-none">Acci√≥n</label>
                                    <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-center">
                                        <span class="mr-2">üìä</span> 
                                        Exportar a Excel
                                    </button>
                                </div>
                                <div data-permission="manage_settings">                            
                                    <button onclick="batchUpdateOldInvoices()" id="batch-update-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-center">
                                        <span class="mr-2">üîß</span>
                                        Actualizar Facturas Antiguas
                                    </button>                                    
                                </div>
                                <div data-permission="manage_settings">                                                                
                                    <!-- Bot√≥n Temporal -->
                                    <button onclick="fixBalances()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-center">
                                        üîß Reparar Saldos
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="historyList" class="space-y-3"></div>
                    </div>
                </div>   

                <!-- SECCION DE REPORTES -->
                <div id="reportsSection" class="section hidden">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6 flex items-center"><span class="bg-gray-600 text-white p-2 rounded-lg mr-3">üìä</span> Panel de Reportes</h2>
                        <!--<div class="mt-6 bg-white p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Reportes Personalizados</h3>
                            <div class="flex gap-4">
                                <button onclick="showAccountStatement()" class="bg-blue-custom hover:bg-blue-600 text-white px-5 py-3 rounded-lg font-semibold">
                                    Generar Estado de Cuenta por Cliente
                                </button>
                                <button onclick="showPaymentReport()" class="bg-green-600 hover:bg-green-700 text-white px-5 py-3 rounded-lg font-semibold">
                                    Reporte de Ingresos (Abonos)
                                </button>
                            </div>
                        </div> -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-custom">
                                <h3 class="text-lg font-semibold">Total Documentos</h3>
                                <p id="totalDocs" class="text-3xl font-bold text-blue-custom">0</p>
                            </div>
                            <div class="bg-orange-50 p-6 rounded-lg border-l-4 border-orange-custom">
                                <h3 class="text-lg font-semibold">Facturas</h3>
                                <p id="totalInvoices" class="text-3xl font-bold text-orange-custom">0</p>
                            </div>
                            <div class="bg-yellow-50 p-6 rounded-lg border-l-4 border-yellow-custom">
                                <h3 class="text-lg font-semibold">Recibos</h3>
                                <p id="totalReceipts" class="text-3xl font-bold text-yellow-custom">0</p>
                            </div>
                            <div class="bg-green-50 p-6 rounded-lg border-l-4 border-green-500">
                                <h3 class="text-lg font-semibold">Ingresos Totales</h3>
                                <p id="totalRevenue" class="text-3xl font-bold text-green-600">L 0</p>
                            </div>
                        </div>
                            <div class="bg-gray-50 p-6 rounded-lg"><h3 class="text-xl font-bold mb-4">Resumen por Empresa</h3>
                                <div id="companyBreakdown">                                    
                                </div>
                            </div>
                        </div>
                </div>

                <!-- SECCION DE AGENDA -->
                <div id="agendaSection" class="hidden p-4 md:p-6 lg:p-8 space-y-6">
                    <h2 class="text-3xl font-bold text-gray-800">üóìÔ∏è Agenda Personal</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-gray-700">Productividad del d√≠a</h3>
                                <span class="text-xl">üöÄ</span>
                            </div>
                            <div class="text-3xl font-bold text-blue-custom" id="productivity">85%</div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: 85%" id="productivity-bar"></div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-gray-700">Tareas Completadas</h3>
                                <span class="text-xl">‚úÖ</span>
                            </div>
                            <div class="text-3xl font-bold text-green-600" id="completed-tasks">0</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-gray-700">Tiempo Enfocado</h3>
                                <span class="text-xl">‚è±Ô∏è</span>
                            </div>
                            <div class="text-3xl font-bold text-orange-custom" id="focused-time">0h 0m</div>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-semibold text-gray-700">Racha Diaria</h3>
                                <span class="text-xl">üî•</span>
                            </div>
                            <div class="text-3xl font-bold text-red-500" id="streak">1</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-2 space-y-6">
                            
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Agregar Tarea R√°pida</h3>
                                
                                <div class="mb-2">
                                    <input type="text" id="quick-task" placeholder="¬øQu√© necesitas hacer hoy?" class="w-full flex-1 border rounded-lg px-3 py-2">
                                </div>
                                
                                <div class="flex flex-wrap gap-2 items-center">
                                    <select id="quick-category" class="flex-grow border rounded-lg px-3 py-2">
                                        <option value="trabajo">üíº Trabajo</option>
                                        <option value="personal">üë§ Personal</option>
                                        <option value="salud">üí™ Salud</option>
                                        <option value="estudios">üìö Estudios</option>
                                        <option value="hogar">üè† Hogar</option>
                                    </select>
                                    
                                    <select id="quick-time-estimate" class="flex-grow border rounded-lg px-3 py-2">
                                        <option value="15">15 min</option>
                                        <option value="30" selected>30 min</option>
                                        <option value="60">1 hora</option>
                                        <option value="120">2 horas</option>
                                    </select>
                                    
                                    <button type="button" id="add-quick-btn" class="bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Agregar</button>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold text-gray-800 mb-4" id="detailed-task-title">üìù Crear Tarea Detallada</h3>
                                <div class="space-y-4">
                                
                                    <input type="hidden" id="detailed-task-id">

                                    <div id="assign-user-container" data-permission="assign_tasks" class="hidden">
                                        <label for="assign-to-user" class="block text-sm font-medium text-gray-700">Asignar Tarea A:</label>
                                        <select id="assign-to-user" class="w-full border rounded-lg px-3 py-2 mt-1">
                                        </select>
                                    </div>

                                    <input type="text" id="detailed-title" placeholder="T√≠tulo de la tarea" class="w-full border rounded-lg px-3 py-2">
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <!-- Categor√≠a -->
                                        <select id="category" class="w-full border rounded-lg px-3 py-2">
                                            <option value="trabajo">üíº Trabajo</option>
                                            <option value="personal">üë§ Personal</option>
                                            <option value="salud">üí™ Salud</option>
                                            <option value="estudios">üìö Estudios</option>
                                            <option value="hogar">üè† Hogar</option>
                                        </select>

                                        <!-- Prioridad -->
                                        <select id="priority" class="w-full border rounded-lg px-3 py-2">
                                            <option value="baja">üü¢ Baja</option>
                                            <option value="media" selected>üü° Media</option>
                                            <option value="alta">üü† Alta</option>
                                            <option value="urgente">üî¥ Urgente</option>
                                        </select>

                                        <!-- ‚ñº‚ñº‚ñº NUEVO CAMPO: RECURRENCIA ‚ñº‚ñº‚ñº -->
                                        <select id="recurrence" class="w-full border rounded-lg px-3 py-2 bg-purple-50 text-purple-700 font-medium">
                                            <option value="ninguna">üîÅ Sin repetici√≥n</option>
                                            <option value="diaria">üìÖ Diariamente</option>
                                            <option value="semanal">üìÜ Semanalmente</option>
                                            <option value="mensual">üóìÔ∏è Mensualmente</option>
                                        </select>
                                    </div>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <input type="number" id="time-estimate" class="w-full border rounded-lg px-3 py-2 md:col-span-1" placeholder="Tiempo (en minutos)">
                                        <input type="date" id="due-date" class="w-full border rounded-lg px-3 py-2 md:col-span-1">
                                        <input type="time" id="due-time" class="w-full border rounded-lg px-3 py-2 md:col-span-1">
                                    </div>

                                    <textarea id="notes" placeholder="Notas adicionales..." rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                                    
                                    <div class="flex gap-2">
                                        <button type="button" id="add-detailed-btn" class="w-full bg-orange-custom hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">Crear Tarea</button>
                                        <button type="button" id="cancel-edit-btn" onclick="resetDetailedTaskForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hidden">Cancelar</button>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                                    <div class="flex gap-2 flex-wrap items-center">
                                        <h3 class="text-xl font-bold text-gray-800 mr-4">üìã Mis Tareas</h3>
                                        <button type="button" id="filter-all" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-blue-custom text-white">Todas</button>
                                        
                                        <button type="button" id="filter-pendiente" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-gray-200 text-gray-700">Pendiente</button>
                                        <button type="button" id="filter-en-curso" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-gray-200 text-gray-700">En Curso</button>
                                        <button type="button" id="filter-en-revision" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-gray-200 text-gray-700">En Revisi√≥n</button>
                                        <button type="button" id="filter-completada" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-gray-200 text-gray-700">Completada</button>
                                        <button type="button" id="clear-completed-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-medium">Limpiar</button>
                                    </div>
                                    
                                    <div class="flex items-center gap-2">
                                        <label for="task-sort-select" class="text-sm font-medium text-gray-700">Ordenar por:</label>
                                        <select id="task-sort-select" class="border rounded-lg px-3 py-1 text-sm" onchange="setTaskSort()">
                                            <option value="created_desc">M√°s Recientes</option>
                                            <option value="due_date_asc">Fecha de Vencimiento</option>
                                            <option value="priority_desc">Prioridad (Alta a Baja)</option>
                                            <option value="time_asc">Tiempo (Menor a Mayor)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="tasks-container" class="space-y-3">
                                    <div class="text-center text-gray-500 py-4">
                                        <span class="text-3xl block mb-2">üìù</span>
                                        <p>No hay tareas. ¬°Agrega tu primera tarea!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="lg:col-span-1 space-y-6">
                            
                            <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">üçÖ Timer Pomodoro</h3>
                                
                                <div class="text-5xl font-mono text-center text-blue-custom mb-4" id="timer-display">25:00</div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                                    <select id="pomodoro-task" class="w-full border rounded-lg px-3 py-2 text-sm">
                                        <option value="">Seleccionar Tarea a Enfocar...</option>
                                        </select>
                                    <select id="pomodoro-sessions" class="w-full border rounded-lg px-3 py-2 text-sm">
                                        <option value="1">1 Sesi√≥n</option>
                                        <option value="2">2 Sesiones</option>
                                        <option value="3">3 Sesiones</option>
                                        <option value="4" selected>4 Sesiones</option>
                                        <option value="6">5 Sesiones</option>
                                        <option value="6">6 Sesiones</option>
                                    </select>
                                </div>

                                <div class="flex gap-2 justify-center mb-4">
                                    <button type="button" id="start-timer-btn" class="bg-orange-custom hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">Iniciar</button>
                                    <button type="button" id="pause-timer-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold">Pausa</button>
                                    <button type="button" id="reset-timer-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">Reset</button>
                                </div>

                                <div class="flex gap-2 justify-center mb-4">
                                    <button type="button" id="set-time-work" class="text-xs px-3 py-1 rounded-full bg-blue-custom text-white">Trabajo (25m)</button>
                                    <button type="button" id="set-time-short-break" class="text-xs px-3 py-1 rounded-full bg-green-500 text-white">Descanso (5m)</button>
                                    <button type="button" id="set-time-long-break" class="text-xs px-3 py-1 rounded-full bg-gray-400 text-white">Largo (15m)</button>
                                </div>

                                <p class="text-gray-500" id="pomodoro-info">Sesi√≥n 1 de 4 - Modo: Trabajo</p>
                            </div>
                            
                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">üìù Notas R√°pidas</h3>
                                <textarea id="quick-notes" placeholder="Anota tus ideas aqu√≠..." rows="6" class="w-full border rounded-lg px-3 py-2"></textarea>
                                <button type="button" id="save-notes-btn" class="w-full mt-3 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Guardar Notas</button>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Estad√≠sticas</h3>
                                <div class="space-y-4">

                                    <div>
                                        <div class="flex justify-between text-sm font-semibold mb-1">
                                            <span class="text-gray-700">Mi Progreso Total</span>
                                            <span class="text-blue-custom" id="stats-total-progress-text">0/0</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-3">
                                            <div id="stats-total-progress-bar" class="bg-blue-custom h-3 rounded-full" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Tareas completadas (mis √∫ltimos 7 d√≠as):</span>
                                        <span class="font-semibold text-gray-900" id="stats-week-tasks">0</span>
                                    </div>

                                    <hr class="my-2">

                                    <h4 class="text-md font-semibold text-gray-700">Mi Progreso por Categor√≠a</h4>
                                    <div id="stats-category-breakdown" class="space-y-3">
                                        <p class="text-sm text-gray-500 text-center">No hay tareas con categor√≠a.</p>
                                    </div>

                                    <div data-permission="assign_tasks" class="hidden">
                                        <hr class="my-4 border-gray-300">
                                        <h4 class="text-md font-semibold text-gray-700">Progreso del Equipo</h4>
                                        <div id="stats-team-breakdown" class="space-y-3 mt-3">
                                            </div>
                                    </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCION DE ANALISIS DE MOROSIDAD -->
                <div id="morosidadSection" class="hidden p-4 md:p-6 lg:p-8 space-y-6">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                        <div class="flex flex-wrap justify-between items-end gap-4 mb-2">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">üìä An√°lisis de Morosidad</h1>
                                <p class="text-gray-600">Seguimiento autom√°tico de cuentas por cobrar</p>
                            </div>
                            
                            <div class="flex gap-4 items-end">
                                <div class="w-full sm:w-64">
                                    <label for="morosidadCompanyFilter" class="block text-sm font-medium text-gray-700">Filtrar por Empresa</label>
                                    <select id="morosidadCompanyFilter" onchange="filterMorosidadByCompany(this.value)" class="w-full mt-1 border rounded-lg px-3 py-2"></select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-transparent select-none">Acci√≥n</label>
                                    <button onclick="exportMorosidadToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-center">
                                        <span class="mr-2">üìä</span> 
                                        Exportar a Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <div class="bg-green-100 rounded-lg p-4 border-l-4 border-green-500">
                            <div class="text-green-800 text-sm font-medium">Por Vencer (0-30 d√≠as)</div>
                            <div id="morosidad-rango-30" class="text-2xl font-bold text-green-700">L 0.00</div>
                        </div>
                        <div class="bg-yellow-100 rounded-lg p-4 border-l-4 border-yellow-500">
                            <div class="text-yellow-800 text-sm font-medium">Vencido (31-60 d√≠as)</div>
                            <div id="morosidad-rango-60" class="text-2xl font-bold text-yellow-700">L 0.00</div>
                        </div>
                        <div class="bg-orange-100 rounded-lg p-4 border-l-4 border-orange-500">
                            <div class="text-orange-800 text-sm font-medium">Vencido (61-90 d√≠as)</div>
                            <div id="morosidad-rango-90" class="text-2xl font-bold text-orange-700">L 0.00</div>
                        </div>
                        <div class="bg-red-100 rounded-lg p-4 border-l-4 border-red-500">
                            <div class="text-red-800 text-sm font-medium">Vencido (M√°s de 90 d√≠as)</div>
                            <div id="morosidad-rango-90-plus" class="text-2xl font-bold text-red-700">L 0.00</div>
                        </div>
                        <div class="bg-gray-100 rounded-lg p-4 border-l-4 border-gray-500">
                            <div class="text-gray-800 text-sm font-medium">Total Pendiente</div>
                            <div id="morosidad-total" class="text-2xl font-bold text-gray-700">L 0.00</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h2 class="text-xl font-semibold text-gray-800">üìã Detalle de Facturas Pendientes</h2>
                            </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th id="sort-cliente" onclick="sortMorosidadReport('cliente')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Cliente
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Factura</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Emisi√≥n</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Vencimiento</th>
                                        <th id="sort-monto" onclick="sortMorosidadReport('monto')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            Total Factura
                                        </th>
                                        <th id="sort-dias" onclick="sortMorosidadReport('dias')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                            D√≠as Vencido
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody id="morosidadTableBody" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SECCION DE ESTADO DE CUENTA -->
                <div id="accountStatementSection" class="hidden p-4 md:p-6 lg:p-8 space-y-6 max-w-7xl mx-auto">    
                    <div class="no-print bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Generar Estado de Cuenta</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div>
                                <label for="statementCompanyFilter" class="block text-sm font-medium text-gray-700">1. Seleccionar Empresa</label>
                                <select id="statementCompanyFilter" class="w-full mt-1 border rounded-lg px-3 py-2"></select>
                            </div>
                            <div>
                                <label for="statementClientFilter" class="block text-sm font-medium text-gray-700">2. Seleccionar Cliente</label>
                                <select id="statementClientFilter" class="w-full mt-1 border rounded-lg px-3 py-2"></select>
                            </div>
                            <button onclick="generateAccountStatement()" class="w-full md:w-auto bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 font-medium">
                                Generar Reporte
                            </button>
                        </div>
                    </div>
                    
                    <div id="statement-print-area">
                        <div id="statement-preview" class="bg-white rounded-lg shadow-md overflow-hidden p-8">
                            <p class="text-center text-gray-500">Seleccione una empresa y un cliente para generar el estado de cuenta.</p>
                        </div>
                    </div>

                    <div id="statement-print-btn-container" class="no-print hidden text-right">
                        <button onclick="printStatement()" class="bg-blue-custom hover:bg-blue-600 text-white px-5 py-3 rounded-lg font-semibold">
                            üñ®Ô∏è Imprimir Estado de Cuenta
                        </button>
                    </div>
                </div>

                <!-- SECCION DE EMPRESAS MODAL -->
                <div id="companyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Gesti√≥n de Empresas</h3>
                            <button onclick="hideCompanyManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                        </div>
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Empresa (Agregar/Editar)</h4>
                            <form id="companyForm" onsubmit="handleCompanyFormSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="companyId" />
                            <input type="text" id="newCompanyName" placeholder="Nombre de la empresa" class="border rounded-lg px-3 py-2" required>
                            <input type="text" id="newCompanyRTN" placeholder="RTN" class="border rounded-lg px-3 py-2">
                            <input type="text" id="newCompanyAddress" placeholder="Direcci√≥n" class="border rounded-lg px-3 py-2 md:col-span-2">
                            <input type="text" id="newCompanyPhone" placeholder="Tel√©fono" class="border rounded-lg px-3 py-2">
                            <input type="text" id="newCompanyEmail" placeholder="Email" class="border rounded-lg px-3 py-2">
                            <label for="newCompanyLogo" class="block mt-2 font-semibold md:col-span-2">Logo:</label>
                            <input type="file" id="newCompanyLogo" name="logo" accept="image/*" class="border p-2 rounded w-full md:col-span-2"/>
                            <div id="logoPreviewContainer" class="col-span-2 hidden">
                                <p class="text-gray-700">Logo actual:</p>
                                <img id="currentLogoPreview" src="" alt="Logo actual" class="h-20 w-auto mt-2 object-contain" />
                            </div>
                            <button type="submit" class="mt-4 md:col-span-2 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Empresa</button>
                            </form>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Empresas Registradas</h4>
                            <div id="companiesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- SECCION DE CLIENTES MODAL -->
                <div id="clientModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold text-gray-800">Maestro de Clientes</h3>
                                <button onclick="hideClientManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                            </div>

                            <div class="mb-6">
                                <h4 class="font-semibold text-gray-700 mb-3">Cliente (Agregar/Editar)</h4>
                                <form id="clientForm" onsubmit="handleClientFormSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="hidden" id="clientId" />
                                
                                <div>
                                    <label for="clientName" class="block text-sm font-medium text-gray-700">Nombre Completo o Raz√≥n Social*</label>
                                    <input type="text" id="clientName" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                                </div>
                                <div>
                                    <label for="clientCode" class="block text-sm font-medium text-gray-700">C√≥digo de Cliente</label>
                                    <input type="text" id="clientCode" class="w-full border rounded-lg px-3 py-2 mt-1 bg-gray-100" readonly>
                                </div>
                                <div>
                                    <label for="clientRTN" class="block text-sm font-medium text-gray-700">RTN</label>
                                    <input type="text" id="clientRTN" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </div>
                                <div>
                                    <label for="clientPhone" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                                    <input type="text" id="clientPhone" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </div>
                                
                                <div>
                                    <label for="clientContactPerson" class="block text-sm font-medium text-gray-700">Persona de Contacto</label>
                                    <input type="text" id="clientContactPerson" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </div>
                                <div>
                                    <label for="clientEmail" class="block text-sm font-medium text-gray-700">Email</label>
                                    <input type="email" id="clientEmail" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </div>

                                <div class="md:col-span-2">
                                    <label for="clientAddress" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                                    <input type="text" id="clientAddress" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </div>

                                <div class="md:col-span-2">
                                    <label for="clientNotes" class="block text-sm font-medium text-gray-700">Notas</label>
                                    <textarea id="clientNotes" rows="3" class="w-full border rounded-lg px-3 py-2 mt-1"></textarea>
                                </div>
                                <hr class="md:col-span-2 my-2"/>

                                <div>
                                    <label for="entityType" class="block text-sm font-medium text-gray-700">Tipo</label>
                                    <select id="entityType" class="w-full border rounded-lg px-3 py-2 mt-1">
                                        <option value="Cliente">Cliente</option>
                                        <option value="Proveedor">Proveedor</option>
                                        <option value="Ambos">Ambos</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="clientGroup" class="block text-sm font-medium text-gray-700">Grupo de Cliente</label>
                                    <input type="text" id="clientGroup" list="clientGroupList" class="w-full border rounded-lg px-3 py-2 mt-1">
                                    <datalist id="clientGroupList"></datalist>
                                </div>
                                <div>
                                    <label for="priceList" class="block text-sm font-medium text-gray-700">Lista de Precios</label>
                                    <input type="text" id="priceList" list="priceLists" class="w-full border rounded-lg px-3 py-2 mt-1">
                                    <datalist id="priceLists"></datalist>
                                </div>
                                
                                <div>
                                    <label for="paymentTerms" class="block text-sm font-medium text-gray-700">Forma de Pago</label>
                                    <input type="text" id="paymentTerms" list="paymentTermsList" placeholder="Ej: Cr√©dito" class="w-full border rounded-lg px-3 py-2 mt-1">
                                    <datalist id="paymentTermsList"></datalist>
                                </div>
                                <div>
                                    <label for="creditDays" class="block text-sm font-medium text-gray-700">D√≠as de Cr√©dito</label>
                                    <input type="number" id="creditDays" placeholder="0" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </div>
                                <div>
                                    <label for="creditLimit" class="block text-sm font-medium text-gray-700">L√≠mite de Cr√©dito (L)</label>
                                    <input type="number" step="0.01" id="creditLimit" placeholder="0.00" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </div>

                                <div class="md:col-span-3 flex items-center gap-3 mt-2">
                                    <input id="clientIsActive" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-custom focus:ring-blue-custom">
                                    <label for="clientIsActive" class="text-sm font-medium text-gray-700">Cliente Activo</label>
                                </div>
                                
                                <button type="submit" class="mt-4 md:col-span-3 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Cliente</button>
                                </form>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-700 mb-3">Clientes Registrados</h4>
                                <div id="clientsList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCION DE USUARIOS MODAL -->
                <div id="userManagerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Gesti√≥n de Usuarios</h3>
                            <button onclick="hideUserManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Usuario (Agregar/Editar)</h4>
                            <form id="userForm" onsubmit="handleUserFormSubmit(event)" class="space-y-4">
                            <input type="hidden" id="userId" />
                            
                            <div>
                                <label for="userNameDisplay" class="block text-sm font-medium text-gray-700">Nombre Usuario*</label>
                                <input type="text" id="userNameDisplay" class="w-full border rounded-lg px-3 py-2 mt-1" required placeholder="Ej: Juan P√©rez">
                            </div>
                            <div>
                                <label for="userEmail" class="block text-sm font-medium text-gray-700">Email*</label>
                                <input type="email" id="userEmail" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                            </div>

                            <div>
                                <label for="userRole" class="block text-sm font-medium text-gray-700">Rol*</label>
                                <select id="userRole" class="w-full border rounded-lg px-3 py-2 mt-1" required></select>
                            </div>
                            <div>
                                <label for="userPassword" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                                <input type="password" id="userPassword" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Dejar en blanco para no cambiar">
                            </div>
                            <div>
                                <label for="userPasswordConfirm" class="block text-sm font-medium text-gray-700">Confirmar Contrase√±a</label>
                                <input type="password" id="userPasswordConfirm" class="w-full border rounded-lg px-3 py-2 mt-1">
                            </div>
                            <div>
                                <label for="userAvatarFile" class="block text-sm font-medium text-gray-700">Avatar</label>
                                <input type="file" id="userAvatarFile" class="w-full border rounded-lg p-2 mt-1">
                            </div>
                            
                            <button type="submit" class="w-full mt-4 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Usuario</button>
                            </form>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Usuarios Registrados</h4>
                            <div id="usersList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- SECCION DE PRODUCTOS/SERVICIOS MODAL -->
                <div id="productManagerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Maestro de Productos</h3>
                            <button onclick="hideProductManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Producto (Agregar/Editar)</h4>
                                <form id="productForm" onsubmit="handleProductFormSubmit(event)" class="space-y-4">
                                    <input type="hidden" id="productId" />
                                    <div>
                                        <label for="productName" class="block text-sm font-medium text-gray-700">Nombre del Producto*</label>
                                        <input type="text" id="productName" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                                    </div>
                                    
                                    <div>
                                        <label for="productDescription" class="block text-sm font-medium text-gray-700">Descripci√≥n del Producto</label>
                                        <textarea id="productDescription" rows="3" class="w-full border rounded-lg px-3 py-2 mt-1"></textarea>
                                    </div>
                                    <div>
                                        <label for="productCode" class="block text-sm font-medium text-gray-700">C√≥digo</label>
                                        <input type="text" id="productCode" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Ej: SERV-01">
                                    </div>
                                    <div>
                                        <label for="productPrice" class="block text-sm font-medium text-gray-700">Precio de Venta (L)*</label>
                                        <input type="number" step="0.01" id="productPrice" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input id="productIsExempt" type="checkbox" class="h-4 w-4 rounded border-gray-300">
                                        <label for="productIsExempt" class="text-sm font-medium text-gray-700">Este producto es Exento de Impuesto (ISV)</label>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Producto</button>
                                </form>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Productos Registrados</h4>
                            <div id="productsList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                        
                        </div>
                    </div>
                </div>

                <!-- SECCION DE AUTORIZACIONES SAR MODAL -->
                <div id="authModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Gesti√≥n de Autorizaciones Fiscales</h3>
                            <button onclick="hideAuthManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                        </div>
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Autorizaci√≥n (Agregar/Editar)</h4>
                            <form id="authForm" onsubmit="handleAuthFormSubmit(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <input type="hidden" id="authId" />
                            <div class="md:col-span-3"><label for="authCompany" class="block text-sm font-medium text-gray-700">Empresa*</label><select id="authCompany" class="w-full border rounded-lg px-3 py-2 mt-1" required></select></div>
                            <div class="md:col-span-2"><label for="authCAI" class="block text-sm font-medium text-gray-700">CAI*</label><input type="text" id="authCAI" placeholder="3BE298-..." class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                            <div><label for="authFechaLimite" class="block text-sm font-medium text-gray-700">Fecha L√≠mite*</label><input type="date" id="authFechaLimite" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                            <div><label for="authRangoInicio" class="block text-sm font-medium text-gray-700">Rango Inicio*</label><input type="number" id="authRangoInicio" placeholder="1" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                            <div><label for="authRangoFin" class="block text-sm font-medium text-gray-700">Rango Fin*</label><input type="number" id="authRangoFin" placeholder="10000" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                            <div><label for="authNumeroActual" class="block text-sm font-medium text-gray-700">N√∫mero Actual*</label><input type="number" id="authNumeroActual" placeholder="1" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                            <div><label for="authCodSucursal" class="block text-sm font-medium text-gray-700">Cod. Sucursal*</label><input type="text" id="authCodSucursal" placeholder="000" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                            <div><label for="authCodPuntoEmision" class="block text-sm font-medium text-gray-700">Cod. Punto Emisi√≥n*</label><input type="text" id="authCodPuntoEmision" placeholder="001" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                            <div><label for="authCodTipoDoc" class="block text-sm font-medium text-gray-700">Cod. Tipo Doc*</label><input type="text" id="authCodTipoDoc" placeholder="01" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                            <div class="md:col-span-3 flex items-center gap-3 mt-2"><input id="authEstaActiva" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-custom focus:ring-blue-custom"><label for="authEstaActiva" class="text-sm font-medium text-gray-700">Marcar como la autorizaci√≥n activa</label></div>
                            <button type="submit" class="mt-4 md:col-span-3 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Autorizaci√≥n</button>
                            </form>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Autorizaciones Registradas</h4>
                            <div id="authList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- SECCION DE CUENTAS DE BANCO MODAL -->
                <div id="bankAccountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">Cuentas Bancarias por Empresa</h3>
                            <button onclick="hideBankAccountManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                        </div>

                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-700 mb-3">Cuenta (Agregar/Editar)</h4>
                            <form id="bankAccountForm" onsubmit="handleBankAccountFormSubmit(event)" class="space-y-4">
                            <input type="hidden" id="accountId" />
                            
                            <div>
                                <label for="accountCompany" class="block text-sm font-medium text-gray-700">Empresa*</label>
                                <select id="accountCompany" class="w-full border rounded-lg px-3 py-2 mt-1" required></select>
                            </div>
                            <div>
                                <label for="accountBankName" class="block text-sm font-medium text-gray-700">Nombre del Banco*</label>
                                <input type="text" id="accountBankName" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                            </div>
                            <div>
                                <label for="accountName" class="block text-sm font-medium text-gray-700">Nombre de la Cuenta*</label>
                                <input type="text" id="accountName" placeholder="Ej: Cuenta Principal" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                            </div>
                            <div>
                                <label for="accountNumber" class="block text-sm font-medium text-gray-700">N√∫mero de Cuenta*</label>
                                <input type="text" id="accountNumber" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                            </div>
                            <div>
                                <label for="accountType" class="block text-sm font-medium text-gray-700">Tipo de Cuenta*</label>
                                <select id="accountType" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                                    <option value="Cheques">Cheques</option>
                                    <option value="Ahorros">Ahorros</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="w-full mt-4 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Cuenta</button>
                            </form>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">Cuentas Registradas</h4>
                            <div id="bankAccountsList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                        </div>
                    </div>
                </div>

                <!-- ================================================= -->
                <!-- =           MODAL: MI PERFIL (Simplificado)     = -->
                <!-- ================================================= -->
                <div id="myProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg p-6 w-full max-w-md shadow-2xl">
                            
                            <!-- Encabezado -->
                            <div class="flex justify-between items-center mb-6 border-b pb-2">
                                <h3 class="text-xl font-bold text-gray-800">üë§ Editar Mi Perfil</h3>
                                <button onclick="document.getElementById('myProfileModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
                            </div>

                            <!-- Formulario -->
                            <form onsubmit="updateMyProfile(event)" class="space-y-5">
                                
                                <!-- Vista previa de la foto -->
                                <div class="text-center">
                                    <img id="profilePreview" src="" class="w-24 h-24 rounded-full mx-auto object-cover border-4 border-gray-100 shadow-sm mb-2">
                                    <p class="text-xs text-gray-400">Foto actual</p>
                                </div>

                                <!-- Campo Nombre -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Tu Nombre</label>
                                    <input type="text" id="profileName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 outline-none" required>
                                </div>

                                <!-- Campo Foto -->
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-1">Cambiar Foto</label>
                                    <input type="file" id="profileAvatar" accept="image/*" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 transition-colors">
                                </div>

                                <!-- Bot√≥n Guardar -->
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-bold shadow-md transition-all transform hover:scale-[1.02]">
                                    Guardar Cambios
                                </button>

                            </form>
                        </div>
                    </div>
                </div>

                <!-- =================================================== -->
                <!-- =              MODAL: REGISTRAR ABONO             = -->
                <!-- =================================================== -->
                <div id="paymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 no-print">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden">
                        <div class="bg-green-600 p-4 flex justify-between items-center text-white">
                            <h3 class="text-lg font-bold">üí∏ Registrar Abono</h3>
                            <button onclick="closePaymentModal()" class="hover:text-gray-200 font-bold text-xl">√ó</button>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <input type="hidden" id="payDocId">
                            
                            <!-- Resumen -->
                            <div class="bg-gray-50 p-3 rounded-lg space-y-1 text-sm border border-gray-200">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Documento:</span>
                                    <span id="payDocNumber" class="font-bold text-gray-800">...</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total Original:</span>
                                    <span id="payDocTotal" class="font-bold text-gray-800">L 0.00</span>
                                </div>
                                <div class="flex justify-between border-t pt-1 mt-1">
                                    <span class="text-gray-700 font-bold">Saldo Pendiente:</span>
                                    <span id="payDocBalance" class="font-bold text-red-600 text-lg">L 0.00</span>
                                </div>
                            </div>

                            <!-- Formulario -->
                            <form onsubmit="processPayment(event)" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Monto a Abonar (L)*</label>
                                    <input type="number" step="0.01" id="paymentAmount" class="w-full border rounded-lg px-3 py-2 mt-1 text-lg font-semibold text-green-700 focus:ring-2 focus:ring-green-500 outline-none" required min="0.01">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Fecha del Pago</label>
                                    <input type="date" id="paymentDate" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">M√©todo de Pago</label>
                                    <select id="paymentMethodModal" class="w-full border rounded-lg px-3 py-2 mt-1">
                                        <option value="Efectivo">Efectivo</option>
                                        <option value="Transferencia">Transferencia</option>
                                        <option value="Cheque">Cheque</option>
                                    </select>
                                </div>
                                
                                <div class="flex gap-2 pt-2">
                                    <button type="button" onclick="closePaymentModal()" class="w-1/2 bg-gray-200 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-300">Cancelar</button>
                                    <button type="submit" class="w-1/2 bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 shadow-md">Confirmar Pago</button>
                                </div>
                            </form>

                            <div class="mt-6 border-t pt-4">
                                <h4 class="text-sm font-bold text-gray-700 mb-2">üìú Historial de Pagos</h4>
                                <div class="overflow-y-auto max-h-32 border rounded-lg bg-gray-50">
                                    <table class="w-full text-sm text-left">
                                        <thead class="bg-gray-100 text-xs text-gray-500 uppercase sticky top-0">
                                            <tr>
                                                <th class="px-3 py-2">Fecha</th>
                                                <th class="px-3 py-2">M√©todo</th>
                                                <th class="px-3 py-2 text-right">Monto</th>
                                            </tr>
                                        </thead>
                                        <tbody id="paymentHistoryList" class="divide-y divide-gray-200">
                                            <!-- Aqu√≠ se llenar√° con JavaScript -->
                                            <tr><td colspan="3" class="p-3 text-center text-gray-400">Cargando...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =================================================== -->
                <!-- =       INICIO SECCI√ìN REPORTE DE ABONOS          = -->
                <!-- =================================================== -->
                <div id="paymentReportSection" class="hidden p-4 md:p-6 lg:p-8 space-y-6 max-w-7xl mx-auto">
                    
                    <!-- Filtros -->
                    <div class="bg-white p-6 rounded-lg shadow-lg no-print">
                        <div class="flex flex-wrap justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">Reporte de Ingresos (Abonos Recibidos)</h2>
                            <!--<button onclick="showSection('reportsSection')" class="text-sm text-gray-500 hover:text-gray-700">‚Üê Volver</button> -->
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Mes</label>
                                <input type="month" id="paymentReportMonth" class="w-full border rounded-lg px-3 py-2 mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Empresa</label>
                                <select id="paymentReportCompany" class="w-full border rounded-lg px-3 py-2 mt-1"></select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">M√©todo de Pago</label>
                                <select id="paymentReportMethod" class="w-full border rounded-lg px-3 py-2 mt-1">
                                    <option value="all">Todos</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Cheque">Cheque</option>
                                </select>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="generatePaymentReport()" class="flex-1 bg-blue-custom text-white py-2 rounded-lg font-semibold hover:bg-blue-600">Generar</button>
                                <button onclick="exportPaymentsToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700">Excel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500 shadow-sm">
                            <p class="text-sm text-green-700 font-bold">Total Recaudado</p>
                            <p id="paymentReportTotal" class="text-2xl font-bold text-green-800">L 0.00</p>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-custom shadow-sm">
                            <p class="text-sm text-blue-700 font-bold">Cantidad de Transacciones</p>
                            <p id="paymentReportCount" class="text-2xl font-bold text-blue-800">0</p>
                        </div>
                    </div>

                    <!-- Tabla -->
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">Fecha</th>
                                        <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">Cliente</th>
                                        <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">Documento</th>
                                        <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">M√©todo</th>
                                        <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">Recibido Por</th>
                                        <th class="px-6 py-3 text-right font-medium text-gray-500 uppercase">Monto</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentReportTableBody" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="6" class="p-4 text-center text-gray-500">Seleccione un mes y genere el reporte.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- =================================================== -->
                <!-- =        FIN SECCI√ìN REPORTE DE ABONOS            = -->
                <!-- =================================================== -->

            </div> </main>
    </div> <script>
        function toggleSubmenu(submenuId, button) {
            const submenu = document.getElementById(submenuId);
            const arrow = button.querySelector('.arrow-icon');
            
            if (submenu.classList.contains('open')) {
                submenu.classList.remove('open');
                arrow.classList.remove('rotate');
                button.classList.remove('bg-sidebar-active', 'text-white');
            } else {
                document.querySelectorAll('.submenu').forEach(el => {
                    el.classList.remove('open');
                    const btn = el.previousElementSibling;
                    if(btn) {
                        const arr = btn.querySelector('.arrow-icon');
                        if(arr) arr.classList.remove('rotate');
                        btn.classList.remove('bg-sidebar-active', 'text-white');
                    }
                });
                submenu.classList.add('open');
                arrow.classList.add('rotate');
                button.classList.add('bg-sidebar-active', 'text-white');
            }
        }

        function setActive(link) {
            document.querySelectorAll('nav a').forEach(el => {
                el.classList.remove('bg-sidebar-hover', 'text-white', 'font-medium');
            });
            link.classList.add('bg-sidebar-hover', 'text-white', 'font-medium');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('h-full');
        }

        /* ------------------------------------------------------------- */
        /* INTEGRACI√ìN DE L√ìGICA LOGICAAPP.TXT         */
        /* ------------------------------------------------------------- */
        
        // Configuraci√≥n PocketBase 
        const pb = new PocketBase("https://db-conexion-hn.pockethost.io/");        

        // Variables Globales
        let companies = []; // lista de registros companies (objetos PocketBase)
        let documents = []; // lista de registros documents (objetos PocketBase)
        let currentCompany = null; // Empresa seleccionada para facturas/recibos
        let currentCompanyId = null; // ID de la empresa seleccionada para editar
        let authorizations = []; // lista de registros autorizaciones
        let products = []; // lista de registros products
        let clients = []; // lista de registros clients
        let users = []; // lista de registros users
        let roles = []; //roles de usuarios
        let bankAccounts = []; // lista de registros bank_accounts
        let invoice_items = []; //lista de items de facturas/recibos
        let currentlyDisplayedDocs = []; //variable para exportar los datos de pantalla
        let currentHistoryFilter = 'all'; // Filtro de historial
        let currentHistoryCompany = 'all'; // Empresa seleccionada para el historial
        let currentHistoryDateStart = ''; // Fecha de inicio del rango
        let currentHistoryDateEnd = '';   // Fecha de fin del rango
        let agendaTasks = []; //lista de tareas programadas
        let agendaNote = null; //notas rapidas
        let agendaInitialized = false; // Inicializar agenda
        let currentFilter = 'all'; //Para los filtros de tareas
        let currentTaskSort = 'created_desc'; // Valor por defecto: M√°s Recientes
        let activeNotifications = []; // Notificaciones
        let morosidadSortBy = 'cliente'; // Columna por defecto para ordenar
        let morosidadSortOrder = 'asc';   // Orden por defecto (ascendente)
        let morosidadCompanyFilter = 'all'; // Filtro de empresa para este reporte
        let morosidadReportData = []; // Guardar√° los datos filtrados para la exportaci√≥n
        let paymentReportData = []; // Datos del reporte de abonos
        // Cat√°logos para clientes
        //window.catalogs = { client_groups: [], price_lists: [], payment_terms: [] };

        // --- AUTH & INIT ---
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            document.getElementById('loginError').classList.add('hidden');
            try {
                // --- CAMBIO AQU√ç: A√±adimos 'expand' para traer los datos del rol ---
                await pb.collection('users').authWithPassword(email, password, {
                    expand: 'role.permissions' // <-- Esto es vital para que funcione
                });

                // PASO 1: Cargar todos los datos primero, incluyendo los productos.
                await loadData();
                
                // PASO 2: Ahora que los datos est√°n listos, actualizamos la UI y la mostramos.
                updateUserInfo();
                if (typeof setDefaultDates === 'function') setDefaultDates();
                if (typeof initializeInvoiceForm === 'function') initializeInvoiceForm();

                // 4. Mostrar la app
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                applyPermissions();
                
                // 6. Ir al dashboard (o mantenerse en la secci√≥n si implementas l√≥gica de rutas)
                showSection('dashboard');

            } catch (err) {
                console.error("Login error:", err);
                document.getElementById('loginError').classList.remove('hidden');
            }
        }

        function logout() {
            pb.authStore.clear();
            document.getElementById('appScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('currentUser').textContent = '';
        }

        function updateUserInfo() {
            const user = pb.authStore.model;
            
            // IDs del nuevo men√∫ lateral ERP
            const nameEl = document.getElementById('sidebarUserName');
            const roleEl = document.getElementById('sidebarUserRole');
            const avatarEl = document.getElementById('sidebarUserAvatar');

            if (user) {
                // 1. Actualizar Nombre
                if (nameEl) nameEl.textContent = user.name || user.email;
                
                // 2. Actualizar Rol (o mostrar 'Usuario' si no tiene)
                if (roleEl) roleEl.textContent = user.expand?.role?.name || 'Usuario';
                
                // 3. Actualizar Avatar
                if (avatarEl) {
                    if (user.avatar) {
                        avatarEl.src = pb.files.getURL(user, user.avatar);
                    } else {
                        // Avatar gen√©rico con iniciales si no hay foto
                        const name = user.name || user.email;
                        avatarEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=334155&color=fff`;
                    }
                }
            }
        }

        // --- Inicializaci√≥n y utilidades ---
        document.addEventListener('DOMContentLoaded', function() {
            // Si ya hay sesi√≥n v√°lida en authStore, usarla
            if (pb.authStore.isValid) {
                // Ejecutamos una funci√≥n an√≥nima as√≠ncrona para poder usar 'await'
                (async () => {
                    try {

                        // PASO 1: Refrescamos la sesi√≥n para traer el rol ---
                        await pb.collection('users').authRefresh({
                            expand: 'role'
                        });

                        // PASO 2: Cargar todos los datos primero.
                        await loadData();

                        // PASO 3: Ahora que los datos est√°n, mostramos la app.
                        updateUserInfo();
                        setDefaultDates();
                        initializeInvoiceForm();
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('appScreen').classList.remove('hidden');
                        // Aplicamos los permisos
                        applyPermissions();
                    } catch (err) {
                        console.error("Error al cargar datos en el inicio:", err);
                        logout(); // Si falla la carga, cerramos sesi√≥n para evitar problemas
                    }
                })();
            } else {
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        });        

        //funci√≥n loadData
        async function loadData() {
            try {
                console.log("Cargando todos los datos...");
                
                // 1. Verificaci√≥n de seguridad inicial
                if (!pb.authStore.isValid || !pb.authStore.model) {
                    console.warn("No hay sesi√≥n v√°lida. Redirigiendo al login.");
                    showSection('loginScreen');
                    return;
                }

                // 2. Carga paralela de datos b√°sicos
                const [
                    companiesList,
                    documentsList,
                    authList,
                    productsList,
                    clientsList,
                    invoiceItemsList, // Aseg√∫rate de cargar esto
                    rolesList
                ] = await Promise.all([
                    pb.collection('companies').getFullList({ sort: '-created' }),
                    pb.collection('documents').getFullList({ sort: '-created', expand: 'company' }),
                    pb.collection('autorizaciones_factura').getFullList({ sort: '-created', expand: 'empresa' }),
                    pb.collection('products').getFullList({ sort: 'name' }),
                    pb.collection('clients').getFullList({ sort: 'name' }),
                    pb.collection('invoice_items').getFullList(),
                    pb.collection('roles').getFullList()
                ]);

                // 3. Asignaci√≥n a variables globales
                companies = companiesList || [];
                documents = documentsList || [];
                authorizations = authList || [];
                products = productsList || [];
                clients = clientsList || [];
                invoice_items = invoiceItemsList || [];
                roles = rolesList || [];

                // 4. L√≥gica de Roles (CON PROTECCI√ìN)
                // Usamos '?.' (optional chaining) para que no falle si algo es null
                const userRoleName = pb.authStore.model?.expand?.role?.name;

                if (userRoleName === 'admin') {
                    console.log("Cargando datos de administrador...");
                    const usersList = await pb.collection('users').getFullList({ expand: 'role' });
                    users = usersList || [];
                    
                    const accountsList = await pb.collection('bank_accounts').getFullList({ sort: '-created', expand: 'company' });
                    bankAccounts = accountsList || [];
                    
                    // Cargar TODAS las tareas de agenda para el admin
                    const tasksList = await pb.collection('agenda_tasks').getFullList({ 
                        sort: '-created',
                        expand: 'user,assigned_by' 
                    });
                    agendaTasks = tasksList || [];
                } else {
                    // Cargar SOLO las tareas del operador
                    const tasksList = await pb.collection('agenda_tasks').getFullList({ 
                        filter: `user = "${pb.authStore.model.id}"`, 
                        sort: '-created',
                        expand: 'user,assigned_by'
                    });
                    agendaTasks = tasksList || [];
                }

                // 5. Cargar Notas de Agenda (con manejo de errores)
                try {
                    const note = await pb.collection('agenda_notes').getFirstListItem(`user = "${pb.authStore.model.id}"`);
                    agendaNote = note;
                } catch (err) {
                    // Si no existe nota, la creamos silenciosamente
                    if (pb.authStore.isValid) {
                        agendaNote = await pb.collection('agenda_notes').create({ 
                            user: pb.authStore.model.id, 
                            content: '' 
                        });
                    }
                }
                
                console.log("Datos cargados con √©xito.");

                // 6. Actualizar la interfaz
                updateCompanySelects();
                populateClientSelects();
                updateReports();
                checkAppNotifications(); // Actualizar notificaciones

            } catch (err) {
                console.error("Error cr√≠tico al cargar datos:", err);
                // No mostramos alerta al usuario si es un error de cancelaci√≥n, solo en consola
            }
        }

        // --- NAVEGACI√ìN ---
        /*function showSection(id) {
            // Ocultar modales y secciones
            document.querySelectorAll('.section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id$="Modal"]').forEach(el => el.classList.add('hidden'));
            
            const target = document.getElementById(id);
            if(target) target.classList.remove('hidden');
        }*/

        function showSection(sectionId) {
            // Lista de TODAS las secciones principales de tu aplicaci√≥n
            const sections = [
                'invoiceSection', 
                'receiptSection', 
                'historySection', 
                'reportsSection', 
                'productManagerModal', // Si estos son modales, no deber√≠an estar aqu√≠, pero ajusta seg√∫n tu l√≥gica
                'clientModal',
                'userManagerModal',
                'bankAccountModal',
                'agendaSection',
                'morosidadSection',
                'accountStatementSection',
                'paymentReportSection'
            ];

            // Oculta todas las secciones
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.add('hidden');
                } else {
                    // Este console.log te dir√° si falta alg√∫n ID
                    console.warn(`La secci√≥n con id '${id}' no se encontr√≥.`);
                }
            });

            // Muestra solo la secci√≥n objetivo
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
            } else {
                console.error(`Error: No se pudo mostrar la secci√≥n '${sectionId}' porque no se encontr√≥ en el HTML.`);
            }
        }

        // --- FACTURACI√ìN ---
        function addInvoiceItem() {
            const itemsContainer = document.getElementById('invoiceItems');
            const newItem = document.createElement('div');
            newItem.className = 'invoice-item grid grid-cols-12 gap-2 items-center';

            // Usamos 'productSelected(this)' en el onchange
            newItem.innerHTML = `
                <div class="col-span-5">
                    <select class="description w-full border rounded-lg px-3 py-2" onchange="productSelected(this)">
                        <option value="">Seleccione un producto...</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <input type="number" class="quantity w-full border rounded-lg px-3 py-2" value="1" oninput="calculateTotals()">
                </div>
                <div class="col-span-2">
                    <input type="number" step="0.01" class="price w-full border rounded-lg px-3 py-2" oninput="calculateTotals()">
                </div>
                <div class="col-span-2 flex items-center justify-center gap-2">
                    <input type="checkbox" class="item-is-exempt h-4 w-4" disabled>
                    <label class="text-xs">Exento</label>
                </div>
                <div class="col-span-1">
                    <button type="button" onclick="removeInvoiceItem(this)" class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center">‚úï</button>
                </div>
            `;

            // Poblar el men√∫ desplegable con los productos del maestro
            const productSelect = newItem.querySelector('.description');
            if (products && products.length > 0) {
                products.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.id;
                    option.textContent = `${product.name} (${product.product_code || 'S/C'})`;
                    productSelect.appendChild(option);
                });
            }
            
            itemsContainer.appendChild(newItem);
        }

        function productSelected(selectElement) {
            // 1. Obtiene el ID del producto que seleccionaste.
            const selectedProductId = selectElement.value;
            
            // 2. Busca el producto completo en nuestra lista de productos.
            const product = products.find(p => p.id === selectedProductId);
            
            // 3. Encuentra la fila ('invoice-item') a la que pertenece este men√∫ desplegable.
            const itemRow = selectElement.closest('.invoice-item');
            
            if (product) {
                // 4. Si se encontr√≥ el producto, actualiza los campos de la misma fila.
                itemRow.querySelector('.price').value = product.default_price; // Actualiza el precio
                itemRow.querySelector('.item-is-exempt').checked = product.is_exempt; // Marca si es exento
            } else {
                // Si el usuario selecciona "Seleccione un producto...", limpia los campos.
                itemRow.querySelector('.price').value = '';
                itemRow.querySelector('.item-is-exempt').checked = false;
            }
            
            calculateTotals();
        }        

        /**
         * Elimina una fila de producto de la factura y recalcula los totales.         
         */
        function removeInvoiceItem(button) {
            // 1. Encuentra la fila completa (el div padre con clase 'invoice-item')
            const itemRow = button.closest('.invoice-item');
            
            // 2. Elim√≠nala del HTML
            if (itemRow) {
                itemRow.remove();
            }
            
            // 3. Recalcula los totales (Subtotal, ISV, Total) inmediatamente
            calculateTotals();
        }

        function calculateTotals() {
            let taxableSubtotal = 0;
            let exemptSubtotal = 0;

            document.querySelectorAll('.invoice-item').forEach(itemDiv => {
                const quantity = parseFloat(itemDiv.querySelector('.quantity').value) || 0;
                const price = parseFloat(itemDiv.querySelector('.price').value) || 0;
                const isExempt = itemDiv.querySelector('.item-is-exempt').checked;
                const lineTotal = quantity * price;
                
                if (isExempt) {
                    exemptSubtotal += lineTotal;
                } else {
                    taxableSubtotal += lineTotal;
                }
            });

            const subtotal = taxableSubtotal + exemptSubtotal;
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            
            // Proporcionalmente aplicar el descuento
            const totalBeforeDiscount = subtotal;
            let discountOnTaxable = 0;
            if (totalBeforeDiscount > 0) {
                discountOnTaxable = (taxableSubtotal / totalBeforeDiscount) * discount;
            }
            
            const taxableBase = taxableSubtotal - discountOnTaxable;
            const taxRateSelect = document.getElementById('taxRate');
            const taxRate = taxRateSelect.value === 'exonerado' ? 0 : parseFloat(taxRateSelect.value) || 0;
            const taxAmount = taxableBase * (taxRate / 100);
            const total = subtotal - discount + taxAmount;

            document.getElementById('subtotal').textContent = `L ${formatNumber(subtotal)}`;
            document.getElementById('taxAmount').textContent = `L ${formatNumber(taxAmount)}`;
            document.getElementById('total').textContent = `L ${formatNumber(total)}`;
        }

        // Funci√≥n de numeros
        function numeroALetras(num) {
            const unidades = ['', 'UNO', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE'];
            const decenas = ['', 'DIEZ', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
            const centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];
            const especiales = ['DIEZ', 'ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE', 'DIECIS√âIS', 'DIECISIETE', 'DIECIOCHO', 'DIECINUEVE'];

            const getDecenas = n =>
                n < 10 ? unidades[n] :
                n < 20 ? especiales[n - 10] :
                (decenas[Math.floor(n / 10)]) + (n % 10 ? ' Y ' + unidades[n % 10] : '');

            const getCentenas = n =>
                n > 99 ? (centenas[Math.floor(n / 100)]) + ' ' + (n % 100 ? getDecenas(n % 100) : '') : getDecenas(n);
                
            const getMiles = n =>
                Math.floor(n / 1000) > 1 ? getCentenas(Math.floor(n / 1000)) + ' MIL ' + (n % 1000 ? getCentenas(n % 1000) : '') :
                Math.floor(n / 1000) === 1 ? 'MIL ' + (n % 1000 ? getCentenas(n % 1000) : '') : getCentenas(n);

            const getMillones = n =>
                Math.floor(n / 1000000) > 1 ? getCentenas(Math.floor(n / 1000000)) + ' MILLONES ' + (n % 1000000 ? getMiles(n % 1000000) : '') :
                Math.floor(n / 1000000) === 1 ? 'UN MILLON ' + (n % 1000000 ? getMiles(n % 1000000) : '') : getMiles(n);
            
            let literal = getMillones(Math.floor(num));
            if (Math.floor(num) === 0) literal = "CERO";
            if (Math.floor(num) === 1 && num > 1) literal = "UN"; // Ajuste para "UN LEMPIRA" vs "UNO"
            
            const decimal = Math.round((num - Math.floor(num)) * 100);
            const textoFinal = `${literal} LEMPIRAS ${String(decimal).padStart(2, '0')}/100`;
            
            return textoFinal.trim();
        }

        function handleInvoiceSubmit() {
            const editingId = document.getElementById('editingInvoiceId').value;
            generateInvoice(editingId || null);
        }

        // --- L√ìGICA PRINCIPAL DE FACTURAS ---
        async function generateInvoice(editingId = null) {
            const saveBtn = document.getElementById('saveInvoiceBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';

            // --- RECOLECCI√ìN DE DATOS COM√öN PARA AMBOS CASOS ---
            const invoiceDate = document.getElementById('invoiceDate').value;
            const clientName = document.getElementById('invoiceClientName').value;
            const clientRTN = document.getElementById('invoiceClientRTN').value;
            const clientAddress = document.getElementById('invoiceClientAddress').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const taxRateSelect = document.getElementById('taxRate');
            const taxRateValue = taxRateSelect.value;
            const observations = document.getElementById('observations').value;
            const itemsFromForm = [];
            document.querySelectorAll('.invoice-item').forEach(itemDiv => {
                const quantity = parseFloat(itemDiv.querySelector('.quantity').value);
                const price = parseFloat(itemDiv.querySelector('.price').value);
                const productSelect = itemDiv.querySelector('.description');
                let description = '';
                if (productSelect.value) {
                    description = productSelect.options[productSelect.selectedIndex].text;
                }
                if (quantity && description && price) {
                    itemsFromForm.push({ quantity, description, price });
                }
            });

            // --- L√ìGICA DE VENCIMIENTO ---
            // 1. Encontrar el cliente seleccionado en nuestra lista global
            const clienteSeleccionado = clients.find(c => c.name === clientName);
            
            // 2. Obtener sus d√≠as de cr√©dito (o 0 si no se encuentra o no tiene)
            const creditDays = clienteSeleccionado ? (clienteSeleccionado.credit_days || 0) : 0;
            
            // 3. Calcular la nueva fecha de vencimiento
            // (Aseguramos que la fecha se cree en la zona horaria local)
            const parts = invoiceDate.split('-'); // Formato YYYY-MM-DD
            const emisionDate = new Date(parts[0], parts[1] - 1, parts[2]); // Meses son 0-indexados
            
            emisionDate.setDate(emisionDate.getDate() + creditDays);
            
            // 4. Convertir a un string YYYY-MM-DD para PocketBase
            const newDueDate = emisionDate.toISOString().split('T')[0];
            
            // --- FIN DE LA L√ìGICA ---

            // 1. Separar subtotales en gravables y exentos
            let taxableSubtotal = 0;
            let exemptSubtotal = 0;
            itemsFromForm.forEach(item => {
                // Buscamos el producto completo para saber si es exento
                const product = products.find(p => p.id === item.productId || `${p.name} (${p.product_code || 'S/C'})` === item.description);
                const lineTotal = item.quantity * item.price;
                
                if (product && product.is_exempt) {
                    exemptSubtotal += lineTotal; // Suma a los exentos
                } else {
                    taxableSubtotal += lineTotal; // Suma a los gravables
                }
            });

            const subtotal = itemsFromForm.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;

            // 2. Aplicar el descuento proporcionalmente para calcular el impuesto correctamente
            let discountOnTaxable = 0;
            if (subtotal > 0) {
                discountOnTaxable = (taxableSubtotal / subtotal) * discount;
            }
            
            const taxableBase = taxableSubtotal - discountOnTaxable;
            const taxRateForCalc = (taxRateValue === 'exonerado') ? 0 : parseFloat(taxRateValue) || 0;

            // 3. Calcular el impuesto SOLO sobre la base gravable
            const taxAmount = taxableBase * (taxRateForCalc / 100);
            const total = subtotal - discount + taxAmount;

            try {
                if (editingId) {
                    // --- L√ìGICA PARA ACTUALIZAR UNA FACTURA EXISTENTE ---
                    const invoiceNumber = document.getElementById('invoiceNumber').value; // Usamos el n√∫mero existente

                    const documentData = {
                        // No se toca la autorizaci√≥n ni el contador
                        number: invoiceNumber, // Se mantiene el n√∫mero original
                        type: 'Factura',
                        company: currentCompany.id,
                        date: invoiceDate,
                        due_date: newDueDate,
                        clientName, clientRTN, clientAddress,
                        subtotal, discount_amount: discount, taxRate: taxRateValue,
                        taxAmount, total, paymentMethod, observations,
                        created_by: pb.authStore.model.id,                
                    };
                    
                    // L√≥gica para exonerado
                    if (taxRateValue === 'exonerado') {
                        documentData.orden_compra_exenta = document.getElementById('ordenCompraExenta').value;
                        documentData.constancia_registro_exonerado = document.getElementById('constanciaRegistroExonerado').value;
                        documentData.registro_sag = document.getElementById('registroSAG').value;
                    }

                    // 1. Actualizar los datos principales de la factura
                    await pb.collection('documents').update(editingId, documentData);

                    // 2. Borrar los art√≠culos viejos
                    const oldItems = await pb.collection('invoice_items').getFullList({ filter: `invoice = "${editingId}"` });
                    for (const item of oldItems) {
                        await pb.collection('invoice_items').delete(item.id);
                    }

                    // 3. Crear los art√≠culos nuevos
                    for (const item of itemsFromForm) {
                        await pb.collection('invoice_items').create({
                            invoice: editingId,
                            description: item.description,
                            quantity: item.quantity,
                            price: item.price,
                        });
                    }

                    alert('¬°Factura actualizada con √©xito!');
                    // Buscamos los datos de autorizaci√≥n para pasarlos a la vista previa
                    const originalDoc = documents.find(d => d.id === editingId);
                    const authData = authorizations.find(a => a.id === originalDoc.autorizacion);
                    // Actualizamos la vista previa con los nuevos datos
                    updateInvoicePreview(documentData, itemsFromForm, authData);
                    await loadData();

                } else {
                    // --- L√ìGICA PARA CREAR UNA NUEVA FACTURA (con reintento) ---
                    const createInvoiceRecord = async () => {
                        const activeAuth = authorizations.find(auth => auth.empresa === currentCompany.id && auth.esta_activa);
                        if (!activeAuth) throw new Error("No se encontr√≥ una autorizaci√≥n de facturaci√≥n activa.");

                        const correlativo = String(activeAuth.numero_actual).padStart(8, '0');
                        const invoiceNumber = `${String(activeAuth.cod_sucursal).padStart(3, '0')}-${String(activeAuth.cod_punto_emision).padStart(3, '0')}-${String(activeAuth.cod_tipo_doc).padStart(2, '0')}-${correlativo}`;

                        const documentData = {
                            autorizacion: activeAuth.id,
                            number: invoiceNumber,
                            type: 'Factura',
                            company: currentCompany.id,
                            date: invoiceDate, due_date: newDueDate, clientName, clientRTN, clientAddress,
                            subtotal, discount_amount: discount, taxRate: taxRateValue,
                            taxAmount, total, paymentMethod, observations,
                            created_by: pb.authStore.model.id,
                            balance: total,
                            payment_status: 'Pendiente'
                        };
                        if (taxRateValue === 'exonerado') {
                            documentData.orden_compra_exenta = document.getElementById('ordenCompraExenta').value;
                            documentData.constancia_registro_exonerado = document.getElementById('constanciaRegistroExonerado').value;
                            documentData.registro_sag = document.getElementById('registroSAG').value;
                        }

                        const newInvoice = await pb.collection('documents').create(documentData);
                        for (const item of itemsFromForm) {
                            await pb.collection('invoice_items').create({
                                invoice: newInvoice.id,
                                description: item.description,
                                quantity: item.quantity,
                                price: item.price,
                            });
                        }
                        await pb.collection('autorizaciones_factura').update(activeAuth.id, { 'numero_actual+': 1 });
                        return { documentData, itemsFromForm, activeAuth };
                    };

                    try {
                        const result = await createInvoiceRecord();
                        alert(`¬°Factura ${result.documentData.number} guardada con √©xito!`);
                        updateInvoicePreview(result.documentData, result.itemsFromForm, result.activeAuth);
                        await loadData();
                    } catch (err) {
                        if (err.response?.data?.number?.code === 'validation_not_unique') {
                            console.warn("Colisi√≥n de n√∫mero. Reintentando...");
                            await loadData();
                            const result = await createInvoiceRecord();
                            alert(`¬°Factura ${result.documentData.number} guardada con √©xito! (en el segundo intento)`);
                            updateInvoicePreview(result.documentData, result.itemsFromForm, result.activeAuth);
                            await loadData();
                        } else {
                            throw err; // Lanza el error para que el catch exterior lo maneje
                        }
                    }
                }
            } catch (err) {
                alert('Ocurri√≥ un error al guardar. Revisa los datos e int√©ntalo de nuevo.');
                console.error("Error en generateInvoice:", err);
                saveBtn.disabled = false;
                saveBtn.textContent = editingId ? 'üíæ Guardar Cambios' : 'üíæ Guardar Factura';
            }
        }

        function handleTaxChange() {
            const taxRateSelect = document.getElementById('taxRate');
            const exoneradoFieldsDiv = document.getElementById('exoneradoFields');

            // Si se selecciona "Exonerado", muestra los campos. Si no, oc√∫ltalos.
            if (taxRateSelect.value === 'exonerado') {
                exoneradoFieldsDiv.classList.remove('hidden');
            } else {
                exoneradoFieldsDiv.classList.add('hidden');
            }

            // Llama a la funci√≥n existente para recalcular los totales
            calculateTotals();
        }

        function resetInvoiceForm() {
            document.getElementById('invoiceForm').reset();
            document.getElementById('editingInvoiceId').value = '';
            document.getElementById('invoiceTitle').textContent = 'Nueva Factura';
            document.getElementById('invoiceItems').innerHTML = '';
            document.getElementById('authInfo').classList.add('hidden');
            document.getElementById('exoneradoFields').classList.add('hidden');
            document.getElementById('discountAmount').value = '';
            // Reactiva el bot√≥n de guardar y restaura su texto original
            const saveBtn = document.getElementById('saveInvoiceBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ Guardar Factura';

            addInvoiceItem();
            calculateTotals();
            setDefaultDates();
            document.getElementById('invoicePreview').innerHTML = '<p class="text-gray-500 text-center mt-20">La vista previa aparecer√° aqu√≠</p>';
        }
    
        function updateInvoicePreview(docData, items, authData) {
            const preview = document.getElementById('invoicePreview');
            const company = findCompanyById(docData.company);
            const logoUrl = company && company.logo ? pb.files.getURL(company, company.logo) : '';
            const logoHtml = logoUrl ? `<img src="${logoUrl}" alt="Logo" class="h-48 mb-6 object-contain">` : '';

        // 1. Separar subtotales en gravables y exentos a partir de los art√≠culos ('items')
            let taxableSubtotal = 0;
            let exemptSubtotal = 0;
            items.forEach(item => {
                // Buscamos el producto completo para saber si es exento
                const product = products.find(p => `${p.name} (${p.product_code || 'S/C'})` === item.description);
                const lineTotal = item.quantity * item.price;
                
                if (product && product.is_exempt) {
                    exemptSubtotal += lineTotal; // Suma a los exentos
                } else {
                    taxableSubtotal += lineTotal; // Suma a los gravables
                }
            });

            // 2. Preparar las variables para el desglose de totales de la impresi√≥n
            let importeExonerado = 0;
            // El importe exento ahora es la suma de los art√≠culos marcados como exentos
            let importeExento = exemptSubtotal; 
            let importeGravado15 = 0;
            let importeGravado18 = 0;
            let isv15 = 0;
            let isv18 = 0;

            const taxRateValue = docData.taxRate;

            // Si la factura completa es de tipo "Exonerado", se suma todo en esa l√≠nea
            if (taxRateValue === 'exonerado') {
                importeExonerado = docData.subtotal;
                // Reiniciamos los otros importes porque todo es exonerado
                importeExento = 0; 
            } else if (taxRateValue == '15') {
                // El importe gravado es la suma de los art√≠culos que no son exentos
                importeGravado15 = taxableSubtotal;
                isv15 = docData.taxAmount;
            } else if (taxRateValue == '18') {
                importeGravado18 = taxableSubtotal;
                isv18 = docData.taxAmount;
            }
            // Si la tasa es 0%, 'importeExento' ya tiene el valor correcto de exemptSubtotal, y los dem√°s son 0.

            let formattedRange = 'N/A';
            if (authData) {
                const prefix = `${String(authData.cod_sucursal).padStart(3, '0')}-${String(authData.cod_punto_emision).padStart(3, '0')}-${String(authData.cod_tipo_doc).padStart(2, '0')}-`;
                const start = String(authData.rango_inicio).padStart(8, '0');
                const end = String(authData.rango_fin).padStart(8, '0');
                formattedRange = `${prefix}${start} al ${prefix}${end}`;
            }

            const itemsHtml = items.map(item => `
                <tr>
                    <td class="border px-4 py-2 text-center">${formatNumber(item.quantity)}</td>
                    <td class="border px-4 py-2">${escapeHtml(item.description)}</td>
                    <td class="border px-4 py-2 text-right">L ${formatNumber(item.price)}</td>
                    <td class="border px-4 py-2 text-right">L ${formatNumber(item.quantity * item.price)}</td>
                </tr>`).join('');

            let bankAccountsHtml = '';
            if (company && bankAccounts.length > 0) {
                const companyBankAccounts = bankAccounts.filter(acc => acc.company === company.id);
                if (companyBankAccounts.length > 0) {
                    bankAccountsHtml = `<div class="border-t mt-4 pt-2 text-xs"><h4 class="font-bold mb-1">Cuentas Bancarias para Pagos</h4>${companyBankAccounts.map(acc => `<p><strong>${escapeHtml(acc.bank_name)} (${escapeHtml(acc.account_type)}):</strong> <span>${escapeHtml(acc.account_name)}</span> - <strong>#${escapeHtml(acc.account_number)}</strong></p>`).join('')}</div>`;
                }
            }

            preview.innerHTML = `<div>
                <div class="flex justify-between items-start mb-6">
                    <div>
                        ${logoHtml}
                        <h2 class="text-xl font-bold">${escapeHtml(company ? company.name : 'N/A')}</h2>
                        <p class="text-sm">RTN: ${escapeHtml(company ? company.rtn : 'N/A')}</p>
                        <p class="text-sm">${escapeHtml(company ? company.address : '')}</p>
                        <p class="text-sm">Tel: ${escapeHtml(company ? company.phone : '')}</p>
                        <p class="text-sm">${escapeHtml(company ? company.email : '')}</p>
                    </div>
                    <div class="text-right border-2 border-gray-700 p-2 text-sm">
                        <h1 class="text-2xl font-bold text-blue-custom">FACTURA</h1>
                        <p class="text-lg font-bold"># ${escapeHtml(docData.number)}</p>
                        <p><strong>CAI:</strong> ${escapeHtml(authData ? authData.cai : 'N/A')}</p>
                        <p><strong>Rango Autorizado:</strong> ${escapeHtml(formattedRange)}</p>
                        <p><strong>Fecha L√≠mite de Emisi√≥n:</strong> ${escapeHtml(authData ? new Date(authData.fecha_limite).toLocaleDateString() : 'N/A')}</p>
                    </div>
                </div>
                <hr class="mb-4">
                <div class="mb-4">
                    <h3 class="font-bold">Datos del Cliente:</h3>
                    <p><strong>Fecha:</strong> ${escapeHtml(new Date(docData.date).toLocaleDateString())}</p>
                    <p><strong>Nombre:</strong> ${escapeHtml(docData.clientName)}</p>
                    <p><strong>RTN:</strong> ${escapeHtml(docData.clientRTN)}</p>
                </div>
                <table class="w-full border-collapse mb-4 text-sm">
                    <thead><tr class="bg-gray-100"><th class="border px-4 py-2">Cant.</th><th class="border px-4 py-2">Descripci√≥n</th><th class="border px-4 py-2">Precio Unit.</th><th class="border px-4 py-2">Total</th></tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                
                <div class="flex justify-between items-start mt-4">
                    <div class="w-1/2 pr-4 text-sm">
                        <div class="border-t border-b py-2">
                            <strong>SON:</strong> ${numeroALetras(docData.total)}
                        </div>
                        <div class="mt-2 text-xs">
                            <h4 class="font-bold">Observaciones:</h4>
                            <p>${escapeHtml(docData.observations)}</p>
                        </div>
                    </div>

                    <div class="w-1/2 text-right text-xs">
                        <div class="grid grid-cols-2 gap-1">
                            <span>Importe Exonerado:</span> <span class="font-semibold">L. ${formatNumber(importeExonerado)}</span>
                            <span>Importe Exento:</span> <span class="font-semibold">L. ${formatNumber(importeExento)}</span>
                            <span>Importe Gravado 15%:</span> <span class="font-semibold">L. ${formatNumber(importeGravado15)}</span>
                            <span>Importe Gravado 18%:</span> <span class="font-semibold">L. ${formatNumber(importeGravado18)}</span>
                            <span class="col-span-2 border-t mt-1 pt-1"></span>
                            <span>Sub-Total:</span> <span class="font-semibold">L. ${formatNumber(docData.subtotal)}</span>
                            <span>Descuentos y Rebajas Otorrgados:</span> <span class="font-semibold">L. ${formatNumber(docData.discount_amount || 0)}</span>
                            <span>ISV 15%:</span> <span class="font-semibold">L. ${formatNumber(isv15)}</span>
                            <span>ISV 18%:</span> <span class="font-semibold">L. ${formatNumber(isv18)}</span>
                            <span class="col-span-2 border-t mt-1 pt-1"></span>
                            <span class="font-bold text-lg">TOTAL A PAGAR:</span> <span class="font-bold text-lg">L. ${formatNumber(docData.total)}</span>
                        </div>
                    </div>
                </div>

                <div class="border-t mt-4 pt-2 text-xs">
                    <h4 class="font-bold mb-1">Informaci√≥n de Factura Exonerada</h4>
                    <p><strong>Orden de Compra Exenta:</strong> ${escapeHtml(docData.orden_compra_exenta)}</p>
                    <p><strong>Constancia de Registro Exonerado:</strong> ${escapeHtml(docData.constancia_registro_exonerado)}</p>
                    <p><strong>Registro de la SAG:</strong> ${escapeHtml(docData.registro_sag)}</p>
                </div>

                ${bankAccountsHtml}

                <div class="text-center mt-8"><p class="text-xs">Gracias por su preferencia.</p></div>
            </div>`;
        }

        function initializeInvoiceForm() {
            // Limpia cualquier item que pudiera existir
            document.getElementById('invoiceItems').innerHTML = '';
            // Llama a la funci√≥n para agregar la primera fila, que ya sabe c√≥mo poblar el men√∫ de productos
            addInvoiceItem();
        }

        // --- RECIBOS ---
        // --- L√ìGICA PRINCIPAL DE RECIBOS ---
        function handleReceiptSubmit() {
            const editingId = document.getElementById('editingReceiptId').value;
            generateReceipt(editingId || null);
        }

        //funci√≥n generateReceipt versi√≥n "Inteligente"        
        async function generateReceipt(editingId = null) {
            const saveBtn = document.getElementById('saveReceiptBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';

            // Recolectar datos
            const receiptDate = document.getElementById('receiptDate').value;
            const clientName = document.getElementById('receiptClientName').value;
            const clientPhone = document.getElementById('receiptClientPhone').value;
            const clientAddress = document.getElementById('receiptClientAddress').value;
            const receiptAmount = parseFloat(document.getElementById('receiptAmount').value);
            const paymentMethod = document.getElementById('receiptPaymentMethod').value;
            const receiptConcept = document.getElementById('receiptConcept').value;
            const receiptObservations = document.getElementById('receiptObservations').value;

            // L√≥gica de Vencimiento
            const clienteSeleccionado = clients.find(c => c.name === clientName);
            const creditDays = clienteSeleccionado ? (clienteSeleccionado.credit_days || 0) : 0;
            
            const parts = receiptDate.split('-');
            const emisionDate = new Date(parts[0], parts[1] - 1, parts[2]);
            emisionDate.setDate(emisionDate.getDate() + creditDays);
            const newDueDate = emisionDate.toISOString().split('T')[0];

            try {
                if (editingId) {
                    // --- ACTUALIZAR (Sin cambios de l√≥gica) ---
                    const receiptNumber = document.getElementById('receiptNumber').value;
                    const documentData = {
                        number: receiptNumber,
                        type: 'Recibo',
                        company: currentCompany.id,
                        date: receiptDate, due_date: newDueDate, clientName, clientPhone, clientAddress,
                        amount: receiptAmount, paymentMethod, concept: receiptConcept,
                        observations: receiptObservations,
                        // No tocamos status ni balance al editar
                    };
                    const updatedReceipt = await pb.collection('documents').update(editingId, documentData);
                    alert('¬°Recibo actualizado con √©xito!');
                    updateReceiptPreview(updatedReceipt);
                    await loadData();

                } else {
                    // --- CREAR NUEVO RECIBO (L√≥gica Inteligente) ---
                    
                    // 1. Validar monto
                    if (isNaN(receiptAmount) || receiptAmount <= 0) throw new Error('El monto debe ser un n√∫mero positivo.');

                    // 2. BUCLE DE B√öSQUEDA DE N√öMERO DISPONIBLE
                    // Esto evita colisiones antes de que sucedan
                    let isNumberUnique = false;
                    let finalNumber = null;
                    let freshCompany = null;

                    while (!isNumberUnique) {
                        // a) Obtenemos el contador actual de la DB
                        freshCompany = await pb.collection('companies').getOne(currentCompany.id);
                        let candidateNumber = freshCompany.siguiente_numero_recibo.toString();

                        // b) Preguntamos a PocketBase: "¬øExiste el Recibo #X para la Empresa Y?"
                        // Nota: Filtramos por company Y number
                        const checkExists = await pb.collection('documents').getList(1, 1, {
                            filter: `company = "${currentCompany.id}" && number = "${candidateNumber}" && type = "Recibo"`,
                            fields: 'id' // Solo necesitamos saber si existe
                        });

                        if (checkExists.totalItems > 0) {
                            // c) Si existe, incrementamos el contador de la empresa y probamos de nuevo
                            console.warn(`El recibo #${candidateNumber} ya existe para esta empresa. Buscando el siguiente...`);
                            await pb.collection('companies').update(currentCompany.id, { 'siguiente_numero_recibo+': 1 });
                        } else {
                            // d) Si no existe, ¬°es v√°lido!
                            finalNumber = candidateNumber;
                            isNumberUnique = true;
                        }
                    }

                    // 3. Crear el documento con el n√∫mero validado
                    const documentData = {
                        number: finalNumber,
                        type: 'Recibo',
                        company: currentCompany.id,
                        date: receiptDate, due_date: newDueDate, clientName, clientPhone, clientAddress,
                        amount: receiptAmount, paymentMethod, concept: receiptConcept,
                        observations: receiptObservations,
                        created_by: pb.authStore.model.id,
                        payment_status: 'Pendiente',
                        balance: receiptAmount
                    };

                    const newDoc = await pb.collection('documents').create(documentData);
                    
                    // 4. Actualizar contador final
                    await pb.collection('companies').update(currentCompany.id, { 'siguiente_numero_recibo+': 1 });

                    alert(`¬°Recibo #${newDoc.number} guardado con √©xito!`);
                    updateReceiptPreview(newDoc);
                    await loadData();
                }
            } catch (err) {
                alert('Ocurri√≥ un error al guardar: ' + err.message);
                console.error("Error detallado:", err);
                saveBtn.disabled = false;
                saveBtn.textContent = editingId ? 'üíæ Guardar Cambios' : 'üíæ Guardar Recibo';
            }
        }

        function resetReceiptForm() {
            document.getElementById('receiptForm').reset();
            document.getElementById('editingReceiptId').value = '';
            document.getElementById('receiptTitle').textContent = 'Nuevo Recibo';
            // Reactiva el bot√≥n de guardar y restaura su texto original
            const saveBtn = document.getElementById('saveReceiptBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ Guardar Recibo';
            setDefaultDates();
            document.getElementById('receiptPreview').innerHTML = '<p class="text-gray-500 text-center mt-20">La vista previa aparecer√° aqu√≠</p>';
        }

        function updateReceiptPreview(docData) {
            const preview = document.getElementById('receiptPreview');
            const company = findCompanyById(docData.company);
            const logoUrl = company && company.logo ? pb.files.getURL(company, company.logo) : '';
            const logoHtml = logoUrl ? `<img src="${logoUrl}" alt="Logo" class="h-40 mb-6 object-contain">` : '';

            let bankAccountsHtml = '';
            if (company && bankAccounts.length > 0) {
                const companyBankAccounts = bankAccounts.filter(acc => acc.company === company.id);
                if (companyBankAccounts.length > 0) {
                    bankAccountsHtml = `<div class="border-t mt-4 pt-2 text-xs"><h4 class="font-bold mb-1">Cuentas Bancarias para Pagos</h4>${companyBankAccounts.map(acc => `<p><strong>${escapeHtml(acc.bank_name)} (${escapeHtml(acc.account_type)}):</strong> <span>${escapeHtml(acc.account_name)}</span> - <strong>#${escapeHtml(acc.account_number)}</strong></p>`).join('')}</div>`;
                }
            }

            preview.innerHTML = `<div>
                <div class="flex justify-between items-start mb-6">
                    <div>${logoHtml}<h2 class="text-xl font-bold">${escapeHtml(company ? company.name : 'N/A')}</h2>
                    <p class="text-sm">RTN: ${escapeHtml(company ? company.rtn : 'N/A')}</p>
                    <p class="text-sm">Tel√©fono: ${escapeHtml(company ? company.phone : 'N/A')}</p>
                    <p class="text-sm">Email: ${escapeHtml(company ? company.email : 'N/A')}</p></div>
                    <div class="text-right"><h1 class="text-2xl font-bold text-orange-custom">RECIBO</h1>
                    <p class="text-lg"># ${escapeHtml(docData.number)}</p><p>Fecha: ${escapeHtml(docData.date)}</p></div>
                </div><hr class="mb-4"><div class="mb-4 text-sm">
                <p>Recibido de: <span class="font-bold">${escapeHtml(docData.clientName)}</span></p>
                <p>Por la cantidad de: <span class="font-bold">L ${formatNumber(docData.amount)}</span></p>
                <p>Concepto: <span class="font-bold">${escapeHtml(docData.concept)}</span></p></div>
                <hr class="my-4"><div class="text-sm"><p>M√©todo de Pago: ${escapeHtml(docData.paymentMethod)}</p></div>
                
                <div class="mt-8 text-left text-xs">
                    <p><span class="font-bold">Observaciones:</span> ${escapeHtml(docData.observations)}</p>
                </div>
                <div class="text-center mt-16">
                    <p>_________________________</p>
                    <p class="text-sm">Firma y Sello</p>
                </div>
                    ${bankAccountsHtml}
                </div>`;
        }

        function updateReceiptCompanyData() {
            const select = document.getElementById('receiptCompanySelect');
            const companyId = select.value;
            currentCompany = findCompanyById(companyId);
            
            const receiptNumberInput = document.getElementById('receiptNumber');

            if (currentCompany) {
                // Verifica si el campo del contador existe y es un n√∫mero
                if (typeof currentCompany.siguiente_numero_recibo === 'number') {
                    receiptNumberInput.value = currentCompany.siguiente_numero_recibo;
                } else {
                    // Si el campo no existe o es nulo, avisa al usuario
                    receiptNumberInput.value = '';
                    alert('Esta empresa no tiene configurado un contador de recibos. Por favor, edite la empresa y guarde para iniciar el contador en 1.');
                }
            } else {
                receiptNumberInput.value = '';
            }
        }

        // --- HISTORIAL Y EDICI√ìN ---
        function loadHistory() {
            const historyList = document.getElementById('historyList');
            if (!historyList) return;

            // 1. Empieza con la lista completa de documentos.
            let filteredDocs = documents;

            // 2. Aplica el filtro por rango de fechas
            if (currentHistoryDateStart || currentHistoryDateEnd) {
                filteredDocs = filteredDocs.filter(doc => {
                    const docDate = doc.date.substring(0, 10); // Extrae solo la parte 'YYYY-MM-DD'
                    
                    // Si hay fecha de inicio y la del documento es anterior, se descarta.
                    if (currentHistoryDateStart && docDate < currentHistoryDateStart) {
                        return false;
                    }
                    // Si hay fecha de fin y la del documento es posterior, se descarta.
                    if (currentHistoryDateEnd && docDate > currentHistoryDateEnd) {
                        return false;
                    }
                    return true;
                });
            }

            // 3. Aplica el filtro por tipo (Factura, Recibo, Todos).
            if (currentHistoryFilter !== 'all') {
                filteredDocs = filteredDocs.filter(doc => doc.type?.toLowerCase() === currentHistoryFilter);
            }

            // 4. Aplica el filtro por empresa.
            if (currentHistoryCompany !== 'all') {
                filteredDocs = filteredDocs.filter(doc => doc.company === currentHistoryCompany);
            }

            // --- ‚ñº‚ñº‚ñº NUEVO BLOQUE DE ORDENAMIENTO ‚ñº‚ñº‚ñº ---
            // Ordenamos: Primero por FECHA (Descendente), luego por CREACI√ìN (Descendente)
            filteredDocs.sort((a, b) => {
                // 1. Comparar fechas de emisi√≥n
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA > dateB) return -1; // a va antes (m√°s nuevo)
                if (dateA < dateB) return 1;  // b va antes (m√°s nuevo)

                // 2. Si es la misma fecha, desempatar por fecha de creaci√≥n (o n√∫mero)
                // Usamos created para asegurar que lo √∫ltimo que registraste salga arriba
                if (a.created > b.created) return -1;
                if (a.created < b.created) return 1;
                
                return 0;
            });
            // --- ‚ñ≤‚ñ≤‚ñ≤ FIN DEL BLOQUE ‚ñ≤‚ñ≤‚ñ≤ ---
            
            // 5. Guarda la lista ya filtrada en la variable global.
            currentlyDisplayedDocs = filteredDocs;

            // 6. Muestra los resultados en la pantalla.
            historyList.innerHTML = '';
            if (currentlyDisplayedDocs.length === 0) {
                historyList.innerHTML = '<p class="text-center text-gray-500">No hay documentos que coincidan con los filtros.</p>';
                return;
            }

            currentlyDisplayedDocs.forEach(doc => {
                const docDiv = document.createElement('div');
                // Usa 'items-start' para alinear todo en la parte superior
                docDiv.className = 'flex justify-between items-start bg-gray-100 p-3 rounded-lg shadow-sm';
                
                const companyName = doc.expand?.company?.name || 'N/A';
                const total = doc.total || doc.amount || 0;
                const docColor = (doc.type?.toLowerCase() === 'factura') ? 'text-blue-custom' : 'text-orange-custom';

                docDiv.innerHTML = `
                    <div class="flex-grow pr-4">
                        <p class="font-bold ${docColor}">${escapeHtml(doc.type)} #${escapeHtml(doc.number)}</p>
                        <p class="text-sm text-gray-600">Cliente: ${escapeHtml(doc.clientName)}</p>
                        <p class="text-xs text-gray-500">Emitido por: ${escapeHtml(companyName)}</p>
                    </div>

                    <div class="flex flex-col items-end w-40 flex-shrink-0">
                        <p class="font-bold text-lg">L ${formatNumber(total)}</p>
                        <p class="text-xs text-gray-500">${new Date(doc.date).toLocaleDateString()}</p>
                        <div class="flex gap-2 mt-1">
                            <button onclick="editDocument('${doc.id}')" class="text-sm bg-blue-500 text-white px-3 py-1 rounded">Editar</button>
                            <button onclick="printDocument('${doc.id}')" class="text-sm bg-gray-500 text-white px-3 py-1 rounded">Imprimir</button>
                        </div>
                    </div>
                `;
                historyList.appendChild(docDiv);
            });
        }

        //FUNCIONES DE FILTRO DE FECHA
        function filterHistoryByDate() {
            // 1. Lee los valores de ambos campos de fecha.
            currentHistoryDateStart = document.getElementById('historyDateStart').value;
            currentHistoryDateEnd = document.getElementById('historyDateEnd').value;
            
            // 2. Llama a loadHistory() para redibujar la lista con el rango.
            loadHistory();
        }

        function clearDateFilter() {
            // 1. Limpia las variables globales del rango.
            currentHistoryDateStart = '';
            currentHistoryDateEnd = '';
            
            // 2. Limpia los valores de los campos en el HTML.
            document.getElementById('historyDateStart').value = '';
            document.getElementById('historyDateEnd').value = '';
            
            // 3. Llama a loadHistory() para mostrar todos los registros de nuevo.
            loadHistory();
        }

        // --- L√ìGICA DE FILTRO PARA EL HISTORIAL---
        function filterHistory(type) {
            currentHistoryFilter = type;
            const filterButtons = document.querySelectorAll('#historyTypeFilter button');
            filterButtons.forEach(btn => {
                if (btn.getAttribute('onclick').includes(`'${type}'`)) {
                    btn.classList.add('bg-blue-custom', 'text-white');
                    btn.classList.remove('bg-gray-200');
                } else {
                    btn.classList.remove('bg-blue-custom', 'text-white');
                    btn.classList.add('bg-gray-200');
                }
            });
            loadHistory();
        }

        function filterHistoryByCompany(companyId) {
            // Actualiza la variable global con la empresa seleccionada.
            currentHistoryCompany = companyId;
            
            // Llama a loadHistory() para que vuelva a dibujar la lista con el nuevo filtro.
            loadHistory();
        }

        // --- EDICION DE DOCUMENTOS --- 
        async function editDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) {
                alert('Documento no encontrado.');
                return;
            }

            // --- INICIO DEL BLOQUE DE DIAGN√ìSTICO ---
            console.log("--- Diagn√≥stico de EditDocument ---");
            console.log("1. Valor original de doc.type:", `'${doc.type}'`);
            
            // 1. Usamos el tipo original, sin convertirlo a min√∫sculas
            const docType = doc.type ? doc.type.trim() : ''; 
            console.log("2. Valor despu√©s de trim() y toLowerCase():", `'${docType}'`);

            console.log("3. Comparando con 'Factura'. ¬øSon iguales?:", docType === 'Factura');
            console.log("4. Comparando con 'Recibo'. ¬øSon iguales?:", docType === 'Recibo');
            console.log("--- Fin del Diagn√≥stico ---");
            // --- FIN DEL BLOQUE DE DIAGN√ìSTICO ---

            if (docType === 'Factura') {
                try {
                    const auth = authorizations.find(a => a.id === doc.autorizacion);
                    const items = await pb.collection('invoice_items').getFullList({ filter: `invoice = "${doc.id}"`, sort: 'created' });
                    populateInvoiceForm(doc, items, auth);
                } catch (err) {
                    console.error("Error al buscar los art√≠culos:", err);
                    alert("No se pudieron cargar los art√≠culos de esta factura.");
                }
            } else if (docType === 'Recibo') {
                populateReceiptForm(doc);
            } else {
                alert(`No se puede editar este tipo de documento: '${doc.type}'`);
            }
        }

        function populateInvoiceForm(doc, items, authData) {
            // 1. Limpia y resetea el formulario a su estado inicial.
            // Esto tambi√©n se encarga de reactivar el bot√≥n de "Guardar".
            resetInvoiceForm();

            // 2. Establece el modo "Edici√≥n"
            document.getElementById('editingInvoiceId').value = doc.id;
            document.getElementById('invoiceTitle').textContent = `Editando Factura #${doc.number}`;

            // 3. Rellena los campos principales de la factura
            document.getElementById('companySelect').value = doc.company;
            updateCompanyData(); // Actualiza la compa√±√≠a actual y busca la autorizaci√≥n
            document.getElementById('invoiceNumber').value = doc.number;
            document.getElementById('invoiceDate').value = doc.date.split(' ')[0]; // Formatea la fecha
            document.getElementById('clientName').value = doc.clientName;
            document.getElementById('clientRTN').value = doc.clientRTN;
            document.getElementById('clientAddress').value = doc.clientAddress;
            document.getElementById('paymentMethod').value = doc.paymentMethod;
            document.getElementById('taxRate').value = doc.taxRate;
            document.getElementById('observations').value = doc.observations;
            document.getElementById('discountAmount').value = doc.discount_amount || 0;
            
            // 4. Muestra y rellena los campos de exoneraci√≥n si existen
            if (doc.taxRate === 'exonerado') {
                document.getElementById('exoneradoFields').classList.remove('hidden');
                document.getElementById('ordenCompraExenta').value = doc.orden_compra_exenta || '';
                document.getElementById('constanciaRegistroExonerado').value = doc.constancia_registro_exonerado || '';
                document.getElementById('registroSAG').value = doc.registro_sag || '';
            }

            // 5. Reconstruye din√°micamente la lista de art√≠culos
            const itemsContainer = document.getElementById('invoiceItems');
            itemsContainer.innerHTML = ''; // Limpia el contenedor
            items.forEach(item => {
                addInvoiceItem(); // Crea una nueva fila con el men√∫ de productos poblado
                const lastItemRow = itemsContainer.lastElementChild; // Obtiene la fila que acabamos de crear
                
                // Selecciona el producto correcto en el men√∫ desplegable
                const productSelect = lastItemRow.querySelector('.description');
                const foundProduct = Array.from(productSelect.options).find(opt => opt.text === item.description);
                if (foundProduct) {
                    productSelect.value = foundProduct.value;
                }

                // Rellena la cantidad y el precio
                lastItemRow.querySelector('.quantity').value = item.quantity;
                lastItemRow.querySelector('.price').value = item.price;
            });

            // 6. Actualiza el estado del bot√≥n a "Guardar Cambios"
            const saveBtn = document.getElementById('saveInvoiceBtn');
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ Guardar Cambios';

            // 7. Actualiza los c√°lculos y la vista previa
            calculateTotals();
            updateInvoicePreview(doc, items, authData);
            showSection('invoiceSection');
            window.scrollTo(0, 0); // Desplaza la vista hacia arriba
        }

        function populateReceiptForm(doc) {
            resetReceiptForm(); // Limpia y reactiva el bot√≥n
            
            document.getElementById('editingReceiptId').value = doc.id;
            document.getElementById('receiptTitle').textContent = `Editando Recibo #${doc.number}`;
            
            // Rellena los campos
            document.getElementById('receiptCompanySelect').value = doc.company;
            updateReceiptCompanyData(); // Actualiza la compa√±√≠a y el n√∫mero
            document.getElementById('receiptNumber').value = doc.number;
            document.getElementById('receiptDate').value = doc.date.split(' ')[0];
            document.getElementById('receiptClientName').value = doc.clientName;
            document.getElementById('receiptClientPhone').value = doc.clientPhone || '';
            document.getElementById('receiptClientAddress').value = doc.clientAddress || '';
            document.getElementById('receiptAmount').value = doc.amount;
            document.getElementById('receiptPaymentMethod').value = doc.paymentMethod;
            document.getElementById('receiptConcept').value = doc.concept || '';
            document.getElementById('receiptObservations').value = doc.observations || '';
            
            // Cambia el texto del bot√≥n a "Guardar Cambios"
            document.getElementById('saveReceiptBtn').textContent = 'üíæ Guardar Cambios';

            updateReceiptPreview(doc);
            showSection('receiptSection');
            window.scrollTo(0, 0);
        }


        // --- UTILIDADES ---
        /**
         * Formatea un n√∫mero con comas para miles y 2 decimales.
         * @param {number} number - El n√∫mero a formatear.
         */
        function formatNumber(number) {
            const numericValue = parseFloat(number) || 0;
            
            // 'es-HN' (Espa√±ol de Honduras) usa coma como separador de miles y punto como decimal.
            // Ej: 1,234.56
            return numericValue.toLocaleString('es-HN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        async function updateCompanyData() {
            const select = document.getElementById('companySelect');
            const companyId = select.value;
            currentCompany = findCompanyById(companyId);

            const invoiceNumberInput = document.getElementById('invoiceNumber');
            const authInfoDiv = document.getElementById('authInfo');

            // Limpiar campos antes de buscar
            invoiceNumberInput.value = '';
            authInfoDiv.classList.add('hidden');

            if (!companyId) {
                return; // No hacer nada si no hay empresa seleccionada
            }

            // Buscar la autorizaci√≥n activa para la empresa seleccionada
            const activeAuth = authorizations.find(auth => auth.empresa === companyId && auth.esta_activa);

            if (activeAuth) {
                // Validar si la autorizaci√≥n sigue vigente
                const hoy = new Date();
                const fechaLimite = new Date(activeAuth.fecha_limite);

                if (activeAuth.numero_actual > activeAuth.rango_fin) {
                    alert('¬°Atenci√≥n! El rango de facturaci√≥n para esta empresa ha llegado a su fin.');
                    return;
                }
                if (hoy > fechaLimite) {
                    alert('¬°Atenci√≥n! La fecha l√≠mite de emisi√≥n para esta empresa ha expirado.');
                    return;
                }

                // Formatear el n√∫mero de factura
                const sucursal = String(activeAuth.cod_sucursal).padStart(3, '0');
                const puntoEmision = String(activeAuth.cod_punto_emision).padStart(3, '0');
                const tipoDoc = String(activeAuth.cod_tipo_doc).padStart(2, '0');
                const correlativo = String(activeAuth.numero_actual).padStart(8, '0');
                
                const numeroFactura = `${sucursal}-${puntoEmision}-${tipoDoc}-${correlativo}`;
                invoiceNumberInput.value = numeroFactura;

                // Mostrar informaci√≥n de la autorizaci√≥n
                document.getElementById('activeCAI').textContent = activeAuth.cai;
                document.getElementById('activeRange').textContent = `${activeAuth.rango_inicio} - ${activeAuth.rango_fin}`;
                document.getElementById('activeDate').textContent = fechaLimite.toLocaleDateString();
                authInfoDiv.classList.remove('hidden');

            } else {
                alert('No se encontr√≥ una autorizaci√≥n de facturaci√≥n activa para la empresa seleccionada. Por favor, configure una en "Gestionar Autorizaciones".');
            }
        }

        function updateCompanySelects() {
            const invoiceSelect = document.getElementById('companySelect');
            const receiptSelect = document.getElementById('receiptCompanySelect');
            invoiceSelect.innerHTML = '<option value="">Seleccionar empresa...</option>';
            receiptSelect.innerHTML = '<option value="">Seleccionar empresa...</option>';
            companies.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id; option.textContent = c.name;
                invoiceSelect.appendChild(option.cloneNode(true));
                receiptSelect.appendChild(option);
            });
            if (currentCompany) {
                invoiceSelect.value = currentCompany.id;
                receiptSelect.value = currentCompany.id;
            }
        }

        function populateClientSelects() {
            const invoiceSelect = document.getElementById('invoiceClientSelect');
            const receiptSelect = document.getElementById('receiptClientSelect');
            
            // Limpiar selects
            invoiceSelect.innerHTML = '<option value="">-- Seleccionar o escribir un nuevo cliente --</option>';
            receiptSelect.innerHTML = '<option value="">-- Seleccionar o escribir un nuevo cliente --</option>';

            // Poblar con clientes activos
            clients.filter(c => c.is_active).forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (${client.rtn || 'S/RTN'})`;
                invoiceSelect.appendChild(option.cloneNode(true));
                receiptSelect.appendChild(option);
            });
        }
        
        function clientSelected(formType) {
            // 1. Determinar qu√© formulario es (Factura o Recibo)
            const selectId = formType === 'invoice' ? 'invoiceClientSelect' : 'receiptClientSelect';
            const selectElement = document.getElementById(selectId);
            
            if (!selectElement) return;

            const clientId = selectElement.value;
            const selectedClient = clients.find(c => c.id === clientId);

            // Definimos los IDs de los campos seg√∫n el tipo
            const fields = formType === 'invoice' 
                ? ['invoiceClientName', 'invoiceClientRTN', 'invoiceClientAddress']
                : ['receiptClientName', 'receiptClientPhone', 'receiptClientAddress'];

            if (selectedClient) {
                // --- CASO 1: CLIENTE ENCONTRADO (BLOQUEAR) ---
                
                // A. Rellenar datos
                if (formType === 'invoice') {
                    document.getElementById(fields[0]).value = selectedClient.name;
                    document.getElementById(fields[1]).value = selectedClient.rtn || '';
                    document.getElementById(fields[2]).value = selectedClient.address || '';
                } else {
                    document.getElementById(fields[0]).value = selectedClient.name;
                    document.getElementById(fields[1]).value = selectedClient.phone || '';
                    document.getElementById(fields[2]).value = selectedClient.address || '';
                }

                // B. Bloquear campos y ponerlos grises
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.setAttribute('readonly', true); // Bloquea la escritura
                        el.classList.add('bg-gray-100', 'cursor-not-allowed'); // Visualmente bloqueado
                    }
                });

            } else {
                // --- CASO 2: DESELECCIONAR / NUEVO (DESBLOQUEAR) ---
                
                // A. Limpiar datos
                fields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.value = ''; // Limpia el texto
                        el.removeAttribute('readonly'); // Permite escribir de nuevo
                        el.classList.remove('bg-gray-100', 'cursor-not-allowed'); // Vuelve al color blanco
                    }
                });
            }
        }  

        // --- AGENDA & NOTIFICACIONES ---
        /**
         * Revisa todas las tareas y actualiza la lista de notificaciones activas.
         * - Operadores: Ven solo sus tareas vencidas.
         * - Admins: Ven sus tareas vencidas + las tareas de todos los operadores.
         * (Los Admins NO ven las tareas de otros Admins).
         */
        function checkAppNotifications() {
            activeNotifications = []; // Limpia la lista
            const today = new Date().setHours(0, 0, 0, 0); // Timestamp de hoy a medianoche

            // 1. Obtenemos el modelo del usuario de forma segura
            const user = pb.authStore.model;
            if (!user) return; // Si no hay usuario logueado, salimos
            
            const myId = pb.authStore.model.id;
            const isAdmin = user.expand?.role?.name === 'admin';

            let tasksToScan;

            if (isAdmin) {
                // --- L√ìGICA DE FILTRO PARA ADMIN ---
                // El admin tiene 'agendaTasks' (global) y la lista 'users' (global).
                tasksToScan = agendaTasks.filter(task => {
                    const taskOwnerId = task.user;
                    
                    // 1. Incluir si la tarea es M√çA
                    if (taskOwnerId === myId) {
                        return true;
                    }
                    
                    // 2. Revisar el rol del due√±o de la tarea
                    const taskOwner = users.find(u => u.id === taskOwnerId);
                    
                    // 3. Incluir si el due√±o es un 'operador'
                    if (taskOwner && taskOwner.expand.role.name === 'operador') {
                        return true;
                    }
                    
                    // 4. Excluir. (Si llega aqu√≠, es una tarea de OTRO admin)
                    return false;
                });
                
            } else {
                // --- L√ìGICA DE FILTRO PARA OPERADOR ---
                // El operador solo tiene sus propias tareas en 'agendaTasks'. No necesita filtro.
                tasksToScan = agendaTasks;
            }

            // --- REVISI√ìN DE TAREAS (L√≥gica sin cambios) ---
            // Ahora 'tasksToScan' es la lista correcta para este usuario.
            tasksToScan.forEach(task => {
                const isPending = task.status !== 'Completada';
                
                if (isPending && task.due_date) {
                    const taskDueDate = new Date(task.due_date).setHours(0, 0, 0, 0);
                    
                    // Si la tarea venci√≥ (es de ayer o antes) O vence hoy
                    if (taskDueDate <= today) {
                        activeNotifications.push(task);
                    }
                }
            });
            
            // Ordena por fecha (m√°s vencidas primero)
            activeNotifications.sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
            
            // Actualiza la interfaz visual
            renderNotifications();
        }

        
        function toggleNotificationPanel() {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('hidden');
        }

        /**
         * Dibuja las notificaciones en el panel y actualiza el contador.
         * Muestra a qu√© operador pertenece la tarea si el usuario es Admin.
         */
        function renderNotifications() {
            const list = document.getElementById('notification-list');
            const badge = document.getElementById('notification-count-badge');
            
            // 1. Verificaci√≥n de seguridad del usuario
            const user = pb.authStore.model;
            if (!user) return; // Si no hay usuario, no hacemos nada

            const myId = user.id;
                
            // Usamos '?. (Optional Chaining)' para leer el rol de forma segura
            const isAdmin = user.expand?.role?.name === 'admin';    
            
            if (activeNotifications.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 p-4">No tienes notificaciones nuevas.</p>';
                badge.classList.add('hidden');
                badge.textContent = '0';
            } else {
                list.innerHTML = ''; // Limpia la lista
                badge.textContent = activeNotifications.length;
                badge.classList.remove('hidden');

                activeNotifications.forEach(task => {
                    const li = document.createElement('a');
                    li.href = "#";
                    li.className = "block p-3 hover:bg-gray-100";
                    
                    li.onclick = (e) => {
                        e.preventDefault();
                        showAgenda();
                        toggleNotificationPanel();
                    };

                    const isOverdue = new Date(task.due_date).setHours(0,0,0,0) < new Date().setHours(0,0,0,0);
                    const dateText = isOverdue ? 'Venci√≥' : 'Vence hoy';

                    let userNameHtml = '';
                    // Si soy Admin Y la tarea NO es m√≠a, muestra el nombre del operador
                    if (isAdmin && task.user !== myId) {
                        const userName = task.expand?.user?.name || 'Usuario Desconocido';
                        userNameHtml = `<div class="text-xs font-semibold text-blue-custom">Para: ${escapeHtml(userName)}</div>`;
                    }

                    li.innerHTML = `
                        <div class="font-semibold text-sm text-gray-800">${escapeHtml(task.title)}</div>
                        ${userNameHtml}
                        <div class="text-xs text-gray-600">
                            <span class="font-medium ${isOverdue ? 'text-red-500' : 'text-orange-500'}">${dateText}</span>
                            - ${new Date(task.due_date).toLocaleDateString()}
                        </div>
                    `;
                    list.appendChild(li);
                });
            }
        }
        //--- FINAL DE NOTIFICACIONES ----  

        // --- IMPRESI√ìN ---
        async function printDocument(id) {
            const doc = documents.find(d => d.id === id);
            if (!doc) {
                alert('Documento no encontrado.');
                return;
            }

            // 1. Oculta todas las secciones (para preparar la vista de impresi√≥n)
            showSection(null); 

            try {
                if (doc.type.toLowerCase() === 'factura') {
                    // Prepara la vista previa de la factura
                    const items = await pb.collection('invoice_items').getFullList({ filter: `invoice = "${doc.id}"` });
                    const auth = authorizations.find(a => a.id === doc.autorizacion);
                    updateInvoicePreview(doc, items, auth);
                    
                    // 2. Muestra la secci√≥n de factura y a√±ade la clase de impresi√≥n
                    document.getElementById('invoiceSection').classList.remove('hidden');
                    document.body.classList.add('printing-invoice');
                    
                } else if (doc.type.toLowerCase() === 'recibo') {
                    // Prepara la vista previa del recibo
                    updateReceiptPreview(doc);
                    
                    // 2. Muestra la secci√≥n de recibo y a√±ade la clase de impresi√≥n
                    document.getElementById('receiptSection').classList.remove('hidden');
                    document.body.classList.add('printing-receipt');
                }

                // 3. Llama a la impresi√≥n
                window.print();

            } catch (err) {
                console.error("Error al preparar la impresi√≥n:", err);
                alert("Error al preparar la impresi√≥n. Revisa la consola.");
            } finally {
                // 4. Limpia las clases del body despu√©s de imprimir
                document.body.classList.remove('printing-invoice', 'printing-receipt');
                
                // 5. Vuelve a mostrar el historial (o el dashboard)
                showHistory();
            }
        }

        function printCurrentDocument() {
            let sectionClass = '';

            // Revisa qu√© secci√≥n est√° visible (Factura o Recibo)
            if (!document.getElementById('invoiceSection').classList.contains('hidden')) {
                sectionClass = 'printing-invoice';
            } else if (!document.getElementById('receiptSection').classList.contains('hidden')) {
                sectionClass = 'printing-receipt';
            }

            if (sectionClass) {
                document.body.classList.add(sectionClass);
                window.print();
                document.body.classList.remove(sectionClass);
            } else {
                alert('No hay una factura o recibo activo para imprimir.');
            }
        }

        /**
         * Imprime el √°rea del estado de cuenta.
         */
        function printStatement() {
            // 1. A√±ade la clase de impresi√≥n al <body>
            document.body.classList.add('printing-statement');
            
            // 2. Llama a la impresi√≥n
            window.print();
            
            // 3. Limpia la clase despu√©s de imprimir (o al cerrar la ventana de impresi√≥n)
            document.body.classList.remove('printing-statement');
        }

        // --- MODALES GESTORES (Empresas, Clientes, etc) ---
        //EMPRESAS        
        async function addCompany(formData) {
            try {
                await pb.collection('companies').create(formData);
                alert('¬°Empresa agregada con √©xito!');
                clearForm();
                hideCompanyManager();
                await loadData();
            } catch (err) {
                console.error("Error al agregar empresa:", err);
                alert('Ocurri√≥ un error al agregar la empresa.');
            }
        }

        async function updateCompany(companyId, formData) {
        try {
            await pb.collection('companies').update(companyId, formData);
            alert('¬°Registro de empresa actualizado con √©xito!');
            clearForm();
            hideCompanyManager();
            await loadData();
        } catch (error) {
            console.error('Error al actualizar el registro:', error);
            alert('Ocurri√≥ un error al actualizar la empresa.');
        }
        }

        async function deleteCompany(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta empresa?')) return;
            try {
                await pb.collection('companies').delete(id);
                alert('Empresa eliminada con √©xito.');
                loadData();
            } catch (err) {
                console.error("Error al eliminar empresa:", err);
                alert('Error al eliminar empresa. Verifica si hay documentos relacionados.');
            }
        }
        function showCompanyManager() {
            document.getElementById('companyModal').classList.remove('hidden');
            renderCompaniesList();
            clearForm();
        }

        function hideCompanyManager() {
            document.getElementById('companyModal').classList.add('hidden');
        }

        function renderCompaniesList() {
            const listContainer = document.getElementById('companiesList');
            listContainer.innerHTML = '';
            companies.forEach(c => {
                const companyDiv = document.createElement('div');
                companyDiv.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm';
                companyDiv.innerHTML = `
                    <span class="font-medium">${escapeHtml(c.name)}</span>
                    <div class="flex gap-2">
                        <button onclick="selectCompanyForEdit('${c.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                        <button onclick="deleteCompany('${c.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
                    </div>
                `;
                listContainer.appendChild(companyDiv);
            });
        }

        function clearForm() {
            document.getElementById('companyForm').reset();
            currentCompanyId = null;
            document.getElementById('logoPreviewContainer').classList.add('hidden');
            document.getElementById('currentLogoPreview').src = '';
        }

        async function handleCompanyFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData();
            const companyId = document.getElementById('companyId').value;
            
            // Recolectar datos del formulario (esto no cambia)
            formData.append('name', document.getElementById('newCompanyName').value);
            formData.append('rtn', document.getElementById('newCompanyRTN').value);
            formData.append('address', document.getElementById('newCompanyAddress').value);
            formData.append('phone', document.getElementById('newCompanyPhone').value);
            formData.append('email', document.getElementById('newCompanyEmail').value);
            const logoInput = document.getElementById('newCompanyLogo');
            if (logoInput.files.length > 0) {
                formData.append('logo', logoInput.files[0]);
            }

            try {
                if (companyId) {
                    // La l√≥gica de ACTUALIZACI√ìN no necesita cambios.
                    await pb.collection('companies').update(companyId, formData);
                    alert('¬°Empresa actualizada con √©xito!');
                } else {
                    // --- INICIO DE LA MODIFICACI√ìN ---
                    // Al CREAR una nueva empresa, a√±adimos el valor por defecto para el contador.
                    formData.append('siguiente_numero_recibo', 1);
                    // --- FIN DE LA MODIFICACI√ìN ---

                    await pb.collection('companies').create(formData);
                    alert('¬°Empresa agregada con √©xito!');
                }
                hideCompanyManager();
                await loadData();
            } catch(err) {
                console.error("Error al guardar empresa:", err);
                alert("Error al guardar empresa. Revisa la consola.");
            }
        }

        function selectCompanyForEdit(id) {
            const c = companies.find(x => x.id === id);
            if (!c) return;
            document.getElementById('companyId').value = c.id;
            document.getElementById('newCompanyName').value = c.name || '';
            document.getElementById('newCompanyRTN').value = c.rtn || '';
            document.getElementById('newCompanyAddress').value = c.address || '';
            document.getElementById('newCompanyPhone').value = c.phone || '';
            document.getElementById('newCompanyEmail').value = c.email || '';
            if (c.logo) {
                const logoUrl = pb.getFileUrl(c, c.logo, { 'thumb': '100x100' });
                document.getElementById('currentLogoPreview').src = logoUrl;
                document.getElementById('logoPreviewContainer').classList.remove('hidden');
            } else {
                document.getElementById('logoPreviewContainer').classList.add('hidden');
            }
            alert('Datos cargados en el formulario para editar.');
        }
        
        //CLIENTES
        function showClientManager() {
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            document.getElementById('clientIsActive').checked = true; // Activo por defecto
            renderClientsList();
            document.getElementById('clientModal').classList.remove('hidden');
        }

        function hideClientManager() {
            document.getElementById('clientModal').classList.add('hidden');
        }

        function renderClientsList() {
            const listContainer = document.getElementById('clientsList');
            listContainer.innerHTML = '';
            clients.forEach(client => {
                const clientDiv = document.createElement('div');
                clientDiv.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm';
                clientDiv.innerHTML = `
                    <div>
                        <span class="font-medium text-sm">${escapeHtml(client.name)} ${client.is_active ? '' : '<span class="text-red-500 text-xs">(Inactivo)</span>'}</span>
                        <p class="text-xs text-gray-600">RTN: ${escapeHtml(client.rtn || 'N/A')}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectClientForEdit('${client.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                        <button onclick="deleteClient('${client.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
                    </div>
                `;
                listContainer.appendChild(clientDiv);
            });
        }

        async function handleClientFormSubmit(event) {
            event.preventDefault();
            const clientId = document.getElementById('clientId').value;

            try {
                // --- PASO 1: RECOLECTAR TODOS LOS DATOS DEL FORMULARIO ---
                // Se incluyen los campos que ya ten√≠as y los nuevos de los cat√°logos
                const data = {
                    name: document.getElementById('clientName').value,
                    rtn: document.getElementById('clientRTN').value,
                    phone_number: document.getElementById('clientPhone').value,
                    address: document.getElementById('clientAddress').value,
                    email: document.getElementById('clientEmail').value,
                    contact_person: document.getElementById('clientContactPerson').value, // <-- CAMPO A√ëADIDO
                    notes: document.getElementById('clientNotes').value, // <-- CAMPO A√ëADIDO
                    entity_type: document.getElementById('entityType').value,
                    client_group: document.getElementById('clientGroup').value.trim(),
                    price_list: document.getElementById('priceList').value.trim(),
                    payment_terms: document.getElementById('paymentTerms').value.trim(),
                    credit_days: parseInt(document.getElementById('creditDays').value) || 0,
                    credit_limit: parseFloat(document.getElementById('creditLimit').value) || 0,
                    is_active: document.getElementById('clientIsActive').checked,
                };

                // --- PASO 2: L√ìGICA DE "SELECCIONAR O CREAR" PARA CAT√ÅLOGOS ---
                // Esta funci√≥n auxiliar revisa si un valor existe y lo crea si es nuevo.
                const createIfNeeded = async (collectionName, value) => {
                    if (!value) return; // No hacer nada si el campo est√° vac√≠o
                    const exists = window.catalogs[collectionName].some(item => item.name.toLowerCase() === value.toLowerCase());
                    if (!exists) {
                        console.log(`Creando nuevo item '${value}' en '${collectionName}'...`);
                        const newItem = await pb.collection(collectionName).create({ name: value });
                        // Actualizamos nuestra lista local para futuros usos en la misma sesi√≥n
                        window.catalogs[collectionName].push(newItem);
                    }
                };

                // Ejecutamos la verificaci√≥n para cada campo. Esto se hace tanto al crear como al actualizar.
                await createIfNeeded('client_groups', data.client_group);
                await createIfNeeded('price_lists', data.price_list);
                await createIfNeeded('payment_terms', data.payment_terms);
                // --- FIN DE LA L√ìGICA DE CAT√ÅLOGOS ---


                // --- PASO 3: L√ìGICA PRINCIPAL PARA GUARDAR EL CLIENTE ---
                if (clientId) {
                    // La l√≥gica de ACTUALIZACI√ìN no cambia.
                    await pb.collection('clients').update(clientId, data);
                    alert('¬°Cliente actualizado con √©xito!');
                } else {
                    // La l√≥gica de CREACI√ìN ahora se ejecuta despu√©s de la verificaci√≥n de cat√°logos.
                    const entityType = data.entity_type;
                    let counterName = '';
                    if (entityType === 'Cliente') counterName = 'clientes';
                    else if (entityType === 'Proveedor') counterName = 'proveedores';
                    else if (entityType === 'Ambos') counterName = 'ambos';
                    else {
                        alert('Tipo de entidad no v√°lido.');
                        return;
                    }

                    const counterRecord = await pb.collection('counters').getFirstListItem(`name = "${counterName}"`);
                    const newNumber = counterRecord.last_value + 1;
                    const newCode = `${counterRecord.prefix}${String(newNumber).padStart(7, '0')}`;
                    
                    data.client_code = newCode; // A√±adimos el c√≥digo autom√°tico a los datos

                    await pb.collection('clients').create(data);
                    
                    await pb.collection('counters').update(counterRecord.id, {
                        'last_value+': 1
                    });
                    
                    alert(`¬°Cliente creado con √©xito! C√≥digo asignado: ${newCode}`);
                }
                
                hideClientManager();
                await loadData(); // Recargamos todo para que las nuevas opciones aparezcan en las listas la pr√≥xima vez
            } catch (err) {
                console.error("Error al guardar el cliente:", err);
                alert('Ocurri√≥ un error al guardar el cliente. Revisa la consola.');
            }
        }
       
        function selectClientForEdit(id) {
            const client = clients.find(c => c.id === id);
            if (!client) return;
            document.getElementById('clientId').value = client.id;
            document.getElementById('clientName').value = client.name;
            document.getElementById('clientCode').value = client.client_code || '';
            document.getElementById('clientRTN').value = client.rtn || '';
            document.getElementById('clientPhone').value = client.phone_number || '';
            document.getElementById('clientAddress').value = client.address || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('contact_person').value = client.contact_person || ''; // <-- CAMPO A√ëADIDO
            document.getElementById('clientNotes').value = client.notes || '';               // <-- CAMPO A√ëADIDO
            document.getElementById('entityType').value = client.entity_type || 'Cliente';
            document.getElementById('clientGroup').value = client.client_group;
            document.getElementById('priceList').value = client.price_list;
            document.getElementById('paymentTerms').value = client.payment_terms;
            document.getElementById('creditDays').value = client.credit_days;
            document.getElementById('creditLimit').value = client.credit_limit;
            document.getElementById('clientIsActive').checked = client.is_active;
        }

        async function deleteClient(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este cliente?')) return;
            try {
                await pb.collection('clients').delete(id);
                alert('Cliente eliminado con √©xito.');
                await loadData();
            } catch (err) {
                console.error("Error al eliminar el cliente:", err);
                alert('Error al eliminar el cliente.');
            }
        }
        
        function populateDatalists() {
            const clientGroupList = document.getElementById('clientGroupList');
            const priceLists = document.getElementById('priceLists');
            const paymentTermsList = document.getElementById('paymentTermsList');

            clientGroupList.innerHTML = '';
            priceLists.innerHTML = '';
            paymentTermsList.innerHTML = '';

            window.catalogs.client_groups.forEach(item => {
                clientGroupList.innerHTML += `<option value="${escapeHtml(item.name)}">`;
            });
            window.catalogs.price_lists.forEach(item => {
                priceLists.innerHTML += `<option value="${escapeHtml(item.name)}">`;
            });
            window.catalogs.payment_terms.forEach(item => {
                paymentTermsList.innerHTML += `<option value="${escapeHtml(item.name)}">`;
            });
        }

        //USUARIOS (SOLO ADMINISTRADOR)
        function showUserManager() {
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            populateRolesDropdown();
            renderUsersList();
            document.getElementById('userManagerModal').classList.remove('hidden');
        }

        function hideUserManager() {
            document.getElementById('userManagerModal').classList.add('hidden');
        }

        function populateRolesDropdown() {
            const roleSelect = document.getElementById('userRole');
            roleSelect.innerHTML = '<option value="">Seleccione un rol...</option>';
            roles.forEach(role => {
                const option = document.createElement('option');
                option.value = role.id;
                option.textContent = role.name;
                roleSelect.appendChild(option);
            });
        }
        
        function renderUsersList() {
            const listContainer = document.getElementById('usersList');
            listContainer.innerHTML = '';
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg';
                const roleName = user.expand?.role?.name || 'Sin rol';
                userDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${user.avatar ? pb.files.getURL(user, user.avatar, {'thumb':'50x50'}) : 'data:image/svg+xml;...'}" class="w-8 h-8 rounded-full object-cover">
                        <div>
                            <p class="text-sm font-medium">${escapeHtml(user.name)}</p>
                            <p class="text-xs text-gray-500 capitalize">${escapeHtml(roleName)}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectUserForEdit('${user.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                    </div>`;
                listContainer.appendChild(userDiv);
            });
        }

        async function handleUserFormSubmit(event) {
            event.preventDefault();
            const userId = document.getElementById('userId').value;
            const saveBtn = document.querySelector('#userForm button[type="submit"]');
            saveBtn.disabled = true;

            try {
                let dataToSend;

                // Obtenemos los nuevos valores del formulario, incluyendo 'name' y 'username'
                const newName = document.getElementById('userNameDisplay').value;
                const newEmail = document.getElementById('userEmail').value;
                const newRole = document.getElementById('userRole').value;
                const newPassword = document.getElementById('userPassword').value;
                const passwordConfirm = document.getElementById('userPasswordConfirm').value;
                const avatarFile = document.getElementById('userAvatarFile').files[0];

                if (userId) {
                    // --- MODO ACTUALIZACI√ìN ---
                    const originalUser = users.find(u => u.id === userId);
                    const dataChanges = {};

                    // Comparamos cada campo y lo a√±adimos solo si ha cambiado
                    if (newName !== originalUser.name) {
                        dataChanges.name = newName;
                    }
                    if (newEmail !== originalUser.email) {
                        dataChanges.email = newEmail;
                    }
                    if (newRole !== originalUser.role) {
                        dataChanges.role = newRole;
                    }
                    if (newPassword) {
                        if (newPassword !== passwordConfirm) {
                            alert('Las contrase√±as no coinciden.');
                            saveBtn.disabled = false;
                            return;
                        }
                        dataChanges.password = newPassword;
                        dataChanges.passwordConfirm = passwordConfirm;
                    }

                    // Decidimos el formato de env√≠o
                    if (avatarFile) {
                        const formData = new FormData();
                        for (const key in dataChanges) {
                            formData.append(key, dataChanges[key]);
                        }
                        formData.append('avatar', avatarFile);
                        dataToSend = formData;
                    } else {
                        dataToSend = dataChanges;
                    }

                    if (Object.keys(dataToSend).length === 0 && !avatarFile) {
                        alert("No se ha realizado ning√∫n cambio.");
                        hideUserManager();
                        return;
                    }

                    await pb.collection('users').update(userId, dataToSend);
                    alert('¬°Usuario actualizado con √©xito!');

                } else {
                    // --- MODO CREACI√ìN ---
                    if (!newPassword || newPassword !== passwordConfirm) {
                        alert('Para un usuario nuevo, las contrase√±as son obligatorias y deben coincidir.');
                        saveBtn.disabled = false;
                        return;
                    }
                    const formData = new FormData();
                    formData.append('name', newName); // <-- CAMPO A√ëADIDO            
                    formData.append('email', newEmail);
                    formData.append('role', newRole);
                    formData.append('password', newPassword);
                    formData.append('passwordConfirm', passwordConfirm);
                    if (avatarFile) {
                        formData.append('avatar', avatarFile);
                    }
                    dataToSend = formData;
                    
                    await pb.collection('users').create(dataToSend);
                    alert('¬°Usuario creado con √©xito!');
                }

                hideUserManager();
                await pb.collection('users').authRefresh({ expand: 'role' }); 
                await loadData();

            } catch (err) {
                console.error("Error al guardar el usuario:", err);
                const errorDetails = err.response?.data ? JSON.stringify(err.response.data) : err.message;
                alert(`Ocurri√≥ un error al guardar el usuario: ${errorDetails}`);
            } finally {
                saveBtn.disabled = false;
            }
        }
        
        function selectUserForEdit(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('userForm').reset();
            document.getElementById('userId').value = user.id;
            document.getElementById('userNameDisplay').value = user.name || '';
            document.getElementById('userEmail').value = user.email;
            document.getElementById('userRole').value = user.role;
        }

        //USUARIOS (CAMBIO DE FOT Y NOMBRE OPERADORES)
        /**
        * 1. Abre el modal y carga los datos actuales del usuario.
        */
        function showMyProfile() {
            const user = pb.authStore.model;
            if (!user) return;

            // Cargar nombre actual
            document.getElementById('profileName').value = user.name || '';
            
            // Cargar vista previa de la foto actual
            const avatarUrl = user.avatar 
                ? pb.files.getURL(user, user.avatar) 
                : `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email)}&background=random`;
            
            document.getElementById('profilePreview').src = avatarUrl;
            
            // Limpiar el input de archivo por si qued√≥ algo seleccionado antes
            document.getElementById('profileAvatar').value = ''; 

            // Mostrar el modal
            document.getElementById('myProfileModal').classList.remove('hidden');
        }

        /**
        * 2. Env√≠a los cambios a PocketBase.
        */
        async function updateMyProfile(event) {
            event.preventDefault(); // Evita que la p√°gina se recargue
            
            const user = pb.authStore.model;
            const newName = document.getElementById('profileName').value;
            const avatarFile = document.getElementById('profileAvatar').files[0];

            const formData = new FormData();
            formData.append('name', newName);
            
            // Solo a√±adimos la foto si el usuario seleccion√≥ una nueva
            if (avatarFile) {
                formData.append('avatar', avatarFile);
            }

            try {
                // Actualizamos en la base de datos
                await pb.collection('users').update(user.id, formData);
                
                // Actualizamos la informaci√≥n visual en la barra lateral inmediatamente
                updateUserInfo(); 
                
                alert('¬°Perfil actualizado con √©xito!');
                document.getElementById('myProfileModal').classList.add('hidden');

            } catch (err) {
                console.error("Error al actualizar perfil:", err);
                alert("Ocurri√≥ un error al guardar. Intenta de nuevo.");
            }
        }

        //PRODUCTOS
        function showProductManager() {
            document.getElementById('productForm').reset(); // Limpiar formulario
            document.getElementById('productId').value = ''; // Limpiar ID de edici√≥n
            renderProductsList(); // Dibujar la lista de productos existentes
            document.getElementById('productManagerModal').classList.remove('hidden');
        }

        function hideProductManager() {
            document.getElementById('productManagerModal').classList.add('hidden');
        }

        function renderProductsList() {
            console.log("--- Iniciando renderProductsList ---");
            const listContainer = document.getElementById('productsList');
            
            if (!listContainer) {
                console.error("Error Cr√≠tico: No se encontr√≥ el contenedor '#productsList' en el HTML.");
                return;
            }
            listContainer.innerHTML = '';

            console.log("Datos de 'products' al momento de renderizar la lista:", products);

            if (!products || products.length === 0) {
                console.warn("La lista de productos est√° vac√≠a o es indefinida. No se mostrar√° nada.");
                listContainer.innerHTML = '<p class="text-gray-500 text-center">No hay productos creados.</p>';
                return;
            }

            products.forEach((product, index) => {
                console.log(`Renderizando producto en la lista #${index + 1}: ${product.name}`);
                const productDiv = document.createElement('div');
                productDiv.className = 'grid grid-cols-6 gap-4 items-center bg-gray-100 p-3 rounded-lg shadow-sm';
                        
                // Se a√±ade '|| 0' para asegurar que si el precio no existe, se use 0 como valor por defecto.
                const price = product.default_price || 0;
                
                productDiv.innerHTML = `
                    <span class="col-span-2 font-medium text-sm">${escapeHtml(product.name)}</span>
                    <span class="col-span-2 text-xs text-gray-600">C√≥digo: ${escapeHtml(product.product_code || 'N/A')}</span>
                    
                    <span class="col-span-1 font-semibold text-sm text-right">L ${formatNumber(price)}</span>
                    
                    <div class="col-span-1 flex gap-2 justify-end">
                        <button onclick="selectProductForEdit('${product.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                        <button onclick="deleteProduct('${product.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
                    </div>
                `;
                listContainer.appendChild(productDiv);
            });
            console.log("--- Finalizado renderProductsList ---");
        }

        async function handleProductFormSubmit(event) {
            event.preventDefault();
            const productId = document.getElementById('productId').value;

            const data = {
                name: document.getElementById('productName').value,
                product_code: document.getElementById('productCode').value,
                description: document.getElementById('productDescription').value,
                default_price: parseFloat(document.getElementById('productPrice').value),
                is_exempt: document.getElementById('productIsExempt').checked,
            };

            try {
                if (productId) {
                    // Actualizar producto existente
                    await pb.collection('products').update(productId, data);
                    alert('¬°Producto actualizado con √©xito!');
                } else {
                    // Crear nuevo producto
                    await pb.collection('products').create(data);
                    alert('¬°Producto creado con √©xito!');
                }
                hideProductManager();
                await loadData(); // Recargar todos los datos para reflejar los cambios
            } catch (err) {
                console.error("Error al guardar el producto:", err);
                alert('Ocurri√≥ un error al guardar el producto. Revisa la consola.');
            }
        }

        function selectProductForEdit(id) {
            const product = products.find(p => p.id === id);
            if (!product) {
                console.error("Producto no encontrado con ID:", id);
                return;
            }

            // Rellena el formulario con los datos del producto encontrado
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productCode').value = product.product_code || '';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productPrice').value = product.default_price;
            document.getElementById('productIsExempt').checked = product.is_exempt;
            
            // Desplaza la vista hacia arriba para ver el formulario
            document.querySelector('#productManagerModal .bg-white').scrollTo(0, 0);
        }

        async function deleteProduct(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) return;
            try {
                await pb.collection('products').delete(id);
                alert('Producto eliminado con √©xito.');
                await loadData();
            } catch (err) {
                console.error("Error al eliminar el producto:", err);
                alert('Error al eliminar el producto. Revisa la consola.');
            }
        }

        //AUTORIZACIONES SAR
        function showAuthManager() {
            document.getElementById('authForm').reset(); // Limpiar formulario
            document.getElementById('authId').value = ''; // Limpiar ID de edici√≥n
            
            // Poblar el dropdown de empresas
            const companySelect = document.getElementById('authCompany');
            companySelect.innerHTML = '<option value="">Seleccione una empresa...</option>';
            companies.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                companySelect.appendChild(option);
            });

            renderAuthList(); // Dibujar la lista de autorizaciones existentes
            document.getElementById('authModal').classList.remove('hidden');
        }

        function hideAuthManager() {
            document.getElementById('authModal').classList.add('hidden');
        }

        function renderAuthList() {
            const listContainer = document.getElementById('authList');
            listContainer.innerHTML = '';
            authorizations.forEach(auth => {
                const authDiv = document.createElement('div');
                const companyName = auth.expand && auth.expand.empresa ? auth.expand.empresa.name : 'Empresa Desconocida';
                authDiv.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm';
                authDiv.innerHTML = `
                    <div>
                        <span class="font-medium text-sm">CAI: ${escapeHtml(auth.cai)}</span>
                        <p class="text-xs text-gray-600">Empresa: ${escapeHtml(companyName)} | Rango: ${auth.rango_inicio}-${auth.rango_fin} ${auth.esta_activa ? '<span class="text-green-600 font-bold">(Activa)</span>' : ''}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectAuthForEdit('${auth.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                        <button onclick="deleteAuth('${auth.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
                    </div>
                `;
                listContainer.appendChild(authDiv);
            });
        }

        async function handleAuthFormSubmit(event) {
            event.preventDefault();
            const authId = document.getElementById('authId').value;

            const data = {
                empresa: document.getElementById('authCompany').value,
                cai: document.getElementById('authCAI').value,
                fecha_limite: document.getElementById('authFechaLimite').value,
                rango_inicio: parseInt(document.getElementById('authRangoInicio').value),
                rango_fin: parseInt(document.getElementById('authRangoFin').value),
                numero_actual: parseInt(document.getElementById('authNumeroActual').value),
                cod_sucursal: document.getElementById('authCodSucursal').value,
                cod_punto_emision: document.getElementById('authCodPuntoEmision').value,
                cod_tipo_doc: document.getElementById('authCodTipoDoc').value,
                esta_activa: document.getElementById('authEstaActiva').checked,
            };

            try {
                if (authId) {
                    // Actualizar registro existente
                    await pb.collection('autorizaciones_factura').update(authId, data);
                    alert('¬°Autorizaci√≥n actualizada con √©xito!');
                } else {
                    // Crear nuevo registro
                    await pb.collection('autorizaciones_factura').create(data);
                    alert('¬°Autorizaci√≥n creada con √©xito!');
                }
                hideAuthManager();
                await loadData(); // Recargar todos los datos para reflejar los cambios
            } catch (err) {
                console.error("Error al guardar la autorizaci√≥n:", err);
                alert('Ocurri√≥ un error al guardar la autorizaci√≥n. Revisa la consola.');
            }
        }

        function selectAuthForEdit(id) {
            const auth = authorizations.find(a => a.id === id);
            if (!auth) return;

            // Llenar el formulario con los datos existentes
            document.getElementById('authId').value = auth.id;
            document.getElementById('authCompany').value = auth.empresa;
            document.getElementById('authCAI').value = auth.cai;
            // Formatear la fecha para el input type="date"
            document.getElementById('authFechaLimite').value = new Date(auth.fecha_limite).toISOString().split('T')[0];
            document.getElementById('authRangoInicio').value = auth.rango_inicio;
            document.getElementById('authRangoFin').value = auth.rango_fin;
            document.getElementById('authNumeroActual').value = auth.numero_actual;
            document.getElementById('authCodSucursal').value = auth.cod_sucursal;
            document.getElementById('authCodPuntoEmision').value = auth.cod_punto_emision;
            document.getElementById('authCodTipoDoc').value = auth.cod_tipo_doc;
            document.getElementById('authEstaActiva').checked = auth.esta_activa;
        }

        async function deleteAuth(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta autorizaci√≥n?')) return;
            try {
                await pb.collection('autorizaciones_factura').delete(id);
                alert('Autorizaci√≥n eliminada con √©xito.');
                await loadData();
            } catch (err) {
                console.error("Error al eliminar la autorizaci√≥n:", err);
                alert('Error al eliminar. Verifica si hay facturas relacionadas con esta autorizaci√≥n.');
            }
        }

        //CUENTAS BANCARIAS (SOLO ADMINISTRADOR)
        function showBankAccountManager() {
            document.getElementById('bankAccountForm').reset();
            document.getElementById('accountId').value = '';
            
            // Poblar el dropdown de empresas
            const companySelect = document.getElementById('accountCompany');
            companySelect.innerHTML = '<option value="">Seleccione una empresa...</option>';
            companies.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                companySelect.appendChild(option);
            });

            renderBankAccountsList();
            document.getElementById('bankAccountModal').classList.remove('hidden');
        }

        function hideBankAccountManager() {
            document.getElementById('bankAccountModal').classList.add('hidden');
        }

        function renderBankAccountsList() {
            const listContainer = document.getElementById('bankAccountsList');
            listContainer.innerHTML = '';
            bankAccounts.forEach(account => {
                const accountDiv = document.createElement('div');
                accountDiv.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg';
                const companyName = account.expand?.company?.name || 'N/A';
                accountDiv.innerHTML = `
                    <div>
                        <p class="text-sm font-medium">${escapeHtml(account.bank_name)} - ${escapeHtml(account.account_name)}</p>
                        <p class="text-xs text-gray-500">${escapeHtml(companyName)} | #${escapeHtml(account.account_number)}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectBankAccountForEdit('${account.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                        <button onclick="deleteBankAccount('${account.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
                    </div>`;
                listContainer.appendChild(accountDiv);
            });
        }

        async function handleBankAccountFormSubmit(event) {
            event.preventDefault();
            const accountId = document.getElementById('accountId').value;
            const data = {
                company: document.getElementById('accountCompany').value,
                bank_name: document.getElementById('accountBankName').value,
                account_name: document.getElementById('accountName').value,
                account_number: document.getElementById('accountNumber').value,
                account_type: document.getElementById('accountType').value,
            };

            try {
                if (accountId) {
                    await pb.collection('bank_accounts').update(accountId, data);
                    alert('¬°Cuenta actualizada con √©xito!');
                } else {
                    await pb.collection('bank_accounts').create(data);
                    alert('¬°Cuenta creada con √©xito!');
                }
                hideBankAccountManager();
                await loadData();
            } catch (err) {
                console.error("Error al guardar la cuenta bancaria:", err);
                alert('Ocurri√≥ un error al guardar la cuenta. Revisa la consola.');
            }
        }

        function selectBankAccountForEdit(id) {
            const account = bankAccounts.find(acc => acc.id === id);
            if (!account) return;

            document.getElementById('accountId').value = account.id;
            document.getElementById('accountCompany').value = account.company;
            document.getElementById('accountBankName').value = account.bank_name;
            document.getElementById('accountName').value = account.account_name;
            document.getElementById('accountNumber').value = account.account_number;
            document.getElementById('accountType').value = account.account_type;
        }

        async function deleteBankAccount(id) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta cuenta bancaria?')) return;
            try {
                await pb.collection('bank_accounts').delete(id);
                alert('Cuenta bancaria eliminada con √©xito.');
                await loadData();
            } catch (err) {
                console.error("Error al eliminar la cuenta:", err);
                alert('Error al eliminar la cuenta bancaria.');
            }
        }

        // --- INICIALIZACI√ìN ---
        // Se ejecuta al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Mostrar la versi√≥n
            document.getElementById('app-version').textContent = APP_VERSION;
            
            // 2. (Opcional) Monitor de conexi√≥n simple
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            updateConnectionStatus();
        });
        
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            const iDate = document.getElementById('invoiceDate');
            const rDate = document.getElementById('receiptDate');
            if (iDate && !iDate.value) iDate.value = today;
            if (rDate && !rDate.value) rDate.value = today;
        }

        function initializeInvoiceForm() { addInvoiceItem(); }

        // FUNCI√ìN DE PERMISOS DE USUARIO
        function applyPermissions() {
            const user = pb.authStore.model;
            
            // Si no hay usuario o rol cargado, ocultamos todo lo protegido por seguridad
            if (!user || !user.expand || !user.expand.role) return;

            // 1. Obtener los permisos desde la relaci√≥n expandida
            // IMPORTANTE: PocketBase devuelve la relaci√≥n expandida en 'expand.permissions'
            // 'permissions' es el nombre del campo de relaci√≥n en tu colecci√≥n 'roles'
            const rolePermissionsObjects = user.expand.role.expand?.permissions || [];
            
            // 2. Crear una lista simple de los "slugs" (c√≥digos) de los permisos
            // Transformamos la lista de objetos [{slug: "view_morosidad"}, ...] a ["view_morosidad", ...]
            const userPermissionSlugs = rolePermissionsObjects.map(p => p.slug);

            // 3. Verificar si es un Super Usuario (tiene el permiso comod√≠n '*')
            const isSuperUser = userPermissionSlugs.includes('*');
            
            console.log(`Aplicando permisos para rol '${user.expand.role.name}':`, userPermissionSlugs);

            // 4. Buscar y filtrar elementos en el HTML
            const protectedElements = document.querySelectorAll('[data-permission]');

            protectedElements.forEach(element => {
                const requiredPermission = element.getAttribute('data-permission');

                // Si es SuperUser O si su lista de permisos incluye el requerido...
                if (isSuperUser || userPermissionSlugs.includes(requiredPermission)) {
                    element.classList.remove('hidden'); // Mostrar
                } else {
                    element.classList.add('hidden');    // Ocultar
                }
            });
        }

        /**
         * Verifica si el usuario actual tiene un permiso espec√≠fico.
         * Retorna true o false.
         */
        function hasPermission(permissionSlug) {
            const user = pb.authStore.model;
            if (!user || !user.expand || !user.expand.role) return false;

            // 1. Obtener permisos (Misma l√≥gica que applyPermissions)
            const rolePermissionsObjects = user.expand.role.expand?.permissions || [];
            const userPermissionSlugs = rolePermissionsObjects.map(p => p.slug);

            // 2. Verificar (incluyendo Super Usuario '*')
            return userPermissionSlugs.includes('*') || userPermissionSlugs.includes(permissionSlug);
        }

        function findCompanyById(id) {
            return id ? companies.find(c => c.id === id) || null : null;
        }

        function updateReports() {
            const totalDocsEl = document.getElementById('totalDocs');
            const totalInvoicesEl = document.getElementById('totalInvoices');
            const totalReceiptsEl = document.getElementById('totalReceipts');
            const totalRevenueEl = document.getElementById('totalRevenue');
            const breakdownEl = document.getElementById('companyBreakdown');
            if (documents.length === 0) {
                totalDocsEl.textContent = '0';
                totalInvoicesEl.textContent = '0';
                totalReceiptsEl.textContent = '0';
                totalRevenueEl.textContent = 'L 0';
                breakdownEl.innerHTML = '<p class="text-center text-gray-500">No hay datos.</p>';
                return;
            }
            const totalDocs = documents.length;
            const totalInvoices = documents.filter(doc => doc.type === 'Factura').length;
            const totalReceipts = documents.filter(doc => doc.type === 'Recibo').length;
            const totalRevenue = documents.reduce((sum, doc) => sum + (doc.total || doc.amount || 0), 0);
            totalDocsEl.textContent = totalDocs;
            totalInvoicesEl.textContent = totalInvoices;
            totalReceiptsEl.textContent = totalReceipts;
            totalRevenueEl.textContent = `L ${formatNumber(totalRevenue)}`;
            const companyData = {};
            companies.forEach(c => {
                companyData[c.id] = { name: c.name, revenue: 0, docs: 0 };
            });
            documents.forEach(doc => {
                if (doc.company && companyData[doc.company]) {
                    companyData[doc.company].revenue += (doc.total || doc.amount || 0);
                    companyData[doc.company].docs++;
                }
            });
            breakdownEl.innerHTML = '';
            const companyBreakdownList = Object.values(companyData);
            if (companyBreakdownList.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'space-y-2';
                companyBreakdownList.forEach(data => {
                    if (data.docs > 0) {
                        const li = document.createElement('li');
                        li.className = 'flex justify-between items-center p-3 bg-white rounded-lg shadow-sm';
                        li.innerHTML = `<span>${escapeHtml(data.name)} (${data.docs} docs)</span>
                            <span class="font-bold text-green-600">L ${formatNumber(data.revenue)}</span>`;
                        ul.appendChild(li);
                    }
                });
                breakdownEl.appendChild(ul);
            } else {
                breakdownEl.innerHTML = '<p class="text-center text-gray-500">No hay datos de empresas.</p>';
            }
        }
        
        // --- SECCIONES EXTRA ---
        //AGENDA
        function showAgenda() {
            // 1. Configurar los event listeners CADA VEZ que se muestra la secci√≥n
            // Esto evita errores con elementos que no existen en otras pantallas
            
            // Tarea r√°pida
            document.getElementById('add-quick-btn').onclick = addQuickTask;
            document.getElementById('quick-task').onkeypress = (e) => { if (e.key === 'Enter') addQuickTask(); };

            // Tarea detallada
            document.getElementById('add-detailed-btn').onclick = addDetailedTask;

            // Filtros
            document.getElementById('filter-all').onclick = () => filterTasks('all');
            document.getElementById('filter-pendiente').onclick = () => filterTasks('Pendiente');
            document.getElementById('filter-en-curso').onclick = () => filterTasks('En Curso');
            document.getElementById('filter-en-revision').onclick = () => filterTasks('En Revisi√≥n');
            document.getElementById('filter-completada').onclick = () => filterTasks('Completada');
            document.getElementById('clear-completed-btn').onclick = clearCompleted;
            document.getElementById('task-sort-select').onchange = setTaskSort;

            // Timer
            document.getElementById('start-timer-btn').onclick = startTimer;
            document.getElementById('pause-timer-btn').onclick = pauseTimer;
            document.getElementById('reset-timer-btn').onclick = resetTimer;

            // Notas
            document.getElementById('save-notes-btn').onclick = saveNotes;

            // --- EVENT LISTENERS PARA EL TIMER ---
            document.getElementById('start-timer-btn').onclick = startTimer;
            document.getElementById('pause-timer-btn').onclick = pauseTimer;
            document.getElementById('reset-timer-btn').onclick = resetTimer;
            
            // Listeners para los botones de presets
            document.getElementById('set-time-work').onclick = () => setTimer(25, 'work');
            document.getElementById('set-time-short-break').onclick = () => setTimer(5, 'shortBreak');
            document.getElementById('set-time-long-break').onclick = () => setTimer(15, 'longBreak');
            
            // Listener para actualizar el total de sesiones
            document.getElementById('pomodoro-sessions').onchange = () => {
                totalPomodoroSessions = parseInt(document.getElementById('pomodoro-sessions').value);
                updatePomodoroInfo();
            };

            // Poblar el men√∫ de asignaci√≥n de usuarios (si es admin)
            const userSelect = document.getElementById('assign-to-user');
            // Usamos la nueva funci√≥n hasPermission
            if (userSelect && hasPermission('assign_tasks')) {
                userSelect.innerHTML = '';
                
                // (Nota: Aseg√∫rate de que la variable 'users' est√© cargada en loadData)
                if (users.length > 0) {
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.name;
                        userSelect.appendChild(option);
                    });
                    userSelect.value = pb.authStore.model.id;
                }
            }

            // 2. Cargar datos iniciales en la vista
            loadNotes();
            renderTasks();
            updateStats();
            populateTimerTasks();
            updateTimerDisplay();
            updatePomodoroInfo();
            
            // 3. Mostrar la secci√≥n de la agenda
            showSection('agendaSection');
        }

        // --- Funciones Modificadas para PocketBase ---

        async function addQuickTask() {
            const input = document.getElementById('quick-task');
            const taskText = input.value.trim();

            if (taskText) {
                const taskData = {
                    user: pb.authStore.model.id,
                    title: taskText,
                    category: document.getElementById('quick-category').value,
                    time_estimate: parseInt(document.getElementById('quick-time-estimate').value),            
                    priority: 'media', // Prioridad por defecto para tareas r√°pidas
                    due_date: null,
                    notes: '',
                    status: 'Pendiente',
                    completed_at: null
                };
                
                try {
                    const newTask = await pb.collection('agenda_tasks').create(taskData);
                    agendaTasks.unshift(newTask); 
                    renderTasks();
                    updateStats();
                    checkAppNotifications(); // Actualiza las notifaciones
                    input.value = ''; // Limpia solo el campo de texto
                } catch (err) {
                    console.error('Error al agregar tarea r√°pida:', err);
                    alert("Error al guardar la tarea. Revisa la consola.");
                }
            }
        }

        /**
         * Guarda o actualiza una tarea detallada.
         * Lee el formulario, determina si es una creaci√≥n o una actualizaci√≥n,
         * y env√≠a los datos a PocketBase.
         */
        async function addDetailedTask() {
            // 1. Lee el ID. Si est√° vac√≠o, es una tarea nueva.
            const taskId = document.getElementById('detailed-task-id').value;
            
            const title = document.getElementById('detailed-title').value.trim();
            if (!title) {
                alert("El t√≠tulo de la tarea no puede estar vac√≠o.");
                return;
            }

            // 2. Procesa la fecha y hora
            const dateVal = document.getElementById('due-date').value;
            const timeVal = document.getElementById('due-time').value;
            let fullDueDate = null;

            if (dateVal && timeVal) {
                fullDueDate = new Date(`${dateVal}T${timeVal}`).toISOString();
            } else if (dateVal) {
                fullDueDate = new Date(dateVal).toISOString();
            }

            // 3. Procesa el tiempo estimado (con valor por defecto)
            const timeValueString = document.getElementById('time-estimate').value;
            const parsedTime = parseInt(timeValueString);
            const timeEstimateValue = !isNaN(parsedTime) ? parsedTime : 30;

            // 4. Procesa la asignaci√≥n de usuario (Admin vs Operador)
            let assignedToUserId = pb.authStore.model.id; // Por defecto, es para m√≠
            let assignedByUserId = null;
            
            if (hasPermission('assign_tasks')) {
                assignedToUserId = document.getElementById('assign-to-user').value;
                
                if (assignedToUserId !== pb.authStore.model.id) {
                    assignedByUserId = pb.authStore.model.id;
                }
            }

            // 5. Prepara el objeto de datos com√∫n
            const taskData = {
                title: title,
                category: document.getElementById('category').value,
                priority: document.getElementById('priority').value,
                recurrence: document.getElementById('recurrence').value,
                time_estimate: timeEstimateValue,
                due_date: fullDueDate,
                notes: document.getElementById('notes').value.trim(),
                user: assignedToUserId,
                assigned_by: assignedByUserId
            };

            try {
                if (taskId) {
                    // --- MODO ACTUALIZAR ---
                    // Pide el registro actualizado CON los nombres expandidos
                    const updatedTask = await pb.collection('agenda_tasks').update(taskId, taskData, {
                        expand: 'user,assigned_by'
                    });
                    
                    // Reemplaza la tarea vieja en la lista local
                    const index = agendaTasks.findIndex(t => t.id === taskId);
                    agendaTasks[index] = updatedTask;
                    alert('¬°Tarea actualizada!');

                } else {
                    // --- MODO CREAR ---
                    // A√±ade los campos que solo se definen al crear
                    Object.assign(taskData, {
                        status: 'Pendiente',                
                        completed_at: null
                    });
                    
                    // 1. Crea el registro
                    const createdRecord = await pb.collection('agenda_tasks').create(taskData);
                    
                    // 2. Vuelve a pedir el registro, pero CON los nombres expandidos
                    // (Esto soluciona el error "Para: N/A")
                    const newTask = await pb.collection('agenda_tasks').getOne(createdRecord.id, {
                        expand: 'user,assigned_by'
                    });

                    // 3. A√±ade la tarea completa a la lista local
                    agendaTasks.unshift(newTask);
                    alert('¬°Tarea creada y asignada!');
                }
                
                resetDetailedTaskForm(); // Limpia y resetea el formulario
                renderTasks(); // Actualiza la lista
                updateStats(); // Actualiza las estad√≠sticas
                checkAppNotifications(); // Vuelve a revisar las notificaciones despu√©s de cualquier cambio.

            } catch (err) {
                console.error('Error al guardar tarea detallada:', err);
                alert("Error al guardar la tarea. Revisa la consola.");
            }
        }

        async function updateTaskStatus(selectElement, taskId) {
            const newStatus = selectElement.value;
            const task = agendaTasks.find(t => t.id === taskId);
            if (!task) return;

            // Actualiza el estado localmente
            task.status = newStatus;
            
            // Prepara los datos para PocketBase
            const dataToUpdate = {
                status: newStatus
            };

            // Si la tarea se marca como "Completada", guarda la fecha
            if (newStatus === 'Completada') {
                task.completed_at = new Date().toISOString();
                dataToUpdate.completed_at = task.completed_at;
                // --- ‚ñº‚ñº‚ñº L√ìGICA DE RECURRENCIA ‚ñº‚ñº‚ñº ---
                // Si la tarea se complet√≥ Y tiene recurrencia, creamos la siguiente
                if (task.recurrence && task.recurrence !== 'ninguna') {
                    await createNextRecurringTask(task);
                }
                // --- ‚ñ≤‚ñ≤‚ñ≤ FIN L√ìGICA RECURRENCIA ‚ñ≤‚ñ≤‚ñ≤ ---
            } 
            // Si se revierte de "Completada" a otro estado
            else if (task.completed_at !== null) { 
                task.completed_at = null;
                dataToUpdate.completed_at = null;
            }

            try {
                // Actualiza en PocketBase
                await pb.collection('agenda_tasks').update(taskId, dataToUpdate);
                
                // Vuelve a renderizar la lista (para aplicar estilos) y las estad√≠sticas
                renderTasks();
                updateStats();
                checkAppNotifications();
            } catch (err) {
                console.error('Error al actualizar el estado:', err);
                alert("Error al actualizar el estado.");
            }
        }
        // Hacemos que la funci√≥n sea accesible desde el HTML
        window.updateTaskStatus = updateTaskStatus;

        async function deleteTask(taskId) {
            if (!confirm('¬øSeguro que quieres eliminar esta tarea?')) return;

            try {
                await pb.collection('agenda_tasks').delete(taskId);
                
                // Elimina de la lista local
                agendaTasks = agendaTasks.filter(task => task.id !== taskId);
                renderTasks();
                updateStats();
            } catch (err) {
                console.error('Error al eliminar tarea:', err);
                alert("Error al eliminar la tarea.");
            }
        }
        window.deleteTask = deleteTask; // Hacerla accesible desde el HTML

        async function clearCompleted() {
            // CORRECCI√ìN 1: Buscar tareas usando el nuevo campo 'status'
            const completedTasks = agendaTasks.filter(task => task.status === 'Completada');
            
            if (completedTasks.length === 0) {
                alert("No hay tareas completadas para limpiar."); // Opcional: un aviso al usuario
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que deseas eliminar permanentemente todas las tareas completadas?')) return;

            try {
                // Borrar una por una de la base de datos
                for (const task of completedTasks) {
                    await pb.collection('agenda_tasks').delete(task.id);
                }
                
                // CORRECCI√ìN 2: Actualizar la lista local filtrando por 'status'
                agendaTasks = agendaTasks.filter(task => task.status !== 'Completada');
                
                // Volver a dibujar la interfaz
                renderTasks();
                updateStats();
            } catch (err) {
                console.error('Error al limpiar tareas:', err);
                alert("Ocurri√≥ un error al eliminar las tareas.");
            }
        }

        function loadNotes() {
            // La nota se carga en loadData, aqu√≠ solo la mostramos
            if (agendaNote) {
                document.getElementById('quick-notes').value = agendaNote.content;
            }
        }

        async function saveNotes() {
            const notesArea = document.getElementById('quick-notes');
            if (!agendaNote) return;

            try {
                agendaNote.content = notesArea.value;
                await pb.collection('agenda_notes').update(agendaNote.id, { 
                    content: agendaNote.content 
                });
                
                const btn = document.getElementById('save-notes-btn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Guardado';
                btn.disabled = true;
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (err) {
                console.error('Error al guardar notas:', err);
                alert("Error al guardar las notas.");
            }
        }

        function setTaskSort() {
            currentTaskSort = document.getElementById('task-sort-select').value;
            renderTasks(); // Vuelve a dibujar la lista con el nuevo orden
        }

        function renderTasks() {
            const container = document.getElementById('tasks-container');
            if (!container) return;

            // 1. Filtrar Tareas (seg√∫n los botones "Todas", "Pendientes", "Completadas")
            let filteredTasks = agendaTasks;
            
            if (currentFilter !== 'all') {
                filteredTasks = agendaTasks.filter(task => task.status === currentFilter);
            }
            
            
            // 2. Ordenar Tareas (seg√∫n el men√∫ "Ordenar por:")
            let sortedTasks = [...filteredTasks]; // Copia la lista filtrada para ordenarla

            // Funci√≥n auxiliar para convertir prioridad a n√∫mero
            const priorityToNumber = (priority) => {
                switch (priority) {
                    case 'urgente': return 4;
                    case 'alta': return 3;
                    case 'media': return 2;
                    case 'baja': return 1;
                    default: return 0;
                }
            };

            switch (currentTaskSort) {
                case 'created_desc':
                    // Ordena por fecha de creaci√≥n (por defecto)
                    sortedTasks.sort((a, b) => new Date(b.created) - new Date(a.created));
                    break;
                case 'due_date_asc':
                    // Ordena por fecha de vencimiento (las tareas sin fecha van al final)
                    sortedTasks.sort((a, b) => {
                        if (a.due_date && b.due_date) return new Date(a.due_date) - new Date(b.due_date);
                        if (a.due_date && !b.due_date) return -1; // a (con fecha) va primero
                        if (!a.due_date && b.due_date) return 1;  // b (con fecha) va primero
                        return 0; // ambos no tienen fecha
                    });
                    break;
                case 'priority_desc':
                    // Ordena por prioridad (de m√°s alta a m√°s baja)
                    sortedTasks.sort((a, b) => priorityToNumber(b.priority) - priorityToNumber(a.priority));
                    break;
                case 'time_asc':
                    // Ordena por tiempo estimado (de menor a mayor)
                    sortedTasks.sort((a, b) => (a.time_estimate || 0) - (b.time_estimate || 0));
                    break;
            }

            // 3. Renderizar (Dibujar) la Lista
            if (sortedTasks.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-4"><span class="text-3xl block mb-2">üìù</span><p>No hay tareas en esta categor√≠a.</p></div>`;
                return;
            }
            
            const categoryEmojis = { trabajo: 'üíº', personal: 'üë§', salud: 'üí™', estudios: 'üìö', hogar: 'üè†' };
            
            let html = '';
            // Usamos la lista 'sortedTasks' para generar el HTML
            sortedTasks.forEach(task => { 
                // L√≥gica para mostrar asignaci√≥n (si es admin o si fue asignada)
                let assignmentText = '';
                const canAssign = hasPermission('assign_tasks'); // Verificamos permiso
                
                if (canAssign && task.user !== pb.authStore.model.id) {
                    assignmentText = `<p class="text-xs font-semibold text-blue-custom mt-1">Para: ${escapeHtml(task.expand?.user?.name || 'N/A')}</p>`;
                } else if (task.assigned_by) {
                    assignmentText = `<p class="text-xs font-semibold text-orange-custom mt-1">De: ${escapeHtml(task.expand?.assigned_by?.name || 'N/A')}</p>`;
                }

                // --- ‚ñº‚ñº‚ñº L√ìGICA DE RECURRENCIA A√ëADIDA ‚ñº‚ñº‚ñº ---
                let recurrenceBadge = '';
                if (task.recurrence && task.recurrence !== 'ninguna') {
                    // Creamos una etiqueta visual
                    const recurrenceMap = {
                        'diaria': 'Diaria',
                        'semanal': 'Semanal',
                        'mensual': 'Mensual'
                    };
                    const label = recurrenceMap[task.recurrence] || 'Recurrente';
                    
                    recurrenceBadge = `
                        <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 border border-purple-200">
                            <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            ${label}
                        </span>
                    `;
                }
                // --- ‚ñ≤‚ñ≤‚ñ≤ FIN L√ìGICA RECURRENCIA ‚ñ≤‚ñ≤‚ñ≤ ---
                
                // Genera el <select> para el estado
                const statusOptions = ['Pendiente', 'En Curso', 'En Revisi√≥n', 'Completada'];
                const statusSelectHtml = `
                    <select onchange="updateTaskStatus(this, '${task.id}')" 
                            class="text-xs font-semibold p-1 border rounded-md ${getStatusColorClass(task.status)}">
                        ${statusOptions.map(opt => 
                            `<option value="${opt}" ${task.status === opt ? 'selected' : ''}>${opt}</option>`
                        ).join('')}
                    </select>
                `;

                html += `<div class="border-l-4 p-4 rounded-r-lg ${task.status === 'Completada' ? 'bg-gray-100 opacity-60' : 'bg-white shadow-sm'}" style="border-left-color: ${getPriorityColor(task.priority)}">
                            <div class="flex items-start gap-3">
                                
                                <div class="flex-1">
                                    <div class="flex items-center flex-wrap gap-1">
                                        <h4 class="font-semibold ${task.status === 'Completada' ? 'line-through' : ''}">${escapeHtml(task.title)}</h4>
                                        ${recurrenceBadge}
                                    </div>
                                    ${assignmentText}
                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 mt-1">
                                        <span>${categoryEmojis[task.category] || 'üìã'} ${task.category}</span>
                                        <span>‚è±Ô∏è ${task.time_estimate} min</span>
                                        ${task.due_date ? `<span>üìÖ ${new Date(task.due_date).toLocaleString()}</span>` : ''}
                                    </div>
                                    ${task.notes ? `<p class="text-sm text-gray-600 mt-2">${escapeHtml(task.notes)}</p>` : ''}
                                </div>
                                
                                <div class="flex flex-col gap-2 items-end w-40 flex-shrink-0">
                                    ${statusSelectHtml} <div class="flex gap-1">
                                        <button onclick="selectTaskForEdit('${task.id}')" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md font-semibold">Editar</button>
                                        <button onclick="deleteTask('${task.id}')" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-md">‚úï</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
            });
            
            container.innerHTML = html;
        }

        // Funci√≥n auxiliar para dar color al <select>
        function getStatusColorClass(status) {
            switch (status) {
                case 'Pendiente': return 'bg-gray-200 text-gray-800';
                case 'En Curso': return 'bg-blue-100 text-blue-800';
                case 'En Revisi√≥n': return 'bg-yellow-100 text-yellow-800';
                case 'Completada': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-200';
            }
        }

        /**
         * Funci√≥n auxiliar para clonar una tarea y programarla para el futuro
         */
        async function createNextRecurringTask(originalTask) {
            try {
                // 1. Calcular la nueva fecha
                let nextDate = originalTask.due_date ? new Date(originalTask.due_date) : new Date();
                
                switch (originalTask.recurrence) {
                    case 'diaria':
                        nextDate.setDate(nextDate.getDate() + 1);
                        break;
                    case 'semanal':
                        nextDate.setDate(nextDate.getDate() + 7);
                        break;
                    case 'mensual':
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        break;
                }

                // 2. Preparar datos de la nueva tarea
                const newTaskData = {
                    user: originalTask.user,
                    assigned_by: originalTask.assigned_by, // Mantiene la asignaci√≥n original
                    title: originalTask.title, // Mismo nombre
                    category: originalTask.category,
                    priority: originalTask.priority,
                    recurrence: originalTask.recurrence, // La nueva tarea TAMBI√âN ser√° recurrente
                    time_estimate: originalTask.time_estimate,
                    notes: originalTask.notes,
                    due_date: nextDate.toISOString(),
                    status: 'Pendiente', // Nace pendiente
                    completed_at: null
                };

                // 3. Guardar en PocketBase
                const createdTask = await pb.collection('agenda_tasks').create(newTaskData);
                
                // 4. Expandir datos para mostrar nombres correctamente
                const expandedTask = await pb.collection('agenda_tasks').getOne(createdTask.id, {
                    expand: 'user,assigned_by'
                });

                // 5. A√±adir a la lista local
                agendaTasks.unshift(expandedTask);
                
                // Notificar al usuario (opcional, usando Toast o Alert)
                // alert(`üîÑ Se ha generado autom√°ticamente la pr√≥xima tarea para el: ${nextDate.toLocaleDateString()}`);

            } catch (err) {
                console.error("Error al crear tarea recurrente:", err);
            }
        }

        function selectTaskForEdit(taskId) {
            const task = agendaTasks.find(t => t.id === taskId);
            if (!task) return;

            // 1. Rellena el formulario con los datos de la tarea
            document.getElementById('detailed-task-id').value = task.id;
            document.getElementById('detailed-title').value = task.title;
            document.getElementById('category').value = task.category;
            document.getElementById('priority').value = task.priority;
            document.getElementById('recurrence').value = task.recurrence || 'ninguna';
            document.getElementById('time-estimate').value = task.time_estimate;
            document.getElementById('notes').value = task.notes;

            // 2. Formatea la fecha y hora para los inputs
            if (task.due_date) {
                document.getElementById('due-date').value = task.due_date.substring(0, 10);
                document.getElementById('due-time').value = task.due_date.substring(11, 16);
            } else {
                document.getElementById('due-date').value = '';
                document.getElementById('due-time').value = '';
            }

            // 3. Rellena el men√∫ de "Asignar A" (si es admin)
            const userSelect = document.getElementById('assign-to-user');
            if (userSelect && hasPermission('assign_tasks')) {
                userSelect.value = task.user; 
            }

            // 4. Cambia la interfaz al modo "Edici√≥n"
            document.getElementById('detailed-task-title').textContent = '‚úèÔ∏è Modificar Tarea';
            document.getElementById('add-detailed-btn').textContent = 'Guardar Cambios';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');

            // 5. Desplaza la vista al formulario de edici√≥n
            document.getElementById('detailed-task-title').scrollIntoView({ behavior: 'smooth' });
        }

        function resetDetailedTaskForm() {
            // 1. Limpia los campos
            document.getElementById('detailed-task-id').value = '';
            document.getElementById('detailed-title').value = '';
            document.getElementById('time-estimate').value = '';
            document.getElementById('notes').value = '';
            document.getElementById('due-date').value = '';
            document.getElementById('due-time').value = '';
            document.getElementById('recurrence').value = 'ninguna';

            // 2. Restaura la interfaz al modo "Crear"
            document.getElementById('detailed-task-title').textContent = 'üìù Crear Tarea Detallada';
            document.getElementById('add-detailed-btn').textContent = 'Crear Tarea';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
        }

        function getPriorityColor(priority) {
            switch (priority) {
                case 'baja': return '#22c55e'; // Verde
                case 'media': return '#f59e0b'; // Naranja
                case 'alta': return '#ef4444'; // Rojo
                case 'urgente': return '#8b0000'; // Rojo Oscuro
                default: return '#6b7280'; // Gris
            }
        }

        // --- Funci√≥n para filtrar tareas ---
        function filterTasks(filter) {
            currentFilter = filter; // filter ahora es 'all', 'Pendiente', 'En Curso', etc.
            
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-custom', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            
            // Genera el ID del bot√≥n a partir del filtro (ej: "En Curso" -> "filter-en-curso")
            let buttonId = 'filter-' + filter.toLowerCase().replace(' ', '-');
            const activeBtn = document.getElementById(buttonId);
            
            if (activeBtn) {
                activeBtn.classList.add('bg-blue-custom', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            }
            
            renderTasks();
        }

        // --- Funciones del Timer Pomodoro (SIN CAMBIOS) ---
        let timerInterval = null;
        let currentTime = 25 * 60; // 25 minutos en segundos
        let pomodoroSession = 1;
        let totalPomodoroSessions = 4;
        let isTimerRunning = false;
        let currentMode = 'work'; // 'work', 'shortBreak', 'longBreak'

        // --- FUNCI√ìN: Poblar Tareas en el Timer ---
        // Llena el men√∫ desplegable con las tareas pendientes
        function populateTimerTasks() {
            const taskSelect = document.getElementById('pomodoro-task');
            taskSelect.innerHTML = '<option value="">Seleccionar Tarea a Enfocar...</option>';
            
            const pendingTasks = agendaTasks.filter(task => !task.is_completed);
            
            pendingTasks.forEach(task => {
                const option = document.createElement('option');
                option.value = task.id;
                option.textContent = `(${task.time_estimate}m) ${escapeHtml(task.title)}`;
                taskSelect.appendChild(option);
            });
        }

        // --- FUNCI√ìN: Establecer Tiempo ---
        // Es llamada por los botones de presets (25m, 5m, 15m)
        function setTimer(minutes, mode) {
            pauseTimer(); // Detiene cualquier timer que est√© corriendo
            currentTime = minutes * 60;
            currentMode = mode;
            updateTimerDisplay();
            updatePomodoroInfo();
        }

        function startTimer() {
            if (isTimerRunning) return; // Evita m√∫ltiples intervalos
            isTimerRunning = true;
            
            // Lee los valores actuales al iniciar
            totalPomodoroSessions = parseInt(document.getElementById('pomodoro-sessions').value);
            updatePomodoroInfo(); // Actualiza el texto
            
            timerInterval = setInterval(() => {
                currentTime--;
                updateTimerDisplay();
                
                if (currentTime <= 0) {
                    pauseTimer(); // Detiene el intervalo
                    
                    if (currentMode === 'work') {
                        pomodoroSession++;
                        if (pomodoroSession > totalPomodoroSessions) {
                            // Ciclo completado, descanso largo
                            alert('¬°Ciclo Pomodoro completado! üçÖ Inicia un descanso largo (15 min).');
                            setTimer(15, 'longBreak');
                        } else {
                            // Descanso corto
                            alert('¬°Sesi√≥n de trabajo completada! üçÖ Inicia un descanso corto (5 min).');
                            setTimer(5, 'shortBreak');
                        }
                    } else {
                        // El descanso termin√≥, volver al trabajo
                        if (currentMode === 'longBreak') {
                            pomodoroSession = 1; // Reinicia el conteo de sesiones
                        }
                        alert('¬°Descanso terminado! üçÖ Hora de volver al trabajo.');
                        setTimer(25, 'work');
                    }
                    // Inicia autom√°ticamente el siguiente timer (opcional, puedes quitarlo si prefieres inicio manual)
                    startTimer(); 
                }
            }, 1000);
        }

        function pauseTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
            }
        }

        function resetTimer() {
            pauseTimer();
            pomodoroSession = 1;
            totalPomodoroSessions = parseInt(document.getElementById('pomodoro-sessions').value);
            setTimer(25, 'work'); // Resetea a 25 minutos de trabajo
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            const display = document.getElementById('timer-display');
            if (display) {
                display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        function updatePomodoroInfo() {
            const info = document.getElementById('pomodoro-info');
            if (!info) return;

            let modeText = "Trabajo";
            if (currentMode === 'shortBreak') modeText = "Descanso Corto";
            if (currentMode === 'longBreak') modeText = "Descanso Largo";
            
            // Intenta obtener la tarea seleccionada
            const taskSelect = document.getElementById('pomodoro-task');
            let taskName = "";
            if (taskSelect && taskSelect.value) {
                taskName = taskSelect.options[taskSelect.selectedIndex].text.split(') ')[1];
            }
            
            if (currentMode === 'work') {
                info.textContent = `Sesi√≥n ${pomodoroSession} de ${totalPomodoroSessions} - ${taskName || modeText}`;
            } else {
                info.textContent = `Modo: ${modeText}`;
            }
        }

        // --- Funci√≥n de Estad√≠sticas ---
        // (Modificada para usar 'agendaTasks' y campos de PocketBase)
        function updateStats() {
            
            // --- 1. C√ÅLCULO DE ESTAD√çSTICAS PERSONALES (MI PROGRESO) ---
            // Filtra solo las tareas asignadas A M√ç (al usuario logueado)
            const myTasks = agendaTasks.filter(t => t.user === pb.authStore.model.id);

            // --- Progreso Total (Personal) ---
            const totalMyTasks = myTasks.length;
            // CORRECCI√ìN: Contamos usando el nuevo status
            const completedMyTasks = myTasks.filter(t => t.status === 'Completada').length;
            let totalPercentage = (totalMyTasks > 0) ? Math.round((completedMyTasks / totalMyTasks) * 100) : 0;
            
            document.getElementById('stats-total-progress-text').textContent = `${completedMyTasks} / ${totalMyTasks}`;
            document.getElementById('stats-total-progress-bar').style.width = `${totalPercentage}%`;
            document.getElementById('productivity').textContent = `${totalPercentage}%`;
            document.getElementById('productivity-bar').style.width = `${totalPercentage}%`;

            // --- Tareas Completadas Hoy (Personal) ---
            const today = new Date().toDateString();
            let totalMinutesToday = 0;
            let completedTodayCount = 0;

            myTasks.forEach(task => { // Usamos myTasks
                // CORRECCI√ìN: Verificamos el status y completed_at
                if (task.status === 'Completada' && task.completed_at && new Date(task.completed_at).toDateString() === today) {
                    totalMinutesToday += task.time_estimate || 0;
                    completedTodayCount++;
                }
            });
            document.getElementById('completed-tasks').textContent = completedTodayCount;
            const hours = Math.floor(totalMinutesToday / 60);
            const minutes = totalMinutesToday % 60;
            document.getElementById('focused-time').textContent = `${hours}h ${minutes}m`;

            // --- Tareas de la Semana (Personal) ---
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            // CORRECCI√ìN: Verificamos el status
            const completedThisWeek = myTasks.filter(t => t.status === 'Completada' && t.completed_at && new Date(t.completed_at) > weekAgo).length;
            document.getElementById('stats-week-tasks').textContent = completedThisWeek;
            
            // --- Racha Diaria (Personal) ---
            const dayInMillis = 24 * 60 * 60 * 1000;
            const todayTimestamp = new Date().setHours(0, 0, 0, 0);

            const uniqueDays = [...new Set(myTasks // Usamos myTasks
                // CORRECCI√ìN: Verificamos el status
                .filter(t => t.status === 'Completada' && t.completed_at)
                .map(t => new Date(t.completed_at).setHours(0, 0, 0, 0))
            )].sort((a, b) => b - a);

            let streak = 0;
            if (uniqueDays.length > 0) {
                if (uniqueDays[0] === todayTimestamp || uniqueDays[0] === (todayTimestamp - dayInMillis)) {
                    streak = 1;
                    for (let i = 0; i < uniqueDays.length - 1; i++) {
                        const currentDay = uniqueDays[i];
                        const previousDay = uniqueDays[i+1];
                        if (currentDay - previousDay === dayInMillis) {
                            streak++;
                        } else {
                            break;
                        }
                    }
                }
            }
            document.getElementById('streak').textContent = streak;

            // --- Desglose por Categor√≠a (Personal) ---
            const categoryBreakdownContainer = document.getElementById('stats-category-breakdown');
            const categoryCounts = {};
            const categoryTotals = {};
            const categories = ['trabajo', 'personal', 'salud', 'estudios', 'hogar'];
            categories.forEach(cat => { categoryCounts[cat] = 0; categoryTotals[cat] = 0; });

            myTasks.forEach(task => { // Usamos myTasks
                if (categoryTotals.hasOwnProperty(task.category)) {
                    categoryTotals[task.category]++;
                    // CORRECCI√ìN: Verificamos el status
                    if (task.status === 'Completada') {
                        categoryCounts[task.category]++;
                    }
                }
            });

            const categoryEmojis = { trabajo: 'üíº', personal: 'üë§', salud: 'üí™', estudios: 'üìö', hogar: 'üè†' };
            let categoryHtml = '';
            categories.forEach(cat => {
                const total = categoryTotals[cat];
                if (total > 0) {
                    const completed = categoryCounts[cat];
                    const percentage = Math.round((completed / total) * 100);
                    categoryHtml += `
                        <div class="text-sm">
                            <div class="flex justify-between mb-1">
                                <span class="font-medium">${categoryEmojis[cat] || 'üìã'} ${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
                                <span class="text-gray-500">${completed} / ${total}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-orange-custom h-2 rounded-full" style="width: ${percentage}%"></div></div>
                        </div>`;
                }
            });
            categoryBreakdownContainer.innerHTML = categoryHtml || '<p class="text-sm text-gray-500 text-center">No hay tareas con categor√≠a.</p>';


            // --- 2. C√ÅLCULO DE ESTAD√çSTICAS DE EQUIPO (SOLO ADMIN) ---
            const teamBreakdownContainer = document.getElementById('stats-team-breakdown');
            //const isAdmin = pb.authStore.model.expand.role.name === 'admin';
            
            if (hasPermission('assign_tasks') && teamBreakdownContainer) {
                teamBreakdownContainer.innerHTML = '';
                let teamHtml = '';

                users.forEach(user => {
                    if (user.id === pb.authStore.model.id) return; 

                    const userTasks = agendaTasks.filter(task => task.user === user.id);
                    const total = userTasks.length;

                    if (total > 0) {
                        // 1. Contar tareas por cada estado
                        const pending = userTasks.filter(t => t.status === 'Pendiente').length;
                        const inProgress = userTasks.filter(t => t.status === 'En Curso').length;
                        const inReview = userTasks.filter(t => t.status === 'En Revisi√≥n').length;
                        const completed = userTasks.filter(t => t.status === 'Completada').length;
                        
                        const avatarUrl = user.avatar ? pb.files.getURL(user, user.avatar, {'thumb':'50x50'}) : 'data:image/svg+xml;base64,...'; // (SVG omitido por brevedad)

                        // 2. Generar el nuevo HTML con el desglose
                        teamHtml += `
                            <div class="text-sm mt-4 pt-3 border-t">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex items-center gap-2">
                                        <img src="${avatarUrl}" class="w-6 h-6 rounded-full object-cover bg-gray-200">
                                        <span class="font-medium">${escapeHtml(user.name)}</span>
                                    </div>
                                    <span class="font-semibold text-gray-500">Completadas: ${completed} / ${total}</span>
                                </div>
                                
                                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                                    <div class="p-1 bg-gray-100 rounded">
                                        <span class="block font-semibold text-gray-700">${pending}</span>
                                        <span class="text-gray-500">Pendiente</span>
                                    </div>
                                    <div class="p-1 bg-blue-100 rounded">
                                        <span class="block font-semibold text-blue-800">${inProgress}</span>
                                        <span class="text-blue-600">En Curso</span>
                                    </div>
                                    <div class="p-1 bg-yellow-100 rounded">
                                        <span class="block font-semibold text-yellow-800">${inReview}</span>
                                        <span class="text-yellow-600">Revisi√≥n</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                if (teamHtml === '') {
                    teamBreakdownContainer.innerHTML = '<p class="text-sm text-gray-500 text-center">No hay tareas asignadas a otros usuarios.</p>';
                } else {
                    teamBreakdownContainer.innerHTML = teamHtml;
                }
            }
        }        

        //ANALISIS DE MOROSIDAD
        function showMorosidadReport() {
            // 1. Prepara el filtro de empresa ANTES de mostrar
            updateMorosidadCompanyFilter(); 
            
            // 2. Genera el reporte (ahora usar√° el filtro)
            generateAndDisplayMorosidad();
            
            // 3. Muestra la secci√≥n
            showSection('morosidadSection');
        }

        /**
         * Funci√≥n principal que calcula y muestra el reporte de morosidad.
         */
        function generateAndDisplayMorosidad() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Estandarizar 'hoy' a medianoche
            
            let totales = { '0-30': 0, '31-60': 0, '61-90': 0, '90+': 0, total: 0 };
            const tbody = document.getElementById('morosidadTableBody');
            tbody.innerHTML = '';

            // 1. Filtra por tipo de documento (Factura/Recibo) y estado (Pendiente)
            let documentosPendientes = documents.filter(doc => 
                (doc.type?.toLowerCase() === 'factura' || doc.type?.toLowerCase() === 'recibo') && 
                doc.payment_status?.toLowerCase() === 'pendiente'
            );

            // 2. Filtra por la empresa seleccionada
            if (morosidadCompanyFilter !== 'all') {
                documentosPendientes = documentosPendientes.filter(doc => doc.company === morosidadCompanyFilter);
            }

            // 3. Mapea los datos (calculando monto, estado, etc.)
            let reporteData = documentosPendientes.map(doc => {
                const fechaVencimiento = doc.due_date ? new Date(doc.due_date) : new Date(doc.date);
                fechaVencimiento.setHours(0, 0, 0, 0);
                const diffTime = today - fechaVencimiento;
                const diasVencido = Math.max(0, Math.floor(diffTime / (1000 * 60 * 60 * 24)));
                const monto = doc.total || doc.amount || 0;
                
                // Calcula el estado aqu√≠ mismo para usarlo en el sort y export
                let estadoInfo;
                if (diasVencido <= 0) { estadoInfo = { texto: 'Al D√≠a', clase: 'bg-green-100 text-green-800' }; }
                else if (diasVencido <= 30) { estadoInfo = { texto: '1-30 d√≠as', clase: 'bg-green-100 text-green-800' }; }
                else if (diasVencido <= 60) { estadoInfo = { texto: '31-60 d√≠as', clase: 'bg-yellow-100 text-yellow-800' }; }
                else if (diasVencido <= 90) { estadoInfo = { texto: '61-90 d√≠as', clase: 'bg-orange-100 text-orange-800' }; }
                else { estadoInfo = { texto: 'M√°s de 90 d√≠as', clase: 'bg-red-100 text-red-800' }; }
                
                return { doc, fechaVencimiento, diasVencido, monto, estadoInfo };
            });

            // 4. Ordena los datos
            reporteData.sort((a, b) => {
                let comparison = 0;
                
                switch (morosidadSortBy) {
                    case 'cliente':
                        const clienteA = a.doc.clientName?.toLowerCase() || '';
                        const clienteB = b.doc.clientName?.toLowerCase() || '';
                        if (clienteA > clienteB) comparison = 1;
                        if (clienteA < clienteB) comparison = -1;
                        if (comparison === 0) {
                            comparison = b.diasVencido - a.diasVencido;
                        }
                        break;
                    
                    case 'monto':
                        comparison = (a.monto || 0) - (b.monto || 0); 
                        if (comparison === 0) {
                            const clienteA = a.doc.clientName?.toLowerCase() || '';
                            const clienteB = b.doc.clientName?.toLowerCase() || '';
                            if (clienteA > clienteB) comparison = 1;
                            if (clienteA < clienteB) comparison = -1;
                        }
                        break;

                    case 'dias':
                        comparison = (a.diasVencido || 0) - (b.diasVencido || 0);
                        if (comparison === 0) {
                            comparison = (a.monto || 0) - (b.monto || 0);
                        }
                        break;
                }
                
                return (morosidadSortOrder === 'asc') ? comparison : (comparison * -1);
            });
            
            // 5. Guarda los datos filtrados y ordenados en la variable global para exportar
            morosidadReportData = reporteData;

            // 6. Renderiza la tabla
            if (reporteData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No hay documentos pendientes que coincidan con los filtros.</td></tr>`;
            } else {
                reporteData.forEach(data => {
                    const { doc, fechaVencimiento, diasVencido, monto, estadoInfo } = data;
                    
                    // Suma a los totales
                    if (diasVencido <= 30) { totales['0-30'] += monto; }
                    else if (diasVencido <= 60) { totales['31-60'] += monto; }
                    else if (diasVencido <= 90) { totales['61-90'] += monto; }
                    else { totales['90+'] += monto; }
                    totales.total += monto;

                    const fila = document.createElement('tr');
                    const docColor = (doc.type?.toLowerCase() === 'recibo') ? 'text-orange-custom' : 'text-blue-custom';

                    fila.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHtml(doc.clientName)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${docColor}">${escapeHtml(doc.number)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(doc.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fechaVencimiento.toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">L ${formatNumber(doc.balance || monto)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${diasVencido > 0 ? 'text-red-600' : 'text-green-600'}">${diasVencido} d√≠as</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${estadoInfo.clase}">
                                ${estadoInfo.texto}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openPaymentModal('${doc.id}')" class="flex items-center gap-1 text-white bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md shadow-sm transition-colors">
                                <span>üíµ</span> Abonar
                            </button>
                        </td>
                    `;
                    tbody.appendChild(fila);
                });
            }

            // 7. Actualiza las tarjetas de resumen
            document.getElementById('morosidad-rango-30').textContent = `L ${formatNumber(totales['0-30'])}`;
            document.getElementById('morosidad-rango-60').textContent = `L ${formatNumber(totales['31-60'])}`;
            document.getElementById('morosidad-rango-90').textContent = `L ${formatNumber(totales['61-90'])}`;
            document.getElementById('morosidad-rango-90-plus').textContent = `L ${formatNumber(totales['90+'])}`;
            document.getElementById('morosidad-total').textContent = `L ${formatNumber(totales.total)}`;

            // 8. Actualiza los indicadores de orden üîº/üîΩ
            document.getElementById('sort-cliente').textContent = 'Cliente';
            document.getElementById('sort-monto').textContent = 'Total Factura';
            document.getElementById('sort-dias').textContent = 'D√≠as Vencido';
            
            const activeHeader = document.getElementById(`sort-${morosidadSortBy}`);
            if (activeHeader) {
                activeHeader.textContent += (morosidadSortOrder === 'asc' ? ' üîº' : ' üîΩ');
            }
        }

        /**
         * Se llama al hacer clic en un encabezado de la tabla de morosidad.
         * Actualiza las variables globales de ordenamiento y vuelve a dibujar la tabla.
         */
        function sortMorosidadReport(sortBy) {
            if (morosidadSortBy === sortBy) {
                // Invierte el orden
                morosidadSortOrder = (morosidadSortOrder === 'asc') ? 'desc' : 'asc';
            } else {
                // Columna nueva
                morosidadSortBy = sortBy;
                
                // El orden por defecto para 'monto' y 'dias' es DESCENDENTE (m√°s √∫til)
                if (sortBy === 'monto' || sortBy === 'dias') {
                    morosidadSortOrder = 'desc';
                } else {
                    morosidadSortOrder = 'asc';
                }
            }
            
            // Vuelve a generar el reporte con el nuevo orden
            generateAndDisplayMorosidad();
        }

        /**
         * Rellena el men√∫ desplegable del filtro de empresas en el reporte de morosidad.
         */
        function updateMorosidadCompanyFilter() {
            const filterSelect = document.getElementById('morosidadCompanyFilter');
            if (!filterSelect) return; 

            let options = '<option value="all">Todas las Empresas</option>';
            companies.forEach(company => {
                options += `<option value="${company.id}">${escapeHtml(company.name)}</option>`;
            });
            filterSelect.innerHTML = options;
            filterSelect.value = morosidadCompanyFilter;
        }

        /**
         * Se llama cuando el usuario cambia la empresa en el filtro de morosidad.
         */
        function filterMorosidadByCompany(companyId) {
            morosidadCompanyFilter = companyId;
            generateAndDisplayMorosidad(); // Vuelve a dibujar el reporte
        }

        function exportMorosidadToExcel() {
            if (morosidadReportData.length === 0) {
                alert('No hay datos en el reporte actual para exportar.');
                return;
            }

            // 1. Define los encabezados
            const headers = [
                "Cliente", "Documento", "N√∫mero", "F. Emisi√≥n", "F. Vencimiento",
                "Monto Total", "D√≠as Vencido", "Estado"
            ];

            // 2. Mapea los datos desde la variable global
            const data = morosidadReportData.map(item => {
                return [
                    item.doc.clientName,
                    item.doc.type,
                    item.doc.number,
                    new Date(item.doc.date).toLocaleDateString(),
                    item.fechaVencimiento.toLocaleDateString(),
                    item.monto,
                    item.diasVencido,
                    item.estadoInfo.texto // El texto del estado (ej: "31-60 d√≠as")
                ];
            });

            // 3. Crea la hoja y el libro (SheetJS)
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            
            // Ajustar anchos de columna
            const colWidths = [
                { wch: 30 }, // Cliente
                { wch: 10 }, // Documento
                { wch: 20 }, // N√∫mero
                { wch: 12 }, // F. Emisi√≥n
                { wch: 12 }, // F. Vencimiento
                { wch: 15 }, // Monto Total
                { wch: 12 }, // D√≠as Vencido
                { wch: 15 }  // Estado
            ];
            ws['!cols'] = colWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte de Morosidad");

            // 4. Descarga el archivo
            XLSX.writeFile(wb, `reporte_morosidad_${morosidadCompanyFilter}.xlsx`);
        }

        /**
         * Funci√≥n para marcar una factura como "Pagada"
         */
        async function marcarDocumentoComoPagado(documentId) {
            if (!confirm('¬øEst√°s seguro de que deseas marcar este documento como "Pagado"?')) return;

            try {
                const updatedRecord = await pb.collection('documents').update(documentId, {
                    'payment_status': 'Pagada'
                });

                const index = documents.findIndex(doc => doc.id === documentId);
                if (index !== -1) {
                    documents[index] = updatedRecord;
                }

                generateAndDisplayMorosidad();
                alert('¬°Documento marcado como pagado!');

            } catch (err) {
                console.error("Error al marcar como pagado:", err);
                alert('Error al actualizar el documento.');
            }
        }
        
        // --- L√ìGICA DE PAGOS PARCIALES ---        
        async function openPaymentModal(docId) {
            const doc = documents.find(d => d.id === docId);
            if (!doc) return;

            // 1. Configuraci√≥n b√°sica (como antes)
            const total = doc.total || doc.amount || 0;
            const currentBalance = (doc.balance !== undefined && doc.balance !== 0) ? doc.balance : total;

            document.getElementById('payDocId').value = doc.id;
            document.getElementById('payDocNumber').textContent = doc.number;
            document.getElementById('payDocTotal').textContent = `L ${formatNumber(total)}`;
            document.getElementById('payDocBalance').textContent = `L ${formatNumber(currentBalance)}`;
            
            const amountInput = document.getElementById('paymentAmount');
            amountInput.value = '';
            amountInput.max = currentBalance;
            amountInput.placeholder = `M√°ximo: ${currentBalance}`;
            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
            
            // 2. Cargar el Historial de Pagos
            const historyList = document.getElementById('paymentHistoryList');
            historyList.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-gray-400">Cargando historial...</td></tr>';
            
            document.getElementById('paymentModal').classList.remove('hidden');
            amountInput.focus();

            try {
                // Buscamos en la nueva colecci√≥n 'payments'
                const payments = await pb.collection('payments').getFullList({
                    filter: `document = "${doc.id}"`,
                    sort: '-date' // Los m√°s recientes primero
                });

                historyList.innerHTML = '';
                
                if (payments.length === 0) {
                    historyList.innerHTML = '<tr><td colspan="3" class="p-3 text-center text-gray-400 text-xs">No hay pagos registrados a√∫n.</td></tr>';
                } else {
                    payments.forEach(pay => {
                        // Formatear fecha para mostrar (ajustar zona horaria si es necesario)
                        const dateStr = new Date(pay.date).toLocaleDateString();
                        
                        const row = `
                            <tr class="bg-white">
                                <td class="px-3 py-2 text-gray-600">${dateStr}</td>
                                <td class="px-3 py-2 text-gray-600">${escapeHtml(pay.method)}</td>
                                <td class="px-3 py-2 text-right font-medium text-green-600">L ${formatNumber(pay.amount)}</td>
                            </tr>
                        `;
                        historyList.innerHTML += row;
                    });
                }
            } catch (err) {
                console.error("Error cargando historial:", err);
                historyList.innerHTML = '<tr><td colspan="3" class="p-2 text-center text-red-400">Error al cargar.</td></tr>';
            }
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.add('hidden');
        }

        async function processPayment(event) {
            event.preventDefault();
            
            const docId = document.getElementById('payDocId').value;
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentMethod = document.getElementById('paymentMethodModal').value;

            if (!amount || amount <= 0) {
                alert("Por favor ingresa un monto v√°lido.");
                return;
            }

            const doc = documents.find(d => d.id === docId);
            const currentBalance = (doc.balance !== undefined && doc.balance !== 0) ? doc.balance : (doc.total || doc.amount);

            if (amount > currentBalance) {
                alert(`El abono (L ${amount}) no puede ser mayor al saldo pendiente.`);
                return;
            }

            const newBalance = currentBalance - amount;
            let newStatus = newBalance <= 0.01 ? 'Pagada' : 'Pendiente';

            try {
                // 1. Actualizar el saldo de la factura (Como antes)
                await pb.collection('documents').update(docId, {
                    balance: newBalance,
                    payment_status: newStatus
                });

                // --- ‚ñº‚ñº‚ñº NUEVO: GUARDAR EL REGISTRO DEL PAGO ‚ñº‚ñº‚ñº ---
                await pb.collection('payments').create({
                    document: docId,
                    amount: amount,
                    date: paymentDate,
                    method: paymentMethod,
                    created_by: pb.authStore.model.id
                });
                // --- ‚ñ≤‚ñ≤‚ñ≤ FIN DE LO NUEVO ‚ñ≤‚ñ≤‚ñ≤ ---

                alert(`¬°Abono de L ${formatNumber(amount)} registrado con √©xito!`);
                
                closePaymentModal();
                await loadData(); 
                
                if (!document.getElementById('morosidadSection').classList.contains('hidden')) {
                    generateAndDisplayMorosidad();
                }

            } catch (err) {
                console.error("Error al registrar pago:", err);
                alert("Error al procesar el pago.");
            }
        }

        //HISTORIAL
        function updateCompanyFilter() {
            const historyCompanyFilter = document.getElementById('historyCompanyFilter');
            // Verificamos si el elemento existe antes de continuar
            if (!historyCompanyFilter) return;

            let options = '<option value="all">Todas las Empresas</option>';
            companies.forEach(company => {
                options += `<option value="${company.id}">${escapeHtml(company.name)}</option>`;
            });
            historyCompanyFilter.innerHTML = options;
            historyCompanyFilter.value = currentHistoryCompany;
        }

        function showHistory() {
            // Primero, poblamos los filtros AHORA que la secci√≥n ser√° visible
            updateCompanyFilter();
            
            // Luego, cargamos el contenido del historial
            loadHistory();
            
            // Finalmente, mostramos la secci√≥n
            showSection('historySection');
        }

        function exportToExcel() {
            // 1. Verifica si hay datos en la vista actual para exportar.
            // Usa la variable global 'currentlyDisplayedDocs' que se actualiza con los filtros.
            if (currentlyDisplayedDocs.length === 0) {
                alert('No hay datos en la vista actual para exportar.');
                return;
            }

            // 2. Define los encabezados para las columnas del archivo Excel.
            const headers = [
                "ID", "Tipo", "Numero", "Fecha", "Empresa", "RTN Empresa", 
                "Cliente", "Subtotal", "Descuento", "ISV", "Total", 
                "Metodo de Pago", "Observaciones", "Art√≠culos"
            ];

            // 3. Prepara los datos, convirtiendo cada documento en una fila para el Excel.
            const data = currentlyDisplayedDocs.map(doc => {
                const docCompany = doc.expand && doc.expand.company;
                
                // Formatea la lista de art√≠culos para que quepa en una sola celda.
                let itemsString = '';
                if (doc.type?.toLowerCase() === 'factura') {
                    // Busca los art√≠culos relacionados en la lista global 'invoice_items'.
                    const relatedItems = invoice_items.filter(item => item.invoice === doc.id);
                    itemsString = relatedItems.map(item => `${item.quantity}x ${item.description} @ L${item.price}`).join('; ');
                } else {
                    // Para los recibos, usamos el campo 'concept'.
                    itemsString = doc.concept || '';
                }

                return [
                    doc.id,
                    doc.type,
                    doc.number,
                    new Date(doc.date).toLocaleDateString(),
                    docCompany ? docCompany.name : 'N/A',
                    docCompany ? docCompany.rtn : 'N/A',
                    doc.clientName,
                    doc.subtotal || doc.amount || 0,
                    doc.discount_amount || 0,
                    doc.taxAmount || 0,
                    doc.total || doc.amount || 0,
                    doc.paymentMethod,
                    doc.observations,
                    itemsString
                ];
            });

            // 4. Usa la biblioteca SheetJS para crear la hoja de c√°lculo.
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

            // 5. (Opcional pero recomendado) Ajusta autom√°ticamente el ancho de las columnas.
            const colWidths = headers.map(header => ({ wch: header.length + 5 }));
            data.forEach(row => {
                row.forEach((cell, i) => {
                    const len = cell ? String(cell).length : 10;
                    if (colWidths[i].wch < len) {
                        colWidths[i].wch = len;
                    }
                });
            });
            ws['!cols'] = colWidths;

            // 6. Crea el libro de trabajo y a√±ade la hoja.
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte Filtrado");

            // 7. Genera y descarga el archivo .xlsx.
            XLSX.writeFile(wb, "reporte_filtrado.xlsx");
        }
        
        //ESTADO DE CUENTA CLIENTE
        /**
         * Muestra la pantalla de Estado de Cuenta y rellena los filtros.
         */
        function showAccountStatement() {
            // 1. Rellena el filtro de empresas
            const companySelect = document.getElementById('statementCompanyFilter');
            let companyOptions = '<option value="all">Todas las Empresas</option>';
            companies.forEach(company => {
                companyOptions += `<option value="${company.id}">${escapeHtml(company.name)}</option>`;
            });
            companySelect.innerHTML = companyOptions;

            // 2. Rellena el filtro de clientes (usando los nombres)
            const clientSelect = document.getElementById('statementClientFilter');
            let clientOptions = '<option value="">Seleccione un Cliente...</option>';
            // Usamos 'clients' (tu maestro de clientes) para rellenar el filtro
            clients.forEach(client => {
                clientOptions += `<option value="${escapeHtml(client.name)}">${escapeHtml(client.name)}</option>`;
            });
            clientSelect.innerHTML = clientOptions;

            // 3. Resetea la vista previa y oculta el bot√≥n de imprimir
            document.getElementById('statement-preview').innerHTML = '<p class="text-center text-gray-500">Seleccione una empresa y un cliente para generar el estado de cuenta.</p>';
            document.getElementById('statement-print-btn-container').classList.add('hidden');
            
            // 4. Muestra la secci√≥n
            showSection('accountStatementSection');
        }

        /**
         * Genera el reporte en la pantalla basado en los filtros.
         */
        function generateAccountStatement() {
            const companyId = document.getElementById('statementCompanyFilter').value;
            const clientName = document.getElementById('statementClientFilter').value;
            const preview = document.getElementById('statement-preview');
            
            if (!clientName) {
                alert("Por favor, seleccione un cliente.");
                return;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 1. Filtra los documentos pendientes para ESE cliente
            let filteredDocs = documents.filter(doc => 
                doc.clientName === clientName &&
                (doc.type?.toLowerCase() === 'factura' || doc.type?.toLowerCase() === 'recibo') && 
                doc.payment_status?.toLowerCase() === 'pendiente'
            );
            
            // 2. Filtra por empresa (si se seleccion√≥ una)
            if (companyId !== 'all') {
                filteredDocs = filteredDocs.filter(doc => doc.company === companyId);
            }

            // 3. Mapea y ordena los datos
            const reporteData = filteredDocs.map(doc => {
                const fechaVencimiento = doc.due_date ? new Date(doc.due_date) : new Date(doc.date);
                fechaVencimiento.setHours(0, 0, 0, 0);
                const diffTime = today - fechaVencimiento;
                const diasVencido = Math.max(0, Math.floor(diffTime / (1000 * 60 * 60 * 24)));
                const monto = doc.total || doc.amount || 0;
                return { doc, fechaVencimiento, diasVencido, monto };
            }).sort((a, b) => a.fechaVencimiento - b.fechaVencimiento); // Ordena por fecha de vencimiento

            // 4. Construye el HTML del reporte
            const companyName = (companyId === 'all') ? "Todas las Empresas" : companies.find(c => c.id === companyId)?.name;
            let totalPendiente = 0;
            let tableRows = '';

            if (reporteData.length === 0) {
                tableRows = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Este cliente no tiene documentos pendientes.</td></tr>';
            } else {
                reporteData.forEach(data => {
                    totalPendiente += data.monto;
                    tableRows += `
                        <tr class="border-b">
                            <td class="px-6 py-4">${escapeHtml(data.doc.number)}</td>
                            <td class="px-6 py-4">${new Date(data.doc.date).toLocaleDateString()}</td>
                            <td class="px-6 py-4">${data.fechaVencimiento.toLocaleDateString()}</td>
                            <td class="px-6 py-4 font-medium ${data.diasVencido > 0 ? 'text-red-600' : ''}">${data.diasVencido} d√≠as</td>
                            <td class="px-6 py-4 text-right font-semibold">L ${formatNumber(data.monto)}</td>
                        </tr>
                    `;
                });
            }

            preview.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Estado de Cuenta por Cliente</h2>
                <p class="text-lg font-semibold text-gray-700">Cliente: ${escapeHtml(clientName)}</p>
                <p class="text-sm text-gray-500 mb-6">${escapeHtml(companyName)}</p>
                
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">Documento #</th>
                            <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">F. Emisi√≥n</th>
                            <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">F. Vence</th>
                            <th class="px-6 py-3 text-left font-medium text-gray-500 uppercase">D√≠as Vence</th>
                            <th class="px-6 py-3 text-right font-medium text-gray-500 uppercase">Monto Pendiente</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${tableRows}
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-50 font-bold">
                            <td colspan="4" class="px-6 py-4 text-right text-lg">Total Pendiente:</td>
                            <td class="px-6 py-4 text-right text-lg">L ${formatNumber(totalPendiente)}</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            // Muestra el bot√≥n de imprimir
            document.getElementById('statement-print-btn-container').classList.remove('hidden');
        }

        // ===============================================
        // =        L√ìGICA DE REPORTE DE ABONOS          =
        // ===============================================

        function showPaymentReport() {
            // 1. Rellena el filtro de empresa
            const companySelect = document.getElementById('paymentReportCompany');
            companySelect.innerHTML = '<option value="all">Todas las Empresas</option>';
            companies.forEach(c => {
                const option = document.createElement('option');
                option.value = c.id;
                option.textContent = c.name;
                companySelect.appendChild(option);
            });

            // 2. Establece el mes actual por defecto
            const now = new Date();
            const monthStr = now.toISOString().slice(0, 7); // YYYY-MM
            document.getElementById('paymentReportMonth').value = monthStr;

            // 3. Muestra la secci√≥n
            showSection('paymentReportSection');
            
            // 4. Genera autom√°ticamente el reporte del mes actual
            generatePaymentReport();
        }

        async function generatePaymentReport() {
            const monthInput = document.getElementById('paymentReportMonth').value; // YYYY-MM
            const companyId = document.getElementById('paymentReportCompany').value;
            const methodFilter = document.getElementById('paymentReportMethod').value;
            const tbody = document.getElementById('paymentReportTableBody');

            if (!monthInput) {
                alert("Por favor selecciona un mes.");
                return;
            }

            tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">Cargando datos...</td></tr>';

            try {
                // 1. Calcular rango de fechas para el filtro de PocketBase
                // PocketBase usa UTC, as√≠ que abarcamos el mes completo
                const startDate = `${monthInput}-01 00:00:00`;
                // Calculamos el √∫ltimo d√≠a del mes
                const [year, month] = monthInput.split('-');
                const lastDay = new Date(year, month, 0).getDate();
                const endDate = `${monthInput}-${lastDay} 23:59:59`;

                // 2. Construir filtro
                let filter = `date >= "${startDate}" && date <= "${endDate}"`;
                
                if (methodFilter !== 'all') {
                    filter += ` && method = "${methodFilter}"`;
                }

                // 3. Obtener datos de la colecci√≥n 'payments'
                // Expandimos 'document' para ver el cliente/n√∫mero y 'created_by' para ver qui√©n cobr√≥
                const payments = await pb.collection('payments').getFullList({
                    filter: filter,
                    sort: '-date',
                    expand: 'document,created_by'
                });

                // 4. Filtrar por empresa (si aplica)
                // La empresa est√° dentro de 'document', as√≠ que filtramos en memoria
                let filteredPayments = payments;
                if (companyId !== 'all') {
                    filteredPayments = payments.filter(p => p.expand?.document?.company === companyId);
                }

                paymentReportData = filteredPayments; // Guardar para Excel

                // 5. Renderizar Tabla y Totales
                tbody.innerHTML = '';
                let totalAmount = 0;

                if (filteredPayments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No se encontraron abonos en este periodo.</td></tr>';
                } else {
                    filteredPayments.forEach(pay => {
                        const doc = pay.expand?.document;
                        const user = pay.expand?.created_by;
                        
                        const clientName = doc ? doc.clientName : 'Desconocido';
                        const docNumber = doc ? `${doc.type} #${doc.number}` : 'N/A';
                        const userName = user ? user.name : 'Sistema';
                        
                        totalAmount += pay.amount;

                        const row = `
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap text-gray-700">${new Date(pay.date).toLocaleDateString()}</td>
                                <td class="px-6 py-4 font-medium text-gray-900">${escapeHtml(clientName)}</td>
                                <td class="px-6 py-4 text-blue-600 text-xs">${escapeHtml(docNumber)}</td>
                                <td class="px-6 py-4 text-gray-600">${escapeHtml(pay.method)}</td>
                                <td class="px-6 py-4 text-gray-500 text-xs">${escapeHtml(userName)}</td>
                                <td class="px-6 py-4 text-right font-bold text-green-600">L ${formatNumber(pay.amount)}</td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                }

                // 6. Actualizar Tarjetas
                document.getElementById('paymentReportTotal').textContent = `L ${formatNumber(totalAmount)}`;
                document.getElementById('paymentReportCount').textContent = filteredPayments.length;

            } catch (err) {
                console.error("Error al generar reporte de pagos:", err);
                tbody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Error al cargar los datos.</td></tr>';
            }
        }

        function exportPaymentsToExcel() {
            if (paymentReportData.length === 0) {
                alert('No hay datos para exportar.');
                return;
            }

            const headers = ["Fecha", "Cliente", "Documento", "M√©todo Pago", "Recibido Por", "Monto"];
            const data = paymentReportData.map(pay => {
                const doc = pay.expand?.document;
                return [
                    new Date(pay.date).toLocaleDateString(),
                    doc ? doc.clientName : 'N/A',
                    doc ? `${doc.type} #${doc.number}` : 'N/A',
                    pay.method,
                    pay.expand?.created_by?.name || 'N/A',
                    pay.amount
                ];
            });

            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte de Abonos");
            XLSX.writeFile(wb, "Reporte_Abonos.xlsx");
        }

        //ESCAPE HTML
        function escapeHtml(unsafe) {
            if (unsafe === undefined || unsafe === null) return '';
            return String(unsafe).replace(/[&<>\"'`=\\/]/g, s => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
            })[s]);
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        //MANTENIMIENTO DE DOCUMENTOS
        /**
         * Funci√≥n de mantenimiento para actualizar todas las facturas antiguas
         * que no tienen una fecha de vencimiento (due_date).
         */
        async function batchUpdateOldInvoices() {
            
            // 1. Verificaci√≥n de Rol (Admin)
            const isAdmin = pb.authStore.model.expand?.role?.name === 'admin';
            if (!isAdmin) {
                alert("Acci√≥n no permitida. Solo los administradores pueden ejecutar esta funci√≥n.");
                return;
            }

            if (!confirm("Esto revisar√° TODOS los documentos (Facturas y Recibos) que no tengan fecha de vencimiento.\n\nSe calcular√° su 'due_date' basado en los d√≠as de cr√©dito del cliente y su estado se marcar√° como 'Pendiente'.\n\n¬øDeseas continuar?")) {
                return;
            }

            const btn = document.getElementById('batch-update-btn');
            btn.disabled = true;
            btn.textContent = 'Actualizando...';

            let updatedCount = 0;
            
            // --- ‚ñº‚ñº‚ñº CORRECCI√ìN DEL FILTRO ‚ñº‚ñº‚ñº ---
            // Ahora incluye 'factura' O 'recibo'
            const docsToUpdate = documents.filter(doc => 
                (doc.type?.toLowerCase() === 'factura' || doc.type?.toLowerCase() === 'recibo') && 
                !doc.due_date
            );
            // --- ‚ñ≤‚ñ≤‚ñ≤ FIN DE LA CORRECCI√ìN ‚ñ≤‚ñ≤‚ñ≤ ---

            if (docsToUpdate.length === 0) {
                alert("¬°Buenas noticias! No se encontraron documentos antiguos que necesiten actualizaci√≥n.");
                btn.disabled = false;
                btn.textContent = 'üîß Actualizar Facturas Antiguas';
                return;
            }

            try {
                // El resto de la l√≥gica funciona para ambos tipos de documentos
                for (const doc of docsToUpdate) {
                    const client = clients.find(c => c.name === doc.clientName);
                    const creditDays = client ? (client.credit_days || 0) : 0;
                    
                    const parts = doc.date.split(' ')[0].split('-'); // Formato YYYY-MM-DD
                    const emisionDate = new Date(parts[0], parts[1] - 1, parts[2]);
                    
                    emisionDate.setDate(emisionDate.getDate() + creditDays);
                    const newDueDate = emisionDate.toISOString().split('T')[0];

                    await pb.collection('documents').update(doc.id, {
                        due_date: newDueDate,
                        payment_status: 'Pendiente'
                    });
                    updatedCount++;
                }

                alert(`¬°√âxito! ${updatedCount} documentos han sido actualizados.`);
                
                await loadData();
                loadHistory(); 

            } catch (err) {
                console.error("Error en la actualizaci√≥n por lotes:", err);
                alert("Ocurri√≥ un error durante la actualizaci√≥n. Revisa la consola.");
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîß Actualizar Facturas Antiguas';
            }
        }

        /**
         * Funci√≥n de mantenimiento para actualizar todas las facturas antiguas
         * Esto igualar√° el SALDO al TOTAL para todos los documentos PENDIENTES
         */
        async function fixBalances() {
            if(!confirm("Esto igualar√° el SALDO al TOTAL para todos los documentos PENDIENTES. ¬øContinuar?")) return;
            
            // Solo actualizamos los pendientes que no tienen saldo (balance = 0)
            const docsToFix = documents.filter(d => d.payment_status === 'Pendiente' && !d.balance);
            
            for(const doc of docsToFix) {
                const total = doc.total || doc.amount || 0;
                await pb.collection('documents').update(doc.id, { balance: total });
            }
            await loadData();
            alert("Saldos reparados.");
        }


        //-- Control de Version Inicio--
        // --- CONFIGURACI√ìN DE LA APP ---
        const APP_VERSION = "1.5.0"; // 
                                  
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            if (navigator.onLine) {
                statusEl.textContent = "‚óè Conectado";
                statusEl.className = "text-[10px] text-green-400 font-bold truncate";
            } else {
                statusEl.textContent = "‚óã Sin Conexi√≥n";
                statusEl.className = "text-[10px] text-red-400 font-bold truncate";
            }
        }
        //-- Control de Version Fin--            
               

    </script>   
</body>
</html>