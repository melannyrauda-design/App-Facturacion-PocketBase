<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema de Facturaci√≥n - PocketBase</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/pocketbase/dist/pocketbase.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'blue-custom': '#2563eb',
              'orange-custom': '#ea580c',
              'yellow-custom': '#eab308'
            }
          }
        }
      }
    </script>

    <style>
      @media print {
        /* Oculta todo lo que no se debe imprimir (botones, formularios, etc.) */
        .no-print {
          display: none !important;
        }

        /* Prepara el cuerpo de la p√°gina para una impresi√≥n limpia */
        body {
          background: white !important;
          margin: 0 !important;
          padding: 0 !important;
        }
        
        /* 1. Reduce los m√°rgenes de la hoja de papel */
        @page {
          size: letter; /* Puedes usar 'A4' si es tu est√°ndar */
          margin: 1.0cm;
        }

        /* --- LA CLAVE DE LA SOLUCI√ìN --- */
        /* Anula todos los estilos visuales del contenedor de la vista previa */
        #invoicePreview, #receiptPreview {
          position: static !important;
          border: none !important;
          box-shadow: none !important;
          padding: 0 !important;
          min-height: 0 !important;
          font-size: 10pt; /* Un tama√±o de letra m√°s compacto */
        }

        /* 3. Reduce el espaciado entre elementos de texto */
        #invoicePreview h1, #invoicePreview h2, #invoicePreview h3, #invoicePreview h4, #invoicePreview p {
          margin: 0 0 0.10rem 0; /* Menos margen inferior */
          padding: 0;
        }

        /* 4. Hace que la tabla de art√≠culos sea m√°s densa */
        #invoicePreview table th, #invoicePreview table td {
          padding: 4px 6px; /* Reduce el relleno de las celdas */
          font-size: 9pt;   /* Letra m√°s peque√±a para los art√≠culos */
        }

        /* 5. Compacta las secciones inferiores */
        #invoicePreview .border-t, #invoicePreview .text-center {
            margin-top: 0.10rem; /* Reduce el margen superior */
        }
        
        #invoicePreview .text-right.text-xs {
            line-height: 1.2; /* Reduce el espacio entre l√≠neas en los totales */
        }
        /* --- FIN DE LAS REGLAS DE OPTIMIZACI√ìN --- */

      }
    </style>
</head>
<body class="bg-white min-h-screen text-gray-800">

<div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gray-50">
  <div class="flex flex-col md:flex-row w-full max-w-4xl mx-auto bg-white shadow-2xl rounded-2xl overflow-hidden">
    <div class="w-full md:w-1/2 p-8 flex flex-col justify-center items-center bg-gradient-to-br from-blue-custom to-blue-600 text-white">
      <div class="text-center">
        <svg class="w-24 h-24 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C6.34 4.01 5.5 4.973 5.5 6.108V18.25a2.25 2.25 0 002.25 2.25h5.379a2.25 2.25 0 002.25-2.25V9.75a2.25 2.25 0 00-2.25-2.25h-4.5a2.25 2.25 0 00-2.25 2.25z" />
        </svg>
        <h1 class="text-3xl font-bold mb-2">Sistema de Facturaci√≥n</h1>
        <p class="text-blue-100">Gesti√≥n de facturas y recibos de forma simple y eficiente.</p>
      </div>
    </div>
    <div class="w-full md:w-1/2 p-8 md:p-12">
      <h2 class="text-3xl font-bold text-gray-800 mb-4">Iniciar Sesi√≥n</h2>
      <p class="text-gray-600 mb-8">Bienvenido de nuevo. Por favor, ingresa tus credenciales.</p>
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700">Email</label>
          <input id="loginEmail" type="email" placeholder="usuario@ejemplo.com" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-custom focus:border-transparent" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700">Contrase√±a</label>
          <input id="loginPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="mt-1 w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-custom focus:border-transparent" />
        </div>
        <button onclick="login()" class="w-full bg-blue-custom text-white py-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors duration-300 shadow-lg hover:shadow-blue-custom/40">
          Iniciar sesi√≥n
        </button>
        <p id="loginError" class="text-red-500 text-sm mt-4 hidden text-center">Credenciales inv√°lidas o error de conexi√≥n.</p>
        <div class="mt-6 text-sm text-center text-gray-500">
          <p>Nota: Necesitas un usuario creado en PocketBase.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="appScreen" class="hidden">
    
    <div class="container mx-auto p-4 max-w-screen-7xl">  

        <div class="bg-gray-50 shadow-md rounded-xl p-4 sm:p-6 mb-6 no-print">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between pb-4 border-b border-gray-200">
            <div>
            <h1 class="text-3xl font-bold text-gray-800">Sistema de Facturaci√≥n</h1>
            <p class="text-sm text-gray-500 mt-1">üá≠üá≥ Honduras - Moneda: Lempira (L)</p>
            </div>
                <div class="flex items-center gap-4 mt-4 sm:mt-0">
                    <div class="flex items-center gap-3 bg-gray-100 px-3 py-1.5 rounded-full">
                        <img id="userAvatar" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iY3VycmVudENvbG9yIiBjbGFzcz0idy0xMCBoLTEwIHRleHQtZ3JheS00MDAiPgogIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgZD0iTTE4LjY4NSAxOS4xMjZDNjcuNzU1IDIxLjU4NSA5LjEyNiAyMS41ODUgNC4zMTUgMTkuMTI2Yy0uOTgwLS40ODgtMS4zNzgtMS4xODYtMS4zOTgtMS45NDlBLjczNS43MzUgMCAwMTEgMTcuNzVWMTNjMC0uMzgxLjMyNS0uNjg2LjczNC0uNjkzQTYwLjQ4MSA2MC40ODEgMCAwMTkgMTIuMjVjLjg3MiAwIDEuNzMzLjAyIDEuNTkuMDQzLjMyOS4wMDQuNjM5LjE3OC44NDIuNDQ1bDIuMDIgMi43YS43NS43NSAwIDAwMS4xMiAwTDE3LjYyIDExLjdjLjIwMy0uMjY3LjUxMy0uNDQxLjg0Mi0uNDQ1YTYwLjQ3OCA2MC40NzggMCAwMTEuNTkuMDQzYy40MS4wMDcuNzM0LjMxMi43MzQuNjkzdjQuNzVjMCAuMzIxLjMyNS42MjYuNzM0LjY0NmEuNzM1LjcMNSAwIDAxLS4wMjEuNTg2Yy0uMDIuNzYzLS40MTggMS40NjEtMS4zOTggMS45NDlaTTkuMzMgOC40NDljLS44MjcgMC0xLjUxLS42NjMtMS41MS0xLjQ3N1M4LjUgNS41IDkuMzMgNS41YzEuNDEyIDAgMi4yNzYgMS41MjkgMS44MDcgMi43MzItLjU1NiAxLjQyMy0xLjQ0MyAyLjcxNC0xLjgwNyAyLjcxNFptNS4zNC0uMTg4Yy0uNTU2IDEuNDIzLTEuNDQzIDIuNzE0LTEuODA3IDIuNzE0LS44MjUgMC0xLjUwOS0uNjYzLTEuNTA5LTEuNDc0UzEzLjY2IDUuNSAxNC40OCA1..NWMxLjQxMyAwIDIuMjc3IDEuNTI5IDEuODA4IDIuNzMxWiIgY2xpcC1ydWxlPSJldmVub2RkIiAvPgo8L3N2Zz4K" alt="User Avatar" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm">
                        <div id="currentUser" class="text-sm font-medium text-gray-700">                
                        </div>
                    </div>
                    <div class="flex-grow"></div> <div class="relative">
                        <button onclick="toggleNotificationPanel()" id="notification-bell-btn" class="relative text-gray-600 hover:text-blue-custom p-2 rounded-full focus:outline-none">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341A6.002 6.002 0 006 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                            <span id="notification-count-badge" class="hidden absolute top-0 right-0 block w-4 h-4 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                        </button>
                        
                        <div id="notification-panel" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden z-50">
                            <div class="py-2 px-4 border-b border-gray-200">
                                <h3 class="font-bold text-gray-800">Notificaciones</h3>
                            </div>
                            <div id="notification-list" class="divide-y divide-gray-100 max-h-96 overflow-y-auto">
                                <p class="text-center text-gray-500 p-4">No tienes notificaciones nuevas.</p>
                            </div>
                        </div>
                    </div>          
                    <button onclick="logout()" class="flex items-center gap-2 bg-red-500 hover:bg-red-600 text-white font-bold px-4 py-2 rounded-lg transition-colors duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg>
                        <span>Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-2 sm:gap-4 mt-4">
                <button onclick="showSection('invoiceSection')" class="flex items-center justify-center gap-2 p-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105"><span>Facturaci√≥n</span></button>
                <button onclick="showSection('receiptSection')" class="flex items-center justify-center gap-2 p-3 bg-orange-500 hover:bg-orange-600 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105"><span>Recibos</span></button>
                <button onclick="showHistory()" class="flex items-center justify-center gap-2 p-3 bg-yellow-500 hover:bg-yellow-600 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105"><span>Historial</span></button>
                <button onclick="showSection('reportsSection')" data-role="admin" class="flex items-center justify-center gap-2 p-3 bg-gray-600 hover:bg-gray-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105"><span>Reportes</span></button>
                <button onclick="showCompanyManager()" data-role="admin" class="flex items-center justify-center gap-2 p-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105"><span>Empresas</span></button>
                <button onclick="showAuthManager()" data-role="admin" class="flex items-center justify-center gap-2 p-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105"><span>Autorizaciones</span></button>
                <button onclick="showProductManager()" data-role="admin" class="flex items-center justify-center gap-2 p-3 bg-teal-600 hover:bg-teal-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105"><span>Productos</span></button>
                <button onclick="showClientManager()" data-role="admin" class="flex items-center justify-center gap-2 p-3 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105"><span>Clientes</span></button>
                <button onclick="showUserManager()" data-role="admin" class="flex items-center justify-center gap-2 p-3 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105">Usuarios</button>
                <button onclick="showBankAccountManager()" data-role="admin" class="flex items-center justify-center gap-2 p-3 bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105">Cuentas Bancarias</button>
                <button onclick="showAgenda()" class="flex items-center justify-center gap-2 p-3 bg-sky-600 hover:bg-sky-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105">Agenda</button>
                <button onclick="showMorosidadReport()" data-role="admin" class="flex items-center justify-center gap-2 p-3 bg-stone-600 hover:bg-stone-700 text-white font-semibold rounded-lg shadow-sm transition-transform transform hover:scale-105">Morosidad</button>
            </div>
        </div>

        <div id="companyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Gesti√≥n de Empresas</h3>
                <button onclick="hideCompanyManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div class="mb-6">
                <h4 class="font-semibold text-gray-700 mb-3">Empresa (Agregar/Editar)</h4>
                <form id="companyForm" onsubmit="handleCompanyFormSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="companyId" />
                <input type="text" id="newCompanyName" placeholder="Nombre de la empresa" class="border rounded-lg px-3 py-2" required>
                <input type="text" id="newCompanyRTN" placeholder="RTN" class="border rounded-lg px-3 py-2">
                <input type="text" id="newCompanyAddress" placeholder="Direcci√≥n" class="border rounded-lg px-3 py-2 md:col-span-2">
                <input type="text" id="newCompanyPhone" placeholder="Tel√©fono" class="border rounded-lg px-3 py-2">
                <input type="text" id="newCompanyEmail" placeholder="Email" class="border rounded-lg px-3 py-2">
                <label for="newCompanyLogo" class="block mt-2 font-semibold md:col-span-2">Logo:</label>
                <input type="file" id="newCompanyLogo" name="logo" accept="image/*" class="border p-2 rounded w-full md:col-span-2"/>
                <div id="logoPreviewContainer" class="col-span-2 hidden">
                    <p class="text-gray-700">Logo actual:</p>
                    <img id="currentLogoPreview" src="" alt="Logo actual" class="h-20 w-auto mt-2 object-contain" />
                </div>
                <button type="submit" class="mt-4 md:col-span-2 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Empresa</button>
                </form>
            </div>
            <div>
                <h4 class="font-semibold text-gray-700 mb-3">Empresas Registradas</h4>
                <div id="companiesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
            </div>
        </div>
        </div>
        
        <div id="authModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Gesti√≥n de Autorizaciones Fiscales</h3>
                <button onclick="hideAuthManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div class="mb-6">
                <h4 class="font-semibold text-gray-700 mb-3">Autorizaci√≥n (Agregar/Editar)</h4>
                <form id="authForm" onsubmit="handleAuthFormSubmit(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="hidden" id="authId" />
                <div class="md:col-span-3"><label for="authCompany" class="block text-sm font-medium text-gray-700">Empresa*</label><select id="authCompany" class="w-full border rounded-lg px-3 py-2 mt-1" required></select></div>
                <div class="md:col-span-2"><label for="authCAI" class="block text-sm font-medium text-gray-700">CAI*</label><input type="text" id="authCAI" placeholder="3BE298-..." class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                <div><label for="authFechaLimite" class="block text-sm font-medium text-gray-700">Fecha L√≠mite*</label><input type="date" id="authFechaLimite" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                <div><label for="authRangoInicio" class="block text-sm font-medium text-gray-700">Rango Inicio*</label><input type="number" id="authRangoInicio" placeholder="1" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                <div><label for="authRangoFin" class="block text-sm font-medium text-gray-700">Rango Fin*</label><input type="number" id="authRangoFin" placeholder="10000" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                <div><label for="authNumeroActual" class="block text-sm font-medium text-gray-700">N√∫mero Actual*</label><input type="number" id="authNumeroActual" placeholder="1" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                <div><label for="authCodSucursal" class="block text-sm font-medium text-gray-700">Cod. Sucursal*</label><input type="text" id="authCodSucursal" placeholder="000" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                <div><label for="authCodPuntoEmision" class="block text-sm font-medium text-gray-700">Cod. Punto Emisi√≥n*</label><input type="text" id="authCodPuntoEmision" placeholder="001" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                <div><label for="authCodTipoDoc" class="block text-sm font-medium text-gray-700">Cod. Tipo Doc*</label><input type="text" id="authCodTipoDoc" placeholder="01" class="w-full border rounded-lg px-3 py-2 mt-1" required></div>
                <div class="md:col-span-3 flex items-center gap-3 mt-2"><input id="authEstaActiva" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-custom focus:ring-blue-custom"><label for="authEstaActiva" class="text-sm font-medium text-gray-700">Marcar como la autorizaci√≥n activa</label></div>
                <button type="submit" class="mt-4 md:col-span-3 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Autorizaci√≥n</button>
                </form>
            </div>
            <div>
                <h4 class="font-semibold text-gray-700 mb-3">Autorizaciones Registradas</h4>
                <div id="authList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
            </div>
        </div>
        </div>

        <div id="productManagerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Maestro de Productos</h3>
                    <button onclick="hideProductManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
                </div>

                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Producto (Agregar/Editar)</h4>
                        <form id="productForm" onsubmit="handleProductFormSubmit(event)" class="space-y-4">
                            <input type="hidden" id="productId" />
                            <div>
                                <label for="productName" class="block text-sm font-medium text-gray-700">Nombre del Producto*</label>
                                <input type="text" id="productName" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                            </div>
                            
                            <div>
                                <label for="productDescription" class="block text-sm font-medium text-gray-700">Descripci√≥n del Producto</label>
                                <textarea id="productDescription" rows="3" class="w-full border rounded-lg px-3 py-2 mt-1"></textarea>
                            </div>
                            <div>
                                <label for="productCode" class="block text-sm font-medium text-gray-700">C√≥digo</label>
                                <input type="text" id="productCode" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Ej: SERV-01">
                            </div>
                            <div>
                                <label for="productPrice" class="block text-sm font-medium text-gray-700">Precio de Venta (L)*</label>
                                <input type="number" step="0.01" id="productPrice" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                            </div>
                            <div class="flex items-center gap-3">
                                <input id="productIsExempt" type="checkbox" class="h-4 w-4 rounded border-gray-300">
                                <label for="productIsExempt" class="text-sm font-medium text-gray-700">Este producto es Exento de Impuesto (ISV)</label>
                            </div>
                            <button type="submit" class="w-full bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Producto</button>
                        </form>
                </div>

                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">Productos Registrados</h4>
                    <div id="productsList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
                
                </div>
            </div>
        </div>

        <div id="clientModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Maestro de Clientes</h3>
                <button onclick="hideClientManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>

            <div class="mb-6">
                <h4 class="font-semibold text-gray-700 mb-3">Cliente (Agregar/Editar)</h4>
                <form id="clientForm" onsubmit="handleClientFormSubmit(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="clientId" />
                
                <div>
                    <label for="clientName" class="block text-sm font-medium text-gray-700">Nombre Completo o Raz√≥n Social*</label>
                    <input type="text" id="clientName" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                </div>
                <div>
                    <label for="clientCode" class="block text-sm font-medium text-gray-700">C√≥digo de Cliente</label>
                    <input type="text" id="clientCode" class="w-full border rounded-lg px-3 py-2 mt-1 bg-gray-100" readonly>
                </div>
                <div>
                    <label for="clientRTN" class="block text-sm font-medium text-gray-700">RTN</label>
                    <input type="text" id="clientRTN" class="w-full border rounded-lg px-3 py-2 mt-1">
                </div>
                <div>
                    <label for="clientPhone" class="block text-sm font-medium text-gray-700">Tel√©fono</label>
                    <input type="text" id="clientPhone" class="w-full border rounded-lg px-3 py-2 mt-1">
                </div>
                
                <div>
                    <label for="clientContactPerson" class="block text-sm font-medium text-gray-700">Persona de Contacto</label>
                    <input type="text" id="clientContactPerson" class="w-full border rounded-lg px-3 py-2 mt-1">
                </div>
                <div>
                    <label for="clientEmail" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="clientEmail" class="w-full border rounded-lg px-3 py-2 mt-1">
                </div>

                <div class="md:col-span-2">
                    <label for="clientAddress" class="block text-sm font-medium text-gray-700">Direcci√≥n</label>
                    <input type="text" id="clientAddress" class="w-full border rounded-lg px-3 py-2 mt-1">
                </div>

                <div class="md:col-span-2">
                    <label for="clientNotes" class="block text-sm font-medium text-gray-700">Notas</label>
                    <textarea id="clientNotes" rows="3" class="w-full border rounded-lg px-3 py-2 mt-1"></textarea>
                </div>
                <hr class="md:col-span-2 my-2"/>

                <div>
                    <label for="entityType" class="block text-sm font-medium text-gray-700">Tipo</label>
                    <select id="entityType" class="w-full border rounded-lg px-3 py-2 mt-1">
                        <option value="Cliente">Cliente</option>
                        <option value="Proveedor">Proveedor</option>
                        <option value="Ambos">Ambos</option>
                    </select>
                </div>
                <div>
                    <label for="clientGroup" class="block text-sm font-medium text-gray-700">Grupo de Cliente</label>
                    <input type="text" id="clientGroup" list="clientGroupList" class="w-full border rounded-lg px-3 py-2 mt-1">
                    <datalist id="clientGroupList"></datalist>
                </div>
                <div>
                    <label for="priceList" class="block text-sm font-medium text-gray-700">Lista de Precios</label>
                    <input type="text" id="priceList" list="priceLists" class="w-full border rounded-lg px-3 py-2 mt-1">
                    <datalist id="priceLists"></datalist>
                </div>
                
                <div>
                    <label for="paymentTerms" class="block text-sm font-medium text-gray-700">Forma de Pago</label>
                    <input type="text" id="paymentTerms" list="paymentTermsList" placeholder="Ej: Cr√©dito" class="w-full border rounded-lg px-3 py-2 mt-1">
                    <datalist id="paymentTermsList"></datalist>
                </div>
                <div>
                    <label for="creditDays" class="block text-sm font-medium text-gray-700">D√≠as de Cr√©dito</label>
                    <input type="number" id="creditDays" placeholder="0" class="w-full border rounded-lg px-3 py-2 mt-1">
                </div>
                <div>
                    <label for="creditLimit" class="block text-sm font-medium text-gray-700">L√≠mite de Cr√©dito (L)</label>
                    <input type="number" step="0.01" id="creditLimit" placeholder="0.00" class="w-full border rounded-lg px-3 py-2 mt-1">
                </div>

                <div class="md:col-span-3 flex items-center gap-3 mt-2">
                    <input id="clientIsActive" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-blue-custom focus:ring-blue-custom">
                    <label for="clientIsActive" class="text-sm font-medium text-gray-700">Cliente Activo</label>
                </div>
                
                <button type="submit" class="mt-4 md:col-span-3 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Cliente</button>
                </form>
            </div>

                <div>
                <h4 class="font-semibold text-gray-700 mb-3">Clientes Registrados</h4>
                <div id="clientsList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
            </div>
        </div>

        <div id="userManagerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Gesti√≥n de Usuarios</h3>
                <button onclick="hideUserManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>

            <div class="mb-6">
                <h4 class="font-semibold text-gray-700 mb-3">Usuario (Agregar/Editar)</h4>
                <form id="userForm" onsubmit="handleUserFormSubmit(event)" class="space-y-4">
                <input type="hidden" id="userId" />
                
                <div>
                    <label for="userNameDisplay" class="block text-sm font-medium text-gray-700">Nombre Usuario*</label>
                    <input type="text" id="userNameDisplay" class="w-full border rounded-lg px-3 py-2 mt-1" required placeholder="Ej: Juan P√©rez">
                </div>
                <div>
                    <label for="userEmail" class="block text-sm font-medium text-gray-700">Email*</label>
                    <input type="email" id="userEmail" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                </div>

                <div>
                    <label for="userRole" class="block text-sm font-medium text-gray-700">Rol*</label>
                    <select id="userRole" class="w-full border rounded-lg px-3 py-2 mt-1" required></select>
                </div>
                <div>
                    <label for="userPassword" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                    <input type="password" id="userPassword" class="w-full border rounded-lg px-3 py-2 mt-1" placeholder="Dejar en blanco para no cambiar">
                </div>
                <div>
                    <label for="userPasswordConfirm" class="block text-sm font-medium text-gray-700">Confirmar Contrase√±a</label>
                    <input type="password" id="userPasswordConfirm" class="w-full border rounded-lg px-3 py-2 mt-1">
                </div>
                <div>
                    <label for="userAvatarFile" class="block text-sm font-medium text-gray-700">Avatar</label>
                    <input type="file" id="userAvatarFile" class="w-full border rounded-lg p-2 mt-1">
                </div>
                
                <button type="submit" class="w-full mt-4 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Usuario</button>
                </form>
            </div>

            <div>
                <h4 class="font-semibold text-gray-700 mb-3">Usuarios Registrados</h4>
                <div id="usersList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
            </div>
        </div>
        </div>

        <div id="bankAccountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 no-print">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Cuentas Bancarias por Empresa</h3>
                <button onclick="hideBankAccountManager()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>

            <div class="mb-6">
                <h4 class="font-semibold text-gray-700 mb-3">Cuenta (Agregar/Editar)</h4>
                <form id="bankAccountForm" onsubmit="handleBankAccountFormSubmit(event)" class="space-y-4">
                <input type="hidden" id="accountId" />
                
                <div>
                    <label for="accountCompany" class="block text-sm font-medium text-gray-700">Empresa*</label>
                    <select id="accountCompany" class="w-full border rounded-lg px-3 py-2 mt-1" required></select>
                </div>
                <div>
                    <label for="accountBankName" class="block text-sm font-medium text-gray-700">Nombre del Banco*</label>
                    <input type="text" id="accountBankName" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                </div>
                <div>
                    <label for="accountName" class="block text-sm font-medium text-gray-700">Nombre de la Cuenta*</label>
                    <input type="text" id="accountName" placeholder="Ej: Cuenta Principal" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                </div>
                <div>
                    <label for="accountNumber" class="block text-sm font-medium text-gray-700">N√∫mero de Cuenta*</label>
                    <input type="text" id="accountNumber" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                </div>
                <div>
                    <label for="accountType" class="block text-sm font-medium text-gray-700">Tipo de Cuenta*</label>
                    <select id="accountType" class="w-full border rounded-lg px-3 py-2 mt-1" required>
                        <option value="Cheques">Cheques</option>
                        <option value="Ahorros">Ahorros</option>
                    </select>
                </div>
                
                <button type="submit" class="w-full mt-4 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Guardar Cuenta</button>
                </form>
            </div>

            <div>
                <h4 class="font-semibold text-gray-700 mb-3">Cuentas Registradas</h4>
                <div id="bankAccountsList" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
            </div>
        </div>
        </div>


        <div id="invoiceSection" class="section">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-blue-custom no-print">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="bg-blue-custom text-white p-2 rounded-lg mr-3">üìÑ</span> <span id="invoiceTitle">Nueva Factura</span>
            </h2>
            <form id="invoiceForm" class="space-y-4" onsubmit="return false;">
                <input type="hidden" id="editingInvoiceId">
                <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Factura</label>
                    <input type="text" id="invoiceNumber" class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                    <input type="date" id="invoiceDate" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>
                </div>
                <div id="authInfo" class="hidden text-sm text-gray-600 bg-purple-50 p-3 rounded-lg">
                <p><strong>CAI Activo:</strong> <span id="activeCAI"></span></p>
                <p><strong>Rango:</strong> <span id="activeRange"></span> | <strong>Fecha L√≠mite:</strong> <span id="activeDate"></span></p>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Datos de la Empresa</h3>
                <select id="companySelect" onchange="updateCompanyData()" class="w-full border border-gray-300 rounded-lg px-3 py-2"><option value="">Seleccionar empresa...</option></select>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Cliente</h3>
                
                <label for="invoiceClientSelect" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Cliente Existente</label>
                <select id="invoiceClientSelect" onchange="clientSelected('invoice')" class="w-full border rounded px-3 py-2 mb-3"></select>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="clientName" placeholder="Nombre del cliente" class="border rounded px-3 py-2">
                    <input type="text" id="clientRTN" placeholder="RTN del cliente" class="border rounded px-3 py-2">
                    <input type="text" id="clientAddress" placeholder="Direcci√≥n" class="md:col-span-2 border rounded px-3 py-2">
                </div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Productos/Servicios</h3>
                <div id="invoiceItems" class="space-y-2">                
                </div>
                <button type="button" onclick="addInvoiceItem()" class="mt-2 bg-yellow-custom hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">+ Agregar</button>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Detalles del Pago</h3>              
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">M√©todo de Pago</label>
                    <select id="paymentMethod" class="w-full border rounded px-3 py-2">
                        <option value="Contado">Contado</option>
                        <option value="Transferencia Bancaria">Transferencia Bancaria</option>
                        <option value="Tarjeta de Cr√©dito">Tarjeta de Cr√©dito</option>
                        <option value="Tarjeta de D√©bito">Tarjeta de D√©bito</option>
                        <option value="Cheque">Cheque</option>
                        <option value="Dep√≥sito Bancario">Dep√≥sito Bancario</option>
                    </select>
                    </div>
                    <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ISV (%)</label>
                    <select id="taxRate" onchange="handleTaxChange()" class="w-full border rounded px-3 py-2">
                        <option value="15">15% - ISV est√°ndar</option>
                        <option value="18">18% - ISV especial</option>
                        <option value="0">0% - Exento</option>
                        <option value="exonerado">Exonerado</option>
                    </select>
                    </div>
                </div>

                <div id="exoneradoFields" class="hidden mt-4 space-y-4 border-t pt-4">
                    <h4 class="text-md font-semibold text-gray-700">Detalles de Exoneraci√≥n</h4>
                    <div>
                    <label class="block text-sm font-medium text-gray-700"># Correlativo de Orden de Compra Exenta</label>
                    <input type="text" id="ordenCompraExenta" class="w-full border rounded px-3 py-2 mt-1">
                    </div>
                    <div>
                    <label class="block text-sm font-medium text-gray-700"># Correlativo de Constancia de Registro Exonerado</label>
                    <input type="text" id="constanciaRegistroExonerado" class="w-full border rounded px-3 py-2 mt-1">
                    </div>
                    <div>
                    <label class="block text-sm font-medium text-gray-700"># Identificativo del Registro de la SAG</label>
                    <input type="text" id="registroSAG" class="w-full border rounded px-3 py-2 mt-1">
                    </div>
                </div>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <div class="space-y-3 text-right">
                    <div class="flex justify-between items-center">
                        <span>Subtotal:</span> 
                        <span id="subtotal">L 0.00</span>
                    </div>
                    
                    <div class="flex justify-between items-center gap-4">
                        <label for="discountAmount" class="text-sm font-medium text-gray-700">Descuento (L):</label>
                        <input type="number" step="0.01" id="discountAmount" placeholder="0.00" 
                            class="w-32 border rounded-lg px-3 py-1 text-right" 
                            oninput="calculateTotals()">
                    </div>
                    <div class="flex justify-between items-center">
                        <span>ISV:</span> 
                        <span id="taxAmount">L 0.00</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg border-t pt-2">
                        <span>TOTAL:</span> 
                        <span id="total">L 0.00</span>
                    </div>
                    </div>
                </div>
                <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label>
                <textarea id="observations" rows="3" class="w-full border rounded px-3 py-2"></textarea>
                </div>
                <div class="flex gap-4">
                    <button type="button" id="saveInvoiceBtn" onclick="handleInvoiceSubmit()" class="w-full bg-gradient-to-r from-blue-custom to-blue-600 text-white py-3 rounded-lg text-lg font-semibold">üíæ Guardar Factura</button>
                    <button type="button" onclick="resetInvoiceForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg text-lg font-semibold">‚ú® Nueva</button>
                </div>
            </form>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4 no-print">
                <h3 class="text-xl font-bold">Vista Previa</h3>
                <button onclick="printDocument()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üñ®Ô∏è Imprimir</button>
            </div>
            <div id="invoicePreview" class="border rounded-lg p-4 min-h-96">
                <p class="text-gray-500 text-center mt-20">La vista previa aparecer√° aqu√≠</p>
            </div>
            </div>
        </div>
        </div>

        <div id="receiptSection" class="section hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-orange-custom no-print">
            <h2 class="text-2xl font-bold mb-6 flex items-center"><span class="bg-orange-custom text-white p-2 rounded-lg mr-3">üßæ</span> <span id="receiptTitle">Nuevo Recibo</span></h2>
            <form id="receiptForm" class="space-y-4" onsubmit="return false;">
                <input type="hidden" id="editingReceiptId">
                <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero de Recibo</label>
                    <input type="text" id="receiptNumber" class="w-full border rounded px-3 py-2 bg-gray-100" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                    <input type="date" id="receiptDate" class="w-full border rounded px-3 py-2">
                </div>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Datos de la Empresa</h3>
                <select id="receiptCompanySelect" onchange="updateReceiptCompanyData()" class="w-full border rounded px-3 py-2"><option value="">Seleccionar empresa...</option></select>
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Cliente</h3>

                <label for="receiptClientSelect" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Cliente Existente</label>
                <select id="receiptClientSelect" onchange="clientSelected('receipt')" class="w-full border rounded px-3 py-2 mb-3"></select>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="receiptClientName" placeholder="Nombre del cliente" class="border rounded px-3 py-2">
                    <input type="text" id="receiptClientPhone" placeholder="Tel√©fono" class="border rounded px-3 py-2">
                    <input type="text" id="receiptClientAddress" placeholder="Direcci√≥n" class="md:col-span-2 border rounded px-3 py-2">
                </div>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Detalles del Pago</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">Monto (L) *</label><input type="number" step="0.01" id="receiptAmount" placeholder="0.00" class="w-full border rounded px-3 py-2" required></div>
                    <div><label class="block text-sm font-medium text-gray-700 mb-1">M√©todo de Pago</label><select id="receiptPaymentMethod" class="w-full border rounded px-3 py-2"><option value="Efectivo">Efectivo</option><option value="Transferencia Bancaria">Transferencia Bancaria</option><option value="Tarjeta de Cr√©dito">Tarjeta de Cr√©dito</option><option value="Tarjeta de D√©bito">Tarjeta de D√©bito</option><option value="Cheque">Cheque</option><option value="Dep√≥sito Bancario">Dep√≥sito Bancario</option></select></div>
                </div>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Concepto/Descripci√≥n</label><textarea id="receiptConcept" rows="3" placeholder="Descripci√≥n del pago..." class="w-full border rounded px-3 py-2"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-1">Observaciones</label><textarea id="receiptObservations" rows="2" class="w-full border rounded px-3 py-2"></textarea></div>
                <div class="flex gap-4">
                    <button type="button" id="saveReceiptBtn" onclick="handleReceiptSubmit()" class="w-full bg-gradient-to-r from-orange-custom to-orange-600 text-white py-3 rounded-lg text-lg font-semibold">üíæ Guardar Recibo</button>
                    <button type="button" onclick="resetReceiptForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg text-lg font-semibold">‚ú® Nuevo</button>
                </div>
            </form>
            </div>
            <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4 no-print">
                <h3 class="text-xl font-bold">Vista Previa</h3>
                <button onclick="printDocument()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üñ®Ô∏è Imprimir</button>
            </div>
            <div id="receiptPreview" class="border rounded-lg p-4 min-h-96">
                <p class="text-gray-500 text-center mt-20">La vista previa aparecer√° aqu√≠</p>
            </div>
            </div>
        </div>
        </div>

        <div id="historySection" class="section hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg no-print">
                <h2 class="text-2xl font-bold mb-4">Historial de Documentos</h2>

                <div class="flex flex-wrap gap-4 items-center mb-4">
                    <div class="flex-grow">
                        <label for="historyCompanyFilter" class="text-sm font-medium">Filtrar por Empresa:</label>
                        <select id="historyCompanyFilter" onchange="filterHistoryByCompany(this.value)" class="w-full mt-1 border rounded-lg px-3 py-2"></select>
                    </div>

                    <div>
                        <label class="text-sm font-medium">Filtrar por Rango de Fechas:</label>
                        <div class="flex gap-2 mt-1">
                            <input type="date" id="historyDateStart" onchange="filterHistoryByDate()" class="border rounded-lg px-3 py-2" placeholder="Desde">
                            <input type="date" id="historyDateEnd" onchange="filterHistoryByDate()" class="border rounded-lg px-3 py-2" placeholder="Hasta">
                            <button onclick="clearDateFilter()" class="px-3 py-2 text-sm rounded-lg bg-gray-300 hover:bg-gray-400" title="Limpiar filtro de fecha">‚úï</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-sm font-medium">Filtrar por Tipo:</label>
                        <div id="historyTypeFilter" class="flex gap-2 mt-1">
                            <button onclick="filterHistory('all')" class="px-4 py-2 text-sm rounded-lg bg-blue-custom text-white">Todos</button>
                            <button onclick="filterHistory('factura')" class="px-4 py-2 text-sm rounded-lg bg-gray-200">Facturas</button>
                            <button onclick="filterHistory('recibo')" class="px-4 py-2 text-sm rounded-lg bg-gray-200">Recibos</button>
                        </div>
                    </div>

                    <div class="flex gap-2 items-end">
                        <div>
                            <label class="block text-sm font-medium text-transparent select-none">Acci√≥n</label>
                            <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-center">
                                <span class="mr-2">üìä</span> 
                                Exportar a Excel
                            </button>
                        </div>
                        <div data-role="admin">                            
                            <button onclick="batchUpdateOldInvoices()" id="batch-update-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-center">
                                <span class="mr-2">üîß</span>
                                Actualizar Facturas Antiguas
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>

        <div id="reportsSection" class="section hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold mb-6 flex items-center"><span class="bg-gray-600 text-white p-2 rounded-lg mr-3">üìä</span> Panel de Reportes</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-blue-50 p-6 rounded-lg border-l-4 border-blue-custom"><h3 class="text-lg font-semibold">Total Documentos</h3><p id="totalDocs" class="text-3xl font-bold text-blue-custom">0</p></div>
            <div class="bg-orange-50 p-6 rounded-lg border-l-4 border-orange-custom"><h3 class="text-lg font-semibold">Facturas</h3><p id="totalInvoices" class="text-3xl font-bold text-orange-custom">0</p></div>
            <div class="bg-yellow-50 p-6 rounded-lg border-l-4 border-yellow-custom"><h3 class="text-lg font-semibold">Recibos</h3><p id="totalReceipts" class="text-3xl font-bold text-yellow-custom">0</p></div>
            <div class="bg-green-50 p-6 rounded-lg border-l-4 border-green-500"><h3 class="text-lg font-semibold">Ingresos Totales</h3><p id="totalRevenue" class="text-3xl font-bold text-green-600">L 0</p></div>
            </div>
            <div class="bg-gray-50 p-6 rounded-lg"><h3 class="text-xl font-bold mb-4">Resumen por Empresa</h3><div id="companyBreakdown"></div></div>
        </div>
        </div>

        <div id="agendaSection" class="hidden p-4 md:p-6 lg:p-8 space-y-6">
            <h2 class="text-3xl font-bold text-gray-800">üóìÔ∏è Agenda Personal</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-gray-700">Productividad del d√≠a</h3>
                        <span class="text-xl">üöÄ</span>
                    </div>
                    <div class="text-3xl font-bold text-blue-custom" id="productivity">85%</div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: 85%" id="productivity-bar"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-gray-700">Tareas Completadas</h3>
                        <span class="text-xl">‚úÖ</span>
                    </div>
                    <div class="text-3xl font-bold text-green-600" id="completed-tasks">0</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-gray-700">Tiempo Enfocado</h3>
                        <span class="text-xl">‚è±Ô∏è</span>
                    </div>
                    <div class="text-3xl font-bold text-orange-custom" id="focused-time">0h 0m</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-gray-700">Racha Diaria</h3>
                        <span class="text-xl">üî•</span>
                    </div>
                    <div class="text-3xl font-bold text-red-500" id="streak">1</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <div class="lg:col-span-2 space-y-6">
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï Agregar Tarea R√°pida</h3>
                        
                        <div class="mb-2">
                            <input type="text" id="quick-task" placeholder="¬øQu√© necesitas hacer hoy?" class="w-full flex-1 border rounded-lg px-3 py-2">
                        </div>
                        
                        <div class="flex flex-wrap gap-2 items-center">
                            <select id="quick-category" class="flex-grow border rounded-lg px-3 py-2">
                                <option value="trabajo">üíº Trabajo</option>
                                <option value="personal">üë§ Personal</option>
                                <option value="salud">üí™ Salud</option>
                                <option value="estudios">üìö Estudios</option>
                                <option value="hogar">üè† Hogar</option>
                            </select>
                            
                            <select id="quick-time-estimate" class="flex-grow border rounded-lg px-3 py-2">
                                <option value="15">15 min</option>
                                <option value="30" selected>30 min</option>
                                <option value="60">1 hora</option>
                                <option value="120">2 horas</option>
                            </select>
                            
                            <button type="button" id="add-quick-btn" class="bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Agregar</button>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4" id="detailed-task-title">üìù Crear Tarea Detallada</h3>
                        <div class="space-y-4">
                        
                            <input type="hidden" id="detailed-task-id">

                            <div id="assign-user-container" data-role="admin" class="hidden">
                                <label for="assign-to-user" class="block text-sm font-medium text-gray-700">Asignar Tarea A:</label>
                                <select id="assign-to-user" class="w-full border rounded-lg px-3 py-2 mt-1">
                                </select>
                            </div>

                            <input type="text" id="detailed-title" placeholder="T√≠tulo de la tarea" class="w-full border rounded-lg px-3 py-2">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select id="category" class="w-full border rounded-lg px-3 py-2">
                                    <option value="trabajo">üíº Trabajo</option>
                                    <option value="personal">üë§ Personal</option>
                                    <option value="salud">üí™ Salud</option>
                                    <option value="estudios">üìö Estudios</option>
                                    <option value="hogar">üè† Hogar</option>
                                </select>
                                <select id="priority" class="w-full border rounded-lg px-3 py-2">
                                    <option value="baja">üü¢ Baja</option>
                                    <option value="media">üü° Media</option>
                                    <option value="alta">üü† Alta</option>
                                    <option value="urgente">üî¥ Urgente</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="number" id="time-estimate" class="w-full border rounded-lg px-3 py-2 md:col-span-1" placeholder="Tiempo (en minutos)">
                                <input type="date" id="due-date" class="w-full border rounded-lg px-3 py-2 md:col-span-1">
                                <input type="time" id="due-time" class="w-full border rounded-lg px-3 py-2 md:col-span-1">
                            </div>

                            <textarea id="notes" placeholder="Notas adicionales..." rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                            
                            <div class="flex gap-2">
                                <button type="button" id="add-detailed-btn" class="w-full bg-orange-custom hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">Crear Tarea</button>
                                <button type="button" id="cancel-edit-btn" onclick="resetDetailedTaskForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hidden">Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <div class="flex flex-wrap justify-between items-center gap-4 mb-4">
                            <div class="flex gap-2 flex-wrap items-center">
                                <h3 class="text-xl font-bold text-gray-800 mr-4">üìã Mis Tareas</h3>
                                <button type="button" id="filter-all" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-blue-custom text-white">Todas</button>
                                
                                <button type="button" id="filter-pendiente" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-gray-200 text-gray-700">Pendiente</button>
                                <button type="button" id="filter-en-curso" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-gray-200 text-gray-700">En Curso</button>
                                <button type="button" id="filter-en-revision" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-gray-200 text-gray-700">En Revisi√≥n</button>
                                <button type="button" id="filter-completada" class="filter-btn px-3 py-1 rounded-lg text-sm font-medium bg-gray-200 text-gray-700">Completada</button>
                                <button type="button" id="clear-completed-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-medium">Limpiar</button>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <label for="task-sort-select" class="text-sm font-medium text-gray-700">Ordenar por:</label>
                                <select id="task-sort-select" class="border rounded-lg px-3 py-1 text-sm" onchange="setTaskSort()">
                                    <option value="created_desc">M√°s Recientes</option>
                                    <option value="due_date_asc">Fecha de Vencimiento</option>
                                    <option value="priority_desc">Prioridad (Alta a Baja)</option>
                                    <option value="time_asc">Tiempo (Menor a Mayor)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="tasks-container" class="space-y-3">
                            <div class="text-center text-gray-500 py-4">
                                <span class="text-3xl block mb-2">üìù</span>
                                <p>No hay tareas. ¬°Agrega tu primera tarea!</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="lg:col-span-1 space-y-6">
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üçÖ Timer Pomodoro</h3>
                        
                        <div class="text-5xl font-mono text-center text-blue-custom mb-4" id="timer-display">25:00</div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-4">
                            <select id="pomodoro-task" class="w-full border rounded-lg px-3 py-2 text-sm">
                                <option value="">Seleccionar Tarea a Enfocar...</option>
                                </select>
                            <select id="pomodoro-sessions" class="w-full border rounded-lg px-3 py-2 text-sm">
                                <option value="1">1 Sesi√≥n</option>
                                <option value="2">2 Sesiones</option>
                                <option value="3">3 Sesiones</option>
                                <option value="4" selected>4 Sesiones</option>
                                <option value="6">5 Sesiones</option>
                                <option value="6">6 Sesiones</option>
                            </select>
                        </div>

                        <div class="flex gap-2 justify-center mb-4">
                            <button type="button" id="start-timer-btn" class="bg-orange-custom hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold">Iniciar</button>
                            <button type="button" id="pause-timer-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold">Pausa</button>
                            <button type="button" id="reset-timer-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold">Reset</button>
                        </div>

                        <div class="flex gap-2 justify-center mb-4">
                            <button type="button" id="set-time-work" class="text-xs px-3 py-1 rounded-full bg-blue-custom text-white">Trabajo (25m)</button>
                            <button type="button" id="set-time-short-break" class="text-xs px-3 py-1 rounded-full bg-green-500 text-white">Descanso (5m)</button>
                            <button type="button" id="set-time-long-break" class="text-xs px-3 py-1 rounded-full bg-gray-400 text-white">Largo (15m)</button>
                        </div>

                        <p class="text-gray-500" id="pomodoro-info">Sesi√≥n 1 de 4 - Modo: Trabajo</p>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìù Notas R√°pidas</h3>
                        <textarea id="quick-notes" placeholder="Anota tus ideas aqu√≠..." rows="6" class="w-full border rounded-lg px-3 py-2"></textarea>
                        <button type="button" id="save-notes-btn" class="w-full mt-3 bg-blue-custom hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">Guardar Notas</button>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Estad√≠sticas</h3>
                        <div class="space-y-4">

                            <div>
                                <div class="flex justify-between text-sm font-semibold mb-1">
                                    <span class="text-gray-700">Mi Progreso Total</span>
                                    <span class="text-blue-custom" id="stats-total-progress-text">0/0</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div id="stats-total-progress-bar" class="bg-blue-custom h-3 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Tareas completadas (mis √∫ltimos 7 d√≠as):</span>
                                <span class="font-semibold text-gray-900" id="stats-week-tasks">0</span>
                            </div>

                            <hr class="my-2">

                            <h4 class="text-md font-semibold text-gray-700">Mi Progreso por Categor√≠a</h4>
                            <div id="stats-category-breakdown" class="space-y-3">
                                <p class="text-sm text-gray-500 text-center">No hay tareas con categor√≠a.</p>
                            </div>

                            <div data-role="admin" class="hidden">
                                <hr class="my-4 border-gray-300">
                                <h4 class="text-md font-semibold text-gray-700">Progreso del Equipo</h4>
                                <div id="stats-team-breakdown" class="space-y-3 mt-3">
                                    </div>
                            </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="morosidadSection" class="hidden p-4 md:p-6 lg:p-8 space-y-6">
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex flex-wrap justify-between items-end gap-4 mb-2">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">üìä An√°lisis de Morosidad</h1>
                        <p class="text-gray-600">Seguimiento autom√°tico de cuentas por cobrar</p>
                    </div>
                    
                    <div class="flex gap-4 items-end">
                        <div class="w-full sm:w-64">
                            <label for="morosidadCompanyFilter" class="block text-sm font-medium text-gray-700">Filtrar por Empresa</label>
                            <select id="morosidadCompanyFilter" onchange="filterMorosidadByCompany(this.value)" class="w-full mt-1 border rounded-lg px-3 py-2"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-transparent select-none">Acci√≥n</label>
                            <button onclick="exportMorosidadToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold flex items-center justify-center">
                                <span class="mr-2">üìä</span> 
                                Exportar a Excel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                <div class="bg-green-100 rounded-lg p-4 border-l-4 border-green-500">
                    <div class="text-green-800 text-sm font-medium">Por Vencer (0-30 d√≠as)</div>
                    <div id="morosidad-rango-30" class="text-2xl font-bold text-green-700">L 0.00</div>
                </div>
                <div class="bg-yellow-100 rounded-lg p-4 border-l-4 border-yellow-500">
                    <div class="text-yellow-800 text-sm font-medium">Vencido (31-60 d√≠as)</div>
                    <div id="morosidad-rango-60" class="text-2xl font-bold text-yellow-700">L 0.00</div>
                </div>
                <div class="bg-orange-100 rounded-lg p-4 border-l-4 border-orange-500">
                    <div class="text-orange-800 text-sm font-medium">Vencido (61-90 d√≠as)</div>
                    <div id="morosidad-rango-90" class="text-2xl font-bold text-orange-700">L 0.00</div>
                </div>
                <div class="bg-red-100 rounded-lg p-4 border-l-4 border-red-500">
                    <div class="text-red-800 text-sm font-medium">Vencido (M√°s de 90 d√≠as)</div>
                    <div id="morosidad-rango-90-plus" class="text-2xl font-bold text-red-700">L 0.00</div>
                </div>
                <div class="bg-gray-100 rounded-lg p-4 border-l-4 border-gray-500">
                    <div class="text-gray-800 text-sm font-medium">Total Pendiente</div>
                    <div id="morosidad-total" class="text-2xl font-bold text-gray-700">L 0.00</div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800">üìã Detalle de Facturas Pendientes</h2>
                    </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th id="sort-cliente" onclick="sortMorosidadReport('cliente')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                    Cliente
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Factura</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Emisi√≥n</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">F. Vencimiento</th>
                                <th id="sort-monto" onclick="sortMorosidadReport('monto')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                    Total Factura
                                </th>
                                <th id="sort-dias" onclick="sortMorosidadReport('dias')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                    D√≠as Vencido
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="morosidadTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/* App JS integrado con PocketBase - Usa la SDK UMD: PocketBase disponible en window.PocketBase - Ajusta la URL si tu PocketBase no corre en localhost */
const pb = new PocketBase("https://db-conexion-hn.pockethost.io/");
let companies = []; // lista de registros companies (objetos PocketBase)
let documents = []; // lista de registros documents (objetos PocketBase)
let currentCompany = null; // Empresa seleccionada para facturas/recibos
let currentCompanyId = null; // ID de la empresa seleccionada para editar
let authorizations = []; // lista de registros autorizaciones
let products = []; // lista de registros products
let clients = []; // lista de registros clients
let users = []; // lista de registros users
let roles = []; //roles de usuarios
let bankAccounts = []; // lista de registros bank_accounts
let invoice_items = []; //lista de items de facturas/recibos
let currentlyDisplayedDocs = []; //variable para exportar los datos de pantalla
let currentHistoryFilter = 'all'; // Filtro de historial
let currentHistoryCompany = 'all'; // Empresa seleccionada para el historial
let currentHistoryDateStart = ''; // Fecha de inicio del rango
let currentHistoryDateEnd = '';   // Fecha de fin del rango
let agendaTasks = []; //lista de tareas programadas
let agendaNote = null; //notas rapidas
let agendaInitialized = false; // Inicializar agenda
let currentFilter = 'all'; //Para los filtros de tareas
let currentTaskSort = 'created_desc'; // Valor por defecto: M√°s Recientes
let activeNotifications = []; // Notificaciones
let morosidadSortBy = 'cliente'; // Columna por defecto para ordenar
let morosidadSortOrder = 'asc';   // Orden por defecto (ascendente)
let morosidadCompanyFilter = 'all'; // Filtro de empresa para este reporte
let morosidadReportData = []; // Guardar√° los datos filtrados para la exportaci√≥n

// --- Auth: Login / Logout ---
async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    document.getElementById('loginError').classList.add('hidden');
    try {
        // --- CAMBIO AQU√ç: A√±adimos 'expand' para traer los datos del rol ---
        await pb.collection('users').authWithPassword(email, password, {
            expand: 'role' 
        });

        // PASO 1: Cargar todos los datos primero, incluyendo los productos.
        await loadData();
        
        // PASO 2: Ahora que los datos est√°n listos, actualizamos la UI y la mostramos.
        updateUserInfo();
        setDefaultDates();
        initializeInvoiceForm();
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appScreen').classList.remove('hidden');
        applyPermissions();
    } catch (err) {
        console.error("Login error:", err);
        document.getElementById('loginError').classList.remove('hidden');
    }
}

function logout() {
    pb.authStore.clear();
    document.getElementById('appScreen').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('currentUser').textContent = '';
}

// --- Inicializaci√≥n y utilidades ---
document.addEventListener('DOMContentLoaded', function() {
    // Si ya hay sesi√≥n v√°lida en authStore, usarla
    if (pb.authStore.isValid) {
        // Ejecutamos una funci√≥n an√≥nima as√≠ncrona para poder usar 'await'
        (async () => {
            try {

                // PASO 1: Refrescamos la sesi√≥n para traer el rol ---
                await pb.collection('users').authRefresh({
                    expand: 'role'
                });

                // PASO 2: Cargar todos los datos primero.
                await loadData();

                // PASO 3: Ahora que los datos est√°n, mostramos la app.
                updateUserInfo();
                setDefaultDates();
                initializeInvoiceForm();
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('appScreen').classList.remove('hidden');
                // Aplicamos los permisos
                applyPermissions();
            } catch (err) {
                console.error("Error al cargar datos en el inicio:", err);
                logout(); // Si falla la carga, cerramos sesi√≥n para evitar problemas
            }
        })();
    } else {
        document.getElementById('loginScreen').classList.remove('hidden');
    }
});

function setDefaultDates() {
    const today = new Date().toISOString().split('T')[0];
    const iDate = document.getElementById('invoiceDate');
    const rDate = document.getElementById('receiptDate');
    if (iDate && !iDate.value) iDate.value = today;
    if (rDate && !rDate.value) rDate.value = today;
}

async function loadData() {
    try {
        console.log("Iniciando carga de datos...");

        // Cargar las otras colecciones
        const companiesList = await pb.collection('companies').getFullList({ sort: '-created' });
        companies = companiesList || [];
        //Carga la lista de documentos
        const documentsList = await pb.collection('documents').getFullList({ sort: '-created', expand: 'company' });
        documents = documentsList || [];
        //Carga la lista de autorizaciones
        const authList = await pb.collection('autorizaciones_factura').getFullList({ sort: '-created', expand: 'empresa' });
        authorizations = authList || [];
        //Cargar la lista de clientes
        const clientsList = await pb.collection('clients').getFullList({ sort: 'name' });
        clients = clientsList || [];
        
        // Para simplificar, las guardamos en un solo objeto
        window.catalogs = {};
        const [groups, prices, terms] = await Promise.all([   
            pb.collection('client_groups').getFullList({ sort: 'name' }),
            pb.collection('price_lists').getFullList({ sort: 'name' }),
            pb.collection('payment_terms').getFullList({ sort: 'name' })
        ]);
        window.catalogs.client_groups = groups;
        window.catalogs.price_lists = prices;
        window.catalogs.payment_terms = terms;
        
        // Solo intentamos cargar la lista de usuarios y roles si el usuario es admin
        const currentUserRole = pb.authStore.model?.expand?.role?.name;
        if (currentUserRole === 'admin') {
            const [usersList, rolesList] = await Promise.all([
                pb.collection('users').getFullList({ expand: 'role' }),
                pb.collection('roles').getFullList()
            ]);
            users = usersList || [];
            roles = rolesList || [];
        }
        // Solo intentamos cargar si el usuario es admin
        if (currentUserRole === 'admin') {
            // ... (carga de users y roles)
            const accountsList = await pb.collection('bank_accounts').getFullList({ sort: '-created', expand: 'company' });
            bankAccounts = accountsList || [];
        }

        // --- BLOQUE DE DIAGN√ìSTICO PARA PRODUCTOS ---
        console.log("Paso 1: Intentando cargar la colecci√≥n 'products'...");
        try {
            const productsList = await pb.collection('products').getFullList({ sort: '-created' });
            products = productsList || [];

            // Cargar Tareas de Agenda
            let taskFilter = `user = "${pb.authStore.model.id}"`; // Operador solo ve lo suyo
            if (pb.authStore.model.expand.role.name === 'admin') {
                taskFilter = ''; // Admin ve TODAS las tareas
            }

            try {
                // Carga las tareas del usuario logueado
                const tasksList = await pb.collection('agenda_tasks').getFullList({ 
                        filter: taskFilter, 
                        sort: '-created',
                        expand: 'user,assigned_by' // Expandimos para ver los nombres
                    });
                agendaTasks = tasksList || [];
                checkAppNotifications();

                // Carga la nota r√°pida del usuario
                try {
                    const note = await pb.collection('agenda_notes').getFirstListItem(`user = "${pb.authStore.model.id}"`);
                    agendaNote = note;
                } catch (err) {
                    // Si no tiene nota, le crea una vac√≠a
                    console.log("Creando registro de nota para el usuario.");
                    agendaNote = await pb.collection('agenda_notes').create({
                        user: pb.authStore.model.id,
                        content: ''
                    });
                }

            } catch (err) {
                console.error("Error al cargar datos de la agenda:", err);
                // Podr√≠as mostrar un error, pero por ahora solo lo logueamos
            }
            
            // Este console.log es la prueba definitiva.
            console.log("Paso 2: ¬°√âXITO AL CARGAR PRODUCTOS! La lista de productos contiene:", products);
            
            if (products.length === 0) {
                alert("Diagn√≥stico: La lista de productos se carg√≥ correctamente desde la base de datos, pero est√° vac√≠a. Por favor, aseg√∫rate de haber creado al menos un producto en el panel de PocketBase.");
            }
        } catch (productError) {
            console.error("--- ¬°ERROR CR√çTICO AL CARGAR PRODUCTOS! ---");
            console.error("La llamada a pb.collection('products').getFullList() ha fallado. Raz√≥n:", productError);
            alert("ERROR DE DIAGN√ìSTICO: No se pudo cargar la lista de productos. Revisa la consola (F12) para ver el error espec√≠fico. Es muy probable que sea un error de permisos (403 Forbidden).");
        }
        // --- FIN DEL BLOQUE DE DIAGN√ìSTICO ---

    } catch (generalError) {
        console.error("Error en la carga general de datos (compa√±√≠as, documentos, etc.):", generalError);
        alert("Ocurri√≥ un error al cargar los datos iniciales. Revisa la consola.");
    }

    // Actualizar la interfaz de usuario
    console.log("Paso 3: Actualizando la interfaz de usuario con los datos cargados...");
    updateCompanySelects();
    //updateCompanyFilter();
    updateReports();
    loadHistory();
    populateClientSelects();
    populateDatalists();
    console.log("Carga de datos y actualizaci√≥n de UI completada.");
}

function updateUserInfo() {
    const user = pb.authStore.model;
    const currentUserDiv = document.getElementById('currentUser');
    const avatarImg = document.getElementById('userAvatar');

    if (user) {
        // Muestra el email del usuario
        currentUserDiv.textContent = user.email;

        // Si el usuario tiene un avatar, muestra la imagen
        if (user.avatar) {
            const avatarUrl = pb.files.getURL(user, user.avatar);
            avatarImg.src = avatarUrl;
        }
        // Si no tiene avatar, se usar√° la imagen SVG por defecto del HTML.
        
    } else {
        currentUserDiv.textContent = '';
    }
}

// FUNCI√ìN de permisos de usuario
function applyPermissions() {
    const user = pb.authStore.model;
    
    // El 'expand' nos da el objeto completo del rol, incluyendo su nombre.
    const userRole = user?.expand?.role?.name; 
    
    console.log(`Aplicando permisos para el rol: ${userRole}`);

    // Si el usuario es un administrador, no hacemos nada (puede ver todo).
    if (userRole === 'admin') {
        // Hacemos visibles todos los elementos restringidos por si estaban ocultos.
        document.querySelectorAll('[data-role]').forEach(el => el.style.display = 'flex');
        return; 
    }

    // Si no es admin (o no tiene rol), ocultamos los elementos restringidos.
    document.querySelectorAll('[data-role="admin"]').forEach(el => {
        el.style.display = 'none';
    });
}

//---Notifiaciones ----
function toggleNotificationPanel() {
    const panel = document.getElementById('notification-panel');
    panel.classList.toggle('hidden');
}

/**
 * Revisa todas las tareas y actualiza la lista de notificaciones activas.
 * - Operadores: Ven solo sus tareas vencidas.
 * - Admins: Ven sus tareas vencidas + las tareas de todos los operadores.
 * (Los Admins NO ven las tareas de otros Admins).
 */
function checkAppNotifications() {
    activeNotifications = []; // Limpia la lista
    const today = new Date().setHours(0, 0, 0, 0); // Timestamp de hoy a medianoche
    
    const myId = pb.authStore.model.id;
    const isAdmin = pb.authStore.model.expand.role.name === 'admin';

    let tasksToScan;

    if (isAdmin) {
        // --- L√ìGICA DE FILTRO PARA ADMIN ---
        // El admin tiene 'agendaTasks' (global) y la lista 'users' (global).
        tasksToScan = agendaTasks.filter(task => {
            const taskOwnerId = task.user;
            
            // 1. Incluir si la tarea es M√çA
            if (taskOwnerId === myId) {
                return true;
            }
            
            // 2. Revisar el rol del due√±o de la tarea
            const taskOwner = users.find(u => u.id === taskOwnerId);
            
            // 3. Incluir si el due√±o es un 'operador'
            if (taskOwner && taskOwner.expand.role.name === 'operador') {
                return true;
            }
            
            // 4. Excluir. (Si llega aqu√≠, es una tarea de OTRO admin)
            return false;
        });
        
    } else {
        // --- L√ìGICA DE FILTRO PARA OPERADOR ---
        // El operador solo tiene sus propias tareas en 'agendaTasks'. No necesita filtro.
        tasksToScan = agendaTasks;
    }

    // --- REVISI√ìN DE TAREAS (L√≥gica sin cambios) ---
    // Ahora 'tasksToScan' es la lista correcta para este usuario.
    tasksToScan.forEach(task => {
        const isPending = task.status !== 'Completada';
        
        if (isPending && task.due_date) {
            const taskDueDate = new Date(task.due_date).setHours(0, 0, 0, 0);
            
            // Si la tarea venci√≥ (es de ayer o antes) O vence hoy
            if (taskDueDate <= today) {
                activeNotifications.push(task);
            }
        }
    });
    
    // Ordena por fecha (m√°s vencidas primero)
    activeNotifications.sort((a, b) => new Date(a.due_date) - new Date(b.due_date));
    
    // Actualiza la interfaz visual
    renderNotifications();
}

/**
 * Dibuja las notificaciones en el panel y actualiza el contador.
 * Muestra a qu√© operador pertenece la tarea si el usuario es Admin.
 */
function renderNotifications() {
    const list = document.getElementById('notification-list');
    const badge = document.getElementById('notification-count-badge');
    
    // Datos del usuario actual
    const myId = pb.authStore.model.id;
    const isAdmin = pb.authStore.model.expand.role.name === 'admin';
    
    if (activeNotifications.length === 0) {
        list.innerHTML = '<p class="text-center text-gray-500 p-4">No tienes notificaciones nuevas.</p>';
        badge.classList.add('hidden');
        badge.textContent = '0';
    } else {
        list.innerHTML = ''; // Limpia la lista
        badge.textContent = activeNotifications.length;
        badge.classList.remove('hidden');

        activeNotifications.forEach(task => {
            const li = document.createElement('a');
            li.href = "#";
            li.className = "block p-3 hover:bg-gray-100";
            
            li.onclick = (e) => {
                e.preventDefault();
                showAgenda();
                toggleNotificationPanel();
            };

            const isOverdue = new Date(task.due_date).setHours(0,0,0,0) < new Date().setHours(0,0,0,0);
            const dateText = isOverdue ? 'Venci√≥' : 'Vence hoy';

            // --- ‚ñº‚ñº‚ñº L√ìGICA PARA MOSTRAR EL NOMBRE ‚ñº‚ñº‚ñº ---
            let userNameHtml = '';
            // Si soy Admin Y la tarea NO es m√≠a, muestra el nombre del operador
            if (isAdmin && task.user !== myId) {
                // Usamos 'expand' para obtener el nombre del usuario
                const userName = task.expand?.user?.name || 'Usuario Desconocido';
                userNameHtml = `<div class="text-xs font-semibold text-blue-custom">De: ${escapeHtml(userName)}</div>`;
            }
            // --- ‚ñ≤‚ñ≤‚ñ≤ FIN DE LA L√ìGICA ‚ñ≤‚ñ≤‚ñ≤ ---

            li.innerHTML = `
                <div class="font-semibold text-sm text-gray-800">${escapeHtml(task.title)}</div>
                ${userNameHtml} <div class="text-xs text-gray-600">
                    <span class="font-medium ${isOverdue ? 'text-red-500' : 'text-orange-500'}">${dateText}</span>
                    - ${new Date(task.due_date).toLocaleDateString()}
                </div>
            `;
            list.appendChild(li);
        });
    }
}
//--- Final Notifiaciones ----

// --- Gesti√≥n de Empresas ---
async function addCompany(formData) {
    try {
        await pb.collection('companies').create(formData);
        alert('¬°Empresa agregada con √©xito!');
        clearForm();
        hideCompanyManager();
        await loadData();
    } catch (err) {
        console.error("Error al agregar empresa:", err);
        alert('Ocurri√≥ un error al agregar la empresa.');
    }
}

async function updateCompany(companyId, formData) {
  try {
    await pb.collection('companies').update(companyId, formData);
    alert('¬°Registro de empresa actualizado con √©xito!');
    clearForm();
    hideCompanyManager();
    await loadData();
  } catch (error) {
    console.error('Error al actualizar el registro:', error);
    alert('Ocurri√≥ un error al actualizar la empresa.');
  }
}

async function deleteCompany(id) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar esta empresa?')) return;
    try {
        await pb.collection('companies').delete(id);
        alert('Empresa eliminada con √©xito.');
        loadData();
    } catch (err) {
        console.error("Error al eliminar empresa:", err);
        alert('Error al eliminar empresa. Verifica si hay documentos relacionados.');
    }
}

// --- L√≥gica de la Interfaz ---
function showCompanyManager() {
    document.getElementById('companyModal').classList.remove('hidden');
    renderCompaniesList();
    clearForm();
}

function hideCompanyManager() {
    document.getElementById('companyModal').classList.add('hidden');
}

function renderCompaniesList() {
    const listContainer = document.getElementById('companiesList');
    listContainer.innerHTML = '';
    companies.forEach(c => {
        const companyDiv = document.createElement('div');
        companyDiv.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm';
        companyDiv.innerHTML = `
            <span class="font-medium">${escapeHtml(c.name)}</span>
            <div class="flex gap-2">
                <button onclick="selectCompanyForEdit('${c.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                <button onclick="deleteCompany('${c.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
            </div>
        `;
        listContainer.appendChild(companyDiv);
    });
}

function clearForm() {
    document.getElementById('companyForm').reset();
    currentCompanyId = null;
    document.getElementById('logoPreviewContainer').classList.add('hidden');
    document.getElementById('currentLogoPreview').src = '';
}

async function handleCompanyFormSubmit(e) {
  e.preventDefault();
  const formData = new FormData();
  const companyId = document.getElementById('companyId').value;
  
  // Recolectar datos del formulario (esto no cambia)
  formData.append('name', document.getElementById('newCompanyName').value);
  formData.append('rtn', document.getElementById('newCompanyRTN').value);
  formData.append('address', document.getElementById('newCompanyAddress').value);
  formData.append('phone', document.getElementById('newCompanyPhone').value);
  formData.append('email', document.getElementById('newCompanyEmail').value);
  const logoInput = document.getElementById('newCompanyLogo');
  if (logoInput.files.length > 0) {
    formData.append('logo', logoInput.files[0]);
  }

  try {
      if (companyId) {
          // La l√≥gica de ACTUALIZACI√ìN no necesita cambios.
          await pb.collection('companies').update(companyId, formData);
          alert('¬°Empresa actualizada con √©xito!');
      } else {
          // --- INICIO DE LA MODIFICACI√ìN ---
          // Al CREAR una nueva empresa, a√±adimos el valor por defecto para el contador.
          formData.append('siguiente_numero_recibo', 1);
          // --- FIN DE LA MODIFICACI√ìN ---

          await pb.collection('companies').create(formData);
          alert('¬°Empresa agregada con √©xito!');
      }
      hideCompanyManager();
      await loadData();
  } catch(err) {
      console.error("Error al guardar empresa:", err);
      alert("Error al guardar empresa. Revisa la consola.");
  }
}

function selectCompanyForEdit(id) {
    const c = companies.find(x => x.id === id);
    if (!c) return;
    document.getElementById('companyId').value = c.id;
    document.getElementById('newCompanyName').value = c.name || '';
    document.getElementById('newCompanyRTN').value = c.rtn || '';
    document.getElementById('newCompanyAddress').value = c.address || '';
    document.getElementById('newCompanyPhone').value = c.phone || '';
    document.getElementById('newCompanyEmail').value = c.email || '';
    if (c.logo) {
        const logoUrl = pb.getFileUrl(c, c.logo, { 'thumb': '100x100' });
        document.getElementById('currentLogoPreview').src = logoUrl;
        document.getElementById('logoPreviewContainer').classList.remove('hidden');
    } else {
        document.getElementById('logoPreviewContainer').classList.add('hidden');
    }
    alert('Datos cargados en el formulario para editar.');
}

function updateCompanySelects() {
    const invoiceSelect = document.getElementById('companySelect');
    const receiptSelect = document.getElementById('receiptCompanySelect');
    invoiceSelect.innerHTML = '<option value="">Seleccionar empresa...</option>';
    receiptSelect.innerHTML = '<option value="">Seleccionar empresa...</option>';
    companies.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id; option.textContent = c.name;
        invoiceSelect.appendChild(option.cloneNode(true));
        receiptSelect.appendChild(option);
    });
    if (currentCompany) {
        invoiceSelect.value = currentCompany.id;
        receiptSelect.value = currentCompany.id;
    }
}

// funci√≥n updateCompanyData
async function updateCompanyData() {
    const select = document.getElementById('companySelect');
    const companyId = select.value;
    currentCompany = findCompanyById(companyId);

    const invoiceNumberInput = document.getElementById('invoiceNumber');
    const authInfoDiv = document.getElementById('authInfo');

    // Limpiar campos antes de buscar
    invoiceNumberInput.value = '';
    authInfoDiv.classList.add('hidden');

    if (!companyId) {
        return; // No hacer nada si no hay empresa seleccionada
    }

    // Buscar la autorizaci√≥n activa para la empresa seleccionada
    const activeAuth = authorizations.find(auth => auth.empresa === companyId && auth.esta_activa);

    if (activeAuth) {
        // Validar si la autorizaci√≥n sigue vigente
        const hoy = new Date();
        const fechaLimite = new Date(activeAuth.fecha_limite);

        if (activeAuth.numero_actual > activeAuth.rango_fin) {
            alert('¬°Atenci√≥n! El rango de facturaci√≥n para esta empresa ha llegado a su fin.');
            return;
        }
        if (hoy > fechaLimite) {
            alert('¬°Atenci√≥n! La fecha l√≠mite de emisi√≥n para esta empresa ha expirado.');
            return;
        }

        // Formatear el n√∫mero de factura
        const sucursal = String(activeAuth.cod_sucursal).padStart(3, '0');
        const puntoEmision = String(activeAuth.cod_punto_emision).padStart(3, '0');
        const tipoDoc = String(activeAuth.cod_tipo_doc).padStart(2, '0');
        const correlativo = String(activeAuth.numero_actual).padStart(8, '0');
        
        const numeroFactura = `${sucursal}-${puntoEmision}-${tipoDoc}-${correlativo}`;
        invoiceNumberInput.value = numeroFactura;

        // Mostrar informaci√≥n de la autorizaci√≥n
        document.getElementById('activeCAI').textContent = activeAuth.cai;
        document.getElementById('activeRange').textContent = `${activeAuth.rango_inicio} - ${activeAuth.rango_fin}`;
        document.getElementById('activeDate').textContent = fechaLimite.toLocaleDateString();
        authInfoDiv.classList.remove('hidden');

    } else {
        alert('No se encontr√≥ una autorizaci√≥n de facturaci√≥n activa para la empresa seleccionada. Por favor, configure una en "Gestionar Autorizaciones".');
    }
}

// FUNCI√ìN SOLO PARA RECIBOS
function updateReceiptCompanyData() {
    const select = document.getElementById('receiptCompanySelect');
    const companyId = select.value;
    currentCompany = findCompanyById(companyId);
    
    const receiptNumberInput = document.getElementById('receiptNumber');

    if (currentCompany) {
        // Verifica si el campo del contador existe y es un n√∫mero
        if (typeof currentCompany.siguiente_numero_recibo === 'number') {
            receiptNumberInput.value = currentCompany.siguiente_numero_recibo;
        } else {
            // Si el campo no existe o es nulo, avisa al usuario
            receiptNumberInput.value = '';
            alert('Esta empresa no tiene configurado un contador de recibos. Por favor, edite la empresa y guarde para iniciar el contador en 1.');
        }
    } else {
        receiptNumberInput.value = '';
    }
}


function findCompanyById(id) {
    return id ? companies.find(c => c.id === id) || null : null;
}

// funci√≥n showSection
function showSection(sectionId) {
    // Lista de TODAS las secciones principales de tu aplicaci√≥n
    const sections = [
        'invoiceSection', 
        'receiptSection', 
        'historySection', 
        'reportsSection', 
        'productManagerModal', // Si estos son modales, no deber√≠an estar aqu√≠, pero ajusta seg√∫n tu l√≥gica
        'clientModal',
        'userManagerModal',
        'bankAccountModal',
        'agendaSection',
        'morosidadSection'
    ];

    // Oculta todas las secciones
    sections.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('hidden');
        } else {
            // Este console.log te dir√° si falta alg√∫n ID
            console.warn(`La secci√≥n con id '${id}' no se encontr√≥.`);
        }
    });

    // Muestra solo la secci√≥n objetivo
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.remove('hidden');
    } else {
        console.error(`Error: No se pudo mostrar la secci√≥n '${sectionId}' porque no se encontr√≥ en el HTML.`);
    }
}

//function printDocument() { window.print(); }

function escapeHtml(unsafe) {
  if (unsafe === undefined || unsafe === null) return '';
  return String(unsafe).replace(/[&<>\"'`=\\/]/g, s => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', "'": '&#39;', '/': '&#x2F;', '`': '&#x60;', '=': '&#x3D;'
  })[s]);
}

function escapeCsv(val) {
  if (val === undefined || val === null) return '';
  let str = String(val);
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    str = '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

function handleInvoiceSubmit() {
    const editingId = document.getElementById('editingInvoiceId').value;
    generateInvoice(editingId || null);
}

// --- Gesti√≥n de Autorizaciones ---
function showAuthManager() {
    document.getElementById('authForm').reset(); // Limpiar formulario
    document.getElementById('authId').value = ''; // Limpiar ID de edici√≥n
    
    // Poblar el dropdown de empresas
    const companySelect = document.getElementById('authCompany');
    companySelect.innerHTML = '<option value="">Seleccione una empresa...</option>';
    companies.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.name;
        companySelect.appendChild(option);
    });

    renderAuthList(); // Dibujar la lista de autorizaciones existentes
    document.getElementById('authModal').classList.remove('hidden');
}

function hideAuthManager() {
    document.getElementById('authModal').classList.add('hidden');
}

function renderAuthList() {
    const listContainer = document.getElementById('authList');
    listContainer.innerHTML = '';
    authorizations.forEach(auth => {
        const authDiv = document.createElement('div');
        const companyName = auth.expand && auth.expand.empresa ? auth.expand.empresa.name : 'Empresa Desconocida';
        authDiv.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm';
        authDiv.innerHTML = `
            <div>
                <span class="font-medium text-sm">CAI: ${escapeHtml(auth.cai)}</span>
                <p class="text-xs text-gray-600">Empresa: ${escapeHtml(companyName)} | Rango: ${auth.rango_inicio}-${auth.rango_fin} ${auth.esta_activa ? '<span class="text-green-600 font-bold">(Activa)</span>' : ''}</p>
            </div>
            <div class="flex gap-2">
                <button onclick="selectAuthForEdit('${auth.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                <button onclick="deleteAuth('${auth.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
            </div>
        `;
        listContainer.appendChild(authDiv);
    });
}

async function handleAuthFormSubmit(event) {
    event.preventDefault();
    const authId = document.getElementById('authId').value;

    const data = {
        empresa: document.getElementById('authCompany').value,
        cai: document.getElementById('authCAI').value,
        fecha_limite: document.getElementById('authFechaLimite').value,
        rango_inicio: parseInt(document.getElementById('authRangoInicio').value),
        rango_fin: parseInt(document.getElementById('authRangoFin').value),
        numero_actual: parseInt(document.getElementById('authNumeroActual').value),
        cod_sucursal: document.getElementById('authCodSucursal').value,
        cod_punto_emision: document.getElementById('authCodPuntoEmision').value,
        cod_tipo_doc: document.getElementById('authCodTipoDoc').value,
        esta_activa: document.getElementById('authEstaActiva').checked,
    };

    try {
        if (authId) {
            // Actualizar registro existente
            await pb.collection('autorizaciones_factura').update(authId, data);
            alert('¬°Autorizaci√≥n actualizada con √©xito!');
        } else {
            // Crear nuevo registro
            await pb.collection('autorizaciones_factura').create(data);
            alert('¬°Autorizaci√≥n creada con √©xito!');
        }
        hideAuthManager();
        await loadData(); // Recargar todos los datos para reflejar los cambios
    } catch (err) {
        console.error("Error al guardar la autorizaci√≥n:", err);
        alert('Ocurri√≥ un error al guardar la autorizaci√≥n. Revisa la consola.');
    }
}

function selectAuthForEdit(id) {
    const auth = authorizations.find(a => a.id === id);
    if (!auth) return;

    // Llenar el formulario con los datos existentes
    document.getElementById('authId').value = auth.id;
    document.getElementById('authCompany').value = auth.empresa;
    document.getElementById('authCAI').value = auth.cai;
    // Formatear la fecha para el input type="date"
    document.getElementById('authFechaLimite').value = new Date(auth.fecha_limite).toISOString().split('T')[0];
    document.getElementById('authRangoInicio').value = auth.rango_inicio;
    document.getElementById('authRangoFin').value = auth.rango_fin;
    document.getElementById('authNumeroActual').value = auth.numero_actual;
    document.getElementById('authCodSucursal').value = auth.cod_sucursal;
    document.getElementById('authCodPuntoEmision').value = auth.cod_punto_emision;
    document.getElementById('authCodTipoDoc').value = auth.cod_tipo_doc;
    document.getElementById('authEstaActiva').checked = auth.esta_activa;
}

async function deleteAuth(id) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar esta autorizaci√≥n?')) return;
    try {
        await pb.collection('autorizaciones_factura').delete(id);
        alert('Autorizaci√≥n eliminada con √©xito.');
        await loadData();
    } catch (err) {
        console.error("Error al eliminar la autorizaci√≥n:", err);
        alert('Error al eliminar. Verifica si hay facturas relacionadas con esta autorizaci√≥n.');
    }
}

// --- L√≥gica Principal de Facturas ---
async function generateInvoice(editingId = null) {
    const saveBtn = document.getElementById('saveInvoiceBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';

    // --- RECOLECCI√ìN DE DATOS COM√öN PARA AMBOS CASOS ---
    const invoiceDate = document.getElementById('invoiceDate').value;
    const clientName = document.getElementById('clientName').value;
    const clientRTN = document.getElementById('clientRTN').value;
    const clientAddress = document.getElementById('clientAddress').value;
    const paymentMethod = document.getElementById('paymentMethod').value;
    const taxRateSelect = document.getElementById('taxRate');
    const taxRateValue = taxRateSelect.value;
    const observations = document.getElementById('observations').value;
    const itemsFromForm = [];
    document.querySelectorAll('.invoice-item').forEach(itemDiv => {
        const quantity = parseFloat(itemDiv.querySelector('.quantity').value);
        const price = parseFloat(itemDiv.querySelector('.price').value);
        const productSelect = itemDiv.querySelector('.description');
        let description = '';
        if (productSelect.value) {
            description = productSelect.options[productSelect.selectedIndex].text;
        }
        if (quantity && description && price) {
            itemsFromForm.push({ quantity, description, price });
        }
    });

    // --- L√ìGICA DE VENCIMIENTO ---
    // 1. Encontrar el cliente seleccionado en nuestra lista global
    const clienteSeleccionado = clients.find(c => c.name === clientName);
    
    // 2. Obtener sus d√≠as de cr√©dito (o 0 si no se encuentra o no tiene)
    const creditDays = clienteSeleccionado ? (clienteSeleccionado.credit_days || 0) : 0;
    
    // 3. Calcular la nueva fecha de vencimiento
    // (Aseguramos que la fecha se cree en la zona horaria local)
    const parts = invoiceDate.split('-'); // Formato YYYY-MM-DD
    const emisionDate = new Date(parts[0], parts[1] - 1, parts[2]); // Meses son 0-indexados
    
    emisionDate.setDate(emisionDate.getDate() + creditDays);
    
    // 4. Convertir a un string YYYY-MM-DD para PocketBase
    const newDueDate = emisionDate.toISOString().split('T')[0];
    
    // --- FIN DE LA L√ìGICA ---

    // 1. Separar subtotales en gravables y exentos
    let taxableSubtotal = 0;
    let exemptSubtotal = 0;
    itemsFromForm.forEach(item => {
        // Buscamos el producto completo para saber si es exento
        const product = products.find(p => p.id === item.productId || `${p.name} (${p.product_code || 'S/C'})` === item.description);
        const lineTotal = item.quantity * item.price;
        
        if (product && product.is_exempt) {
            exemptSubtotal += lineTotal; // Suma a los exentos
        } else {
            taxableSubtotal += lineTotal; // Suma a los gravables
        }
    });

    const subtotal = itemsFromForm.reduce((sum, item) => sum + (item.quantity * item.price), 0);
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;

    // 2. Aplicar el descuento proporcionalmente para calcular el impuesto correctamente
    let discountOnTaxable = 0;
    if (subtotal > 0) {
        discountOnTaxable = (taxableSubtotal / subtotal) * discount;
    }
    
    const taxableBase = taxableSubtotal - discountOnTaxable;
    const taxRateForCalc = (taxRateValue === 'exonerado') ? 0 : parseFloat(taxRateValue) || 0;

    // 3. Calcular el impuesto SOLO sobre la base gravable
    const taxAmount = taxableBase * (taxRateForCalc / 100);
    const total = subtotal - discount + taxAmount;

    try {
        if (editingId) {
            // --- L√ìGICA PARA ACTUALIZAR UNA FACTURA EXISTENTE ---
            const invoiceNumber = document.getElementById('invoiceNumber').value; // Usamos el n√∫mero existente

            const documentData = {
                // No se toca la autorizaci√≥n ni el contador
                number: invoiceNumber, // Se mantiene el n√∫mero original
                type: 'Factura',
                company: currentCompany.id,
                date: invoiceDate,
                due_date: newDueDate,
                clientName, clientRTN, clientAddress,
                subtotal, discount_amount: discount, taxRate: taxRateValue,
                taxAmount, total, paymentMethod, observations,
                created_by: pb.authStore.model.id,                
            };
            
            // L√≥gica para exonerado
            if (taxRateValue === 'exonerado') {
                documentData.orden_compra_exenta = document.getElementById('ordenCompraExenta').value;
                documentData.constancia_registro_exonerado = document.getElementById('constanciaRegistroExonerado').value;
                documentData.registro_sag = document.getElementById('registroSAG').value;
            }

            // 1. Actualizar los datos principales de la factura
            await pb.collection('documents').update(editingId, documentData);

            // 2. Borrar los art√≠culos viejos
            const oldItems = await pb.collection('invoice_items').getFullList({ filter: `invoice = "${editingId}"` });
            for (const item of oldItems) {
                await pb.collection('invoice_items').delete(item.id);
            }

            // 3. Crear los art√≠culos nuevos
            for (const item of itemsFromForm) {
                await pb.collection('invoice_items').create({
                    invoice: editingId,
                    description: item.description,
                    quantity: item.quantity,
                    price: item.price,
                });
            }

            alert('¬°Factura actualizada con √©xito!');
            // Buscamos los datos de autorizaci√≥n para pasarlos a la vista previa
            const originalDoc = documents.find(d => d.id === editingId);
            const authData = authorizations.find(a => a.id === originalDoc.autorizacion);
            // Actualizamos la vista previa con los nuevos datos
            updateInvoicePreview(documentData, itemsFromForm, authData);
            await loadData();

        } else {
            // --- L√ìGICA PARA CREAR UNA NUEVA FACTURA (con reintento) ---
            const createInvoiceRecord = async () => {
                const activeAuth = authorizations.find(auth => auth.empresa === currentCompany.id && auth.esta_activa);
                if (!activeAuth) throw new Error("No se encontr√≥ una autorizaci√≥n de facturaci√≥n activa.");

                const correlativo = String(activeAuth.numero_actual).padStart(8, '0');
                const invoiceNumber = `${String(activeAuth.cod_sucursal).padStart(3, '0')}-${String(activeAuth.cod_punto_emision).padStart(3, '0')}-${String(activeAuth.cod_tipo_doc).padStart(2, '0')}-${correlativo}`;

                const documentData = {
                    autorizacion: activeAuth.id,
                    number: invoiceNumber,
                    type: 'Factura',
                    company: currentCompany.id,
                    date: invoiceDate, due_date: newDueDate, clientName, clientRTN, clientAddress,
                    subtotal, discount_amount: discount, taxRate: taxRateValue,
                    taxAmount, total, paymentMethod, observations,
                    created_by: pb.authStore.model.id,
                    payment_status: 'Pendiente'
                };
                 if (taxRateValue === 'exonerado') {
                    documentData.orden_compra_exenta = document.getElementById('ordenCompraExenta').value;
                    documentData.constancia_registro_exonerado = document.getElementById('constanciaRegistroExonerado').value;
                    documentData.registro_sag = document.getElementById('registroSAG').value;
                }

                const newInvoice = await pb.collection('documents').create(documentData);
                for (const item of itemsFromForm) {
                    await pb.collection('invoice_items').create({
                        invoice: newInvoice.id,
                        description: item.description,
                        quantity: item.quantity,
                        price: item.price,
                    });
                }
                await pb.collection('autorizaciones_factura').update(activeAuth.id, { 'numero_actual+': 1 });
                return { documentData, itemsFromForm, activeAuth };
            };

            try {
                const result = await createInvoiceRecord();
                alert(`¬°Factura ${result.documentData.number} guardada con √©xito!`);
                updateInvoicePreview(result.documentData, result.itemsFromForm, result.activeAuth);
                await loadData();
            } catch (err) {
                if (err.response?.data?.number?.code === 'validation_not_unique') {
                    console.warn("Colisi√≥n de n√∫mero. Reintentando...");
                    await loadData();
                    const result = await createInvoiceRecord();
                    alert(`¬°Factura ${result.documentData.number} guardada con √©xito! (en el segundo intento)`);
                    updateInvoicePreview(result.documentData, result.itemsFromForm, result.activeAuth);
                    await loadData();
                } else {
                    throw err; // Lanza el error para que el catch exterior lo maneje
                }
            }
        }
    } catch (err) {
        alert('Ocurri√≥ un error al guardar. Revisa los datos e int√©ntalo de nuevo.');
        console.error("Error en generateInvoice:", err);
        saveBtn.disabled = false;
        saveBtn.textContent = editingId ? 'üíæ Guardar Cambios' : 'üíæ Guardar Factura';
    }
}

function handleTaxChange() {
    const taxRateSelect = document.getElementById('taxRate');
    const exoneradoFieldsDiv = document.getElementById('exoneradoFields');

    // Si se selecciona "Exonerado", muestra los campos. Si no, oc√∫ltalos.
    if (taxRateSelect.value === 'exonerado') {
        exoneradoFieldsDiv.classList.remove('hidden');
    } else {
        exoneradoFieldsDiv.classList.add('hidden');
    }

    // Llama a la funci√≥n existente para recalcular los totales
    calculateTotals();
}

function resetInvoiceForm() {
    document.getElementById('invoiceForm').reset();
    document.getElementById('editingInvoiceId').value = '';
    document.getElementById('invoiceTitle').textContent = 'Nueva Factura';
    document.getElementById('invoiceItems').innerHTML = '';
    document.getElementById('authInfo').classList.add('hidden');
    document.getElementById('exoneradoFields').classList.add('hidden');
    document.getElementById('discountAmount').value = '';
    // Reactiva el bot√≥n de guardar y restaura su texto original
    const saveBtn = document.getElementById('saveInvoiceBtn');
    saveBtn.disabled = false;
    saveBtn.textContent = 'üíæ Guardar Factura';

    addInvoiceItem();
    calculateTotals();
    setDefaultDates();
    document.getElementById('invoicePreview').innerHTML = '<p class="text-gray-500 text-center mt-20">La vista previa aparecer√° aqu√≠</p>';
}

//funci√≥n updateInvoicePreview
function updateInvoicePreview(docData, items, authData) {
    const preview = document.getElementById('invoicePreview');
    const company = findCompanyById(docData.company);
    const logoUrl = company && company.logo ? pb.files.getURL(company, company.logo) : '';
    const logoHtml = logoUrl ? `<img src="${logoUrl}" alt="Logo" class="h-24 mb-6 object-contain">` : '';

// 1. Separar subtotales en gravables y exentos a partir de los art√≠culos ('items')
    let taxableSubtotal = 0;
    let exemptSubtotal = 0;
    items.forEach(item => {
        // Buscamos el producto completo para saber si es exento
        const product = products.find(p => `${p.name} (${p.product_code || 'S/C'})` === item.description);
        const lineTotal = item.quantity * item.price;
        
        if (product && product.is_exempt) {
            exemptSubtotal += lineTotal; // Suma a los exentos
        } else {
            taxableSubtotal += lineTotal; // Suma a los gravables
        }
    });

    // 2. Preparar las variables para el desglose de totales de la impresi√≥n
    let importeExonerado = 0;
    // El importe exento ahora es la suma de los art√≠culos marcados como exentos
    let importeExento = exemptSubtotal; 
    let importeGravado15 = 0;
    let importeGravado18 = 0;
    let isv15 = 0;
    let isv18 = 0;

    const taxRateValue = docData.taxRate;

    // Si la factura completa es de tipo "Exonerado", se suma todo en esa l√≠nea
    if (taxRateValue === 'exonerado') {
        importeExonerado = docData.subtotal;
        // Reiniciamos los otros importes porque todo es exonerado
        importeExento = 0; 
    } else if (taxRateValue == '15') {
        // El importe gravado es la suma de los art√≠culos que no son exentos
        importeGravado15 = taxableSubtotal;
        isv15 = docData.taxAmount;
    } else if (taxRateValue == '18') {
        importeGravado18 = taxableSubtotal;
        isv18 = docData.taxAmount;
    }
    // Si la tasa es 0%, 'importeExento' ya tiene el valor correcto de exemptSubtotal, y los dem√°s son 0.

    let formattedRange = 'N/A';
    if (authData) {
        const prefix = `${String(authData.cod_sucursal).padStart(3, '0')}-${String(authData.cod_punto_emision).padStart(3, '0')}-${String(authData.cod_tipo_doc).padStart(2, '0')}-`;
        const start = String(authData.rango_inicio).padStart(8, '0');
        const end = String(authData.rango_fin).padStart(8, '0');
        formattedRange = `${prefix}${start} al ${prefix}${end}`;
    }

    const itemsHtml = items.map(item => `
        <tr>
            <td class="border px-4 py-2 text-center">${escapeHtml(item.quantity)}</td>
            <td class="border px-4 py-2">${escapeHtml(item.description)}</td>
            <td class="border px-4 py-2 text-right">L ${formatNumber(item.price)}</td>
            <td class="border px-4 py-2 text-right">L ${formatNumber(item.quantity * item.price)}</td>
        </tr>`).join('');

    let bankAccountsHtml = '';
    if (company && bankAccounts.length > 0) {
        const companyBankAccounts = bankAccounts.filter(acc => acc.company === company.id);
        if (companyBankAccounts.length > 0) {
            bankAccountsHtml = `<div class="border-t mt-4 pt-2 text-xs"><h4 class="font-bold mb-1">Cuentas Bancarias para Pagos</h4>${companyBankAccounts.map(acc => `<p><strong>${escapeHtml(acc.bank_name)} (${escapeHtml(acc.account_type)}):</strong> <span>${escapeHtml(acc.account_name)}</span> - <strong>#${escapeHtml(acc.account_number)}</strong></p>`).join('')}</div>`;
        }
    }

    preview.innerHTML = `<div>
        <div class="flex justify-between items-start mb-6">
            <div>
                ${logoHtml}
                <h2 class="text-xl font-bold">${escapeHtml(company ? company.name : 'N/A')}</h2>
                <p class="text-sm">RTN: ${escapeHtml(company ? company.rtn : 'N/A')}</p>
                <p class="text-sm">${escapeHtml(company ? company.address : '')}</p>
                <p class="text-sm">Tel: ${escapeHtml(company ? company.phone : '')}</p>
                <p class="text-sm">${escapeHtml(company ? company.email : '')}</p>
            </div>
            <div class="text-right border-2 border-gray-700 p-2 text-sm">
                <h1 class="text-2xl font-bold text-blue-custom">FACTURA</h1>
                <p class="text-lg font-bold"># ${escapeHtml(docData.number)}</p>
                <p><strong>CAI:</strong> ${escapeHtml(authData ? authData.cai : 'N/A')}</p>
                <p><strong>Rango Autorizado:</strong> ${escapeHtml(formattedRange)}</p>
                <p><strong>Fecha L√≠mite de Emisi√≥n:</strong> ${escapeHtml(authData ? new Date(authData.fecha_limite).toLocaleDateString() : 'N/A')}</p>
            </div>
        </div>
        <hr class="mb-4">
        <div class="mb-4">
            <h3 class="font-bold">Datos del Cliente:</h3>
            <p><strong>Fecha:</strong> ${escapeHtml(new Date(docData.date).toLocaleDateString())}</p>
            <p><strong>Nombre:</strong> ${escapeHtml(docData.clientName)}</p>
            <p><strong>RTN:</strong> ${escapeHtml(docData.clientRTN)}</p>
        </div>
        <table class="w-full border-collapse mb-4 text-sm">
            <thead><tr class="bg-gray-100"><th class="border px-4 py-2">Cant.</th><th class="border px-4 py-2">Descripci√≥n</th><th class="border px-4 py-2">Precio Unit.</th><th class="border px-4 py-2">Total</th></tr></thead>
            <tbody>${itemsHtml}</tbody>
        </table>
        
        <div class="flex justify-between items-start mt-4">
            <div class="w-1/2 pr-4 text-sm">
                <div class="border-t border-b py-2">
                    <strong>SON:</strong> ${numeroALetras(docData.total)}
                </div>
                <div class="mt-2 text-xs">
                    <h4 class="font-bold">Observaciones:</h4>
                    <p>${escapeHtml(docData.observations)}</p>
                </div>
            </div>

            <div class="w-1/2 text-right text-xs">
                <div class="grid grid-cols-2 gap-1">
                    <span>Importe Exonerado:</span> <span class="font-semibold">L. ${formatNumber(importeExonerado)}</span>
                    <span>Importe Exento:</span> <span class="font-semibold">L. ${formatNumber(importeExento)}</span>
                    <span>Importe Gravado 15%:</span> <span class="font-semibold">L. ${formatNumber(importeGravado15)}</span>
                    <span>Importe Gravado 18%:</span> <span class="font-semibold">L. ${formatNumber(importeGravado18)}</span>
                    <span class="col-span-2 border-t mt-1 pt-1"></span>
                    <span>Sub-Total:</span> <span class="font-semibold">L. ${formatNumber(docData.subtotal)}</span>
                    <span>Descuentos y Rebajas Otorrgados:</span> <span class="font-semibold">L. ${formatNumber(docData.discount_amount || 0)}</span>
                    <span>ISV 15%:</span> <span class="font-semibold">L. ${formatNumber(isv15)}</span>
                    <span>ISV 18%:</span> <span class="font-semibold">L. ${formatNumber(isv18)}</span>
                    <span class="col-span-2 border-t mt-1 pt-1"></span>
                    <span class="font-bold text-lg">TOTAL A PAGAR:</span> <span class="font-bold text-lg">L. ${formatNumber(docData.total)}</span>
                </div>
            </div>
        </div>

        <div class="border-t mt-4 pt-2 text-xs">
            <h4 class="font-bold mb-1">Informaci√≥n de Factura Exonerada</h4>
            <p><strong>Orden de Compra Exenta:</strong> ${escapeHtml(docData.orden_compra_exenta)}</p>
            <p><strong>Constancia de Registro Exonerado:</strong> ${escapeHtml(docData.constancia_registro_exonerado)}</p>
            <p><strong>Registro de la SAG:</strong> ${escapeHtml(docData.registro_sag)}</p>
        </div>

        ${bankAccountsHtml}

        <div class="text-center mt-8"><p class="text-xs">Gracias por su preferencia.</p></div>
    </div>`;
}

function initializeInvoiceForm() {
    // Limpia cualquier item que pudiera existir
    document.getElementById('invoiceItems').innerHTML = '';
    // Llama a la funci√≥n para agregar la primera fila, que ya sabe c√≥mo poblar el men√∫ de productos
    addInvoiceItem();
}



// funci√≥n addInvoiceItem
function addInvoiceItem() {
    const itemsContainer = document.getElementById('invoiceItems');
    const newItem = document.createElement('div');
    newItem.className = 'invoice-item grid grid-cols-12 gap-2 items-center';

    // Usamos 'productSelected(this)' en el onchange
    newItem.innerHTML = `
        <div class="col-span-5">
            <select class="description w-full border rounded-lg px-3 py-2" onchange="productSelected(this)">
                <option value="">Seleccione un producto...</option>
            </select>
        </div>
        <div class="col-span-2">
            <input type="number" class="quantity w-full border rounded-lg px-3 py-2" value="1" oninput="calculateTotals()">
        </div>
        <div class="col-span-2">
            <input type="number" step="0.01" class="price w-full border rounded-lg px-3 py-2" oninput="calculateTotals()">
        </div>
        <div class="col-span-2 flex items-center justify-center gap-2">
             <input type="checkbox" class="item-is-exempt h-4 w-4" disabled>
             <label class="text-xs">Exento</label>
        </div>
        <div class="col-span-1">
            <button type="button" onclick="removeInvoiceItem(this)" class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center">‚úï</button>
        </div>
    `;

    // Poblar el men√∫ desplegable con los productos del maestro
    const productSelect = newItem.querySelector('.description');
    if (products && products.length > 0) {
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.name} (${product.product_code || 'S/C'})`;
            productSelect.appendChild(option);
        });
    }
    
    itemsContainer.appendChild(newItem);
}

// funci√≥n productSelected
function productSelected(selectElement) {
    // 1. Obtiene el ID del producto que seleccionaste.
    const selectedProductId = selectElement.value;
    
    // 2. Busca el producto completo en nuestra lista de productos.
    const product = products.find(p => p.id === selectedProductId);
    
    // 3. Encuentra la fila ('invoice-item') a la que pertenece este men√∫ desplegable.
    const itemRow = selectElement.closest('.invoice-item');
    
    if (product) {
        // 4. Si se encontr√≥ el producto, actualiza los campos de la misma fila.
        itemRow.querySelector('.price').value = product.default_price; // Actualiza el precio
        itemRow.querySelector('.item-is-exempt').checked = product.is_exempt; // Marca si es exento
    } else {
        // Si el usuario selecciona "Seleccione un producto...", limpia los campos.
        itemRow.querySelector('.price').value = '';
        itemRow.querySelector('.item-is-exempt').checked = false;
    }
    
    calculateTotals();
}

function removeItem(button) {
    button.closest('.invoice-item').remove();
    calculateTotals();
}

//funci√≥n calculateTotals
function calculateTotals() {
    let taxableSubtotal = 0;
    let exemptSubtotal = 0;

    document.querySelectorAll('.invoice-item').forEach(itemDiv => {
        const quantity = parseFloat(itemDiv.querySelector('.quantity').value) || 0;
        const price = parseFloat(itemDiv.querySelector('.price').value) || 0;
        const isExempt = itemDiv.querySelector('.item-is-exempt').checked;
        const lineTotal = quantity * price;
        
        if (isExempt) {
            exemptSubtotal += lineTotal;
        } else {
            taxableSubtotal += lineTotal;
        }
    });

    const subtotal = taxableSubtotal + exemptSubtotal;
    const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
    
    // Proporcionalmente aplicar el descuento
    const totalBeforeDiscount = subtotal;
    let discountOnTaxable = 0;
    if (totalBeforeDiscount > 0) {
        discountOnTaxable = (taxableSubtotal / totalBeforeDiscount) * discount;
    }
    
    const taxableBase = taxableSubtotal - discountOnTaxable;
    const taxRateSelect = document.getElementById('taxRate');
    const taxRate = taxRateSelect.value === 'exonerado' ? 0 : parseFloat(taxRateSelect.value) || 0;
    const taxAmount = taxableBase * (taxRate / 100);
    const total = subtotal - discount + taxAmount;

    document.getElementById('subtotal').textContent = `L ${formatNumber(subtotal)}`;
    document.getElementById('taxAmount').textContent = `L ${formatNumber(taxAmount)}`;
    document.getElementById('total').textContent = `L ${formatNumber(total)}`;
}

// Funci√≥n de numeros
function numeroALetras(num) {
    const unidades = ['', 'UNO', 'DOS', 'TRES', 'CUATRO', 'CINCO', 'SEIS', 'SIETE', 'OCHO', 'NUEVE'];
    const decenas = ['', 'DIEZ', 'VEINTE', 'TREINTA', 'CUARENTA', 'CINCUENTA', 'SESENTA', 'SETENTA', 'OCHENTA', 'NOVENTA'];
    const centenas = ['', 'CIENTO', 'DOSCIENTOS', 'TRESCIENTOS', 'CUATROCIENTOS', 'QUINIENTOS', 'SEISCIENTOS', 'SETECIENTOS', 'OCHOCIENTOS', 'NOVECIENTOS'];
    const especiales = ['DIEZ', 'ONCE', 'DOCE', 'TRECE', 'CATORCE', 'QUINCE', 'DIECIS√âIS', 'DIECISIETE', 'DIECIOCHO', 'DIECINUEVE'];

    const getDecenas = n =>
        n < 10 ? unidades[n] :
        n < 20 ? especiales[n - 10] :
        (decenas[Math.floor(n / 10)]) + (n % 10 ? ' Y ' + unidades[n % 10] : '');

    const getCentenas = n =>
        n > 99 ? (centenas[Math.floor(n / 100)]) + ' ' + (n % 100 ? getDecenas(n % 100) : '') : getDecenas(n);
        
    const getMiles = n =>
        Math.floor(n / 1000) > 1 ? getCentenas(Math.floor(n / 1000)) + ' MIL ' + (n % 1000 ? getCentenas(n % 1000) : '') :
        Math.floor(n / 1000) === 1 ? 'MIL ' + (n % 1000 ? getCentenas(n % 1000) : '') : getCentenas(n);

    const getMillones = n =>
        Math.floor(n / 1000000) > 1 ? getCentenas(Math.floor(n / 1000000)) + ' MILLONES ' + (n % 1000000 ? getMiles(n % 1000000) : '') :
        Math.floor(n / 1000000) === 1 ? 'UN MILLON ' + (n % 1000000 ? getMiles(n % 1000000) : '') : getMiles(n);
    
    let literal = getMillones(Math.floor(num));
    if (Math.floor(num) === 0) literal = "CERO";
    if (Math.floor(num) === 1 && num > 1) literal = "UN"; // Ajuste para "UN LEMPIRA" vs "UNO"
    
    const decimal = Math.round((num - Math.floor(num)) * 100);
    const textoFinal = `${literal} LEMPIRAS ${String(decimal).padStart(2, '0')}/100`;
    
    return textoFinal.trim();
}


// --- L√≥gica de Recibos ---
function handleReceiptSubmit() {
    const editingId = document.getElementById('editingReceiptId').value;
    generateReceipt(editingId || null);
}

//funci√≥n generateReceipt
async function generateReceipt(editingId = null) {
    const saveBtn = document.getElementById('saveReceiptBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Guardando...';

    // Recolectar datos del formulario
    const receiptDate = document.getElementById('receiptDate').value;
    const clientName = document.getElementById('receiptClientName').value;
    const clientPhone = document.getElementById('receiptClientPhone').value;
    const clientAddress = document.getElementById('receiptClientAddress').value;
    const receiptAmount = parseFloat(document.getElementById('receiptAmount').value);
    const paymentMethod = document.getElementById('receiptPaymentMethod').value;
    const receiptConcept = document.getElementById('receiptConcept').value;
    const receiptObservations = document.getElementById('receiptObservations').value;

    // --- ‚ñº‚ñº‚ñº INICIO DE L√ìGICA DE VENCIMIENTO A√ëADIDA ‚ñº‚ñº‚ñº ---
    const clienteSeleccionado = clients.find(c => c.name === clientName);
    const creditDays = clienteSeleccionado ? (clienteSeleccionado.credit_days || 0) : 0;
    
    const parts = receiptDate.split('-');
    const emisionDate = new Date(parts[0], parts[1] - 1, parts[2]);
    emisionDate.setDate(emisionDate.getDate() + creditDays);
    const newDueDate = emisionDate.toISOString().split('T')[0];
    // --- ‚ñ≤‚ñ≤‚ñ≤ FIN DE L√ìGICA A√ëADIDA ‚ñ≤‚ñ≤‚ñ≤ ---

    try {
        if (editingId) {
            // --- L√ìGICA PARA ACTUALIZAR UN RECIBO EXISTENTE ---
            const receiptNumber = document.getElementById('receiptNumber').value;
            const documentData = {
                number: receiptNumber, // Mantenemos el n√∫mero original
                type: 'Recibo',
                company: currentCompany.id,
                date: receiptDate, due_date: newDueDate, clientName, clientPhone, clientAddress,
                amount: receiptAmount, paymentMethod, concept: receiptConcept,
                observations: receiptObservations,
                created_by: pb.authStore.model.id,                
            };

            const updatedReceipt = await pb.collection('documents').update(editingId, documentData);
            alert('¬°Recibo actualizado con √©xito!');
            updateReceiptPreview(updatedReceipt);
            await loadData();
            // El bot√≥n permanece deshabilitado hasta hacer clic en 'Nuevo' o editar otro.

        } else {
            // --- L√ìGICA PARA CREAR UN NUEVO RECIBO (con reintento) ---
            const createReceiptRecord = async () => {
                const freshCompany = await pb.collection('companies').getOne(currentCompany.id);
                const receiptNumber = freshCompany.siguiente_numero_recibo;

                const documentData = {
                    number: receiptNumber.toString(),
                    type: 'Recibo',
                    company: currentCompany.id,
                    date: receiptDate, due_date: newDueDate, clientName, clientPhone, clientAddress,
                    amount: receiptAmount, paymentMethod, concept: receiptConcept,
                    observations: receiptObservations,
                    created_by: pb.authStore.model.id,
                    payment_status: 'Pendiente'
                };
                if (isNaN(documentData.amount)) throw new Error('El monto no es un n√∫mero v√°lido.');

                await pb.collection('documents').create(documentData);
                await pb.collection('companies').update(currentCompany.id, { 'siguiente_numero_recibo+': 1 });
                return documentData;
            };

            try {
                const docData = await createReceiptRecord();
                alert(`¬°Recibo #${docData.number} guardado con √©xito!`);
                updateReceiptPreview(docData);
                await loadData();
            } catch (err) {
                if (err.response?.data?.number?.code === 'validation_not_unique') {
                    console.warn("Colisi√≥n de n√∫mero de recibo. Reintentando...");
                    await loadData();
                    const docData = await createReceiptRecord();
                    alert(`¬°Recibo #${docData.number} guardado con √©xito! (en el segundo intento)`);
                    updateReceiptPreview(docData);
                    await loadData();
                } else {
                    throw err; // Lanza el error para que el catch exterior lo maneje
                }
            }
        }
    } catch (err) {
        alert('Ocurri√≥ un error al guardar el recibo. ' + err.message);
        console.error("Error en generateReceipt:", err);
        saveBtn.disabled = false; // Rehabilita el bot√≥n solo si hay un error
        saveBtn.textContent = editingId ? 'üíæ Guardar Cambios' : 'üíæ Guardar Recibo';
    }
}

function resetReceiptForm() {
    document.getElementById('receiptForm').reset();
    document.getElementById('editingReceiptId').value = '';
    document.getElementById('receiptTitle').textContent = 'Nuevo Recibo';
    // Reactiva el bot√≥n de guardar y restaura su texto original
    const saveBtn = document.getElementById('saveReceiptBtn');
    saveBtn.disabled = false;
    saveBtn.textContent = 'üíæ Guardar Recibo';
    setDefaultDates();
    document.getElementById('receiptPreview').innerHTML = '<p class="text-gray-500 text-center mt-20">La vista previa aparecer√° aqu√≠</p>';
}

function updateReceiptPreview(docData) {
    const preview = document.getElementById('receiptPreview');
    const company = findCompanyById(docData.company);
    const logoUrl = company && company.logo ? pb.files.getURL(company, company.logo) : '';
    const logoHtml = logoUrl ? `<img src="${logoUrl}" alt="Logo" class="h-24 mb-6 object-contain">` : '';

    let bankAccountsHtml = '';
    if (company && bankAccounts.length > 0) {
        const companyBankAccounts = bankAccounts.filter(acc => acc.company === company.id);
        if (companyBankAccounts.length > 0) {
            bankAccountsHtml = `<div class="border-t mt-4 pt-2 text-xs"><h4 class="font-bold mb-1">Cuentas Bancarias para Pagos</h4>${companyBankAccounts.map(acc => `<p><strong>${escapeHtml(acc.bank_name)} (${escapeHtml(acc.account_type)}):</strong> <span>${escapeHtml(acc.account_name)}</span> - <strong>#${escapeHtml(acc.account_number)}</strong></p>`).join('')}</div>`;
        }
    }

    preview.innerHTML = `<div>
        <div class="flex justify-between items-start mb-6">
            <div>${logoHtml}<h2 class="text-xl font-bold">${escapeHtml(company ? company.name : 'N/A')}</h2>
            <p class="text-sm">RTN: ${escapeHtml(company ? company.rtn : 'N/A')}</p>
            <p class="text-sm">Tel√©fono: ${escapeHtml(company ? company.phone : 'N/A')}</p>
            <p class="text-sm">Email: ${escapeHtml(company ? company.email : 'N/A')}</p></div>
            <div class="text-right"><h1 class="text-2xl font-bold text-orange-custom">RECIBO</h1>
            <p class="text-lg"># ${escapeHtml(docData.number)}</p><p>Fecha: ${escapeHtml(docData.date)}</p></div>
        </div><hr class="mb-4"><div class="mb-4 text-sm">
        <p>Recibido de: <span class="font-bold">${escapeHtml(docData.clientName)}</span></p>
        <p>Por la cantidad de: <span class="font-bold">L ${formatNumber(docData.amount)}</span></p>
        <p>Concepto: <span class="font-bold">${escapeHtml(docData.concept)}</span></p></div>
        <hr class="my-4"><div class="text-sm"><p>M√©todo de Pago: ${escapeHtml(docData.paymentMethod)}</p></div>
        
        <div class="mt-8 text-left text-xs">
            <p><span class="font-bold">Observaciones:</span> ${escapeHtml(docData.observations)}</p>
        </div>
        <div class="text-center mt-16">
            <p>_________________________</p>
            <p class="text-sm">Firma y Sello</p>
        </div>
            ${bankAccountsHtml}
        </div>`;
}

// --- Historial y Edici√≥n ---
function loadHistory() {
    const historyList = document.getElementById('historyList');
    if (!historyList) return;

    // 1. Empieza con la lista completa de documentos.
    let filteredDocs = documents;

    // --- L√ìGICA DE FILTRADO POR RANGO DE FECHAS ---
    if (currentHistoryDateStart || currentHistoryDateEnd) {
        filteredDocs = filteredDocs.filter(doc => {
            const docDate = doc.date.substring(0, 10); // Extrae solo la parte 'YYYY-MM-DD'
            
            // Si hay fecha de inicio y la del documento es anterior, se descarta.
            if (currentHistoryDateStart && docDate < currentHistoryDateStart) {
                return false;
            }
            // Si hay fecha de fin y la del documento es posterior, se descarta.
            if (currentHistoryDateEnd && docDate > currentHistoryDateEnd) {
                return false;
            }
            // Si pasa ambas validaciones, se incluye.
            return true;
        });
    }

    // 2. Aplica el filtro por tipo (Factura, Recibo, Todos).
    if (currentHistoryFilter !== 'all') {
        filteredDocs = filteredDocs.filter(doc => doc.type?.toLowerCase() === currentHistoryFilter);
    }

    // 3. Aplica el filtro por empresa.
    if (currentHistoryCompany !== 'all') {
        filteredDocs = filteredDocs.filter(doc => doc.company === currentHistoryCompany);
    }
    
    // 4. Guarda la lista ya filtrada en una variable global para que la funci√≥n de exportar a Excel la pueda usar.
    currentlyDisplayedDocs = filteredDocs;

    // 5. Muestra los resultados en la pantalla.
    historyList.innerHTML = '';
    if (currentlyDisplayedDocs.length === 0) {
        historyList.innerHTML = '<p class="text-center text-gray-500">No hay documentos que coincidan con los filtros.</p>';
        return;
    }

    currentlyDisplayedDocs.forEach(doc => {
        const docDiv = document.createElement('div');

        docDiv.className = 'flex justify-between items-start bg-gray-100 p-3 rounded-lg shadow-sm';

        const companyName = doc.expand?.company?.name || 'N/A';
        const total = doc.total || doc.amount || 0;
        const docColor = (doc.type?.toLowerCase() === 'factura') ? 'text-blue-custom' : 'text-orange-custom';

        // 2. Estructura interna: separamos la parte izquierda y derecha
        docDiv.innerHTML = `
            <div class="flex-grow pr-4">
                <p class="font-bold ${docColor}">${escapeHtml(doc.type)} #${escapeHtml(doc.number)}</p>
                <p class="text-sm text-gray-600">Cliente: ${escapeHtml(doc.clientName)}</p>
                <p class="text-xs text-gray-500">Emitido por: ${escapeHtml(companyName)}</p>
                <p class="text-xs text-gray-500">Fecha Emisi√≥n: ${new Date(doc.date).toLocaleDateString()}</p>
            </div>

            <div class="flex flex-col items-end w-40 flex-shrink-0">
                <p class="font-bold text-lg">L ${formatNumber(total)}</p>                
                <p class="text-xs text-gray-500">Fecha Vence: ${new Date(doc.due_date).toLocaleDateString()}</p>
                <div class="mt-1">
                    <button onclick="editDocument('${doc.id}')" class="text-sm bg-blue-500 text-white px-3 py-1 rounded">Editar</button>
                </div>
            </div>
        `;
        historyList.appendChild(docDiv);
    });
}

//funciones de filtro de fecha
function filterHistoryByDate() {
    // 1. Lee los valores de ambos campos de fecha.
    currentHistoryDateStart = document.getElementById('historyDateStart').value;
    currentHistoryDateEnd = document.getElementById('historyDateEnd').value;
    
    // 2. Llama a loadHistory() para redibujar la lista con el rango.
    loadHistory();
}

function clearDateFilter() {
    // 1. Limpia las variables globales del rango.
    currentHistoryDateStart = '';
    currentHistoryDateEnd = '';
    
    // 2. Limpia los valores de los campos en el HTML.
    document.getElementById('historyDateStart').value = '';
    document.getElementById('historyDateEnd').value = '';
    
    // 3. Llama a loadHistory() para mostrar todos los registros de nuevo.
    loadHistory();
}

// --- L√≥gica de Filtros para el Historial ---

function filterHistory(type) {
    currentHistoryFilter = type;
    const filterButtons = document.querySelectorAll('#historyTypeFilter button');
    filterButtons.forEach(btn => {
        if (btn.getAttribute('onclick').includes(`'${type}'`)) {
            btn.classList.add('bg-blue-custom', 'text-white');
            btn.classList.remove('bg-gray-200');
        } else {
            btn.classList.remove('bg-blue-custom', 'text-white');
            btn.classList.add('bg-gray-200');
        }
    });
    loadHistory();
}

function filterHistoryByCompany(companyId) {
    // Actualiza la variable global con la empresa seleccionada.
    currentHistoryCompany = companyId;
    
    // Llama a loadHistory() para que vuelva a dibujar la lista con el nuevo filtro.
    loadHistory();
}

async function editDocument(id) {
    const doc = documents.find(d => d.id === id);
    if (!doc) {
        alert('Documento no encontrado.');
        return;
    }

    // --- INICIO DEL BLOQUE DE DIAGN√ìSTICO ---
    console.log("--- Diagn√≥stico de EditDocument ---");
    console.log("1. Valor original de doc.type:", `'${doc.type}'`);
    
    // 1. Usamos el tipo original, sin convertirlo a min√∫sculas
    const docType = doc.type ? doc.type.trim() : ''; 
    console.log("2. Valor despu√©s de trim() y toLowerCase():", `'${docType}'`);

    console.log("3. Comparando con 'Factura'. ¬øSon iguales?:", docType === 'Factura');
    console.log("4. Comparando con 'Recibo'. ¬øSon iguales?:", docType === 'Recibo');
    console.log("--- Fin del Diagn√≥stico ---");
    // --- FIN DEL BLOQUE DE DIAGN√ìSTICO ---

    if (docType === 'Factura') {
        try {
            const auth = authorizations.find(a => a.id === doc.autorizacion);
            const items = await pb.collection('invoice_items').getFullList({ filter: `invoice = "${doc.id}"`, sort: 'created' });
            populateInvoiceForm(doc, items, auth);
        } catch (err) {
            console.error("Error al buscar los art√≠culos:", err);
            alert("No se pudieron cargar los art√≠culos de esta factura.");
        }
    } else if (docType === 'Recibo') {
        populateReceiptForm(doc);
    } else {
        alert(`No se puede editar este tipo de documento: '${doc.type}'`);
    }
}

function populateInvoiceForm(doc, items, authData) {
    // 1. Limpia y resetea el formulario a su estado inicial.
    // Esto tambi√©n se encarga de reactivar el bot√≥n de "Guardar".
    resetInvoiceForm();

    // 2. Establece el modo "Edici√≥n"
    document.getElementById('editingInvoiceId').value = doc.id;
    document.getElementById('invoiceTitle').textContent = `Editando Factura #${doc.number}`;

    // 3. Rellena los campos principales de la factura
    document.getElementById('companySelect').value = doc.company;
    updateCompanyData(); // Actualiza la compa√±√≠a actual y busca la autorizaci√≥n
    document.getElementById('invoiceNumber').value = doc.number;
    document.getElementById('invoiceDate').value = doc.date.split(' ')[0]; // Formatea la fecha
    document.getElementById('clientName').value = doc.clientName;
    document.getElementById('clientRTN').value = doc.clientRTN;
    document.getElementById('clientAddress').value = doc.clientAddress;
    document.getElementById('paymentMethod').value = doc.paymentMethod;
    document.getElementById('taxRate').value = doc.taxRate;
    document.getElementById('observations').value = doc.observations;
    document.getElementById('discountAmount').value = doc.discount_amount || 0;
    
    // 4. Muestra y rellena los campos de exoneraci√≥n si existen
    if (doc.taxRate === 'exonerado') {
        document.getElementById('exoneradoFields').classList.remove('hidden');
        document.getElementById('ordenCompraExenta').value = doc.orden_compra_exenta || '';
        document.getElementById('constanciaRegistroExonerado').value = doc.constancia_registro_exonerado || '';
        document.getElementById('registroSAG').value = doc.registro_sag || '';
    }

    // 5. Reconstruye din√°micamente la lista de art√≠culos
    const itemsContainer = document.getElementById('invoiceItems');
    itemsContainer.innerHTML = ''; // Limpia el contenedor
    items.forEach(item => {
        addInvoiceItem(); // Crea una nueva fila con el men√∫ de productos poblado
        const lastItemRow = itemsContainer.lastElementChild; // Obtiene la fila que acabamos de crear
        
        // Selecciona el producto correcto en el men√∫ desplegable
        const productSelect = lastItemRow.querySelector('.description');
        const foundProduct = Array.from(productSelect.options).find(opt => opt.text === item.description);
        if (foundProduct) {
            productSelect.value = foundProduct.value;
        }

        // Rellena la cantidad y el precio
        lastItemRow.querySelector('.quantity').value = item.quantity;
        lastItemRow.querySelector('.price').value = item.price;
    });

    // 6. Actualiza el estado del bot√≥n a "Guardar Cambios"
    const saveBtn = document.getElementById('saveInvoiceBtn');
    saveBtn.disabled = false;
    saveBtn.textContent = 'üíæ Guardar Cambios';

    // 7. Actualiza los c√°lculos y la vista previa
    calculateTotals();
    updateInvoicePreview(doc, items, authData);
    showSection('invoiceSection');
    window.scrollTo(0, 0); // Desplaza la vista hacia arriba
}


// REEMPLAZA tu funci√≥n populateReceiptForm con esta
function populateReceiptForm(doc) {
    resetReceiptForm(); // Limpia y reactiva el bot√≥n
    
    document.getElementById('editingReceiptId').value = doc.id;
    document.getElementById('receiptTitle').textContent = `Editando Recibo #${doc.number}`;
    
    // Rellena los campos
    document.getElementById('receiptCompanySelect').value = doc.company;
    updateReceiptCompanyData(); // Actualiza la compa√±√≠a y el n√∫mero
    document.getElementById('receiptNumber').value = doc.number;
    document.getElementById('receiptDate').value = doc.date.split(' ')[0];
    document.getElementById('receiptClientName').value = doc.clientName;
    document.getElementById('receiptClientPhone').value = doc.clientPhone || '';
    document.getElementById('receiptClientAddress').value = doc.clientAddress || '';
    document.getElementById('receiptAmount').value = doc.amount;
    document.getElementById('receiptPaymentMethod').value = doc.paymentMethod;
    document.getElementById('receiptConcept').value = doc.concept || '';
    document.getElementById('receiptObservations').value = doc.observations || '';
    
    // Cambia el texto del bot√≥n a "Guardar Cambios"
    document.getElementById('saveReceiptBtn').textContent = 'üíæ Guardar Cambios';

    updateReceiptPreview(doc);
    showSection('receiptSection');
    window.scrollTo(0, 0);
}

// --- Maestro de Productos ---
function showProductManager() {
    document.getElementById('productForm').reset(); // Limpiar formulario
    document.getElementById('productId').value = ''; // Limpiar ID de edici√≥n
    renderProductsList(); // Dibujar la lista de productos existentes
    document.getElementById('productManagerModal').classList.remove('hidden');
}

function hideProductManager() {
    document.getElementById('productManagerModal').classList.add('hidden');
}

function renderProductsList() {
    console.log("--- Iniciando renderProductsList ---");
    const listContainer = document.getElementById('productsList');
    
    if (!listContainer) {
        console.error("Error Cr√≠tico: No se encontr√≥ el contenedor '#productsList' en el HTML.");
        return;
    }
    listContainer.innerHTML = '';

    console.log("Datos de 'products' al momento de renderizar la lista:", products);

    if (!products || products.length === 0) {
        console.warn("La lista de productos est√° vac√≠a o es indefinida. No se mostrar√° nada.");
        listContainer.innerHTML = '<p class="text-gray-500 text-center">No hay productos creados.</p>';
        return;
    }

    products.forEach((product, index) => {
        console.log(`Renderizando producto en la lista #${index + 1}: ${product.name}`);
        const productDiv = document.createElement('div');
        productDiv.className = 'grid grid-cols-6 gap-4 items-center bg-gray-100 p-3 rounded-lg shadow-sm';
                
        // Se a√±ade '|| 0' para asegurar que si el precio no existe, se use 0 como valor por defecto.
        const price = product.default_price || 0;
        
        productDiv.innerHTML = `
            <span class="col-span-2 font-medium text-sm">${escapeHtml(product.name)}</span>
            <span class="col-span-2 text-xs text-gray-600">C√≥digo: ${escapeHtml(product.product_code || 'N/A')}</span>
            
            <span class="col-span-1 font-semibold text-sm text-right">L ${formatNumber(price)}</span>
            
            <div class="col-span-1 flex gap-2 justify-end">
                <button onclick="selectProductForEdit('${product.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                <button onclick="deleteProduct('${product.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
            </div>
        `;
        listContainer.appendChild(productDiv);
    });
    console.log("--- Finalizado renderProductsList ---");
}

async function handleProductFormSubmit(event) {
    event.preventDefault();
    const productId = document.getElementById('productId').value;

    const data = {
        name: document.getElementById('productName').value,
        product_code: document.getElementById('productCode').value,
        description: document.getElementById('productDescription').value,
        default_price: parseFloat(document.getElementById('productPrice').value),
        is_exempt: document.getElementById('productIsExempt').checked,
    };

    try {
        if (productId) {
            // Actualizar producto existente
            await pb.collection('products').update(productId, data);
            alert('¬°Producto actualizado con √©xito!');
        } else {
            // Crear nuevo producto
            await pb.collection('products').create(data);
            alert('¬°Producto creado con √©xito!');
        }
        hideProductManager();
        await loadData(); // Recargar todos los datos para reflejar los cambios
    } catch (err) {
        console.error("Error al guardar el producto:", err);
        alert('Ocurri√≥ un error al guardar el producto. Revisa la consola.');
    }
}

function selectProductForEdit(id) {
    const product = products.find(p => p.id === id);
    if (!product) {
        console.error("Producto no encontrado con ID:", id);
        return;
    }

    // Rellena el formulario con los datos del producto encontrado
    document.getElementById('productId').value = product.id;
    document.getElementById('productName').value = product.name;
    document.getElementById('productCode').value = product.product_code || '';
    document.getElementById('productDescription').value = product.description || '';
    document.getElementById('productPrice').value = product.default_price;
    document.getElementById('productIsExempt').checked = product.is_exempt;
    
    // Desplaza la vista hacia arriba para ver el formulario
    document.querySelector('#productManagerModal .bg-white').scrollTo(0, 0);
}

async function deleteProduct(id) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar este producto?')) return;
    try {
        await pb.collection('products').delete(id);
        alert('Producto eliminado con √©xito.');
        await loadData();
    } catch (err) {
        console.error("Error al eliminar el producto:", err);
        alert('Error al eliminar el producto. Revisa la consola.');
    }
}

// --- Maestro de Clientes ---
function showClientManager() {
    document.getElementById('clientForm').reset();
    document.getElementById('clientId').value = '';
    document.getElementById('clientIsActive').checked = true; // Activo por defecto
    renderClientsList();
    document.getElementById('clientModal').classList.remove('hidden');
}

function hideClientManager() {
    document.getElementById('clientModal').classList.add('hidden');
}

function renderClientsList() {
    const listContainer = document.getElementById('clientsList');
    listContainer.innerHTML = '';
    clients.forEach(client => {
        const clientDiv = document.createElement('div');
        clientDiv.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg shadow-sm';
        clientDiv.innerHTML = `
            <div>
                <span class="font-medium text-sm">${escapeHtml(client.name)} ${client.is_active ? '' : '<span class="text-red-500 text-xs">(Inactivo)</span>'}</span>
                <p class="text-xs text-gray-600">RTN: ${escapeHtml(client.rtn || 'N/A')}</p>
            </div>
            <div class="flex gap-2">
                <button onclick="selectClientForEdit('${client.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                <button onclick="deleteClient('${client.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
            </div>
        `;
        listContainer.appendChild(clientDiv);
    });
}

async function handleClientFormSubmit(event) {
    event.preventDefault();
    const clientId = document.getElementById('clientId').value;

    try {
        // --- PASO 1: RECOLECTAR TODOS LOS DATOS DEL FORMULARIO ---
        // Se incluyen los campos que ya ten√≠as y los nuevos de los cat√°logos
        const data = {
            name: document.getElementById('clientName').value,
            rtn: document.getElementById('clientRTN').value,
            phone_number: document.getElementById('clientPhone').value,
            address: document.getElementById('clientAddress').value,
            email: document.getElementById('clientEmail').value,
            contact_person: document.getElementById('clientContactPerson').value, // <-- CAMPO A√ëADIDO
            notes: document.getElementById('clientNotes').value, // <-- CAMPO A√ëADIDO
            entity_type: document.getElementById('entityType').value,
            client_group: document.getElementById('clientGroup').value.trim(),
            price_list: document.getElementById('priceList').value.trim(),
            payment_terms: document.getElementById('paymentTerms').value.trim(),
            credit_days: parseInt(document.getElementById('creditDays').value) || 0,
            credit_limit: parseFloat(document.getElementById('creditLimit').value) || 0,
            is_active: document.getElementById('clientIsActive').checked,
        };

        // --- PASO 2: L√ìGICA DE "SELECCIONAR O CREAR" PARA CAT√ÅLOGOS ---
        // Esta funci√≥n auxiliar revisa si un valor existe y lo crea si es nuevo.
        const createIfNeeded = async (collectionName, value) => {
            if (!value) return; // No hacer nada si el campo est√° vac√≠o
            const exists = window.catalogs[collectionName].some(item => item.name.toLowerCase() === value.toLowerCase());
            if (!exists) {
                console.log(`Creando nuevo item '${value}' en '${collectionName}'...`);
                const newItem = await pb.collection(collectionName).create({ name: value });
                // Actualizamos nuestra lista local para futuros usos en la misma sesi√≥n
                window.catalogs[collectionName].push(newItem);
            }
        };

        // Ejecutamos la verificaci√≥n para cada campo. Esto se hace tanto al crear como al actualizar.
        await createIfNeeded('client_groups', data.client_group);
        await createIfNeeded('price_lists', data.price_list);
        await createIfNeeded('payment_terms', data.payment_terms);
        // --- FIN DE LA L√ìGICA DE CAT√ÅLOGOS ---


        // --- PASO 3: L√ìGICA PRINCIPAL PARA GUARDAR EL CLIENTE ---
        if (clientId) {
            // La l√≥gica de ACTUALIZACI√ìN no cambia.
            await pb.collection('clients').update(clientId, data);
            alert('¬°Cliente actualizado con √©xito!');
        } else {
            // La l√≥gica de CREACI√ìN ahora se ejecuta despu√©s de la verificaci√≥n de cat√°logos.
            const entityType = data.entity_type;
            let counterName = '';
            if (entityType === 'Cliente') counterName = 'clientes';
            else if (entityType === 'Proveedor') counterName = 'proveedores';
            else if (entityType === 'Ambos') counterName = 'ambos';
            else {
                alert('Tipo de entidad no v√°lido.');
                return;
            }

            const counterRecord = await pb.collection('counters').getFirstListItem(`name = "${counterName}"`);
            const newNumber = counterRecord.last_value + 1;
            const newCode = `${counterRecord.prefix}${String(newNumber).padStart(7, '0')}`;
            
            data.client_code = newCode; // A√±adimos el c√≥digo autom√°tico a los datos

            await pb.collection('clients').create(data);
            
            await pb.collection('counters').update(counterRecord.id, {
                'last_value+': 1
            });
            
            alert(`¬°Cliente creado con √©xito! C√≥digo asignado: ${newCode}`);
        }
        
        hideClientManager();
        await loadData(); // Recargamos todo para que las nuevas opciones aparezcan en las listas la pr√≥xima vez
    } catch (err) {
        console.error("Error al guardar el cliente:", err);
        alert('Ocurri√≥ un error al guardar el cliente. Revisa la consola.');
    }
}

// REEMPLAZA tu funci√≥n selectClientForEdit con esta
function selectClientForEdit(id) {
    const client = clients.find(c => c.id === id);
    if (!client) return;
    document.getElementById('clientId').value = client.id;
    document.getElementById('clientName').value = client.name;
    document.getElementById('clientCode').value = client.client_code || '';
    document.getElementById('clientRTN').value = client.rtn || '';
    document.getElementById('clientPhone').value = client.phone_number || '';
    document.getElementById('clientAddress').value = client.address || '';
    document.getElementById('clientEmail').value = client.email || '';
    document.getElementById('contact_person').value = client.contact_person || ''; // <-- CAMPO A√ëADIDO
    document.getElementById('clientNotes').value = client.notes || '';               // <-- CAMPO A√ëADIDO
    document.getElementById('entityType').value = client.entity_type || 'Cliente';
    document.getElementById('clientGroup').value = client.client_group;
    document.getElementById('priceList').value = client.price_list;
    document.getElementById('paymentTerms').value = client.payment_terms;
    document.getElementById('creditDays').value = client.credit_days;
    document.getElementById('creditLimit').value = client.credit_limit;
    document.getElementById('clientIsActive').checked = client.is_active;
}

async function deleteClient(id) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar este cliente?')) return;
    try {
        await pb.collection('clients').delete(id);
        alert('Cliente eliminado con √©xito.');
        await loadData();
    } catch (err) {
        console.error("Error al eliminar el cliente:", err);
        alert('Error al eliminar el cliente.');
    }
}

function populateClientSelects() {
    const invoiceSelect = document.getElementById('invoiceClientSelect');
    const receiptSelect = document.getElementById('receiptClientSelect');
    
    // Limpiar selects
    invoiceSelect.innerHTML = '<option value="">-- Seleccionar o escribir un nuevo cliente --</option>';
    receiptSelect.innerHTML = '<option value="">-- Seleccionar o escribir un nuevo cliente --</option>';

    // Poblar con clientes activos
    clients.filter(c => c.is_active).forEach(client => {
        const option = document.createElement('option');
        option.value = client.id;
        option.textContent = `${client.name} (${client.rtn || 'S/RTN'})`;
        invoiceSelect.appendChild(option.cloneNode(true));
        receiptSelect.appendChild(option);
    });
}

// AGREGA ESTA NUEVA FUNCI√ìN a tu script
function populateDatalists() {
    const clientGroupList = document.getElementById('clientGroupList');
    const priceLists = document.getElementById('priceLists');
    const paymentTermsList = document.getElementById('paymentTermsList');

    clientGroupList.innerHTML = '';
    priceLists.innerHTML = '';
    paymentTermsList.innerHTML = '';

    window.catalogs.client_groups.forEach(item => {
        clientGroupList.innerHTML += `<option value="${escapeHtml(item.name)}">`;
    });
    window.catalogs.price_lists.forEach(item => {
        priceLists.innerHTML += `<option value="${escapeHtml(item.name)}">`;
    });
    window.catalogs.payment_terms.forEach(item => {
        paymentTermsList.innerHTML += `<option value="${escapeHtml(item.name)}">`;
    });
}

function clientSelected(formType) {
    const selectId = formType === 'invoice' ? 'invoiceClientSelect' : 'receiptClientSelect';
    const clientId = document.getElementById(selectId).value;
    
    const selectedClient = clients.find(c => c.id === clientId);

    if (selectedClient) {
        if (formType === 'invoice') {
            document.getElementById('clientName').value = selectedClient.name;
            document.getElementById('clientRTN').value = selectedClient.rtn || '';
            document.getElementById('clientAddress').value = selectedClient.address || '';
        } else {
            document.getElementById('receiptClientName').value = selectedClient.name;
            document.getElementById('receiptClientPhone').value = selectedClient.phone_number || '';
            document.getElementById('receiptClientAddress').value = selectedClient.address || '';
        }
    }
}

// --- Gesti√≥n de Usuarios (Solo Admin) ---
function showUserManager() {
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    populateRolesDropdown();
    renderUsersList();
    document.getElementById('userManagerModal').classList.remove('hidden');
}

function hideUserManager() {
    document.getElementById('userManagerModal').classList.add('hidden');
}

function populateRolesDropdown() {
    const roleSelect = document.getElementById('userRole');
    roleSelect.innerHTML = '<option value="">Seleccione un rol...</option>';
    roles.forEach(role => {
        const option = document.createElement('option');
        option.value = role.id;
        option.textContent = role.name;
        roleSelect.appendChild(option);
    });
}

//funci√≥n renderUsersList
function renderUsersList() {
    const listContainer = document.getElementById('usersList');
    listContainer.innerHTML = '';
    users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg';
        const roleName = user.expand?.role?.name || 'Sin rol';
        userDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <img src="${user.avatar ? pb.files.getURL(user, user.avatar, {'thumb':'50x50'}) : 'data:image/svg+xml;...'}" class="w-8 h-8 rounded-full object-cover">
                <div>
                    <p class="text-sm font-medium">${escapeHtml(user.name)}</p>
                    <p class="text-xs text-gray-500 capitalize">${escapeHtml(roleName)}</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="selectUserForEdit('${user.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
            </div>`;
        listContainer.appendChild(userDiv);
    });
}

async function handleUserFormSubmit(event) {
    event.preventDefault();
    const userId = document.getElementById('userId').value;
    const saveBtn = document.querySelector('#userForm button[type="submit"]');
    saveBtn.disabled = true;

    try {
        let dataToSend;

        // Obtenemos los nuevos valores del formulario, incluyendo 'name' y 'username'
        const newName = document.getElementById('userNameDisplay').value;
        const newEmail = document.getElementById('userEmail').value;
        const newRole = document.getElementById('userRole').value;
        const newPassword = document.getElementById('userPassword').value;
        const passwordConfirm = document.getElementById('userPasswordConfirm').value;
        const avatarFile = document.getElementById('userAvatarFile').files[0];

        if (userId) {
            // --- MODO ACTUALIZACI√ìN ---
            const originalUser = users.find(u => u.id === userId);
            const dataChanges = {};

            // Comparamos cada campo y lo a√±adimos solo si ha cambiado
            if (newName !== originalUser.name) {
                dataChanges.name = newName;
            }
            if (newEmail !== originalUser.email) {
                dataChanges.email = newEmail;
            }
            if (newRole !== originalUser.role) {
                dataChanges.role = newRole;
            }
            if (newPassword) {
                if (newPassword !== passwordConfirm) {
                    alert('Las contrase√±as no coinciden.');
                    saveBtn.disabled = false;
                    return;
                }
                dataChanges.password = newPassword;
                dataChanges.passwordConfirm = passwordConfirm;
            }

            // Decidimos el formato de env√≠o
            if (avatarFile) {
                const formData = new FormData();
                for (const key in dataChanges) {
                    formData.append(key, dataChanges[key]);
                }
                formData.append('avatar', avatarFile);
                dataToSend = formData;
            } else {
                dataToSend = dataChanges;
            }

            if (Object.keys(dataToSend).length === 0 && !avatarFile) {
                alert("No se ha realizado ning√∫n cambio.");
                hideUserManager();
                return;
            }

            await pb.collection('users').update(userId, dataToSend);
            alert('¬°Usuario actualizado con √©xito!');

        } else {
            // --- MODO CREACI√ìN ---
            if (!newPassword || newPassword !== passwordConfirm) {
                alert('Para un usuario nuevo, las contrase√±as son obligatorias y deben coincidir.');
                saveBtn.disabled = false;
                return;
            }
            const formData = new FormData();
            formData.append('name', newName); // <-- CAMPO A√ëADIDO            
            formData.append('email', newEmail);
            formData.append('role', newRole);
            formData.append('password', newPassword);
            formData.append('passwordConfirm', passwordConfirm);
            if (avatarFile) {
                formData.append('avatar', avatarFile);
            }
            dataToSend = formData;
            
            await pb.collection('users').create(dataToSend);
            alert('¬°Usuario creado con √©xito!');
        }

        hideUserManager();
        await pb.collection('users').authRefresh({ expand: 'role' }); 
        await loadData();

    } catch (err) {
        console.error("Error al guardar el usuario:", err);
        const errorDetails = err.response?.data ? JSON.stringify(err.response.data) : err.message;
        alert(`Ocurri√≥ un error al guardar el usuario: ${errorDetails}`);
    } finally {
        saveBtn.disabled = false;
    }
}

//funci√≥n selectUserForEdit
function selectUserForEdit(id) {
    const user = users.find(u => u.id === id);
    if (!user) return;

    document.getElementById('userForm').reset();
    document.getElementById('userId').value = user.id;
    document.getElementById('userNameDisplay').value = user.name || '';
    document.getElementById('userEmail').value = user.email;
    document.getElementById('userRole').value = user.role;
}

// --- Gesti√≥n de Cuentas Bancarias (Solo Admin) ---

function showBankAccountManager() {
    document.getElementById('bankAccountForm').reset();
    document.getElementById('accountId').value = '';
    
    // Poblar el dropdown de empresas
    const companySelect = document.getElementById('accountCompany');
    companySelect.innerHTML = '<option value="">Seleccione una empresa...</option>';
    companies.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = c.name;
        companySelect.appendChild(option);
    });

    renderBankAccountsList();
    document.getElementById('bankAccountModal').classList.remove('hidden');
}

function hideBankAccountManager() {
    document.getElementById('bankAccountModal').classList.add('hidden');
}

function renderBankAccountsList() {
    const listContainer = document.getElementById('bankAccountsList');
    listContainer.innerHTML = '';
    bankAccounts.forEach(account => {
        const accountDiv = document.createElement('div');
        accountDiv.className = 'flex justify-between items-center bg-gray-100 p-2 rounded-lg';
        const companyName = account.expand?.company?.name || 'N/A';
        accountDiv.innerHTML = `
            <div>
                <p class="text-sm font-medium">${escapeHtml(account.bank_name)} - ${escapeHtml(account.account_name)}</p>
                <p class="text-xs text-gray-500">${escapeHtml(companyName)} | #${escapeHtml(account.account_number)}</p>
            </div>
            <div class="flex gap-2">
                <button onclick="selectBankAccountForEdit('${account.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">Editar</button>
                <button onclick="deleteBankAccount('${account.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg text-sm">Eliminar</button>
            </div>`;
        listContainer.appendChild(accountDiv);
    });
}

async function handleBankAccountFormSubmit(event) {
    event.preventDefault();
    const accountId = document.getElementById('accountId').value;
    const data = {
        company: document.getElementById('accountCompany').value,
        bank_name: document.getElementById('accountBankName').value,
        account_name: document.getElementById('accountName').value,
        account_number: document.getElementById('accountNumber').value,
        account_type: document.getElementById('accountType').value,
    };

    try {
        if (accountId) {
            await pb.collection('bank_accounts').update(accountId, data);
            alert('¬°Cuenta actualizada con √©xito!');
        } else {
            await pb.collection('bank_accounts').create(data);
            alert('¬°Cuenta creada con √©xito!');
        }
        hideBankAccountManager();
        await loadData();
    } catch (err) {
        console.error("Error al guardar la cuenta bancaria:", err);
        alert('Ocurri√≥ un error al guardar la cuenta. Revisa la consola.');
    }
}

function selectBankAccountForEdit(id) {
    const account = bankAccounts.find(acc => acc.id === id);
    if (!account) return;

    document.getElementById('accountId').value = account.id;
    document.getElementById('accountCompany').value = account.company;
    document.getElementById('accountBankName').value = account.bank_name;
    document.getElementById('accountName').value = account.account_name;
    document.getElementById('accountNumber').value = account.account_number;
    document.getElementById('accountType').value = account.account_type;
}

async function deleteBankAccount(id) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar esta cuenta bancaria?')) return;
    try {
        await pb.collection('bank_accounts').delete(id);
        alert('Cuenta bancaria eliminada con √©xito.');
        await loadData();
    } catch (err) {
        console.error("Error al eliminar la cuenta:", err);
        alert('Error al eliminar la cuenta bancaria.');
    }
}

// --- Agenda Personal Logica ---

function showAgenda() {
    // 1. Configurar los event listeners CADA VEZ que se muestra la secci√≥n
    // Esto evita errores con elementos que no existen en otras pantallas
    
    // Tarea r√°pida
    document.getElementById('add-quick-btn').onclick = addQuickTask;
    document.getElementById('quick-task').onkeypress = (e) => { if (e.key === 'Enter') addQuickTask(); };

    // Tarea detallada
    document.getElementById('add-detailed-btn').onclick = addDetailedTask;

    // Filtros
    document.getElementById('filter-all').onclick = () => filterTasks('all');
    document.getElementById('filter-pendiente').onclick = () => filterTasks('Pendiente');
    document.getElementById('filter-en-curso').onclick = () => filterTasks('En Curso');
    document.getElementById('filter-en-revision').onclick = () => filterTasks('En Revisi√≥n');
    document.getElementById('filter-completada').onclick = () => filterTasks('Completada');
    document.getElementById('clear-completed-btn').onclick = clearCompleted;
    document.getElementById('task-sort-select').onchange = setTaskSort;

    // Timer
    document.getElementById('start-timer-btn').onclick = startTimer;
    document.getElementById('pause-timer-btn').onclick = pauseTimer;
    document.getElementById('reset-timer-btn').onclick = resetTimer;

    // Notas
    document.getElementById('save-notes-btn').onclick = saveNotes;

    // --- EVENT LISTENERS PARA EL TIMER ---
    document.getElementById('start-timer-btn').onclick = startTimer;
    document.getElementById('pause-timer-btn').onclick = pauseTimer;
    document.getElementById('reset-timer-btn').onclick = resetTimer;
    
    // Listeners para los botones de presets
    document.getElementById('set-time-work').onclick = () => setTimer(25, 'work');
    document.getElementById('set-time-short-break').onclick = () => setTimer(5, 'shortBreak');
    document.getElementById('set-time-long-break').onclick = () => setTimer(15, 'longBreak');
    
    // Listener para actualizar el total de sesiones
    document.getElementById('pomodoro-sessions').onchange = () => {
        totalPomodoroSessions = parseInt(document.getElementById('pomodoro-sessions').value);
        updatePomodoroInfo();
    };

    // Poblar el men√∫ de asignaci√≥n de usuarios (si es admin)
    const userSelect = document.getElementById('assign-to-user');
    if (userSelect && pb.authStore.model.expand.role.name === 'admin') {
        userSelect.innerHTML = ''; // Limpiar opciones
        
        // A√±adir a todos los usuarios
        users.forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = user.name;
            userSelect.appendChild(option);
        });
        
        // Poner al propio admin como seleccionado por defecto
        userSelect.value = pb.authStore.model.id;
    }

    // 2. Cargar datos iniciales en la vista
    loadNotes();
    renderTasks();
    updateStats();
    populateTimerTasks();
    updateTimerDisplay();
    updatePomodoroInfo();
    
    // 3. Mostrar la secci√≥n de la agenda
    showSection('agendaSection');
}

// --- Funciones Modificadas para PocketBase ---

async function addQuickTask() {
    const input = document.getElementById('quick-task');
    const taskText = input.value.trim();

    if (taskText) {
        const taskData = {
            user: pb.authStore.model.id,
            title: taskText,
            category: document.getElementById('quick-category').value,
            time_estimate: parseInt(document.getElementById('quick-time-estimate').value),            
            priority: 'media', // Prioridad por defecto para tareas r√°pidas
            due_date: null,
            notes: '',
            status: 'Pendiente',
            completed_at: null
        };
        
        try {
            const newTask = await pb.collection('agenda_tasks').create(taskData);
            agendaTasks.unshift(newTask); 
            renderTasks();
            updateStats();
            checkAppNotifications(); // Actualiza las notifaciones
            input.value = ''; // Limpia solo el campo de texto
        } catch (err) {
            console.error('Error al agregar tarea r√°pida:', err);
            alert("Error al guardar la tarea. Revisa la consola.");
        }
    }
}

/**
 * Guarda o actualiza una tarea detallada.
 * Lee el formulario, determina si es una creaci√≥n o una actualizaci√≥n,
 * y env√≠a los datos a PocketBase.
 */
async function addDetailedTask() {
    // 1. Lee el ID. Si est√° vac√≠o, es una tarea nueva.
    const taskId = document.getElementById('detailed-task-id').value;
    
    const title = document.getElementById('detailed-title').value.trim();
    if (!title) {
        alert("El t√≠tulo de la tarea no puede estar vac√≠o.");
        return;
    }

    // 2. Procesa la fecha y hora
    const dateVal = document.getElementById('due-date').value;
    const timeVal = document.getElementById('due-time').value;
    let fullDueDate = null;

    if (dateVal && timeVal) {
        fullDueDate = new Date(`${dateVal}T${timeVal}`).toISOString();
    } else if (dateVal) {
        fullDueDate = new Date(dateVal).toISOString();
    }

    // 3. Procesa el tiempo estimado (con valor por defecto)
    const timeValueString = document.getElementById('time-estimate').value;
    const parsedTime = parseInt(timeValueString);
    const timeEstimateValue = !isNaN(parsedTime) ? parsedTime : 30;

    // 4. Procesa la asignaci√≥n de usuario (Admin vs Operador)
    let assignedToUserId = pb.authStore.model.id; // Por defecto, es para m√≠
    let assignedByUserId = null;
    
    if (pb.authStore.model.expand.role.name === 'admin') {
        assignedToUserId = document.getElementById('assign-to-user').value;
        if (assignedToUserId !== pb.authStore.model.id) {
            assignedByUserId = pb.authStore.model.id;
        }
    }

    // 5. Prepara el objeto de datos com√∫n
    const taskData = {
        title: title,
        category: document.getElementById('category').value,
        priority: document.getElementById('priority').value,
        time_estimate: timeEstimateValue,
        due_date: fullDueDate,
        notes: document.getElementById('notes').value.trim(),
        user: assignedToUserId,
        assigned_by: assignedByUserId
    };

    try {
        if (taskId) {
            // --- MODO ACTUALIZAR ---
            // Pide el registro actualizado CON los nombres expandidos
            const updatedTask = await pb.collection('agenda_tasks').update(taskId, taskData, {
                expand: 'user,assigned_by'
            });
            
            // Reemplaza la tarea vieja en la lista local
            const index = agendaTasks.findIndex(t => t.id === taskId);
            agendaTasks[index] = updatedTask;
            alert('¬°Tarea actualizada!');

        } else {
            // --- MODO CREAR ---
            // A√±ade los campos que solo se definen al crear
            Object.assign(taskData, {
                status: 'Pendiente',
                completed_at: null
            });
            
            // 1. Crea el registro
            const createdRecord = await pb.collection('agenda_tasks').create(taskData);
            
            // 2. Vuelve a pedir el registro, pero CON los nombres expandidos
            // (Esto soluciona el error "Para: N/A")
            const newTask = await pb.collection('agenda_tasks').getOne(createdRecord.id, {
                expand: 'user,assigned_by'
            });

            // 3. A√±ade la tarea completa a la lista local
            agendaTasks.unshift(newTask);
            alert('¬°Tarea creada y asignada!');
        }
        
        resetDetailedTaskForm(); // Limpia y resetea el formulario
        renderTasks(); // Actualiza la lista
        updateStats(); // Actualiza las estad√≠sticas
        checkAppNotifications(); // Vuelve a revisar las notificaciones despu√©s de cualquier cambio.

    } catch (err) {
        console.error('Error al guardar tarea detallada:', err);
        alert("Error al guardar la tarea. Revisa la consola.");
    }
}

async function updateTaskStatus(selectElement, taskId) {
    const newStatus = selectElement.value;
    const task = agendaTasks.find(t => t.id === taskId);
    if (!task) return;

    // Actualiza el estado localmente
    task.status = newStatus;
    
    // Prepara los datos para PocketBase
    const dataToUpdate = {
        status: newStatus
    };

    // Si la tarea se marca como "Completada", guarda la fecha
    if (newStatus === 'Completada') {
        task.completed_at = new Date().toISOString();
        dataToUpdate.completed_at = task.completed_at;
    } 
    // Si se revierte de "Completada" a otro estado
    else if (task.completed_at !== null) { 
        task.completed_at = null;
        dataToUpdate.completed_at = null;
    }

    try {
        // Actualiza en PocketBase
        await pb.collection('agenda_tasks').update(taskId, dataToUpdate);
        
        // Vuelve a renderizar la lista (para aplicar estilos) y las estad√≠sticas
        renderTasks();
        updateStats();
        checkAppNotifications();
    } catch (err) {
        console.error('Error al actualizar el estado:', err);
        alert("Error al actualizar el estado.");
    }
}
// Hacemos que la funci√≥n sea accesible desde el HTML
window.updateTaskStatus = updateTaskStatus;

async function deleteTask(taskId) {
    if (!confirm('¬øSeguro que quieres eliminar esta tarea?')) return;

    try {
        await pb.collection('agenda_tasks').delete(taskId);
        
        // Elimina de la lista local
        agendaTasks = agendaTasks.filter(task => task.id !== taskId);
        renderTasks();
        updateStats();
    } catch (err) {
        console.error('Error al eliminar tarea:', err);
        alert("Error al eliminar la tarea.");
    }
}
window.deleteTask = deleteTask; // Hacerla accesible desde el HTML

async function clearCompleted() {
    // CORRECCI√ìN 1: Buscar tareas usando el nuevo campo 'status'
    const completedTasks = agendaTasks.filter(task => task.status === 'Completada');
    
    if (completedTasks.length === 0) {
        alert("No hay tareas completadas para limpiar."); // Opcional: un aviso al usuario
        return;
    }
    
    if (!confirm('¬øEst√°s seguro de que deseas eliminar permanentemente todas las tareas completadas?')) return;

    try {
        // Borrar una por una de la base de datos
        for (const task of completedTasks) {
            await pb.collection('agenda_tasks').delete(task.id);
        }
        
        // CORRECCI√ìN 2: Actualizar la lista local filtrando por 'status'
        agendaTasks = agendaTasks.filter(task => task.status !== 'Completada');
        
        // Volver a dibujar la interfaz
        renderTasks();
        updateStats();
    } catch (err) {
        console.error('Error al limpiar tareas:', err);
        alert("Ocurri√≥ un error al eliminar las tareas.");
    }
}

function loadNotes() {
    // La nota se carga en loadData, aqu√≠ solo la mostramos
    if (agendaNote) {
        document.getElementById('quick-notes').value = agendaNote.content;
    }
}

async function saveNotes() {
    const notesArea = document.getElementById('quick-notes');
    if (!agendaNote) return;

    try {
        agendaNote.content = notesArea.value;
        await pb.collection('agenda_notes').update(agendaNote.id, { 
            content: agendaNote.content 
        });
        
        const btn = document.getElementById('save-notes-btn');
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Guardado';
        btn.disabled = true;
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
    } catch (err) {
        console.error('Error al guardar notas:', err);
        alert("Error al guardar las notas.");
    }
}

function setTaskSort() {
    currentTaskSort = document.getElementById('task-sort-select').value;
    renderTasks(); // Vuelve a dibujar la lista con el nuevo orden
}

function renderTasks() {
    const container = document.getElementById('tasks-container');
    if (!container) return;

    // 1. Filtrar Tareas (seg√∫n los botones "Todas", "Pendientes", "Completadas")
    let filteredTasks = agendaTasks;
    
    if (currentFilter !== 'all') {
        filteredTasks = agendaTasks.filter(task => task.status === currentFilter);
    }
    
    
    // 2. Ordenar Tareas (seg√∫n el men√∫ "Ordenar por:")
    let sortedTasks = [...filteredTasks]; // Copia la lista filtrada para ordenarla

    // Funci√≥n auxiliar para convertir prioridad a n√∫mero
    const priorityToNumber = (priority) => {
        switch (priority) {
            case 'urgente': return 4;
            case 'alta': return 3;
            case 'media': return 2;
            case 'baja': return 1;
            default: return 0;
        }
    };

    switch (currentTaskSort) {
        case 'created_desc':
            // Ordena por fecha de creaci√≥n (por defecto)
            sortedTasks.sort((a, b) => new Date(b.created) - new Date(a.created));
            break;
        case 'due_date_asc':
            // Ordena por fecha de vencimiento (las tareas sin fecha van al final)
            sortedTasks.sort((a, b) => {
                if (a.due_date && b.due_date) return new Date(a.due_date) - new Date(b.due_date);
                if (a.due_date && !b.due_date) return -1; // a (con fecha) va primero
                if (!a.due_date && b.due_date) return 1;  // b (con fecha) va primero
                return 0; // ambos no tienen fecha
            });
            break;
        case 'priority_desc':
            // Ordena por prioridad (de m√°s alta a m√°s baja)
            sortedTasks.sort((a, b) => priorityToNumber(b.priority) - priorityToNumber(a.priority));
            break;
        case 'time_asc':
            // Ordena por tiempo estimado (de menor a mayor)
            sortedTasks.sort((a, b) => (a.time_estimate || 0) - (b.time_estimate || 0));
            break;
    }

    // 3. Renderizar (Dibujar) la Lista
    if (sortedTasks.length === 0) {
        container.innerHTML = `<div class="text-center text-gray-500 py-4"><span class="text-3xl block mb-2">üìù</span><p>No hay tareas en esta categor√≠a.</p></div>`;
        return;
    }
    
    const categoryEmojis = { trabajo: 'üíº', personal: 'üë§', salud: 'üí™', estudios: 'üìö', hogar: 'üè†' };
    
    let html = '';
    // Usamos la lista 'sortedTasks' para generar el HTML
    sortedTasks.forEach(task => { 
        // L√≥gica para mostrar asignaci√≥n (si es admin o si fue asignada)
        let assignmentText = '';
        const isAdmin = pb.authStore.model.expand.role.name === 'admin';
        
        if (isAdmin && task.user !== pb.authStore.model.id) {
            assignmentText = `<p class="text-xs font-semibold text-blue-custom mt-1">Para: ${escapeHtml(task.expand?.user?.name || 'N/A')}</p>`;
        } else if (task.assigned_by) {
            assignmentText = `<p class="text-xs font-semibold text-orange-custom mt-1">De: ${escapeHtml(task.expand?.assigned_by?.name || 'N/A')}</p>`;
        }
        
        // Genera el <select> para el estado
        const statusOptions = ['Pendiente', 'En Curso', 'En Revisi√≥n', 'Completada'];
        const statusSelectHtml = `
            <select onchange="updateTaskStatus(this, '${task.id}')" 
                    class="text-xs font-semibold p-1 border rounded-md ${getStatusColorClass(task.status)}">
                ${statusOptions.map(opt => 
                    `<option value="${opt}" ${task.status === opt ? 'selected' : ''}>${opt}</option>`
                ).join('')}
            </select>
        `;

        html += `<div class="border-l-4 p-4 rounded-r-lg ${task.status === 'Completada' ? 'bg-gray-100 opacity-60' : 'bg-white shadow-sm'}" style="border-left-color: ${getPriorityColor(task.priority)}">
                    <div class="flex items-start gap-3">
                        
                        <div class="flex-1">
                            <h4 class="font-semibold ${task.status === 'Completada' ? 'line-through' : ''}">${escapeHtml(task.title)}</h4>
                            ${assignmentText}
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs text-gray-500 mt-1">
                                <span>${categoryEmojis[task.category] || 'üìã'} ${task.category}</span>
                                <span>‚è±Ô∏è ${task.time_estimate} min</span>
                                ${task.due_date ? `<span>üìÖ ${new Date(task.due_date).toLocaleString()}</span>` : ''}
                            </div>
                            ${task.notes ? `<p class="text-sm text-gray-600 mt-2">${escapeHtml(task.notes)}</p>` : ''}
                        </div>
                        
                        <div class="flex flex-col gap-2 items-end w-40 flex-shrink-0">
                            ${statusSelectHtml} <div class="flex gap-1">
                                <button onclick="selectTaskForEdit('${task.id}')" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-md font-semibold">Editar</button>
                                <button onclick="deleteTask('${task.id}')" class="text-xs bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded-md">‚úï</button>
                            </div>
                        </div>
                    </div>
                 </div>`;
    });
    
    container.innerHTML = html;
}

// Funci√≥n auxiliar para dar color al <select>
function getStatusColorClass(status) {
    switch (status) {
        case 'Pendiente': return 'bg-gray-200 text-gray-800';
        case 'En Curso': return 'bg-blue-100 text-blue-800';
        case 'En Revisi√≥n': return 'bg-yellow-100 text-yellow-800';
        case 'Completada': return 'bg-green-100 text-green-800';
        default: return 'bg-gray-200';
    }
}

function selectTaskForEdit(taskId) {
    const task = agendaTasks.find(t => t.id === taskId);
    if (!task) return;

    // 1. Rellena el formulario con los datos de la tarea
    document.getElementById('detailed-task-id').value = task.id;
    document.getElementById('detailed-title').value = task.title;
    document.getElementById('category').value = task.category;
    document.getElementById('priority').value = task.priority;
    document.getElementById('time-estimate').value = task.time_estimate;
    document.getElementById('notes').value = task.notes;

    // 2. Formatea la fecha y hora para los inputs
    if (task.due_date) {
        document.getElementById('due-date').value = task.due_date.substring(0, 10);
        document.getElementById('due-time').value = task.due_date.substring(11, 16);
    } else {
        document.getElementById('due-date').value = '';
        document.getElementById('due-time').value = '';
    }

    // 3. Rellena el men√∫ de "Asignar A" (si es admin)
    const userSelect = document.getElementById('assign-to-user');
    if (userSelect && pb.authStore.model.expand.role.name === 'admin') {
        userSelect.value = task.user; // Asigna el ID del usuario que tiene la tarea
    }

    // 4. Cambia la interfaz al modo "Edici√≥n"
    document.getElementById('detailed-task-title').textContent = '‚úèÔ∏è Modificar Tarea';
    document.getElementById('add-detailed-btn').textContent = 'Guardar Cambios';
    document.getElementById('cancel-edit-btn').classList.remove('hidden');

    // 5. Desplaza la vista al formulario de edici√≥n
    document.getElementById('detailed-task-title').scrollIntoView({ behavior: 'smooth' });
}

function resetDetailedTaskForm() {
    // 1. Limpia los campos
    document.getElementById('detailed-task-id').value = '';
    document.getElementById('detailed-title').value = '';
    document.getElementById('time-estimate').value = '';
    document.getElementById('notes').value = '';
    document.getElementById('due-date').value = '';
    document.getElementById('due-time').value = '';

    // 2. Restaura la interfaz al modo "Crear"
    document.getElementById('detailed-task-title').textContent = 'üìù Crear Tarea Detallada';
    document.getElementById('add-detailed-btn').textContent = 'Crear Tarea';
    document.getElementById('cancel-edit-btn').classList.add('hidden');
}

function getPriorityColor(priority) {
    switch (priority) {
        case 'baja': return '#22c55e'; // Verde
        case 'media': return '#f59e0b'; // Naranja
        case 'alta': return '#ef4444'; // Rojo
        case 'urgente': return '#8b0000'; // Rojo Oscuro
        default: return '#6b7280'; // Gris
    }
}

// --- Funci√≥n para filtrar tareas ---
function filterTasks(filter) {
    currentFilter = filter; // filter ahora es 'all', 'Pendiente', 'En Curso', etc.
    
    const buttons = document.querySelectorAll('.filter-btn');
    buttons.forEach(btn => {
        btn.classList.remove('bg-blue-custom', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    // Genera el ID del bot√≥n a partir del filtro (ej: "En Curso" -> "filter-en-curso")
    let buttonId = 'filter-' + filter.toLowerCase().replace(' ', '-');
    const activeBtn = document.getElementById(buttonId);
    
    if (activeBtn) {
        activeBtn.classList.add('bg-blue-custom', 'text-white');
        activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
    }
    
    renderTasks();
}

// --- Funciones del Timer Pomodoro (SIN CAMBIOS) ---
let timerInterval = null;
let currentTime = 25 * 60; // 25 minutos en segundos
let pomodoroSession = 1;
let totalPomodoroSessions = 4;
let isTimerRunning = false;
let currentMode = 'work'; // 'work', 'shortBreak', 'longBreak'

// --- FUNCI√ìN: Poblar Tareas en el Timer ---
// Llena el men√∫ desplegable con las tareas pendientes
function populateTimerTasks() {
    const taskSelect = document.getElementById('pomodoro-task');
    taskSelect.innerHTML = '<option value="">Seleccionar Tarea a Enfocar...</option>';
    
    const pendingTasks = agendaTasks.filter(task => !task.is_completed);
    
    pendingTasks.forEach(task => {
        const option = document.createElement('option');
        option.value = task.id;
        option.textContent = `(${task.time_estimate}m) ${escapeHtml(task.title)}`;
        taskSelect.appendChild(option);
    });
}

// --- FUNCI√ìN: Establecer Tiempo ---
// Es llamada por los botones de presets (25m, 5m, 15m)
function setTimer(minutes, mode) {
    pauseTimer(); // Detiene cualquier timer que est√© corriendo
    currentTime = minutes * 60;
    currentMode = mode;
    updateTimerDisplay();
    updatePomodoroInfo();
}

function startTimer() {
    if (isTimerRunning) return; // Evita m√∫ltiples intervalos
    isTimerRunning = true;
    
    // Lee los valores actuales al iniciar
    totalPomodoroSessions = parseInt(document.getElementById('pomodoro-sessions').value);
    updatePomodoroInfo(); // Actualiza el texto
    
    timerInterval = setInterval(() => {
        currentTime--;
        updateTimerDisplay();
        
        if (currentTime <= 0) {
            pauseTimer(); // Detiene el intervalo
            
            if (currentMode === 'work') {
                pomodoroSession++;
                if (pomodoroSession > totalPomodoroSessions) {
                    // Ciclo completado, descanso largo
                    alert('¬°Ciclo Pomodoro completado! üçÖ Inicia un descanso largo (15 min).');
                    setTimer(15, 'longBreak');
                } else {
                    // Descanso corto
                    alert('¬°Sesi√≥n de trabajo completada! üçÖ Inicia un descanso corto (5 min).');
                    setTimer(5, 'shortBreak');
                }
            } else {
                // El descanso termin√≥, volver al trabajo
                if (currentMode === 'longBreak') {
                    pomodoroSession = 1; // Reinicia el conteo de sesiones
                }
                alert('¬°Descanso terminado! üçÖ Hora de volver al trabajo.');
                setTimer(25, 'work');
            }
            // Inicia autom√°ticamente el siguiente timer (opcional, puedes quitarlo si prefieres inicio manual)
            startTimer(); 
        }
    }, 1000);
}

function pauseTimer() {
    if (isTimerRunning) {
        clearInterval(timerInterval);
        isTimerRunning = false;
    }
}

function resetTimer() {
    pauseTimer();
    pomodoroSession = 1;
    totalPomodoroSessions = parseInt(document.getElementById('pomodoro-sessions').value);
    setTimer(25, 'work'); // Resetea a 25 minutos de trabajo
}

function updateTimerDisplay() {
    const minutes = Math.floor(currentTime / 60);
    const seconds = currentTime % 60;
    const display = document.getElementById('timer-display');
    if (display) {
        display.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }
}

function updatePomodoroInfo() {
    const info = document.getElementById('pomodoro-info');
    if (!info) return;

    let modeText = "Trabajo";
    if (currentMode === 'shortBreak') modeText = "Descanso Corto";
    if (currentMode === 'longBreak') modeText = "Descanso Largo";
    
    // Intenta obtener la tarea seleccionada
    const taskSelect = document.getElementById('pomodoro-task');
    let taskName = "";
    if (taskSelect && taskSelect.value) {
        taskName = taskSelect.options[taskSelect.selectedIndex].text.split(') ')[1];
    }
    
    if (currentMode === 'work') {
        info.textContent = `Sesi√≥n ${pomodoroSession} de ${totalPomodoroSessions} - ${taskName || modeText}`;
    } else {
        info.textContent = `Modo: ${modeText}`;
    }
}

// --- Funci√≥n de Estad√≠sticas ---
// (Modificada para usar 'agendaTasks' y campos de PocketBase)
function updateStats() {
    
    // --- 1. C√ÅLCULO DE ESTAD√çSTICAS PERSONALES (MI PROGRESO) ---
    // Filtra solo las tareas asignadas A M√ç (al usuario logueado)
    const myTasks = agendaTasks.filter(t => t.user === pb.authStore.model.id);

    // --- Progreso Total (Personal) ---
    const totalMyTasks = myTasks.length;
    // CORRECCI√ìN: Contamos usando el nuevo status
    const completedMyTasks = myTasks.filter(t => t.status === 'Completada').length;
    let totalPercentage = (totalMyTasks > 0) ? Math.round((completedMyTasks / totalMyTasks) * 100) : 0;
    
    document.getElementById('stats-total-progress-text').textContent = `${completedMyTasks} / ${totalMyTasks}`;
    document.getElementById('stats-total-progress-bar').style.width = `${totalPercentage}%`;
    document.getElementById('productivity').textContent = `${totalPercentage}%`;
    document.getElementById('productivity-bar').style.width = `${totalPercentage}%`;

    // --- Tareas Completadas Hoy (Personal) ---
    const today = new Date().toDateString();
    let totalMinutesToday = 0;
    let completedTodayCount = 0;

    myTasks.forEach(task => { // Usamos myTasks
        // CORRECCI√ìN: Verificamos el status y completed_at
        if (task.status === 'Completada' && task.completed_at && new Date(task.completed_at).toDateString() === today) {
            totalMinutesToday += task.time_estimate || 0;
            completedTodayCount++;
        }
    });
    document.getElementById('completed-tasks').textContent = completedTodayCount;
    const hours = Math.floor(totalMinutesToday / 60);
    const minutes = totalMinutesToday % 60;
    document.getElementById('focused-time').textContent = `${hours}h ${minutes}m`;

    // --- Tareas de la Semana (Personal) ---
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - 7);
    // CORRECCI√ìN: Verificamos el status
    const completedThisWeek = myTasks.filter(t => t.status === 'Completada' && t.completed_at && new Date(t.completed_at) > weekAgo).length;
    document.getElementById('stats-week-tasks').textContent = completedThisWeek;
    
    // --- Racha Diaria (Personal) ---
    const dayInMillis = 24 * 60 * 60 * 1000;
    const todayTimestamp = new Date().setHours(0, 0, 0, 0);

    const uniqueDays = [...new Set(myTasks // Usamos myTasks
        // CORRECCI√ìN: Verificamos el status
        .filter(t => t.status === 'Completada' && t.completed_at)
        .map(t => new Date(t.completed_at).setHours(0, 0, 0, 0))
    )].sort((a, b) => b - a);

    let streak = 0;
    if (uniqueDays.length > 0) {
        if (uniqueDays[0] === todayTimestamp || uniqueDays[0] === (todayTimestamp - dayInMillis)) {
            streak = 1;
            for (let i = 0; i < uniqueDays.length - 1; i++) {
                const currentDay = uniqueDays[i];
                const previousDay = uniqueDays[i+1];
                if (currentDay - previousDay === dayInMillis) {
                    streak++;
                } else {
                    break;
                }
            }
        }
    }
    document.getElementById('streak').textContent = streak;

    // --- Desglose por Categor√≠a (Personal) ---
    const categoryBreakdownContainer = document.getElementById('stats-category-breakdown');
    const categoryCounts = {};
    const categoryTotals = {};
    const categories = ['trabajo', 'personal', 'salud', 'estudios', 'hogar'];
    categories.forEach(cat => { categoryCounts[cat] = 0; categoryTotals[cat] = 0; });

    myTasks.forEach(task => { // Usamos myTasks
        if (categoryTotals.hasOwnProperty(task.category)) {
            categoryTotals[task.category]++;
            // CORRECCI√ìN: Verificamos el status
            if (task.status === 'Completada') {
                categoryCounts[task.category]++;
            }
        }
    });

    const categoryEmojis = { trabajo: 'üíº', personal: 'üë§', salud: 'üí™', estudios: 'üìö', hogar: 'üè†' };
    let categoryHtml = '';
    categories.forEach(cat => {
        const total = categoryTotals[cat];
        if (total > 0) {
            const completed = categoryCounts[cat];
            const percentage = Math.round((completed / total) * 100);
            categoryHtml += `
                <div class="text-sm">
                    <div class="flex justify-between mb-1">
                        <span class="font-medium">${categoryEmojis[cat] || 'üìã'} ${cat.charAt(0).toUpperCase() + cat.slice(1)}</span>
                        <span class="text-gray-500">${completed} / ${total}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-orange-custom h-2 rounded-full" style="width: ${percentage}%"></div></div>
                </div>`;
        }
    });
    categoryBreakdownContainer.innerHTML = categoryHtml || '<p class="text-sm text-gray-500 text-center">No hay tareas con categor√≠a.</p>';


    // --- 2. C√ÅLCULO DE ESTAD√çSTICAS DE EQUIPO (SOLO ADMIN) ---
    const teamBreakdownContainer = document.getElementById('stats-team-breakdown');
    const isAdmin = pb.authStore.model.expand.role.name === 'admin';
    
    if (isAdmin && teamBreakdownContainer) {
        teamBreakdownContainer.innerHTML = '';
        let teamHtml = '';

        users.forEach(user => {
            if (user.id === pb.authStore.model.id) return; 

            const userTasks = agendaTasks.filter(task => task.user === user.id);
            const total = userTasks.length;

            if (total > 0) {
                // 1. Contar tareas por cada estado
                const pending = userTasks.filter(t => t.status === 'Pendiente').length;
                const inProgress = userTasks.filter(t => t.status === 'En Curso').length;
                const inReview = userTasks.filter(t => t.status === 'En Revisi√≥n').length;
                const completed = userTasks.filter(t => t.status === 'Completada').length;
                
                const avatarUrl = user.avatar ? pb.files.getURL(user, user.avatar, {'thumb':'50x50'}) : 'data:image/svg+xml;base64,...'; // (SVG omitido por brevedad)

                // 2. Generar el nuevo HTML con el desglose
                teamHtml += `
                    <div class="text-sm mt-4 pt-3 border-t">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-2">
                                <img src="${avatarUrl}" class="w-6 h-6 rounded-full object-cover bg-gray-200">
                                <span class="font-medium">${escapeHtml(user.name)}</span>
                            </div>
                            <span class="font-semibold text-gray-500">Completadas: ${completed} / ${total}</span>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 text-center text-xs">
                            <div class="p-1 bg-gray-100 rounded">
                                <span class="block font-semibold text-gray-700">${pending}</span>
                                <span class="text-gray-500">Pendiente</span>
                            </div>
                            <div class="p-1 bg-blue-100 rounded">
                                <span class="block font-semibold text-blue-800">${inProgress}</span>
                                <span class="text-blue-600">En Curso</span>
                            </div>
                            <div class="p-1 bg-yellow-100 rounded">
                                <span class="block font-semibold text-yellow-800">${inReview}</span>
                                <span class="text-yellow-600">Revisi√≥n</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        });

        if (teamHtml === '') {
            teamBreakdownContainer.innerHTML = '<p class="text-sm text-gray-500 text-center">No hay tareas asignadas a otros usuarios.</p>';
        } else {
            teamBreakdownContainer.innerHTML = teamHtml;
        }
    }
}

// --- Analisis de Morosidad ---

function showMorosidadReport() {
    // 1. Prepara el filtro de empresa ANTES de mostrar
    updateMorosidadCompanyFilter(); 
    
    // 2. Genera el reporte (ahora usar√° el filtro)
    generateAndDisplayMorosidad();
    
    // 3. Muestra la secci√≥n
    showSection('morosidadSection');
}

/**
 * Funci√≥n principal que calcula y muestra el reporte de morosidad.
 */
function generateAndDisplayMorosidad() {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Estandarizar 'hoy' a medianoche
    
    let totales = { '0-30': 0, '31-60': 0, '61-90': 0, '90+': 0, total: 0 };
    const tbody = document.getElementById('morosidadTableBody');
    tbody.innerHTML = '';

    // 1. Filtra por tipo de documento (Factura/Recibo) y estado (Pendiente)
    let documentosPendientes = documents.filter(doc => 
        (doc.type?.toLowerCase() === 'factura' || doc.type?.toLowerCase() === 'recibo') && 
        doc.payment_status?.toLowerCase() === 'pendiente'
    );

    // 2. Filtra por la empresa seleccionada
    if (morosidadCompanyFilter !== 'all') {
        documentosPendientes = documentosPendientes.filter(doc => doc.company === morosidadCompanyFilter);
    }

    // 3. Mapea los datos (calculando monto, estado, etc.)
    let reporteData = documentosPendientes.map(doc => {
        const fechaVencimiento = doc.due_date ? new Date(doc.due_date) : new Date(doc.date);
        fechaVencimiento.setHours(0, 0, 0, 0);
        const diffTime = today - fechaVencimiento;
        const diasVencido = Math.max(0, Math.floor(diffTime / (1000 * 60 * 60 * 24)));
        const monto = doc.total || doc.amount || 0;
        
        // Calcula el estado aqu√≠ mismo para usarlo en el sort y export
        let estadoInfo;
        if (diasVencido <= 0) { estadoInfo = { texto: 'Al D√≠a', clase: 'bg-green-100 text-green-800' }; }
        else if (diasVencido <= 30) { estadoInfo = { texto: '1-30 d√≠as', clase: 'bg-green-100 text-green-800' }; }
        else if (diasVencido <= 60) { estadoInfo = { texto: '31-60 d√≠as', clase: 'bg-yellow-100 text-yellow-800' }; }
        else if (diasVencido <= 90) { estadoInfo = { texto: '61-90 d√≠as', clase: 'bg-orange-100 text-orange-800' }; }
        else { estadoInfo = { texto: 'M√°s de 90 d√≠as', clase: 'bg-red-100 text-red-800' }; }
        
        return { doc, fechaVencimiento, diasVencido, monto, estadoInfo };
    });

    // 4. Ordena los datos
    reporteData.sort((a, b) => {
        let comparison = 0;
        
        switch (morosidadSortBy) {
            case 'cliente':
                const clienteA = a.doc.clientName?.toLowerCase() || '';
                const clienteB = b.doc.clientName?.toLowerCase() || '';
                if (clienteA > clienteB) comparison = 1;
                if (clienteA < clienteB) comparison = -1;
                if (comparison === 0) {
                    comparison = b.diasVencido - a.diasVencido;
                }
                break;
            
            case 'monto':
                comparison = (a.monto || 0) - (b.monto || 0); 
                if (comparison === 0) {
                    const clienteA = a.doc.clientName?.toLowerCase() || '';
                    const clienteB = b.doc.clientName?.toLowerCase() || '';
                    if (clienteA > clienteB) comparison = 1;
                    if (clienteA < clienteB) comparison = -1;
                }
                break;

            case 'dias':
                comparison = (a.diasVencido || 0) - (b.diasVencido || 0);
                if (comparison === 0) {
                    comparison = (a.monto || 0) - (b.monto || 0);
                }
                break;
        }
        
        return (morosidadSortOrder === 'asc') ? comparison : (comparison * -1);
    });
    
    // 5. Guarda los datos filtrados y ordenados en la variable global para exportar
    morosidadReportData = reporteData;

    // 6. Renderiza la tabla
    if (reporteData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No hay documentos pendientes que coincidan con los filtros.</td></tr>`;
    } else {
        reporteData.forEach(data => {
            const { doc, fechaVencimiento, diasVencido, monto, estadoInfo } = data;
            
            // Suma a los totales
            if (diasVencido <= 30) { totales['0-30'] += monto; }
            else if (diasVencido <= 60) { totales['31-60'] += monto; }
            else if (diasVencido <= 90) { totales['61-90'] += monto; }
            else { totales['90+'] += monto; }
            totales.total += monto;

            const fila = document.createElement('tr');
            const docColor = (doc.type?.toLowerCase() === 'recibo') ? 'text-orange-custom' : 'text-blue-custom';

            fila.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${escapeHtml(doc.clientName)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${docColor}">${escapeHtml(doc.number)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(doc.date).toLocaleDateString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${fechaVencimiento.toLocaleDateString()}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">L ${formatNumber(monto)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${diasVencido > 0 ? 'text-red-600' : 'text-green-600'}">${diasVencido} d√≠as</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${estadoInfo.clase}">
                        ${estadoInfo.texto}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="marcarDocumentoComoPagado('${doc.id}')" class="text-green-600 hover:text-green-900">
                        Marcar como Pagado
                    </button>
                </td>
            `;
            tbody.appendChild(fila);
        });
    }

    // 7. Actualiza las tarjetas de resumen
    document.getElementById('morosidad-rango-30').textContent = `L ${formatNumber(totales['0-30'])}`;
    document.getElementById('morosidad-rango-60').textContent = `L ${formatNumber(totales['31-60'])}`;
    document.getElementById('morosidad-rango-90').textContent = `L ${formatNumber(totales['61-90'])}`;
    document.getElementById('morosidad-rango-90-plus').textContent = `L ${formatNumber(totales['90+'])}`;
    document.getElementById('morosidad-total').textContent = `L ${formatNumber(totales.total)}`;

    // 8. Actualiza los indicadores de orden üîº/üîΩ
    document.getElementById('sort-cliente').textContent = 'Cliente';
    document.getElementById('sort-monto').textContent = 'Total Factura';
    document.getElementById('sort-dias').textContent = 'D√≠as Vencido';
    
    const activeHeader = document.getElementById(`sort-${morosidadSortBy}`);
    if (activeHeader) {
        activeHeader.textContent += (morosidadSortOrder === 'asc' ? ' üîº' : ' üîΩ');
    }
}

/**
 * Se llama al hacer clic en un encabezado de la tabla de morosidad.
 * Actualiza las variables globales de ordenamiento y vuelve a dibujar la tabla.
 */
function sortMorosidadReport(sortBy) {
    if (morosidadSortBy === sortBy) {
        // Invierte el orden
        morosidadSortOrder = (morosidadSortOrder === 'asc') ? 'desc' : 'asc';
    } else {
        // Columna nueva
        morosidadSortBy = sortBy;
        
        // El orden por defecto para 'monto' y 'dias' es DESCENDENTE (m√°s √∫til)
        if (sortBy === 'monto' || sortBy === 'dias') {
            morosidadSortOrder = 'desc';
        } else {
            morosidadSortOrder = 'asc';
        }
    }
    
    // Vuelve a generar el reporte con el nuevo orden
    generateAndDisplayMorosidad();
}

/**
 * Rellena el men√∫ desplegable del filtro de empresas en el reporte de morosidad.
 */
function updateMorosidadCompanyFilter() {
    const filterSelect = document.getElementById('morosidadCompanyFilter');
    if (!filterSelect) return; 

    let options = '<option value="all">Todas las Empresas</option>';
    companies.forEach(company => {
        options += `<option value="${company.id}">${escapeHtml(company.name)}</option>`;
    });
    filterSelect.innerHTML = options;
    filterSelect.value = morosidadCompanyFilter;
}

/**
 * Se llama cuando el usuario cambia la empresa en el filtro de morosidad.
 */
function filterMorosidadByCompany(companyId) {
    morosidadCompanyFilter = companyId;
    generateAndDisplayMorosidad(); // Vuelve a dibujar el reporte
}

function exportMorosidadToExcel() {
    if (morosidadReportData.length === 0) {
        alert('No hay datos en el reporte actual para exportar.');
        return;
    }

    // 1. Define los encabezados
    const headers = [
        "Cliente", "Documento", "N√∫mero", "F. Emisi√≥n", "F. Vencimiento",
        "Monto Total", "D√≠as Vencido", "Estado"
    ];

    // 2. Mapea los datos desde la variable global
    const data = morosidadReportData.map(item => {
        return [
            item.doc.clientName,
            item.doc.type,
            item.doc.number,
            new Date(item.doc.date).toLocaleDateString(),
            item.fechaVencimiento.toLocaleDateString(),
            item.monto,
            item.diasVencido,
            item.estadoInfo.texto // El texto del estado (ej: "31-60 d√≠as")
        ];
    });

    // 3. Crea la hoja y el libro (SheetJS)
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
    
    // Ajustar anchos de columna
    const colWidths = [
        { wch: 30 }, // Cliente
        { wch: 10 }, // Documento
        { wch: 20 }, // N√∫mero
        { wch: 12 }, // F. Emisi√≥n
        { wch: 12 }, // F. Vencimiento
        { wch: 15 }, // Monto Total
        { wch: 12 }, // D√≠as Vencido
        { wch: 15 }  // Estado
    ];
    ws['!cols'] = colWidths;

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Reporte de Morosidad");

    // 4. Descarga el archivo
    XLSX.writeFile(wb, `reporte_morosidad_${morosidadCompanyFilter}.xlsx`);
}

/**
 * Funci√≥n para marcar una factura como "Pagada"
 */
async function marcarDocumentoComoPagado(documentId) {
    if (!confirm('¬øEst√°s seguro de que deseas marcar este documento como "Pagado"?')) return;

    try {
        const updatedRecord = await pb.collection('documents').update(documentId, {
            'payment_status': 'Pagada'
        });

        const index = documents.findIndex(doc => doc.id === documentId);
        if (index !== -1) {
            documents[index] = updatedRecord;
        }

        generateAndDisplayMorosidad();
        alert('¬°Documento marcado como pagado!');

    } catch (err) {
        console.error("Error al marcar como pagado:", err);
        alert('Error al actualizar el documento.');
    }
}

//------------------------------

// --- Funci√≥n de Utilidad ---
function escapeHtml(text) {
    if (typeof text !== 'string') return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}


//--------------------------------------------------------------------------
function updateCompanyFilter() {
    const historyCompanyFilter = document.getElementById('historyCompanyFilter');
    // Verificamos si el elemento existe antes de continuar
    if (!historyCompanyFilter) return;

    let options = '<option value="all">Todas las Empresas</option>';
    companies.forEach(company => {
        options += `<option value="${company.id}">${escapeHtml(company.name)}</option>`;
    });
    historyCompanyFilter.innerHTML = options;
    historyCompanyFilter.value = currentHistoryCompany;
}

function showHistory() {
    // Primero, poblamos los filtros AHORA que la secci√≥n ser√° visible
    updateCompanyFilter();
    
    // Luego, cargamos el contenido del historial
    loadHistory();
    
    // Finalmente, mostramos la secci√≥n
    showSection('historySection');
}

function exportToExcel() {
    // 1. Verifica si hay datos en la vista actual para exportar.
    // Usa la variable global 'currentlyDisplayedDocs' que se actualiza con los filtros.
    if (currentlyDisplayedDocs.length === 0) {
        alert('No hay datos en la vista actual para exportar.');
        return;
    }

    // 2. Define los encabezados para las columnas del archivo Excel.
    const headers = [
        "ID", "Tipo", "Numero", "Fecha", "Empresa", "RTN Empresa", 
        "Cliente", "Subtotal", "Descuento", "ISV", "Total", 
        "Metodo de Pago", "Observaciones", "Art√≠culos"
    ];

    // 3. Prepara los datos, convirtiendo cada documento en una fila para el Excel.
    const data = currentlyDisplayedDocs.map(doc => {
        const docCompany = doc.expand && doc.expand.company;
        
        // Formatea la lista de art√≠culos para que quepa en una sola celda.
        let itemsString = '';
        if (doc.type?.toLowerCase() === 'factura') {
            // Busca los art√≠culos relacionados en la lista global 'invoice_items'.
            const relatedItems = invoice_items.filter(item => item.invoice === doc.id);
            itemsString = relatedItems.map(item => `${item.quantity}x ${item.description} @ L${item.price}`).join('; ');
        } else {
            // Para los recibos, usamos el campo 'concept'.
            itemsString = doc.concept || '';
        }

        return [
            doc.id,
            doc.type,
            doc.number,
            new Date(doc.date).toLocaleDateString(),
            docCompany ? docCompany.name : 'N/A',
            docCompany ? docCompany.rtn : 'N/A',
            doc.clientName,
            doc.subtotal || doc.amount || 0,
            doc.discount_amount || 0,
            doc.taxAmount || 0,
            doc.total || doc.amount || 0,
            doc.paymentMethod,
            doc.observations,
            itemsString
        ];
    });

    // 4. Usa la biblioteca SheetJS para crear la hoja de c√°lculo.
    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);

    // 5. (Opcional pero recomendado) Ajusta autom√°ticamente el ancho de las columnas.
    const colWidths = headers.map(header => ({ wch: header.length + 5 }));
    data.forEach(row => {
        row.forEach((cell, i) => {
            const len = cell ? String(cell).length : 10;
            if (colWidths[i].wch < len) {
                colWidths[i].wch = len;
            }
        });
    });
    ws['!cols'] = colWidths;

    // 6. Crea el libro de trabajo y a√±ade la hoja.
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Reporte Filtrado");

    // 7. Genera y descarga el archivo .xlsx.
    XLSX.writeFile(wb, "reporte_filtrado.xlsx");
}

function updateReports() {
    const totalDocsEl = document.getElementById('totalDocs');
    const totalInvoicesEl = document.getElementById('totalInvoices');
    const totalReceiptsEl = document.getElementById('totalReceipts');
    const totalRevenueEl = document.getElementById('totalRevenue');
    const breakdownEl = document.getElementById('companyBreakdown');
    if (documents.length === 0) {
        totalDocsEl.textContent = '0';
        totalInvoicesEl.textContent = '0';
        totalReceiptsEl.textContent = '0';
        totalRevenueEl.textContent = 'L 0';
        breakdownEl.innerHTML = '<p class="text-center text-gray-500">No hay datos.</p>';
        return;
    }
    const totalDocs = documents.length;
    const totalInvoices = documents.filter(doc => doc.type === 'Factura').length;
    const totalReceipts = documents.filter(doc => doc.type === 'Recibo').length;
    const totalRevenue = documents.reduce((sum, doc) => sum + (doc.total || doc.amount || 0), 0);
    totalDocsEl.textContent = totalDocs;
    totalInvoicesEl.textContent = totalInvoices;
    totalReceiptsEl.textContent = totalReceipts;
    totalRevenueEl.textContent = `L ${formatNumber(totalRevenue)}`;
    const companyData = {};
    companies.forEach(c => {
        companyData[c.id] = { name: c.name, revenue: 0, docs: 0 };
    });
    documents.forEach(doc => {
        if (doc.company && companyData[doc.company]) {
            companyData[doc.company].revenue += (doc.total || doc.amount || 0);
            companyData[doc.company].docs++;
        }
    });
    breakdownEl.innerHTML = '';
    const companyBreakdownList = Object.values(companyData);
    if (companyBreakdownList.length > 0) {
        const ul = document.createElement('ul');
        ul.className = 'space-y-2';
        companyBreakdownList.forEach(data => {
            if (data.docs > 0) {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-3 bg-white rounded-lg shadow-sm';
                li.innerHTML = `<span>${escapeHtml(data.name)} (${data.docs} docs)</span>
                    <span class="font-bold text-green-600">L ${formatNumber(data.revenue)}</span>`;
                ul.appendChild(li);
            }
        });
        breakdownEl.appendChild(ul);
    } else {
        breakdownEl.innerHTML = '<p class="text-center text-gray-500">No hay datos de empresas.</p>';
    }
}

/**
 * Formatea un n√∫mero con comas para miles y 2 decimales.
 * @param {number} number - El n√∫mero a formatear.
 */
function formatNumber(number) {
    const numericValue = parseFloat(number) || 0;
    
    // 'es-HN' (Espa√±ol de Honduras) usa coma como separador de miles y punto como decimal.
    // Ej: 1,234.56
    return numericValue.toLocaleString('es-HN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

/**
 * Funci√≥n de mantenimiento para actualizar todas las facturas antiguas
 * que no tienen una fecha de vencimiento (due_date).
 */
async function batchUpdateOldInvoices() {
    
    // 1. Verificaci√≥n de Rol (Admin)
    const isAdmin = pb.authStore.model.expand?.role?.name === 'admin';
    if (!isAdmin) {
        alert("Acci√≥n no permitida. Solo los administradores pueden ejecutar esta funci√≥n.");
        return;
    }

    if (!confirm("Esto revisar√° TODOS los documentos (Facturas y Recibos) que no tengan fecha de vencimiento.\n\nSe calcular√° su 'due_date' basado en los d√≠as de cr√©dito del cliente y su estado se marcar√° como 'Pendiente'.\n\n¬øDeseas continuar?")) {
        return;
    }

    const btn = document.getElementById('batch-update-btn');
    btn.disabled = true;
    btn.textContent = 'Actualizando...';

    let updatedCount = 0;
    
    // --- ‚ñº‚ñº‚ñº CORRECCI√ìN DEL FILTRO ‚ñº‚ñº‚ñº ---
    // Ahora incluye 'factura' O 'recibo'
    const docsToUpdate = documents.filter(doc => 
        (doc.type?.toLowerCase() === 'factura' || doc.type?.toLowerCase() === 'recibo') && 
        !doc.due_date
    );
    // --- ‚ñ≤‚ñ≤‚ñ≤ FIN DE LA CORRECCI√ìN ‚ñ≤‚ñ≤‚ñ≤ ---

    if (docsToUpdate.length === 0) {
        alert("¬°Buenas noticias! No se encontraron documentos antiguos que necesiten actualizaci√≥n.");
        btn.disabled = false;
        btn.textContent = 'üîß Actualizar Facturas Antiguas';
        return;
    }

    try {
        // El resto de la l√≥gica funciona para ambos tipos de documentos
        for (const doc of docsToUpdate) {
            const client = clients.find(c => c.name === doc.clientName);
            const creditDays = client ? (client.credit_days || 0) : 0;
            
            const parts = doc.date.split(' ')[0].split('-'); // Formato YYYY-MM-DD
            const emisionDate = new Date(parts[0], parts[1] - 1, parts[2]);
            
            emisionDate.setDate(emisionDate.getDate() + creditDays);
            const newDueDate = emisionDate.toISOString().split('T')[0];

            await pb.collection('documents').update(doc.id, {
                due_date: newDueDate,
                payment_status: 'Pendiente'
            });
            updatedCount++;
        }

        alert(`¬°√âxito! ${updatedCount} documentos han sido actualizados.`);
        
        await loadData();
        loadHistory(); 

    } catch (err) {
        console.error("Error en la actualizaci√≥n por lotes:", err);
        alert("Ocurri√≥ un error durante la actualizaci√≥n. Revisa la consola.");
    } finally {
        btn.disabled = false;
        btn.textContent = 'üîß Actualizar Facturas Antiguas';
    }
}

</script>
</body>
</html>